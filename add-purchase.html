<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legg til kj√∏p - Husholdningsbudsjett</title>

  <!-- Element SDK / Canva -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase + auth-helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/auth-helpers.js"></script>

  <style>
    body {
      box-sizing:border-box; margin:0; padding:0; height:100%;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      display:flex; align-items:center; justify-content:center;
    }
    html { height:100%; }
    .container {
      width:90%; max-width:600px; padding:40px; background:white;
      border-radius:25px; box-shadow:0 10px 30px rgba(0,0,0,0.1);
      animation:slideInUp .6s ease-out;
    }
    .header { text-align:center; margin-bottom:40px; animation:fadeInDown .8s ease-out; }
    .title { font-size:32px; font-weight:700; color:#2d5f4d; margin-bottom:15px; line-height:1.3; }
    .description { font-size:18px; color:#5a7a6d; line-height:1.5; }
    .form-section { margin-bottom:40px; animation:fadeInUp .8s ease-out .2s both; }
    .form-group { margin-bottom:25px; }
    .form-label {
      display:flex; align-items:center; gap:10px;
      font-size:18px; font-weight:600; color:#2d5f4d; margin-bottom:12px;
    }
    .form-icon { font-size:22px; }
    .form-input {
      width:100%; padding:20px 25px; font-size:20px;
      border:3px solid #e8f5f0; border-radius:15px; background:#fafffe;
      color:#2d5f4d; font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      transition:all .3s ease; box-sizing:border-box;
    }
    .form-input:focus {
      outline:none; border-color:#4caf50; background:white;
      box-shadow:0 0 0 4px rgba(76,175,80,.1);
    }
    .form-select {
      appearance:none;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%235a7a6d' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position:right 20px center;
      background-repeat:no-repeat; background-size:16px;
      padding-right:50px;
    }
    .amount-input { position:relative; }
    .amount-input::after {
      content:'kr'; position:absolute; right:25px; top:50%;
      transform:translateY(-50%); font-size:20px; color:#5a7a6d;
      font-weight:600; pointer-events:none;
    }
    .amount-input input { padding-right:60px; text-align:right; }
    .date-input { max-width:200px; }
    .button-section { text-align:center; animation:fadeInUp .8s ease-out .4s both; }
    .save-button {
      background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);
      color:white; border:none; padding:25px 60px; font-size:22px;
      font-weight:700; border-radius:50px; cursor:pointer;
      box-shadow:0 8px 20px rgba(76,175,80,.3); transition:all .3s ease;
      margin-bottom:20px; position:relative; overflow:hidden;
    }
    .save-button:hover {
      transform:translateY(-3px);
      box-shadow:0 12px 28px rgba(76,175,80,.4);
      background:linear-gradient(135deg,#45a049 0%,#3d8b40 100%);
    }
    .save-button:active { transform:translateY(-1px); }
    .save-button.saving {
      background:#81c784; transform:scale(0.95); pointer-events:none;
    }
    .back-button {
      background:transparent; color:#8a9a8d; border:2px solid #e0e7e3;
      padding:18px 45px; font-size:18px; font-weight:500;
      border-radius:30px; cursor:pointer; transition:all .3s ease;
    }
    .back-button:hover {
      background:#f5f8f6; border-color:#c8d4cb; color:#5a7a6d;
    }
    .success-message {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:white; padding:30px 40px; border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,.2); text-align:center;
      z-index:1000; opacity:0; scale:.8; transition:all .3s ease;
    }
    .success-message.show { opacity:1; scale:1; }
    .success-icon { font-size:60px; color:#4caf50; margin-bottom:15px; animation:checkBounce .6s ease-out; }
    .success-text { font-size:20px; font-weight:600; color:#2d5f4d; margin:0; }
    .overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.3); z-index:999; opacity:0; visibility:hidden;
      transition:all .3s ease;
    }
    .overlay.show { opacity:1; visibility:visible; }

    /* Budsjett-varsel */
    .budget-hint {
      display:none; margin-top:10px; font-size:14px;
      font-weight:600; padding:10px 12px; border-radius:12px;
    }
    .budget-hint.ok   { display:block; background:rgba(76,175,80,.10); color:#2d5f4d; }
    .budget-hint.warn { display:block; background:rgba(249,168,37,.12); color:#f9a825; }
    .budget-hint.over { display:block; background:rgba(211,47,47,.12);  color:#d32f2f; }

    @keyframes slideInUp { from{opacity:0; transform:translateY(50px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInDown { from{opacity:0; transform:translateY(-30px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
    @keyframes checkBounce { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

    @media (max-width:768px){
      .container{padding:30px 25px;}
      .title{font-size:28px;}
      .description{font-size:16px;}
      .form-input{padding:18px 20px; font-size:18px;}
      .save-button{font-size:20px; padding:22px 50px;}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Legg til nytt kj√∏p</h1>
      <p class="description" id="descriptionText">Registrer hvor mye du brukte, og hvor du handlet.</p>
    </div>

    <form class="form-section" id="purchaseForm">
      <!-- Butikk -->
      <div class="form-group">
        <label class="form-label" for="storeInput">
          <span class="form-icon">üè™</span> <span id="storeLabel">Butikk</span>
        </label>
        <select class="form-input form-select" id="storeInput" required>
          <option value="">Velg butikk...</option>
          <option value="Kiwi">Kiwi</option>
          <option value="Rema 1000">Rema 1000</option>
          <option value="Meny">Meny</option>
          <option value="Coop Extra">Coop Extra</option>
          <option value="Bunnpris">Bunnpris</option>
          <option value="Joker">Joker</option>
          <option value="Spar">Spar</option>
          <option value="Eurospar">Eurospar</option>
          <option value="Annet">Annet</option>
        </select>
      </div>

      <!-- Fritekst butikk n√•r "Annet" -->
      <div class="form-group" id="otherStoreGroup" style="display:none;">
        <label class="form-label" for="otherStoreInput">
          <span class="form-icon">‚úèÔ∏è</span> Butikknavn
        </label>
        <input type="text" class="form-input" id="otherStoreInput" placeholder="Skriv butikknavn‚Ä¶" autocomplete="organization">
      </div>

      <!-- Bel√∏p -->
      <div class="form-group">
        <label class="form-label" for="amountInput">
          <span class="form-icon">üí∏</span> <span id="amountLabel">Bel√∏p</span>
        </label>
        <div class="amount-input">
          <input type="number" class="form-input" id="amountInput" placeholder="0" min="0" step="0.01" inputmode="decimal" required>
        </div>
        <!-- Budsjett-varsel (live) -->
        <div id="budgetHint" class="budget-hint" aria-live="polite"></div>
      </div>

      <!-- Kategori -->
      <div class="form-group">
        <label class="form-label" for="categoryInput">
          <span class="form-icon">üè∑Ô∏è</span> Kategori
        </label>
        <select class="form-input form-select" id="categoryInput" required>
          <option value="">Velg kategori‚Ä¶</option>
          <!-- Resten fylles inn via JS basert p√• settings.html -->
        </select>
      </div>

      <!-- Dato -->
      <div class="form-group">
        <label class="form-label" for="dateInput">
          <span class="form-icon">üìÖ</span> <span id="dateLabel">Dato</span>
        </label>
        <input type="date" class="form-input date-input" id="dateInput" required>
      </div>
    </form>

    <div class="button-section">
      <button type="submit" class="save-button" id="saveButton" form="purchaseForm">
        <span id="saveButtonText">Lagre kj√∏p</span>
      </button><br>
      <button type="button" class="back-button" id="backButton">
        <span id="backButtonText">Tilbake til oversikten</span>
      </button>
    </div>
  </main>

  <div class="overlay" id="overlay"></div>
  <div class="success-message" id="successMessage">
    <div class="success-icon">‚úÖ</div>
    <p class="success-text" id="successText">Kj√∏pet er lagt til!</p>
  </div>

<script>
  // ---------- Element default config ----------
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    main_title: "Legg til nytt kj√∏p",
    description_text: "Registrer hvor mye du brukte, og hvor du handlet.",
    store_label: "Butikk",
    amount_label: "Bel√∏p",
    date_label: "Dato",
    save_button_text: "Lagre kj√∏p",
    back_button_text: "Tilbake til oversikten",
    success_message: "Kj√∏pet er lagt til!"
  };

  // ---------- Supabase init ----------
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- Kategorier fra settings.html (localStorage) ----------
  const CATEGORY_SETTINGS_KEY = 'purchase_categories_v1';

  function loadCategorySettings() {
    try {
      const raw = localStorage.getItem(CATEGORY_SETTINGS_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return null;
      return parsed;
    } catch (e) {
      console.warn('Klarte ikke √• lese kategori-innstillinger', e);
      return null;
    }
  }

  function initCategorySelect() {
    const select = document.getElementById('categoryInput');
    if (!select) return;

    // Behold placeholder
    const placeholder = select.querySelector('option[value=""]');
    select.innerHTML = '';
    if (placeholder) select.appendChild(placeholder);

    const stored = loadCategorySettings();
    let categories = [];

    if (stored && stored.length > 0) {
      // Bruk kun aktiverte kategorier
      categories = stored.filter(c => c && c.enabled);
    } else {
      // Fallback til defaults (samme som opprinnelig)
      categories = [
        { name: 'ü•ï Mat & dagligvarer', enabled: true },
        { name: 'üßΩ Husholdning & rengj√∏ring', enabled: true },
        { name: 'üçû Frokost & br√∏d', enabled: true },
        { name: 'üçø Snacks & kos', enabled: true },
        { name: 'ü•¨ Frukt & gr√∏nt', enabled: true },
        { name: 'üì¶ Annet', enabled: true }
      ];
    }

    if (categories.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Ingen kategorier aktivert ‚Äì g√• til Innstillinger';
      select.appendChild(opt);
      select.disabled = true;
      select.required = false;
      return;
    }

    select.disabled = false;
    select.required = true;

    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.name;      // Lagres i DB som samme streng
      opt.textContent = cat.name; // Viser med emoji + navn
      select.appendChild(opt);
    });
  }

  // ---------- State for budsjett-hint ----------
  const state = {
    currentWeekISO: null,
    currentBudget: 0,
    currentSpent: 0
  };

  // ---- Utils (lokal tid / uke) ----
  function isoLocalToday(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function dateFromISOLocal(iso){ // yyyy-mm-dd -> Date (lokal tid)
    const [y,m,d] = iso.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  // Mandag kl 12:00 (samme som app.html) for stabil uke-n√∏kkel
  function mondayOfLocal(date){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = (d.getDay()+6)%7; // 0=mandag
    d.setDate(d.getDate()-day);
    d.setHours(12,0,0,0);
    return d;
  }
  // Bruk aktiv uke hvis satt (fra "Start ny uke"), ellers mandag for valgt dato
  function resolveWeekISOFor(date){
    return localStorage.getItem('activeWeekISO') || mondayOfLocal(date).toISOString().slice(0,10);
  }

  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  // ---------- Hent budsjett + brukt fra Supabase for gitt dato ----------
  async function loadWeekDataFor(date){
    const weekISO = resolveWeekISOFor(date);
    state.currentWeekISO = weekISO;

    let budget = 0;
    let spent = 0;

    try {
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        // Hvis ikke innlogget: send til innlogging
        window.location.href = '/innlogging.html';
        return;
      }

      // 1) Fors√∏k uke-spesifikt budsjett for denne brukeren
      const { data: budgetRow, error: bErr } = await supa
        .from('household_budgets')
        .select('amount')
        .eq('user_id', session.user.id)
        .eq('week_start', weekISO)
        .maybeSingle();

      if (!bErr && budgetRow && typeof budgetRow.amount === 'number') {
        budget = budgetRow.amount;
      } else {
        // 2) Ingen rad for denne uka ‚Üí bruk husstandens default_weekly_budget
        const { data: member, error: mErr } = await supa
          .from('members')
          .select('household_id')
          .eq('user_id', session.user.id)
          .maybeSingle();

        if (!mErr && member?.household_id) {
          const { data: household, error: hErr } = await supa
            .from('households')
            .select('default_weekly_budget')
            .eq('id', member.household_id)
            .maybeSingle();

          if (!hErr && household && typeof household.default_weekly_budget === 'number') {
            budget = household.default_weekly_budget;
          }
        }
      }
    } catch (err) {
      console.warn('Feil ved henting budsjett (DB):', err);
    }

    // 3) Fallback hvis vi fortsatt ikke har budsjett
    if (!budget) {
      const global = parseInt(localStorage.getItem('weeklyBudget') || '', 10);
      budget = (!isNaN(global) && global > 0) ? global : 3000;
    }

    try {
      // Hent alle kj√∏p for samme uke (RLS s√∏rger for riktig husstand)
      const { data: rows, error: pErr } = await supa
        .from('purchases')
        .select('amount')
        .eq('week_start', weekISO);

      if (pErr) {
        console.warn('Feil ved henting kj√∏p:', pErr);
      } else {
        spent = (rows || []).reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
      }
    } catch (err) {
      console.warn('Feil ved henting kj√∏p-session:', err);
    }

    state.currentBudget = budget;
    state.currentSpent = spent;

    // Speil budsjett lokalt for ev. eldre kode / andre sider
    localStorage.setItem('budget_total', String(budget));
    localStorage.setItem('activeWeekISO', weekISO);
    localStorage.setItem(`weeklyBudget_${weekISO}`, String(budget));
    localStorage.setItem('weeklyBudget', String(budget));
  }

  // ---------- Budsjett-varsel (live) ----------
  let isHintLoading = false;

  async function updateBudgetHint(){
    const hint = document.getElementById('budgetHint');
    const amountRaw = document.getElementById('amountInput').value;
    const dateISO = document.getElementById('dateInput').value || isoLocalToday();
    const amount = Number(String(amountRaw).replace(',', '.'));

    if (!amount || amount <= 0) {
      hint.className = 'budget-hint';
      hint.style.display = 'none';
      hint.textContent = '';
      return;
    }

    const date = dateFromISOLocal(dateISO);
    const weekISO = resolveWeekISOFor(date);

    // Hvis uke har endret seg ‚Üí last nye tall
    if (weekISO !== state.currentWeekISO && !isHintLoading) {
      isHintLoading = true;
      hint.style.display = 'block';
      hint.className = 'budget-hint';
      hint.textContent = 'Henter budsjettdata...';
      await loadWeekDataFor(date);
      isHintLoading = false;
    }

    const total = state.currentBudget;
    const spent = state.currentSpent;
    const predicted = spent + Math.round(amount); // Antar hele kroner i DB
    const remainingAfter = total - predicted;
    const ratioAfter = total > 0 ? (predicted / total) : 0;

    let cls = 'ok';
    let text = '';

    if (remainingAfter < 0) {
      cls = 'over';
      text = `Etter lagring: ${formatAmount(Math.abs(remainingAfter))} kr over budsjett`;
    } else if (ratioAfter >= 0.90) {
      cls = 'warn';
      text = `Etter lagring: ${formatAmount(remainingAfter)} kr igjen (n√¶r budsjett)`;
    } else {
      cls = 'ok';
      text = `Etter lagring: ${formatAmount(remainingAfter)} kr igjen`;
    }

    hint.className = `budget-hint ${cls}`;
    hint.textContent = text;
  }

  // ---------- Annet-butikknavn ----------
  function updateOtherStoreVisibility(){
    const sel = document.getElementById('storeInput').value;
    const group = document.getElementById('otherStoreGroup');
    const input = document.getElementById('otherStoreInput');
    if (sel === 'Annet') {
      group.style.display = 'block';
      input.setAttribute('required','required');
      input.focus();
    } else {
      group.style.display = 'none';
      input.removeAttribute('required');
      input.value = '';
    }
  }

  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));
    const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R*0x10000 + G*0x100 + B).toString(16).slice(1);
  }

  function showSuccessMessage() {
    const overlay = document.getElementById('overlay');
    const successMessage = document.getElementById('successMessage');
    overlay.classList.add('show');
    successMessage.classList.add('show');
    setTimeout(() => {
      overlay.classList.remove('show');
      successMessage.classList.remove('show');
      // Flytt redirect hit slik at brukeren faktisk rekker √• se meldingen
      window.location.href = 'app.html';
    }, 900);
  }

  // ---------- Lagring til Supabase + localStorage fallback ----------
  async function handleSubmit(e){
    e.preventDefault();

    const saveButton = document.getElementById('saveButton');
    const saveLabel  = document.getElementById('saveButtonText');

    const storeSel   = document.getElementById('storeInput').value;
    const otherStore = document.getElementById('otherStoreInput').value.trim();
    const store      = (storeSel === 'Annet') ? otherStore : storeSel;

    const amountRaw = document.getElementById('amountInput').value;
    const dateISO   = document.getElementById('dateInput').value;
    const category  = document.getElementById('categoryInput').value;

    const amountFloat = Number(String(amountRaw).replace(',', '.'));

    if (!store || !isFinite(amountFloat) || amountFloat <= 0 || !dateISO || !category) return;

    // Vi lagrer hele kroner i DB (integer)
    const amountInt = Math.round(amountFloat);

    const originalLabel = saveLabel.textContent;
    saveButton.classList.add('saving');
    saveLabel.textContent = 'Lagrer...';

    try {
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        alert('Du er ikke innlogget');
        window.location.href = '/innlogging.html';
        return;
      }

      // Finn medlem/husstand for brukeren
      const { data: member, error: memberError } = await supa
        .from('members')
        .select('id, household_id')
        .eq('user_id', session.user.id)
        .maybeSingle();

      if (memberError || !member) {
        console.error(memberError);
        alert('Fant ikke husstand for brukeren (members-rad mangler).');
        return;
      }

      const date = dateFromISOLocal(dateISO);
      const weekISO = resolveWeekISOFor(date);
      localStorage.setItem('activeWeekISO', weekISO);

      const { error: insertError } = await supa
        .from('purchases')
        .insert({
          household_id: member.household_id,
          member_id:    member.id,
          user_id:      session.user.id,
          week_start:   weekISO,
          amount:       amountInt,
          store:        store,
          description:  '',
          category:     category
        });

      if (insertError) {
        console.error(insertError);
        alert('Kunne ikke lagre kj√∏pet.');
        return;
      }

      // Oppdater localStorage-fallback slik at andre sider som bare leser local f√•r med seg kj√∏pet
      try {
        const localKey = `purchases_${weekISO}`;
        const raw = localStorage.getItem(localKey);
        let list = [];
        if (raw) {
          try { list = JSON.parse(raw); } catch { list = []; }
        }
        if (!Array.isArray(list)) list = [];
        list.push({
          amount: amountInt,
          store,
          date: dateISO,
          category
        });
        localStorage.setItem(localKey, JSON.stringify(list));
      } catch (e) {
        console.warn('Klarte ikke √• oppdatere lokal purchases-cache', e);
      }

      // Oppdater internt "spent" for budsjett-hintet (i samme √∏kt)
      state.currentSpent += amountInt;

      showSuccessMessage();

    } catch (err) {
      console.error(err);
      alert(err.message || 'Ukjent feil oppstod ved lagring.');
    } finally {
      saveButton.classList.remove('saving');
      saveLabel.textContent = originalLabel;
    }
  }

  // ---------- Element SDK ----------
  function onConfigChange(config){
    const backgroundColor = config.background_color || defaultConfig.background_color;
    const surfaceColor = config.surface_color || defaultConfig.surface_color;
    const textColor = config.text_color || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
    const customFont = config.font_family || defaultConfig.font_family;
    const baseSize = config.font_size || defaultConfig.font_size;

    document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor, -2)} 100%)`;

    const container = document.querySelector('.container');
    container.style.background = surfaceColor;

    document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
    document.getElementById('descriptionText').textContent = config.description_text || defaultConfig.description_text;
    document.getElementById('storeLabel').textContent = config.store_label || defaultConfig.store_label;
    document.getElementById('amountLabel').textContent = config.amount_label || defaultConfig.amount_label;
    document.getElementById('dateLabel').textContent = config.date_label || defaultConfig.date_label;
    document.getElementById('saveButtonText').textContent = config.save_button_text || defaultConfig.save_button_text;
    document.getElementById('backButtonText').textContent = config.back_button_text || defaultConfig.back_button_text;
    document.getElementById('successText').textContent = config.success_message || defaultConfig.success_message;

    ['mainTitle','descriptionText','successText'].forEach(id=>{
      const el = document.getElementById(id);
      el.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      el.style.color = id==='descriptionText' ? secondaryTextColor : textColor;
      if (id==='mainTitle') el.style.fontSize = `${baseSize * 1.78}px`;
    });

    document.querySelectorAll('.form-input').forEach(input=>{
      input.style.borderColor = adjustColor(primaryActionColor, 60);
      input.style.color = textColor;
      input.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    });

    const saveButton = document.getElementById('saveButton');
    saveButton.style.background = `linear-gradient(135deg, ${primaryActionColor} 0%, ${adjustColor(primaryActionColor, -10)} 100%)`;
    saveButton.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
  }
  function mapToCapabilities(config){
    return {
      recolorables:[
        {get:()=>config.background_color||defaultConfig.background_color,set:v=>window.elementSdk?.setConfig({background_color:v})},
        {get:()=>config.surface_color||defaultConfig.surface_color,set:v=>window.elementSdk?.setConfig({surface_color:v})},
        {get:()=>config.text_color||defaultConfig.text_color,set:v=>window.elementSdk?.setConfig({text_color:v})},
        {get:()=>config.primary_action_color||defaultConfig.primary_action_color,set:v=>window.elementSdk?.setConfig({primary_action_color:v})},
        {get:()=>config.secondary_text_color||defaultConfig.secondary_text_color,set:v=>window.elementSdk?.setConfig({secondary_text_color:v})},
      ],
      borderables:[],
      fontEditable:{get:()=>config.font_family||defaultConfig.font_family,set:v=>window.elementSdk?.setConfig({font_family:v})},
      fontSizeable:{get:()=>config.font_size||defaultConfig.font_size,set:v=>window.elementSdk?.setConfig({font_size:v})},
    };
  }
  function mapToEditPanelValues(config){
    return new Map([
      ["main_title", config.main_title || defaultConfig.main_title],
      ["description_text", config.description_text || defaultConfig.description_text],
      ["store_label", config.store_label || defaultConfig.store_label],
      ["amount_label", config.amount_label || defaultConfig.amount_label],
      ["date_label", config.date_label || defaultConfig.date_label],
      ["save_button_text", config.save_button_text || defaultConfig.save_button_text],
      ["back_button_text", config.back_button_text || defaultConfig.back_button_text],
      ["success_message", config.success_message || defaultConfig.success_message]
    ]);
  }

  async function init(){
    // Auth guard (bruk samme "hjerne" som de andre sidene)
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/add-purchase.html') {
        // Ble redirectet til f.eks. /innlogging.html
        return;
      }
    }

    // Lytt p√• ekstern utlogging
    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    }

    // Sett dagens dato
    const dateInput = document.getElementById('dateInput');
    dateInput.value = isoLocalToday();

    // Bygg kategori-listen basert p√• settings.html
    initCategorySelect();

    // Last budsjett/spent for denne datoen
    await loadWeekDataFor(dateFromISOLocal(dateInput.value));

    // Lyttere
    document.getElementById('amountInput').addEventListener('input', () => { updateBudgetHint(); });
    document.getElementById('dateInput').addEventListener('change', () => { updateBudgetHint(); });
    document.getElementById('storeInput').addEventListener('change', () => { updateOtherStoreVisibility(); });

    document.getElementById('purchaseForm').addEventListener('submit', handleSubmit);
    document.getElementById('backButton').addEventListener('click', () => {
      window.location.href = 'app.html';
    });

    // Element SDK
    if (window.elementSdk){
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }

    // Init UI
    updateBudgetHint();
    updateOtherStoreVisibility();
  }

  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
