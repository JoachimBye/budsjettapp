<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legg til kj√∏p - Husholdningsbudsjett</title>

  <!-- Element SDK / Canva -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase + auth-helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>
  <script src="/auth-helpers.js"></script>
  <script src="/js/services/household-context.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/category-service.js"></script>
  <script src="/js/services/store-service.js"></script>
  <script src="/js/services/budget-utils.js"></script>
  <script src="/js/services/budget-service.js"></script>
  <script src="/js/ui/toast.js"></script>
  <script src="/js/ui/coach.js"></script>

  <style>
    html {
      height: 100%;
    }

    body {
      box-sizing: border-box;
      margin: 0;
      padding: 24px 0;          /* litt luft over/under */
      min-height: 100vh;        /* kan bli h√∏yere enn skjermen */
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      display: block;           /* ikke flex-layout p√• body */
    }

    html { height:100%; }
    .container {
      width: 90%;
      max-width: 600px;
      padding: 40px;
      background: white;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: slideInUp .6s ease-out;
      margin: 0 auto;          /* horisontalt midt */
    }

    .header { text-align:center; margin-bottom:40px; animation:fadeInDown .8s ease-out; }
    .header {
      text-align:left;
      margin-bottom:32px;
    }

    /* Liten badge √∏verst */
    .header-badge {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(76,175,80,0.07);
      color:#2d5f4d;
      font-size:13px;
      font-weight:600;
      margin-bottom:14px;
    }

    .badge-icon {
      font-size:16px;
    }

    .badge-text {
      letter-spacing:0.03em;
      text-transform:uppercase;
    }

    /* Tittel + uke-pill p√• samme linje */
    .header-title-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }

    /* Liten ‚Äúpill‚Äù til h√∏yre ‚Äì kan brukes til uke, ‚ÄúEtter butikk-tur‚Äù osv */
    .header-pill {
      padding:6px 14px;
      border-radius:999px;
      background:#f0f9f4;
      border:1px solid rgba(76,175,80,0.25);
      font-size:13px;
      font-weight:600;
      color:#2d5f4d;
      white-space:nowrap;
    }

    @media (max-width:768px){
      .header-title-row {
        flex-direction:column;
        align-items:flex-start;
      }
    }

    .title { font-size:32px; font-weight:700; color:#2d5f4d; margin-bottom:15px; line-height:1.3; }
    .description { font-size:18px; color:#5a7a6d; line-height:1.5; }
    .form-section { margin-bottom:40px; animation:fadeInUp .8s ease-out .2s both; }
    .form-group { margin-bottom:25px; }
    .form-label {
      display:flex; align-items:center; gap:10px;
      font-size:18px; font-weight:600; color:#2d5f4d; margin-bottom:12px;
    }
    .form-icon { font-size:22px; }
    .form-input {
      width:100%; padding:20px 25px; font-size:20px;
      border:3px solid #e8f5f0; border-radius:15px; background:#fafffe;
      color:#2d5f4d; font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      transition:all .3s ease; box-sizing:border-box;
    }
    .form-input:focus {
      outline:none; border-color:#4caf50; background:white;
      box-shadow:0 0 0 4px rgba(76,175,80,.1);
    }
    .form-select {
      appearance:none;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%235a7a6d' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position:right 20px center;
      background-repeat:no-repeat; background-size:16px;
      padding-right:50px;
    }
    .amount-input { position:relative; }
    .amount-input::after {
      content:'kr'; position:absolute; right:25px; top:50%;
      transform:translateY(-50%); font-size:20px; color:#5a7a6d;
      font-weight:600; pointer-events:none;
    }
    .amount-input input { padding-right:60px; text-align:right; }
    .date-input { max-width:200px; }
    .button-section { text-align:center; animation:fadeInUp .8s ease-out .4s both; }
    .save-button {
      background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);
      color:white; border:none; padding:25px 60px; font-size:22px;
      font-weight:700; border-radius:50px; cursor:pointer;
      box-shadow:0 8px 20px rgba(76,175,80,.3); transition:all .3s ease;
      margin-bottom:20px; position:relative; overflow:hidden;
      display:inline-flex; align-items:center; justify-content:center; min-width:60px;
    }
    .save-button:hover {
      transform:translateY(-3px);
      box-shadow:0 12px 28px rgba(76,175,80,.4);
      background:linear-gradient(135deg,#45a049 0%,#3d8b40 100%);
    }
    .save-button:active { transform:translateY(-1px); }
    .save-button.saving {
      background:#81c784; transform:scale(0.95); pointer-events:none;
    }
    .back-button {
      background:transparent; color:#8a9a8d; border:2px solid #e0e7e3;
      padding:18px 45px; font-size:18px; font-weight:500;
      border-radius:30px; cursor:pointer; transition:all .3s ease;
    }
    .back-button:hover {
      background:#f5f8f6; border-color:#c8d4cb; color:#5a7a6d;
    }
    .success-message {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:white; padding:30px 40px; border-radius:20px;
      box-shadow:0 15px 40px rgba(0,0,0,.2); text-align:center;
      z-index:1000; opacity:0; scale:.8; transition:all .3s ease;
    }
    .success-message.show { opacity:1; scale:1; }
    .success-icon { font-size:60px; color:#4caf50; margin-bottom:15px; animation:checkBounce .6s ease-out; }
    .success-text { font-size:20px; font-weight:600; color:#2d5f4d; margin:0; }
    .overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.3); z-index:999; opacity:0; visibility:hidden;
      transition:all .3s ease;
    }
    .overlay.show { opacity:1; visibility:visible; }

    /* Budsjett-varsel */
    .budget-hint {
      display:none; margin-top:10px; font-size:14px;
      font-weight:600; padding:10px 12px; border-radius:12px;
    }
    .budget-hint.ok   { display:block; background:rgba(76,175,80,.10); color:#2d5f4d; }
    .budget-hint.warn { display:block; background:rgba(249,168,37,.12); color:#f9a825; }
    .budget-hint.over { display:block; background:rgba(211,47,47,.12);  color:#d32f2f; }

    /* Coach overlay (intro-guide) */
    .coach-overlay {
      position: fixed;
      inset: 0;
      z-index: 500;
      display: none;
      pointer-events: auto;
    }

    .coach-highlight {
      position: fixed;
      border-radius: 16px;
      border: 2px solid #4caf50;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      transition: all 0.25s ease;
      pointer-events: none;
    }

    .coach-tooltip {
      position: fixed;
      max-width: 320px;
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px 12px 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      color: #2d5f4d;
      font-size: 14px;
      line-height: 1.4;
      transition: opacity 0.25s ease, top 0.25s ease;
    }

    .coach-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .coach-text {
      margin: 0;
    }

    .coach-step-label {
      margin-top: 6px;
      font-size: 12px;
      color: #5a7a6d;
    }

    .coach-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .coach-btn {
      border: none;
      border-radius: 9999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, color 0.2s;
    }

    .coach-btn.coach-skip {
      background: transparent;
      color: #5a7a6d;
    }

    .coach-btn.coach-prev {
      background: #f0f0f0;
      color: #2d5f4d;
    }

    .coach-btn.coach-next {
      background: #4caf50;
      color: #ffffff;
    }

    .coach-btn.coach-next:hover {
      background: #45a049;
    }

    @keyframes slideInUp { from{opacity:0; transform:translateY(50px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInDown { from{opacity:0; transform:translateY(-30px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
    @keyframes checkBounce { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

    @media (max-width:768px){
      .container{padding:30px 25px;}
      .title{font-size:28px;}
      .description{font-size:16px;}
      .form-input{padding:18px 20px; font-size:18px;}
      .save-button{font-size:20px; padding:22px 50px;}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
  <main class="container">

    <div class="header">
      <div class="header-badge">
        <span class="badge-icon">üßæ</span>
        <span class="badge-text">Registrer et nytt kj√∏p</span>
      </div>

      <div class="header-title-row">
        <h1 class="title" id="mainTitle">
          Legg til nytt kj√∏p
        </h1>
        <div class="header-pill" id="weekPill" aria-hidden="true">
          Uke&nbsp;42
        </div>
      </div>

      <p class="description" id="descriptionText">
        Skriv inn butikk, bel√∏p og dato ‚Äì s√• holder vi styr p√• budsjettet for deg.
      </p>
    </div>

    <form class="form-section" id="purchaseForm">
      <!-- Butikk -->
      <div class="form-group">
        <label class="form-label" for="storeInput">
          <span class="form-icon">üè™</span> <span id="storeLabel">Butikk</span>
        </label>
        <select class="form-input form-select" id="storeInput" required>
          <option value="">Velg butikk...</option>
          <option value="Kiwi">Kiwi</option>
          <option value="Rema 1000">Rema 1000</option>
          <option value="Meny">Meny</option>
          <option value="Coop Extra">Coop Extra</option>
          <option value="Bunnpris">Bunnpris</option>
          <option value="Joker">Joker</option>
          <option value="Spar">Spar</option>
          <option value="Eurospar">Eurospar</option>
          <option value="Annet">Annet</option>
        </select>
      </div>

      <!-- Fritekst butikk n√•r "Annet" -->
      <div class="form-group" id="otherStoreGroup" style="display:none;">
        <label class="form-label" for="otherStoreInput">
          <span class="form-icon">‚úèÔ∏è</span> Butikknavn
        </label>
        <input type="text" class="form-input" id="otherStoreInput" placeholder="Skriv butikknavn‚Ä¶" autocomplete="organization">
      </div>

      <!-- Bel√∏p -->
      <div class="form-group">
        <label class="form-label" for="amountInput">
          <span class="form-icon">üí∏</span> <span id="amountLabel">Bel√∏p</span>
        </label>
        <div class="amount-input">
          <input type="number" class="form-input" id="amountInput" placeholder="0" min="0" step="0.01" inputmode="decimal" required>
        </div>
        <!-- Budsjett-varsel (live) -->
        <div id="budgetHint" class="budget-hint" aria-live="polite"></div>
      </div>

      <!-- Kategori -->
      <div class="form-group">
        <label class="form-label" for="categoryInput">
          <span class="form-icon">üè∑Ô∏è</span> Kategori
        </label>
        <select class="form-input form-select" id="categoryInput" required>
          <option value="">Velg kategori‚Ä¶</option>
          <!-- Resten fylles inn via JS basert p√• settings.html -->
        </select>
      </div>

      <!-- Dato -->
      <div class="form-group">
        <label class="form-label" for="dateInput">
          <span class="form-icon">üìÖ</span> <span id="dateLabel">Dato</span>
        </label>
        <input type="date" class="form-input date-input" id="dateInput" required>
      </div>
    </form>

    <div class="button-section">
      <button type="submit" class="save-button" id="saveButton" form="purchaseForm">
        <span id="saveButtonText">Lagre kj√∏p</span>
      </button><br>
      <button type="button" class="back-button" id="backButton">
        <span id="backButtonText">Tilbake til oversikten</span>
      </button>
    </div>
  </main>

  <!-- Coach overlay: liten intro-guide -->
  <div class="coach-overlay" id="coachOverlay">
    <div class="coach-highlight" id="coachHighlight"></div>
    <div class="coach-tooltip" id="coachTooltip">
      <div class="coach-title" id="coachTitle"></div>
      <p class="coach-text" id="coachText"></p>
      <div class="coach-step-label" id="coachStepLabel"></div>
      <div class="coach-buttons">
        <button type="button" class="coach-btn coach-skip" id="coachSkipBtn">Hopp over</button>
        <button type="button" class="coach-btn coach-prev" id="coachPrevBtn">Tilbake</button>
        <button type="button" class="coach-btn coach-next" id="coachNextBtn">Neste</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="success-message" id="successMessage">
    <div class="success-icon">‚úÖ</div>
    <p class="success-text" id="successText">Kj√∏pet er lagt til!</p>
  </div>

<script>
  // ---------- Element default config ----------
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    main_title: "Legg til nytt kj√∏p",
    description_text: "Registrer hvor mye du brukte, og hvor du handlet.",
    store_label: "Butikk",
    amount_label: "Bel√∏p",
    date_label: "Dato",
    save_button_text: "Lagre kj√∏p",
    back_button_text: "Tilbake til oversikten",
    success_message: "Kj√∏pet er lagt til!"
  };

  // ---------- Supabase init ----------
  const supa = window.supaClient?.getClient();
  const householdCtx = window.householdContext;
  const showToast = (message, type = 'info') => {
    if (window.toast?.show) {
      window.toast.show(message, { type });
    } else {
      console[type === 'error' ? 'error' : 'log'](message);
    }
  };

// ---------- Coach overlay (intro) ----------
const COACH_SEEN_KEY = 'addPurchase_coach_seen_v1';
let coachInstance = null;

const coachSteps = [
  {
    id: 'store',
    selector: '#storeInput',
    title: 'Hvor handlet du?',
    text:  'Velg butikken du handlet i. Om det ikke er p√• lista kan du velge "Annet" og skrive navnet selv.',
  },
  {
    id: 'amount',
    selector: '#amountInput',
    title: 'Hvor mye brukte du?',
    text:  'Skriv inn totalsummen fra kvitteringen. Vi viser samtidig hvordan det p√•virker ukesbudsjettet ditt.',
  },
  {
    id: 'category',
    selector: '#categoryInput',
    title: 'Hvilken kategori?',
    text:  'Velg en kategori for kj√∏pet. Du kan endre kategoriene selv under Innstillinger.',
  },
  {
    id: 'date',
    selector: '#dateInput',
    title: 'N√•r var kj√∏pet?',
    text:  'Sjekk at datoen stemmer.',
  },
  {
    id: 'save',
    selector: '#saveButton',
    title: 'Lagre kj√∏pet',
    text:  'N√•r alt ser riktig ut trykker du her. Kj√∏pet lagres og budsjettet oppdateres i oversikten.',
  },
];

function setupCoach() {
  if (!window.coach) return;
  coachInstance = window.coach.create({
    steps: coachSteps,
    storageKey: COACH_SEEN_KEY,
  });
}

function startCoachTour() {
  coachInstance?.start();
}

function endCoachTour() {
  coachInstance?.stop();
}

function shouldStartCoachTour() {
  if (!coachInstance) return false;
  return !coachInstance.hasSeen();
}

  // ---------- Kategorier / butikker fra settings ----------
  const categoryService = window.categoryService || null;
  const storeService = window.storeService || null;
  const FALLBACK_CATEGORY_LIST = categoryService?.DEFAULT_CATEGORIES || [
    { name: 'ü•ï Mat & dagligvarer', enabled: true },
    { name: 'üßΩ Husholdning & rengj√∏ring', enabled: true },
    { name: 'üçû Frokost & br√∏d', enabled: true },
    { name: 'üçø Snacks & kos', enabled: true },
    { name: 'ü•¨ Frukt & gr√∏nt', enabled: true },
    { name: 'üì¶ Annet', enabled: false }
  ];
  const FALLBACK_STORE_LIST = storeService?.DEFAULT_STORES || [
    { name: 'Kiwi', enabled: true },
    { name: 'Rema 1000', enabled: true },
    { name: 'Coop Extra', enabled: true },
    { name: 'Meny', enabled: true },
    { name: 'Spar', enabled: true },
    { name: 'Joker', enabled: false },
    { name: 'Bunnpris', enabled: false }
  ];
  const OTHER_STORE_VALUE = 'Annet';

  async function fetchActiveCategories() {
    if (categoryService?.loadCategorySettings) {
      try {
        const list = await categoryService.loadCategorySettings(supa);
        if (Array.isArray(list)) {
          return list.filter((cat) => cat.enabled !== false);
        }
      } catch (err) {
        console.error('Kunne ikke hente kategorier fra Supabase', err);
      }
    }
    return FALLBACK_CATEGORY_LIST.filter((cat) => cat.enabled !== false);
  }

  async function fetchActiveStores() {
    if (storeService?.loadStoreSettings) {
      try {
        const list = await storeService.loadStoreSettings(supa);
        if (Array.isArray(list)) {
          return list.filter((store) => store.enabled !== false);
        }
      } catch (err) {
        console.error('Kunne ikke hente butikker fra Supabase', err);
      }
    }
    return FALLBACK_STORE_LIST.filter((store) => store.enabled !== false);
  }

  async function initCategorySelect() {
    const select = document.getElementById('categoryInput');
    if (!select) return;

    // Behold placeholder
    const placeholder = select.querySelector('option[value=""]');
    select.innerHTML = '';
    if (placeholder) select.appendChild(placeholder);

    const categories = await fetchActiveCategories();

    if (categories.length === 0) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Ingen kategorier aktivert ‚Äì g√• til Innstillinger';
      select.appendChild(opt);
      select.disabled = true;
      select.required = false;
      return;
    }

    select.disabled = false;
    select.required = true;

    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.name;      // Lagres i DB som samme streng
      opt.textContent = cat.name; // Viser med emoji + navn
      select.appendChild(opt);
    });

    const storeSel = document.getElementById('storeInput');
    if (storeSel && storeSel.value && storeSel.value !== OTHER_STORE_VALUE) {
      applyLastCategoryForStore(storeSel.value);
    }
  }

  async function initStoreSelect() {
    const select = document.getElementById('storeInput');
    if (!select) return;

    let placeholder = select.querySelector('option[value=""]');
    if (!placeholder) {
      placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Velg butikk...';
    }

    select.innerHTML = '';
    placeholder.selected = true;
    select.appendChild(placeholder);

    const stores = await fetchActiveStores();

    if (stores.length === 0) {
      const info = document.createElement('option');
      info.value = '';
      info.textContent = 'Ingen butikker aktivert ‚Äì velg Annet';
      info.disabled = true;
      select.appendChild(info);
    } else {
      stores.forEach(store => {
        const opt = document.createElement('option');
        opt.value = store.name;
        opt.textContent = store.name;
        select.appendChild(opt);
      });
    }

    const otherOpt = document.createElement('option');
    otherOpt.value = OTHER_STORE_VALUE;
    otherOpt.textContent = OTHER_STORE_VALUE;
    select.appendChild(otherOpt);

    select.disabled = false;
    select.required = true;
    updateOtherStoreVisibility();
    if (select.value && select.value !== OTHER_STORE_VALUE) {
      applyLastCategoryForStore(select.value);
    }
  }

  // ---------- State for budsjett-hint ----------
  const state = {
    currentWeekISO: null,
    currentBudget: 0,
    currentSpent: 0
  };
  const dateUtils = window.dateUtils || {};
  const budgetService = window.budgetService || null;
  const budgetUtils = window.budgetUtils || {};
  const isoToday = () => (dateUtils.isoLocalToday ? dateUtils.isoLocalToday() : new Date().toISOString().slice(0, 10));
  const parseLocalDate = (iso) => (dateUtils.dateFromISOLocal ? dateUtils.dateFromISOLocal(iso) : new Date(iso));
  const resolveWeekISO = (date) => (dateUtils.resolveWeekISOForDate ? dateUtils.resolveWeekISOForDate(date) : (date ? date.toISOString().slice(0, 10) : isoToday()));
  const getISOWeekNumber = (iso) => (dateUtils.getISOWeekFromISODate ? dateUtils.getISOWeekFromISODate(iso) : null);

  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  function readJSON(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw) ?? fallback;
    } catch {
      return fallback;
    }
  }


  // ---------- Hent budsjett + brukt fra Supabase for gitt dato ----------
  async function loadWeekDataFor(date){
    const weekISO = resolveWeekISO(date);
    state.currentWeekISO = weekISO;

    let summary = null;
    if (budgetService?.loadWeekSummary) {
      summary = await budgetService.loadWeekSummary(supa, weekISO);
    }

    const budget = summary?.budget
      ?? (budgetService?.readWeeklyBudgetLocal
        ? budgetService.readWeeklyBudgetLocal(weekISO)
        : 3000);
    const spent = summary?.spent
      ?? (budgetUtils.safeSumPurchases
        ? budgetUtils.safeSumPurchases(readJSON(`purchases_${weekISO}`, []))
        : 0);

    state.currentBudget = budget;
    state.currentSpent = spent;

    const weekPill = document.getElementById('weekPill');
    if (weekPill && weekISO) {
      const weekNum = getISOWeekNumber(weekISO);
      if (weekNum) {
        weekPill.textContent = `Uke ${weekNum}`;
      }
    }
  }

  // ---------- Budsjett-varsel (live) ----------
  let isHintLoading = false;

  async function updateBudgetHint(){
    const hint = document.getElementById('budgetHint');
    const amountRaw = document.getElementById('amountInput').value;
    const dateISO = document.getElementById('dateInput').value || isoToday();
    const amount = Number(String(amountRaw).replace(',', '.'));

    if (!amount || amount <= 0) {
      hint.className = 'budget-hint';
      hint.style.display = 'none';
      hint.textContent = '';
      return;
    }

    const date = parseLocalDate(dateISO);
    const weekISO = resolveWeekISO(date);

    // Hvis uke har endret seg ‚Üí last nye tall
    if (weekISO !== state.currentWeekISO && !isHintLoading) {
      isHintLoading = true;
      hint.style.display = 'block';
      hint.className = 'budget-hint';
      hint.textContent = 'Henter budsjettdata...';
      await loadWeekDataFor(date);
      isHintLoading = false;
    }

    const total = state.currentBudget;
    const spent = state.currentSpent;
    const predicted = spent + Math.round(amount); // Antar hele kroner i DB
    const remainingAfter = total - predicted;
    const ratioAfter = total > 0 ? (predicted / total) : 0;

    let cls = 'ok';
    let text = '';

    if (remainingAfter < 0) {
      cls = 'over';
      text = `Etter lagring: ${formatAmount(Math.abs(remainingAfter))} kr over budsjett`;
    } else if (ratioAfter >= 0.90) {
      cls = 'warn';
      text = `Etter lagring: ${formatAmount(remainingAfter)} kr igjen (n√¶r budsjett)`;
    } else {
      cls = 'ok';
      text = `Etter lagring: ${formatAmount(remainingAfter)} kr igjen`;
    }

    hint.className = `budget-hint ${cls}`;
    hint.textContent = text;
  }

  // ---------- Annet-butikknavn ----------
  function updateOtherStoreVisibility(){
    const select = document.getElementById('storeInput');
    if (!select) return;
    const sel = select.value;
    const group = document.getElementById('otherStoreGroup');
    const input = document.getElementById('otherStoreInput');
    if (!group || !input) return;
    if (sel === OTHER_STORE_VALUE) {
      group.style.display = 'block';
      input.setAttribute('required','required');
      input.focus();
    } else {
      group.style.display = 'none';
      input.removeAttribute('required');
      input.value = '';
    }
  }

  const lastCategoryKey = (storeName) => storeName ? `lastCategoryForStore_${storeName}` : null;

  function rememberLastCategory(storeName, categoryName) {
    const key = lastCategoryKey(storeName);
    if (!key || !categoryName) return;
    try {
      localStorage.setItem(key, categoryName);
    } catch (err) {
      console.warn('Kunne ikke lagre forrige kategori for butikk', err);
    }
  }

  function applyLastCategoryForStore(storeName) {
    const key = lastCategoryKey(storeName);
    if (!key) return;
    const last = localStorage.getItem(key);
    if (!last) return;
    const categorySelect = document.getElementById('categoryInput');
    if (!categorySelect) return;
    const exists = Array.from(categorySelect.options).some((opt) => opt.value === last);
    if (exists) {
      categorySelect.value = last;
    }
  }

  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));
    const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R*0x10000 + G*0x100 + B).toString(16).slice(1);
  }

  function showSuccessMessage() {
    const overlay = document.getElementById('overlay');
    const successMessage = document.getElementById('successMessage');
    if (overlay) overlay.classList.add('show');
    if (successMessage) successMessage.classList.add('show');
    setTimeout(() => {
      window.location.href = 'app.html';
    }, 1200);
  }

  // ---------- Lagring til Supabase + localStorage fallback ----------
  async function handleSubmit(e){
    e.preventDefault();
    if (!supa) {
      showToast('Klarte ikke kontakte databasen. Pr√∏v igjen.', 'error');
      return;
    }

    const saveBtn = document.getElementById('saveButton');
    const saveText = document.getElementById('saveButtonText');
    let savedSuccessfully = false;

    const storeSel   = document.getElementById('storeInput').value;
    const otherStore = document.getElementById('otherStoreInput').value.trim();
    const store      = (storeSel === OTHER_STORE_VALUE) ? otherStore : storeSel;

    const amountRaw = document.getElementById('amountInput').value;
    const dateISO   = document.getElementById('dateInput').value;
    const category  = document.getElementById('categoryInput').value;

    const amountFloat = Number(String(amountRaw).replace(',', '.'));

    if (!store || !isFinite(amountFloat) || amountFloat <= 0 || !dateISO || !category) return;

    // Vi lagrer hele kroner i DB (integer)
    const amountInt = Math.round(amountFloat);

    const originalLabel = saveText?.textContent || '';
    if (saveBtn) saveBtn.classList.add('saving');
    if (saveText) saveText.textContent = 'Lagrer...';

    try {
      const { data: { session } } = await supa.auth.getSession();
      if (!session) throw new Error('Ikke innlogget');

      const resolvedHouseholdId = householdCtx?.getHouseholdId
        ? await householdCtx.getHouseholdId(supa)
        : null;
      const { data: member, error: memErr } = await supa
        .from('members')
        .select('id, household_id')
        .eq('user_id', session.user.id)
        .maybeSingle();

      if (memErr) {
        console.error('Feil ved lesing fra members:', memErr);
      }
      if (!member) {
        throw new Error('Fant ikke medlemsinfo for denne brukeren.');
      }

      const householdId = member.household_id || resolvedHouseholdId;
      const memberId = member.id;
      if (!householdId) {
        throw new Error('Klarte ikke identifisere husstand for kj√∏pet.');
      }

      const date = dateUtils.dateFromISOLocal
        ? dateUtils.dateFromISOLocal(dateISO)
        : new Date(dateISO);
      const weekISO = dateUtils.resolveWeekISOForDate
        ? dateUtils.resolveWeekISOForDate(date)
        : dateISO;
      localStorage.setItem('activeWeekISO', weekISO);

      const { data: newPurchase, error: insErr } = await supa
        .from('purchases')
        .insert({
          household_id: householdId,
          member_id:    memberId,
          week_start:   weekISO,
          amount:       amountInt,
          store:        store,
          description:  '',
          category:     category
        })
        .select('id')
        .single();

      if (insErr) {
        console.error('Insert feil mot purchases:', insErr);
        throw new Error('Lagring feilet i databasen.');
      }
      if (!newPurchase?.id) {
        console.warn('Supabase returnerte ingen id for nytt kj√∏p');
      }

      rememberLastCategory(store, category);

      try {
        const localKey = `purchases_${weekISO}`;
        const list = JSON.parse(localStorage.getItem(localKey) || '[]');
        list.push({
          id: newPurchase?.id,
          amount: amountInt,
          store,
          date: dateISO,
          category
        });
        localStorage.setItem(localKey, JSON.stringify(list));
      } catch (e) {
        console.warn('Klarte ikke oppdatere localStorage for purchases', e);
      }

      state.currentSpent += amountInt;

      const successMessages = [
        'Kj√∏pet er i boks! ‚úÖ',
        'Registrert! üí∏',
        'Ka-ching! Lagret. üßæ',
        'Nice! Budsjettet er oppdatert. üìä'
      ];
      const msg = successMessages[Math.floor(Math.random() * successMessages.length)];
      const successTextEl = document.getElementById('successText');
      if (successTextEl) successTextEl.textContent = msg;
      if (saveBtn) {
        saveBtn.classList.remove('saving');
        saveBtn.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
        saveBtn.classList.add('saving-success');
        saveBtn.style.width = '60px';
        saveBtn.style.padding = '0';
        saveBtn.style.transform = 'scale(1.1)';
      }
      if (saveText) {
        saveText.innerHTML = '‚úÖ';
      }
      savedSuccessfully = true;
      showSuccessMessage();

    } catch (err) {
      console.error(err);
      showToast(err.message || 'Kunne ikke lagre kj√∏pet.', 'error');
    } finally {
      if (!savedSuccessfully) {
        if (saveBtn) saveBtn.classList.remove('saving');
        if (saveText) saveText.textContent = originalLabel;
      }
    }
  }

  // ---------- Element SDK ----------
  function onConfigChange(config){
    const backgroundColor = config.background_color || defaultConfig.background_color;
    const surfaceColor = config.surface_color || defaultConfig.surface_color;
    const textColor = config.text_color || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
    const customFont = config.font_family || defaultConfig.font_family;
    const baseSize = config.font_size || defaultConfig.font_size;

    document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor, -2)} 100%)`;

    const container = document.querySelector('.container');
    container.style.background = surfaceColor;

    document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
    document.getElementById('descriptionText').textContent = config.description_text || defaultConfig.description_text;
    document.getElementById('storeLabel').textContent = config.store_label || defaultConfig.store_label;
    document.getElementById('amountLabel').textContent = config.amount_label || defaultConfig.amount_label;
    document.getElementById('dateLabel').textContent = config.date_label || defaultConfig.date_label;
    document.getElementById('saveButtonText').textContent = config.save_button_text || defaultConfig.save_button_text;
    document.getElementById('backButtonText').textContent = config.back_button_text || defaultConfig.back_button_text;
    document.getElementById('successText').textContent = config.success_message || defaultConfig.success_message;

    // Bare description + success bruker Canva-farger
    ['descriptionText','successText'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      el.style.color = (id === 'descriptionText') ? secondaryTextColor : textColor;
    });

    // Tittelen har l√•st, m√∏rk gr√∏nn farge
    const mainTitleEl = document.getElementById('mainTitle');
    if (mainTitleEl) {
      mainTitleEl.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      mainTitleEl.style.fontSize = `${baseSize * 1.78}px`;
      mainTitleEl.style.color = '#2d5f4d'; // alltid lesbar
    }

    document.querySelectorAll('.form-input').forEach(input=>{
      input.style.borderColor = adjustColor(primaryActionColor, 60);
      input.style.color = textColor;
      input.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    });

    const saveButton = document.getElementById('saveButton');
    saveButton.style.background = `linear-gradient(135deg, ${primaryActionColor} 0%, ${adjustColor(primaryActionColor, -10)} 100%)`;
    saveButton.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
  }
  function mapToCapabilities(config){
    return {
      recolorables:[
        {get:()=>config.background_color||defaultConfig.background_color,set:v=>window.elementSdk?.setConfig({background_color:v})},
        {get:()=>config.surface_color||defaultConfig.surface_color,set:v=>window.elementSdk?.setConfig({surface_color:v})},
        {get:()=>config.text_color||defaultConfig.text_color,set:v=>window.elementSdk?.setConfig({text_color:v})},
        {get:()=>config.primary_action_color||defaultConfig.primary_action_color,set:v=>window.elementSdk?.setConfig({primary_action_color:v})},
        {get:()=>config.secondary_text_color||defaultConfig.secondary_text_color,set:v=>window.elementSdk?.setConfig({secondary_text_color:v})},
      ],
      borderables:[],
      fontEditable:{get:()=>config.font_family||defaultConfig.font_family,set:v=>window.elementSdk?.setConfig({font_family:v})},
      fontSizeable:{get:()=>config.font_size||defaultConfig.font_size,set:v=>window.elementSdk?.setConfig({font_size:v})},
    };
  }
  function mapToEditPanelValues(config){
    return new Map([
      ["main_title", config.main_title || defaultConfig.main_title],
      ["description_text", config.description_text || defaultConfig.description_text],
      ["store_label", config.store_label || defaultConfig.store_label],
      ["amount_label", config.amount_label || defaultConfig.amount_label],
      ["date_label", config.date_label || defaultConfig.date_label],
      ["save_button_text", config.save_button_text || defaultConfig.save_button_text],
      ["back_button_text", config.back_button_text || defaultConfig.back_button_text],
      ["success_message", config.success_message || defaultConfig.success_message]
    ]);
  }

  async function init(){
    if (!supa) {
      console.error('Supabase-klient mangler');
      return;
    }
    // Auth guard (bruk samme "hjerne" som de andre sidene)
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/add-purchase.html') {
        // Ble redirectet til f.eks. /innlogging.html
        return;
      }
    }

    // Lytt p√• ekstern utlogging
    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    }

    // Sett dagens dato
    const dateInput = document.getElementById('dateInput');
    dateInput.value = isoToday();

    // Bygg kategori- og butikklister basert p√• Supabase
    await initCategorySelect();
    await initStoreSelect();

    // Last budsjett/spent for denne datoen
    await loadWeekDataFor(parseLocalDate(dateInput.value));

    // Lyttere
    document.getElementById('amountInput').addEventListener('input', () => { updateBudgetHint(); });
    document.getElementById('dateInput').addEventListener('change', () => { updateBudgetHint(); });
    document.getElementById('storeInput').addEventListener('change', () => {
      updateOtherStoreVisibility();
      const value = document.getElementById('storeInput').value;
      if (value && value !== OTHER_STORE_VALUE) {
        applyLastCategoryForStore(value);
      }
    });

    document.getElementById('purchaseForm').addEventListener('submit', handleSubmit);
    document.getElementById('backButton').addEventListener('click', () => {
      window.location.href = 'app.html';
    });

    // Element SDK
    if (window.elementSdk){
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }

    // Init UI
    updateBudgetHint();
    updateOtherStoreVisibility();
    setupCoach();

    // Start liten intro f√∏rste gang
    if (shouldStartCoachTour()) {
      setTimeout(() => {
        startCoachTour();
      }, 600);
    }
  }

  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
