<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Middagsanbefaling</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/budget-utils.js"></script>
  <style>
    /* ------ Base ------ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      color: #2d5f4d;
      overflow-x: hidden;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px; }

    /* ------ Header ------ */
    .header { margin-bottom: 24px; }
    .back-button {
      display: inline-flex; align-items: center; gap: 6px;
      background: none; border: none; color: #5a7a6d;
      font-size: 14px; cursor: pointer; padding: 8px 12px;
      border-radius: 12px; transition: background .2s; font-family: inherit;
    }
    .back-button:hover { background: rgba(76,175,80,.1); }
    .back-button:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .page-title { font-size: 32px; font-weight: 700; color: #2d5f4d; margin: 12px 0 8px; }
    .page-subtitle { font-size: 16px; color: #5a7a6d; }

    /* ------ Budget card ------ */
    .budget-card {
      background: #fff; border-radius: 20px; padding: 24px; margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(45,95,77,.08); display: flex; align-items: center; gap: 20px;
    }
    .budget-info { flex: 1; }
    .budget-label { font-size: 14px; color: #5a7a6d; margin-bottom: 8px; }
    .budget-amount { font-size: 28px; font-weight: 700; color: #4caf50; }
    .budget-progress { width: 80px; height: 80px; position: relative; }
    .progress-ring { width: 80px; height: 80px; transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: #f0f9f4; stroke-width: 8; }
    .progress-ring-fill { fill: none; stroke: #4caf50; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset .4s ease; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 12px; font-weight: 600; color: #2d5f4d; text-align: center; }

    /* ------ Filters ------ */
    .filter-panel { background: #fff; border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(45,95,77,.08); }
    .filter-title { font-size: 18px; font-weight: 600; color: #2d5f4d; margin-bottom: 20px; }
    .filter-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: end; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; }
    .filter-label { font-size: 14px; font-weight: 600; color: #2d5f4d; }

    .price-input {
      width: 140px; padding: 12px 16px; border: 1px solid rgba(76,175,80,.2);
      border-radius: 12px; font-size: 16px; color: #2d5f4d; background: #f8fffe; font-family: inherit;
    }
    .price-input:focus { outline: 2px solid #4caf50; border-color: #4caf50; }

    .stepper { display: flex; align-items: center; gap: 8px; background: #f8fffe; border-radius: 12px; padding: 4px; border: 1px solid rgba(76,175,80,.2); }
    .stepper-btn {
      width: 32px; height: 32px; border: none; background: #4caf50; color: #fff; border-radius: 8px;
      cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background .2s;
    }
    .stepper-btn:hover { background: #45a049; }
    .stepper-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .stepper-value { min-width: 40px; text-align: center; font-weight: 600; color: #2d5f4d; }

    .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 8px 16px; border: 2px solid rgba(76,175,80,.2); border-radius: 20px; background: #f8fffe; color: #2d5f4d;
      font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s; user-select: none;
    }
    .chip:hover { border-color: rgba(76,175,80,.4); }
    .chip.active { background: #4caf50; color: #fff; border-color: #4caf50; }
    .chip:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .toggle-chip { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px solid rgba(76,175,80,.2); border-radius: 20px; background: #f8fffe; color: #2d5f4d; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s; user-select: none; }
    .toggle-chip:hover { border-color: rgba(76,175,80,.4); }
    .toggle-chip.active { background: #4caf50; color: #fff; border-color: #4caf50; }

    .suggest-btn { padding: 14px 28px; background: #4caf50; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; }
    .suggest-btn:hover { background: #45a049; transform: translateY(-1px); }
    .suggest-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    /* ------ Tips ------ */
    .tip-card { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .tip-icon { font-size: 20px; }
    .tip-text { font-size: 14px; color: #856404; }

    /* ------ Results ------ */
    .results-section { margin-bottom: 24px; }
    .results-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 20px; }
    .recipe-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 20px; }
    .recipe-card { background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(45,95,77,.08); transition: all .2s; }
    .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(45,95,77,.12); }
    .recipe-image { width: 100%; height: 180px; background: linear-gradient(135deg,#e8f5e8 0%,#c8e6c9 100%); display: flex; align-items: center; justify-content: center; font-size: 48px; color: #4caf50; }
    .recipe-content { padding: 20px; }
    .recipe-name { font-size: 18px; font-weight: 600; color: #2d5f4d; margin-bottom: 12px; }
    .recipe-chips { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
    .recipe-chip { padding: 4px 8px; background: #f0f9f4; color: #2d5f4d; font-size: 12px; border-radius: 8px; font-weight: 500; }
    .recipe-chip.price { background: #4caf50; color: #fff; }
    .recipe-description { font-size: 14px; color: #5a7a6d; margin-bottom: 16px; line-height: 1.4; }
    .recipe-actions { display: flex; gap: 8px; }
    .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; flex: 1; }
    .btn-primary { background: #4caf50; color: #fff; }
    .btn-primary:hover { background: #45a049; }
    .btn-secondary { background: #f0f0f0; color: #5a7a6d; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    /* ------ Empty state ------ */
    .empty-state { text-align: center; padding: 40px 20px; background: #fff; border-radius: 20px; box-shadow: 0 2px 8px rgba(45,95,77,.08); }
    .empty-icon { font-size: 64px; color: #5a7a6d; margin-bottom: 16px; }
    .empty-title { font-size: 20px; font-weight: 600; color: #2d5f4d; margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: #5a7a6d; margin-bottom: 20px; }

    /* ------ Modal ------ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(45,95,77,.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 24px; padding: 28px; max-width: 600px; width: 100%; max-height: 90%; overflow-y: auto; box-shadow: 0 8px 32px rgba(45,95,77,.2); }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .modal-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 12px; }
    .modal-close { width: 32px; height: 32px; border: none; background: #f0f0f0; border-radius: 50%; cursor: pointer; font-size: 18px; color: #5a7a6d; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #e0e0e0; }
    .modal-close:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .modal-price { font-size: 20px; font-weight: 700; color: #4caf50; margin-bottom: 20px; }

    .accordion { border: 1px solid rgba(76,175,80,.2); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
    .accordion-header { padding: 16px 20px; background: #f8fffe; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2d5f4d; user-select: none; }
    .accordion-header:hover { background: #f0f9f4; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height .3s ease; }
    .accordion.open .accordion-content { max-height: 500px; }
    .accordion-body { padding: 20px; }

    .ingredient-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .ingredient-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
    .ingredient-checkbox { width: 18px; height: 18px; accent-color: #4caf50; }
    .ingredient-text { font-size: 14px; color: #2d5f4d; }

    .steps-list { list-style: none; display: flex; flex-direction: column; gap: 16px; }
    .step-item { display: flex; gap: 12px; }
    .step-number { width: 24px; height: 24px; background: #4caf50; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .step-text { font-size: 14px; color: #2d5f4d; line-height: 1.5; }
    .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
    .modal-note { font-size: 12px; color: #5a7a6d; margin-top: 8px; }

    /* ------ Toast ------ */
    .toast {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: #4caf50; color: #fff; padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.12); z-index: 1000; font-weight: 600;
    }

    /* ------ FAB ------ */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%;
      background: #4caf50; color: #fff; border: none; font-size: 24px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(76,175,80,.4); display: flex; align-items: center; justify-content: center; transition: all .2s; z-index: 50;
    }
    .fab:hover { background: #45a049; transform: scale(1.05); }
    .fab:focus { outline: 3px solid #4caf50; outline-offset: 3px; }

    /* ------ Responsive ------ */
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .page-title { font-size: 28px; }
      .budget-card { flex-direction: column; text-align: center; }
      .filter-row { flex-direction: column; align-items: stretch; }
      .price-input { width: 100%; }
      .recipe-grid { grid-template-columns: 1fr; }
      .fab { bottom: 16px; right: 16px; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-button" id="backBtn" aria-label="G√• tilbake">‚Üê Tilbake</button>
      <h1 class="page-title" id="pageTitle">Middagsanbefaling</h1>
      <p class="page-subtitle" id="pageSubtitle">F√• forslag som passer budsjettet ditt i dag.</p>
    </header>

    <section class="budget-card" aria-live="polite">
      <div class="budget-info">
        <div class="budget-label" id="budgetRemainingLabel">Budsjett igjen denne uka:</div>
        <div class="budget-amount" id="budgetAmount">‚Äì</div>
      </div>
      <div class="budget-progress">
        <svg class="progress-ring" viewBox="0 0 80 80" aria-hidden="true">
          <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
          <circle class="progress-ring-fill" cx="40" cy="40" r="32" id="progressRing"></circle>
        </svg>
        <div class="progress-text" id="progressText">‚Äì</div>
      </div>
    </section>

    <div id="tipCard" class="tip-card" style="display:none;">
      <span class="tip-icon">üí°</span>
      <span class="tip-text" id="tipText">Tips: Bytt til vegetar for lavere pris og spar mer denne uka!</span>
    </div>

    <section class="filter-panel">
      <h2 class="filter-title">Filtrer middager</h2>

      <div class="filter-row">
        <div class="filter-group">
          <label for="maxPrice" class="filter-label" id="maxPriceLabel">Maks kr pr. porsjon</label>
          <input type="number" id="maxPrice" class="price-input" value="70" min="10" max="200" inputmode="numeric" />
        </div>

        <div class="filter-group">
          <span class="filter-label" id="peopleCountLabel">Antall personer</span>
          <div class="stepper">
            <button class="stepper-btn" id="decrementPeople" aria-label="Reduser antall">‚àí</button>
            <span class="stepper-value" id="peopleCount">2</span>
            <button class="stepper-btn" id="incrementPeople" aria-label="√òk antall">+</button>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Kategori</span>
        <div class="chip-group" id="categoryChips">
          <div class="chip" data-category="kylling" tabindex="0" role="button">Kylling</div>
          <div class="chip" data-category="kj√∏ttdeig" tabindex="0" role="button">Kj√∏ttdeig</div>
          <div class="chip" data-category="fisk" tabindex="0" role="button">Fisk</div>
          <div class="chip" data-category="vegetar" tabindex="0" role="button">Vegetar</div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Allergivennlig</span>
        <div class="chip-group" id="allergyChips">
          <div class="chip" data-allergy="gluten" tabindex="0" role="button">Glutenfri</div>
          <div class="chip" data-allergy="laktose" tabindex="0" role="button">Laktosefri</div>
          <div class="chip" data-allergy="pean√∏tt" tabindex="0" role="button">N√∏ttefri</div>
        </div>
      </div>

      <div class="filter-row">
        <div class="toggle-chip" id="quickToggle" tabindex="0" role="button"><span>‚ö°</span><span>Rask (‚â§ 25 min)</span></div>
        <button class="suggest-btn" id="suggestBtn">Foresl√• middager</button>
      </div>
    </section>

    <section class="results-section" id="resultsSection" style="display:none;">
      <h2 class="results-title">Anbefalte middager</h2>
      <div class="recipe-grid" id="recipeGrid"></div>
    </section>

    <section class="empty-state" id="emptyState" style="display:none;">
      <div class="empty-icon">üçΩÔ∏è</div>
      <h3 class="empty-title">Ingen middager funnet</h3>
      <p class="empty-text">Pr√∏v √• justere filtrene dine for √• finne flere alternativer.</p>
      <button class="btn btn-primary" id="resetFiltersBtn">Nullstill filter</button>
    </section>
  </div>

  <button class="fab" id="randomFab" aria-label="Tilfeldig middag">üé≤</button>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="modalTitle">Oppskrift</h2>
          <div class="recipe-chips" id="modalChips"></div>
          <div class="modal-price" id="modalPrice">Pris for 2 personer: ‚Äì kr</div>
          <div class="modal-note">Fjern avkrysning p√• ingredienser du allerede har ‚Äì kun krysset blir lagt til i handlelista.</div>
        </div>
        <button class="modal-close" id="modalClose" aria-label="Lukk modal">√ó</button>
      </div>

      <div class="accordion" id="ingredientsAccordion">
        <div class="accordion-header"><span>Ingredienser</span><span>‚ñº</span></div>
        <div class="accordion-content">
          <div class="accordion-body">
            <ul class="ingredient-list" id="ingredientsList"></ul>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom:16px;color:#2d5f4d;font-weight:600;">Fremgangsm√•te</h3>
        <ol class="steps-list" id="stepsList"></ol>
      </div>

      <div class="modal-actions">
        <button class="btn btn-primary" id="addToShoppingBtn">Legg til i handlelista</button>
        <button class="btn btn-secondary" id="goToListBtn">√Öpne handlelista</button>
        <button class="btn btn-secondary" id="closeModalBtn">Lukk</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Konfig / theming (Element SDK)
       ========================= */
    const defaultConfig = {
      page_title: "Middagsanbefaling",
      page_subtitle: "F√• forslag som passer budsjettet ditt i dag.",
      budget_remaining_label: "Budsjett igjen denne uka",
      max_price_label: "Maks kr pr. porsjon",
      people_count_label: "Antall personer",
      suggest_button: "Foresl√• middager",
      background_color: "#f8fffe",
      primary_color: "#4caf50",
      text_color: "#2d5f4d",
      secondary_text_color: "#5a7a6d",
      surface_color: "#ffffff",
      font_family: "Inter",
      font_size: 16
    };

    function applyConfig(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
      document.body.style.background =
        `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, #f0f9f4 100%)`;

      const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

      setText('pageTitle', config.page_title || defaultConfig.page_title);
      setText('pageSubtitle', config.page_subtitle || defaultConfig.page_subtitle);
      setText('budgetRemainingLabel', (config.budget_remaining_label || defaultConfig.budget_remaining_label) + ':');
      setText('maxPriceLabel', config.max_price_label || defaultConfig.max_price_label);
      setText('peopleCountLabel', config.people_count_label || defaultConfig.people_count_label);

      const suggestBtn = document.getElementById('suggestBtn');
      if (suggestBtn) {
        suggestBtn.textContent = config.suggest_button || defaultConfig.suggest_button;
        suggestBtn.style.background = config.primary_color || defaultConfig.primary_color;
      }

      document.querySelectorAll('.stepper-btn, .fab, .btn-primary').forEach(el => {
        el.style.background = config.primary_color || defaultConfig.primary_color;
      });

      document.querySelectorAll('.budget-card, .filter-panel, .recipe-card, .modal').forEach(el => {
        el.style.background = config.surface_color || defaultConfig.surface_color;
      });

      const title = document.getElementById('pageTitle');
      if (title) title.style.fontSize = `${baseSize * 2}px`;
      const subtitle = document.getElementById('pageSubtitle');
      if (subtitle) subtitle.style.fontSize = `${baseSize}px`;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: applyConfig,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
            { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk.setConfig({ surface_color: v }) },
            { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk.setConfig({ text_color: v }) },
            { get: () => config.primary_color || defaultConfig.primary_color, set: v => window.elementSdk.setConfig({ primary_color: v }) },
            { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
          ],
          borderables: [],
          fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk.setConfig({ font_family: v }) },
          fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk.setConfig({ font_size: v }) }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["page_title", config.page_title || defaultConfig.page_title],
          ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
          ["budget_remaining_label", config.budget_remaining_label || defaultConfig.budget_remaining_label],
          ["max_price_label", config.max_price_label || defaultConfig.max_price_label],
          ["people_count_label", config.people_count_label || defaultConfig.people_count_label],
          ["suggest_button", config.suggest_button || defaultConfig.suggest_button],
        ])
      });
    }

    function formatKr(n) {
      const v = Number.isFinite(n) ? n : 0;
      return v.toLocaleString('no-NO');
    }

    /* =========================
       Mock oppskrifter
       ========================= */
    const mockRecipes = [
      { navn:"Kylling i form", prisPerM√•ltid:65, porsjoner:4, tidMin:45, vanskelighetsgrad:"Lett", kalorier:420, kategori:"kylling", allergener:["ingen"], bilde:"üçó",
        ingredienser:["4 kyllingfileter","2 paprika","1 l√∏k","400g poteter","2 ss olivenolje","Salt og pepper"],
        steg:["Forvarm ovnen til 200¬∞C","Skj√¶r poteter og gr√∏nnsaker i biter","Legg alt i ildfast form med olje og krydder","Stek i 35‚Äì40 minutter","Sjekk at kyllingen er gjennomstekt"] },
      { navn:"Kj√∏ttdeigpasta", prisPerM√•ltid:45, porsjoner:4, tidMin:20, vanskelighetsgrad:"Lett", kalorier:520, kategori:"kj√∏ttdeig", allergener:["gluten"], bilde:"üçù",
        ingredienser:["400g kj√∏ttdeig","400g pasta","1 boks hakkede tomater","1 l√∏k","2 fedd hvitl√∏k","Oregano"],
        steg:["Kok pasta","Stek l√∏k/hvitl√∏k","Tilsett kj√∏ttdeig","Hell i tomater/krydder 10 min","Bland med pasta"] },
      { navn:"Laks med ris", prisPerM√•ltid:85, porsjoner:2, tidMin:25, vanskelighetsgrad:"Lett", kalorier:450, kategori:"fisk", allergener:["ingen"], bilde:"üêü",
        ingredienser:["2 laksebiter","2 dl ris","1 brokkoli","1 sitron","2 ss sm√∏r","Salt og pepper"],
        steg:["Kok ris","Damp brokkoli 8‚Äì10 min","Stek laks i sm√∏r 3‚Äì4 min pr side","Krydre og server"] },
      { navn:"Vegetar chili", prisPerM√•ltid:35, porsjoner:6, tidMin:30, vanskelighetsgrad:"Lett", kalorier:320, kategori:"vegetar", allergener:["ingen"], bilde:"üå∂Ô∏è",
        ingredienser:["2 bokser kidneyb√∏nner","1 boks hakkede tomater","1 paprika","1 l√∏k","2 ss tomatpur√©","Chili og cumin"],
        steg:["Stek l√∏k/paprika","Tilsett tomatpur√© 1 min","Ha i tomater og b√∏nner","Krydre og putre 20 min"] },
      { navn:"Kyllingwok", prisPerM√•ltid:55, porsjoner:3, tidMin:15, vanskelighetsgrad:"Lett", kalorier:380, kategori:"kylling", allergener:["ingen"], bilde:"ü•ò",
        ingredienser:["300g kyllingstriper","1 pose wokgr√∏nnsaker","3 ss soyasaus","2 ss olje","1 ts ingef√¶r","Ris til servering"],
        steg:["Varm olje","Stek kylling gyllen","Wok gr√∏nnsaker 3‚Äì4 min","Tilsett kylling+saus","Server med ris"] },
      { navn:"Fiskekaker med potetmos", prisPerM√•ltid:50, porsjoner:4, tidMin:30, vanskelighetsgrad:"Lett", kalorier:420, kategori:"fisk", allergener:["gluten","egg"], bilde:"üê†",
        ingredienser:["8 fiskekaker","800g poteter","1 dl melk","2 ss sm√∏r","Ertestuing","Salt"],
        steg:["Kok poteter 20 min","Stek fiskekaker","Mos poteter med melk/sm√∏r","Varm ertestuing","Server"] },
      { navn:"Tacoskjell", prisPerM√•ltid:60, porsjoner:4, tidMin:20, vanskelighetsgrad:"Lett", kalorier:480, kategori:"kj√∏ttdeig", allergener:["gluten","laktose"], bilde:"üåÆ",
        ingredienser:["400g kj√∏ttdeig","1 pakke tacokrydder","8 tacoskjell","1 tomat","1 agurk","Ost og r√∏mme"],
        steg:["Stek kj√∏ttdeig","Tilsett krydder + litt vann","Varm tacoskjell","Kutt gr√∏nnsaker","Server"] },
      { navn:"Vegetar curry", prisPerM√•ltid:40, porsjoner:4, tidMin:35, vanskelighetsgrad:"Moderat", kalorier:350, kategori:"vegetar", allergener:["laktose"], bilde:"üçõ",
        ingredienser:["1 s√∏tpotet","1 aubergine","400ml kokosmelk","2 ss currypasta","1 l√∏k","Ris"],
        steg:["Kutt gr√∏nnsaker","Stek l√∏k","R√∏r inn currypasta","Tilsett kokosmelk/gr√∏nnsaker","La putre til m√∏rt","Server med ris"] },
      { navn:"Karbonadedeig", prisPerM√•ltid:48, porsjoner:4, tidMin:25, vanskelighetsgrad:"Lett", kalorier:460, kategori:"kj√∏ttdeig", allergener:["gluten","laktose"], bilde:"ü•©",
        ingredienser:["400g kj√∏ttdeig","2 ss mel","5 dl melk","1 l√∏k","Sm√∏r","Poteter"],
        steg:["Form karbonader","Stek karbonader","Stek l√∏k","Jevn saus med mel/melk","La putre 10 min"] },
      { navn:"Torsk med gr√∏nnsaker", prisPerM√•ltid:75, porsjoner:2, tidMin:20, vanskelighetsgrad:"Lett", kalorier:320, kategori:"fisk", allergener:["ingen"], bilde:"üêü",
        ingredienser:["2 torskebiter","300g brokkoli","2 gulr√∏tter","2 ss olivenolje","1 sitron","Timian"],
        steg:["Forvarm ovn 200¬∞C","Kutt gr√∏nnsaker","Legg alt p√• brett + olje/krydder","Stek 15‚Äì18 min"] },
    ];

    /* =========================
       State
       ========================= */
    const dateUtils = window.dateUtils || {};

    const state = {
      filters: {
        maxPrice: 70,
        people: 2,
        categories: [],
        allergies: [], // "gluten" => ekskluder oppskrifter som inneholder gluten
        quickOnly: false,
      },
      budget: { total: 0, used: 0, remaining: 0 },
      activeWeekISO: (dateUtils.getActiveWeekISO
        ? dateUtils.getActiveWeekISO()
        : (dateUtils.mondayISO ? dateUtils.mondayISO() : new Date().toISOString().slice(0, 10))),
      currentRecipe: null,
    };

    /* =========================
       Budsjett / purchases
       ========================= */
    function loadBudgetData() {
      const weekISO = state.activeWeekISO;
      const weeklyBudgetKey = `weeklyBudget_${weekISO}`;
      const purchasesKey = `purchases_${weekISO}`;

      const fallbackBudget = parseInt((localStorage.getItem('weeklyBudget') || '').replace(/\s|kr/g,''), 10);
      const weekBudget = parseInt((localStorage.getItem(weeklyBudgetKey) || '').replace(/\s|kr/g,''), 10);

      const total = Number.isFinite(weekBudget) ? weekBudget
                  : (Number.isFinite(fallbackBudget) ? fallbackBudget : 0);

      let used = 0;
      try {
        const raw = localStorage.getItem(purchasesKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            if (window.budgetUtils?.safeSumPurchases) {
              used = window.budgetUtils.safeSumPurchases(parsed);
            } else {
              used = parsed.reduce((sum, item) => sum + (Number(item?.amount) || 0), 0);
            }
          }
        }
      } catch {}

      const remaining = Math.max(0, total - used);
      state.budget = { total, used, remaining };
      updateBudgetDisplay();
    }

    function updateBudgetDisplay() {
      const { total, remaining } = state.budget;
      const budgetAmount = document.getElementById('budgetAmount');
      const progressRing = document.getElementById('progressRing');
      const progressText = document.getElementById('progressText');
      const tipCard = document.getElementById('tipCard');

      budgetAmount.textContent = `${formatKr(remaining)} kr`;

      const r = 32, circumference = 2 * Math.PI * r;
      const pct = total > 0 ? Math.max(0, Math.min(100, (remaining / total) * 100)) : 0;
      progressRing.style.strokeDasharray = `${circumference}`;
      progressRing.style.strokeDashoffset = `${circumference * (1 - pct/100)}`;
      progressText.innerHTML = `${Math.round(pct)}%<br>igjen`;

      let showTip = false, tip = '';
      if (pct <= 25) { showTip = true; tip = 'Tips: Velg vegetar/gryter for √• presse prisen ned resten av uka.'; }
      else if (pct <= 50) { showTip = true; tip = 'Tips: Planlegg 1‚Äì2 billige middager (‚â§ 40 kr/pers) for √• holde budsjettet.'; }
      document.getElementById('tipText').textContent = tip;
      tipCard.style.display = showTip ? 'flex' : 'none';
    }

    /* =========================
       Filtre & UI handling
       ========================= */
    function initPeopleFromHousehold() {
      const raw = (localStorage.getItem('householdCount') || '2').replace('+','');
      const n = Math.max(1, parseInt(raw, 10) || 2);
      state.filters.people = n;
      document.getElementById('peopleCount').textContent = String(n);
    }

    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    function setupFilters() {
      const categoryChips = document.getElementById('categoryChips');
      const allergyChips  = document.getElementById('allergyChips');
      const quickToggle   = document.getElementById('quickToggle');
      const maxPriceInput = document.getElementById('maxPrice');
      const decBtn = document.getElementById('decrementPeople');
      const incBtn = document.getElementById('incrementPeople');
      const peopleCount = document.getElementById('peopleCount');

      categoryChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-category]');
        if (!chip) return;
        const cat = chip.dataset.category;
        chip.classList.toggle('active');
        const i = state.filters.categories.indexOf(cat);
        if (i >= 0) state.filters.categories.splice(i,1); else state.filters.categories.push(cat);
      });

      allergyChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-allergy]');
        if (!chip) return;
        const a = chip.dataset.allergy;
        chip.classList.toggle('active');
        const i = state.filters.allergies.indexOf(a);
        if (i >= 0) state.filters.allergies.splice(i,1); else state.filters.allergies.push(a);
      });

      quickToggle.addEventListener('click', () => {
        quickToggle.classList.toggle('active');
        state.filters.quickOnly = !state.filters.quickOnly;
      });

      maxPriceInput.addEventListener('input', (e) => {
        const v = clamp(parseInt(e.target.value,10) || 70, 10, 200);
        state.filters.maxPrice = v;
        e.target.value = String(v);
      });

      decBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people - 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
      });
      incBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people + 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
      });

      document.addEventListener('keydown', (e) => {
        const target = e.target;
        const isChip = target.classList && target.classList.contains('chip');
        const isToggle = target.id === 'quickToggle';
        if ((isChip || isToggle) && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault(); target.click();
        }
      });
    }

    function filterRecipes() {
      const selCats = state.filters.categories;
      const selAllergies = state.filters.allergies;
      const maxPrice = state.filters.maxPrice;
      const quick = state.filters.quickOnly;

      return mockRecipes.filter(r => {
        if (r.prisPerM√•ltid > maxPrice) return false;
        if (selCats.length && !selCats.includes(r.kategori)) return false;
        if (quick && r.tidMin > 25) return false;
        if (selAllergies.length) {
          if (!r.allergener.includes('ingen')) {
            if (selAllergies.some(a => r.allergener.includes(a))) return false;
          }
        }
        return true;
      });
    }

    function createRecipeCard(recipe) {
      const card = document.createElement('div');
      card.className = 'recipe-card';

      card.innerHTML = `
        <div class="recipe-image">${recipe.bilde}</div>
        <div class="recipe-content">
          <h3 class="recipe-name">${recipe.navn}</h3>
          <div class="recipe-chips">
            <span class="recipe-chip price">${recipe.prisPerM√•ltid} kr/pers</span>
            <span class="recipe-chip">${recipe.tidMin} min</span>
            <span class="recipe-chip">${recipe.vanskelighetsgrad}</span>
            <span class="recipe-chip">${recipe.kalorier} kcal</span>
          </div>
          <p class="recipe-description">
            ${recipe.kategori.charAt(0).toUpperCase() + recipe.kategori.slice(1)}rett som passer perfekt til
            ${state.filters.people} ${state.filters.people === 1 ? 'person' : 'personer'}.
          </p>
          <div class="recipe-actions">
            <button class="btn btn-primary" data-action="open" data-name="${recipe.navn}">Se oppskrift</button>
            <button class="btn btn-secondary" data-action="resuggest">Ny anbefaling</button>
          </div>
        </div>
      `;
      return card;
    }

    function displayRecipes(recipes) {
      const resultsSection = document.getElementById('resultsSection');
      const recipeGrid = document.getElementById('recipeGrid');
      const emptyState = document.getElementById('emptyState');

      if (!recipes.length) {
        resultsSection.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      resultsSection.style.display = 'block';

      recipeGrid.innerHTML = '';
      recipes
        .slice()
        .sort((a,b) => (a.prisPerM√•ltid - b.prisPerM√•ltid) || (a.tidMin - b.tidMin))
        .slice(0, 5)
        .forEach(r => recipeGrid.appendChild(createRecipeCard(r)));
    }

    /* =========================
       Modal & handleliste
       ========================= */
    function openRecipeModalByName(name) {
      const recipe = mockRecipes.find(r => r.navn === name);
      if (!recipe) return;

      state.currentRecipe = recipe;

      const modal = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalChips = document.getElementById('modalChips');
      const modalPrice = document.getElementById('modalPrice');
      const ingredientsList = document.getElementById('ingredientsList');
      const stepsList = document.getElementById('stepsList');

      modalTitle.textContent = recipe.navn;
      modalChips.innerHTML = `
        <span class="recipe-chip price">${recipe.prisPerM√•ltid} kr/pers</span>
        <span class="recipe-chip">${recipe.tidMin} min</span>
        <span class="recipe-chip">${recipe.vanskelighetsgrad}</span>
        <span class="recipe-chip">${recipe.kalorier} kcal</span>
      `;

      const totalPrice = recipe.prisPerM√•ltid * state.filters.people;
      modalPrice.textContent = `Pris for ${state.filters.people} ${state.filters.people === 1 ? 'person' : 'personer'}: ${formatKr(totalPrice)} kr`;

      ingredientsList.innerHTML = '';
      recipe.ingredienser.forEach(ing => {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        li.innerHTML = `
          <input type="checkbox" class="ingredient-checkbox" checked aria-label="Merk ${ing}">
          <span class="ingredient-text">${ing}</span>
        `;
        ingredientsList.appendChild(li);
      });

      stepsList.innerHTML = '';
      recipe.steg.forEach((step, i) => {
        const li = document.createElement('li');
        li.className = 'step-item';
        li.innerHTML = `<div class="step-number">${i+1}</div><div class="step-text">${step}</div>`;
        stepsList.appendChild(li);
      });

      modal.classList.add('open');
      document.getElementById('modalClose').focus();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
      state.currentRecipe = null;
    }

    function showToast(text) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = text;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    // Legg valgte (krysset av) ingredienser i INBOX for aktiv uke ‚Äì samme n√∏kkel som handleliste.html forventer
    function addCurrentRecipeToShoppingList() {
      const recipe = state.currentRecipe;
      if (!recipe) return;

      const weekISO = state.activeWeekISO;
      const inboxKey = `shoppingList_inbox_${weekISO}`;

      let inbox = [];
      try {
        const raw = localStorage.getItem(inboxKey);
        if (raw) inbox = JSON.parse(raw);
        if (!Array.isArray(inbox)) inbox = [];
      } catch { inbox = []; }

      // hvilke ingredienser er valgt?
      const chosen = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item'))
        .filter(li => li.querySelector('.ingredient-checkbox')?.checked)
        .map(li => li.querySelector('.ingredient-text')?.textContent?.trim())
        .filter(Boolean);

      if (!chosen.length) {
        showToast('Ingen ingredienser valgt.');
        return;
      }

      // unng√• duplikater (case-insensitive p√• streng)
      const existing = new Set(inbox.map(x => String(x || '').trim().toLowerCase()));
      let added = 0;
      chosen.forEach(ing => {
        const key = ing.toLowerCase();
        if (!existing.has(key)) {
          inbox.push(ing);
          existing.add(key);
          added++;
        }
      });

      localStorage.setItem(inboxKey, JSON.stringify(inbox));

      const btn = document.getElementById('addToShoppingBtn');
      const old = btn.textContent;
      btn.textContent = added > 0 ? `Lagt til ${added}` : 'Alt fantes fra f√∏r';
      btn.disabled = true;
      setTimeout(() => { btn.textContent = old; btn.disabled = false; }, 1200);

      showToast(added > 0 ? `La til ${added} varer i handleliste` : 'Ingen nye varer lagt til');
    }

    /* =========================
       Navigasjon / events
       ========================= */
    document.getElementById('backBtn').addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = 'app.html';
    });

    document.getElementById('suggestBtn').addEventListener('click', () => {
      const filtered = filterRecipes();
      displayRecipes(filtered);
    });

    document.getElementById('randomFab').addEventListener('click', () => {
      const filtered = filterRecipes();
      if (!filtered.length) return;
      const r = filtered[Math.floor(Math.random() * filtered.length)];
      openRecipeModalByName(r.navn);
    });

    document.getElementById('resetFiltersBtn').addEventListener('click', () => {
      state.filters = { maxPrice: 70, people: 2, categories: [], allergies: [], quickOnly: false };
      document.getElementById('maxPrice').value = '70';
      document.getElementById('peopleCount').textContent = '2';
      document.querySelectorAll('.chip.active').forEach(chip => chip.classList.remove('active'));
      document.getElementById('quickToggle').classList.remove('active');
      displayRecipes(filterRecipes());
    });

    // Modal
    document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('addToShoppingBtn').addEventListener('click', addCurrentRecipeToShoppingList);

    // √Öpne handleliste med toast-parameter (brukes av handleliste.html for √• vise "la til X varer fra ‚Ä¶")
    document.getElementById('goToListBtn').addEventListener('click', () => {
      const name = encodeURIComponent(state.currentRecipe?.navn || 'oppskrift');
      location.href = `handleliste.html?added=${name}`;
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    // Accordion
    document.getElementById('ingredientsAccordion').addEventListener('click', (e) => {
      if (e.target.closest('.accordion-header')) e.currentTarget.classList.toggle('open');
    });

    // Delegert klikk for kort-knapper
    document.getElementById('recipeGrid').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === 'open') openRecipeModalByName(btn.dataset.name);
      if (action === 'resuggest') displayRecipes(filterRecipes().sort(() => 0.5 - Math.random()).slice(0, 5));
    });

    /* =========================
       Init
       ========================= */
    initPeopleFromHousehold();
    loadBudgetData();
    setupFilters();
    displayRecipes(filterRecipes());
    applyConfig(defaultConfig);
  </script>

  <!-- (Canva/Cloudflare-snutt beholdt ur√∏rt) -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99bfd0691443b4f7',t:'MTc2MjcxNzU2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
