<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Middagsanbefaling</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    /* ------ Base ------ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      color: #2d5f4d;
      overflow-x: hidden;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px; }

    /* ------ Header ------ */
    .header { margin-bottom: 24px; }
    .back-button {
      display: inline-flex; align-items: center; gap: 6px;
      background: none; border: none; color: #5a7a6d;
      font-size: 14px; cursor: pointer; padding: 8px 12px;
      border-radius: 12px; transition: background .2s; font-family: inherit;
    }
    .back-button:hover { background: rgba(76,175,80,.1); }
    .back-button:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .page-title { font-size: 32px; font-weight: 700; color: #2d5f4d; margin: 12px 0 8px; }
    .page-subtitle { font-size: 16px; color: #5a7a6d; }

    /* ------ Budget card ------ */
    .budget-card {
      background: #fff; border-radius: 20px; padding: 24px; margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(45,95,77,.08); display: flex; align-items: center; gap: 20px;
    }
    .budget-info { flex: 1; }
    .budget-label { font-size: 14px; color: #5a7a6d; margin-bottom: 8px; }
    .budget-amount { font-size: 28px; font-weight: 700; color: #4caf50; }
    .budget-progress { width: 80px; height: 80px; position: relative; }
    .progress-ring { width: 80px; height: 80px; transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: #f0f9f4; stroke-width: 8; }
    .progress-ring-fill { fill: none; stroke: #4caf50; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset .4s ease; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 12px; font-weight: 600; color: #2d5f4d; text-align: center; }

    /* ------ Filters ------ */
    .filter-panel { background: #fff; border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(45,95,77,.08); }
    .filter-title { font-size: 18px; font-weight: 600; color: #2d5f4d; margin-bottom: 20px; }
    .filter-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: end; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; }
    .filter-label { font-size: 14px; font-weight: 600; color: #2d5f4d; }

    .price-input {
      width: 140px; padding: 12px 16px; border: 1px solid rgba(76,175,80,.2);
      border-radius: 12px; font-size: 16px; color: #2d5f4d; background: #f8fffe; font-family: inherit;
    }
    .price-input:focus { outline: 2px solid #4caf50; border-color: #4caf50; }

    .stepper { display: flex; align-items: center; gap: 8px; background: #f8fffe; border-radius: 12px; padding: 4px; border: 1px solid rgba(76,175,80,.2); }
    .stepper-btn {
      width: 32px; height: 32px; border: none; background: #4caf50; color: #fff; border-radius: 8px;
      cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background .2s;
    }
    .stepper-btn:hover { background: #45a049; }
    .stepper-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .stepper-value { min-width: 40px; text-align: center; font-weight: 600; color: #2d5f4d; }

    .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 8px 16px; border: 2px solid rgba(76,175,80,.2); border-radius: 20px; background: #f8fffe; color: #2d5f4d;
      font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s; user-select: none;
    }
    .chip:hover { border-color: rgba(76,175,80,.4); }
    .chip.active { background: #4caf50; color: #fff; border-color: #4caf50; }
    .chip:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .toggle-chip { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px solid rgba(76,175,80,.2); border-radius: 20px; background: #f8fffe; color: #2d5f4d; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s; user-select: none; }
    .toggle-chip:hover { border-color: rgba(76,175,80,.4); }
    .toggle-chip.active { background: #4caf50; color: #fff; border-color: #4caf50; }

    .suggest-btn { padding: 14px 28px; background: #4caf50; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; }
    .suggest-btn:hover { background: #45a049; transform: translateY(-1px); }
    .suggest-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    /* ------ Tips ------ */
    .tip-card { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .tip-icon { font-size: 20px; }
    .tip-text { font-size: 14px; color: #856404; }

    /* ------ Results ------ */
    .results-section { margin-bottom: 24px; }
    .results-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 20px; }
    .recipe-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 20px; }
    .recipe-card { background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(45,95,77,.08); transition: all .2s; }
    .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(45,95,77,.12); }
    .recipe-image { width: 100%; height: 180px; background: linear-gradient(135deg,#e8f5e8 0%,#c8e6c9 100%); display: flex; align-items: center; justify-content: center; font-size: 48px; color: #4caf50; }
    .recipe-content { padding: 20px; }
    .recipe-name { font-size: 18px; font-weight: 600; color: #2d5f4d; margin-bottom: 12px; }
    .recipe-chips { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
    .recipe-chip { padding: 4px 8px; background: #f0f9f4; color: #2d5f4d; font-size: 12px; border-radius: 8px; font-weight: 500; }
    .recipe-chip.price { background: #4caf50; color: #fff; }
    .recipe-description { font-size: 14px; color: #5a7a6d; margin-bottom: 16px; line-height: 1.4; }
    .recipe-actions { display: flex; gap: 8px; }
    .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; flex: 1; }
    .btn-primary { background: #4caf50; color: #fff; }
    .btn-primary:hover { background: #45a049; }
    .btn-secondary { background: #f0f0f0; color: #5a7a6d; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    /* ------ Empty state ------ */
    .empty-state { text-align: center; padding: 40px 20px; background: #fff; border-radius: 20px; box-shadow: 0 2px 8px rgba(45,95,77,.08); }
    .empty-icon { font-size: 64px; color: #5a7a6d; margin-bottom: 16px; }
    .empty-title { font-size: 20px; font-weight: 600; color: #2d5f4d; margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: #5a7a6d; margin-bottom: 20px; }

    /* ------ Modal ------ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(45,95,77,.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 24px; padding: 28px; max-width: 600px; width: 100%; max-height: 90%; overflow-y: auto; box-shadow: 0 8px 32px rgba(45,95,77,.2); }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .modal-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 12px; }
    .modal-close { width: 32px; height: 32px; border: none; background: #f0f0f0; border-radius: 50%; cursor: pointer; font-size: 18px; color: #5a7a6d; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #e0e0e0; }
    .modal-close:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .modal-price { font-size: 20px; font-weight: 700; color: #4caf50; margin-bottom: 8px; }
    .modal-subprice { font-size: 12px; color:#5a7a6d; margin-bottom: 20px; }

    .accordion { border: 1px solid rgba(76,175,80,.2); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
    .accordion-header { padding: 16px 20px; background: #f8fffe; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2d5f4d; user-select: none; }
    .accordion-header:hover { background: #f0f9f4; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height .3s ease; }
    .accordion.open .accordion-content { max-height: 500px; }
    .accordion-body { padding: 20px; }

    .ingredient-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .ingredient-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; justify-content: space-between; }
    .ingredient-left { display:flex; align-items:center; gap:12px; }
    .ingredient-checkbox { width: 18px; height: 18px; accent-color: #4caf50; }
    .ingredient-text { font-size: 14px; color: #2d5f4d; }
    .ingredient-price { font-size: 13px; color:#2d5f4d; font-weight:600; }
    .ingredient-sub { font-size: 12px; color:#5a7a6d; }

    .steps-list { list-style: none; display: flex; flex-direction: column; gap: 16px; }
    .step-item { display: flex; gap: 12px; }
    .step-number { width: 24px; height: 24px; background: #4caf50; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .step-text { font-size: 14px; color: #2d5f4d; line-height: 1.5; }
    .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
    .modal-note { font-size: 12px; color: #5a7a6d; margin-top: 8px; }

    /* ------ Toast ------ */
    .toast {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: #4caf50; color: #fff; padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.12); z-index: 1000; font-weight: 600;
    }

    /* ------ FAB ------ */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%;
      background: #4caf50; color: #fff; border: none; font-size: 24px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(76,175,80,.4); display: flex; align-items: center; justify-content: center; transition: all .2s; z-index: 50;
    }
    .fab:hover { background: #45a049; transform: scale(1.05); }
    .fab:focus { outline: 3px solid #4caf50; outline-offset: 3px; }

    /* ------ Responsive ------ */
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .page-title { font-size: 28px; }
      .budget-card { flex-direction: column; text-align: center; }
      .filter-row { flex-direction: column; align-items: stretch; }
      .price-input { width: 100%; }
      .recipe-grid { grid-template-columns: 1fr; }
      .fab { bottom: 16px; right: 16px; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-button" id="backBtn" aria-label="G√• tilbake">‚Üê Tilbake</button>
      <h1 class="page-title" id="pageTitle">Middagsanbefaling</h1>
      <p class="page-subtitle" id="pageSubtitle">F√• forslag som passer budsjettet ditt i dag.</p>
    </header>

    <section class="budget-card" aria-live="polite">
      <div class="budget-info">
        <div class="budget-label" id="budgetRemainingLabel">Budsjett igjen denne uka:</div>
        <div class="budget-amount" id="budgetAmount">‚Äì</div>
      </div>
      <div class="budget-progress">
        <svg class="progress-ring" viewBox="0 0 80 80" aria-hidden="true">
          <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
          <circle class="progress-ring-fill" cx="40" cy="40" r="32" id="progressRing"></circle>
        </svg>
        <div class="progress-text" id="progressText">‚Äì</div>
      </div>
    </section>

    <div id="tipCard" class="tip-card" style="display:none;">
      <span class="tip-icon">üí°</span>
      <span class="tip-text" id="tipText">Tips: Bytt til vegetar for lavere pris og spar mer denne uka!</span>
    </div>

    <section class="filter-panel">
      <h2 class="filter-title">Filtrer middager</h2>

      <div class="filter-row">
        <div class="filter-group">
          <label for="maxPrice" class="filter-label" id="maxPriceLabel">Maks kr pr. porsjon</label>
          <input type="number" id="maxPrice" class="price-input" value="70" min="10" max="200" inputmode="numeric" />
        </div>

        <div class="filter-group">
          <span class="filter-label" id="peopleCountLabel">Antall personer</span>
          <div class="stepper">
            <button class="stepper-btn" id="decrementPeople" aria-label="Reduser antall">‚àí</button>
            <span class="stepper-value" id="peopleCount">2</span>
            <button class="stepper-btn" id="incrementPeople" aria-label="√òk antall">+</button>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Kategori</span>
        <div class="chip-group" id="categoryChips">
          <div class="chip" data-category="kylling" tabindex="0" role="button">Kylling</div>
          <div class="chip" data-category="kj√∏ttdeig" tabindex="0" role="button">Kj√∏ttdeig</div>
          <div class="chip" data-category="fisk" tabindex="0" role="button">Fisk</div>
          <div class="chip" data-category="vegetar" tabindex="0" role="button">Vegetar</div>
        </div>
      </div>

      <div class="filter-group">
        <span class="filter-label">Allergivennlig</span>
        <div class="chip-group" id="allergyChips">
          <div class="chip" data-allergy="gluten" tabindex="0" role="button">Glutenfri</div>
          <div class="chip" data-allergy="laktose" tabindex="0" role="button">Laktosefri</div>
          <div class="chip" data-allergy="pean√∏tt" tabindex="0" role="button">N√∏ttefri</div>
        </div>
      </div>

      <div class="filter-row">
        <div class="toggle-chip" id="quickToggle" tabindex="0" role="button"><span>‚ö°</span><span>Rask (‚â§ 25 min)</span></div>
        <button class="suggest-btn" id="suggestBtn">Foresl√• middager</button>
      </div>
    </section>

    <section class="results-section" id="resultsSection" style="display:none;">
      <h2 class="results-title">Anbefalte middager</h2>
      <div class="recipe-grid" id="recipeGrid"></div>
    </section>

    <section class="empty-state" id="emptyState" style="display:none;">
      <div class="empty-icon">üçΩÔ∏è</div>
      <h3 class="empty-title">Ingen middager funnet</h3>
      <p class="empty-text">Pr√∏v √• justere filtrene dine for √• finne flere alternativer.</p>
      <button class="btn btn-primary" id="resetFiltersBtn">Nullstill filter</button>
    </section>
  </div>

  <button class="fab" id="randomFab" aria-label="Tilfeldig middag">üé≤</button>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="modalTitle">Oppskrift</h2>
          <div class="recipe-chips" id="modalChips"></div>
          <div class="modal-price" id="modalPrice">Total du m√• betale: ‚Äì</div>
          <div class="modal-subprice" id="modalSubPrice">Brukt verdi: ‚Äì ‚Ä¢ Rester verdi: ‚Äì</div>
          <div class="modal-note">Fjern avkrysning p√• ingredienser du allerede har ‚Äì kun krysset blir lagt til i handlelista.</div>
        </div>
        <button class="modal-close" id="modalClose" aria-label="Lukk modal">√ó</button>
      </div>

      <div class="accordion" id="ingredientsAccordion">
        <div class="accordion-header"><span>Ingredienser</span><span>‚ñº</span></div>
        <div class="accordion-content">
          <div class="accordion-body">
            <ul class="ingredient-list" id="ingredientsList"></ul>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom:16px;color:#2d5f4d;font-weight:600;">Fremgangsm√•te</h3>
        <ol class="steps-list" id="stepsList"></ol>
      </div>

      <div class="modal-actions">
        <button class="btn btn-primary" id="addToShoppingBtn">Legg til i handlelista</button>
        <button class="btn btn-secondary" id="goToListBtn">√Öpne handlelista</button>
        <button class="btn btn-secondary" id="closeModalBtn">Lukk</button>
      </div>
    </div>
  </div>

  <!-- Datasett -->
  <script type="application/json" id="mealData">
  {
    "meta": {
      "currency": "NOK",
      "locale": "no-NO",
      "retailers_considered": ["Kiwi", "REMA 1000", "Extra/Coop"],
      "collected_at_iso": "2025-11-10",
      "notes": "Priser fra norske kjeder per nov. 2025."
    },
    "recipes": [
      {
        "id": "kyllingwok-ris-kylling",
        "navn": "Kyllingwok med ris",
        "kategori": "kylling",
        "porsjoner": 4,
        "tidMin": 20,
        "vanskelighetsgrad": "Lett",
        "kalorierPerPorsjon": 480,
        "allergener": ["soya"],
        "allergiFlags": { "gluten": false, "laktose": false, "pean√∏tt": false },
        "ingredienser": [
          {"navn":"Kyllingfilet","kategoriHandleliste":"Matvarer","enhet":"g","mengde_brukt":500,"pakke_st√∏rrelse":700,"enhetspris_per":"kg","enhetspris_nok":139.0,"pakkepris_nok":97.3,"kostnad_brukt_nok":69.5,"kilde":"https://etilbudsavis.no/soek/kylling","kilde_dato_iso":"2025-11-10"},
          {"navn":"Basmatiris","kategoriHandleliste":"Matvarer","enhet":"g","mengde_brukt":200,"pakke_st√∏rrelse":1000,"enhetspris_per":"kg","enhetspris_nok":30.0,"pakkepris_nok":30.0,"kostnad_brukt_nok":6.0,"kilde":"https://eldorado.no/varer/basmatiris-7035620003882","kilde_dato_iso":"2025-11-10"},
          {"navn":"R√∏d paprika","kategoriHandleliste":"Matvarer","enhet":"stk","mengde_brukt":2,"pakke_st√∏rrelse":3,"enhetspris_per":"stk","enhetspris_nok":6.63,"pakkepris_nok":19.90,"kostnad_brukt_nok":13.26,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10","merknad":"Typisk 3-pk paprika"},
          {"navn":"Gulrot","kategoriHandleliste":"Matvarer","enhet":"g","mengde_brukt":200,"pakke_st√∏rrelse":750,"enhetspris_per":"kg","enhetspris_nok":33.20,"pakkepris_nok":24.90,"kostnad_brukt_nok":6.64,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10"},
          {"navn":"Brokkoli","kategoriHandleliste":"Matvarer","enhet":"stk","mengde_brukt":1,"pakke_st√∏rrelse":1,"enhetspris_per":"stk","enhetspris_nok":19.90,"pakkepris_nok":19.90,"kostnad_brukt_nok":19.90,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10"},
          {"navn":"Minimais (hermetisk)","kategoriHandleliste":"Matvarer","enhet":"boks","mengde_brukt":1,"pakke_st√∏rrelse":1,"enhetspris_per":"stk","enhetspris_nok":14.90,"pakkepris_nok":14.90,"kostnad_brukt_nok":14.90,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10"},
          {"navn":"Solsikkeolje","kategoriHandleliste":"Matvarer","enhet":"ss","mengde_brukt":2,"pakke_st√∏rrelse":1000,"enhetspris_per":"l","enhetspris_nok":30.0,"pakkepris_nok":30.0,"kostnad_brukt_nok":0.90,"kilde":"https://kiwi.no/dagligvarer/prislaas","kilde_dato_iso":"2025-11-10","merknad":"‚âà15 ml totalt"},
          {"navn":"Hvitl√∏k","kategoriHandleliste":"Matvarer","enhet":"fedd","mengde_brukt":2,"pakke_st√∏rrelse":1,"enhetspris_per":"stk","enhetspris_nok":4.0,"pakkepris_nok":4.0,"kostnad_brukt_nok":0.80,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10"},
          {"navn":"Soyasaus","kategoriHandleliste":"Matvarer","enhet":"ss","mengde_brukt":2,"pakke_st√∏rrelse":150,"enhetspris_per":"l","enhetspris_nok":60.0,"pakkepris_nok":9.0,"kostnad_brukt_nok":1.80,"kilde":"https://kiwi.no/dagligvarer/","kilde_dato_iso":"2025-11-10","merknad":"‚âà30 ml brukt"}
        ],
        "pris_total_nok": 122.90,
        "pris_per_porsjon_nok": 30.73,
        "steg": [
          "Kok basmatiris etter anvisning.",
          "Skj√¶r kylling i strimler, paprika i strimler, del brokkoli i sm√• buketter.",
          "Varm olje i wok, stek kylling p√• h√∏y varme til gjennomstekt.",
          "Tilsett gr√∏nnsaker, hvitl√∏k og minimais. Wok 3‚Äì4 min.",
          "Vend inn soyasaus, smak til med salt/pepper. Server med ris."
        ]
      }
    ]
  }
  </script>

  <script>
    /* =========================
       Konfig / theming (Element SDK)
       ========================= */
    const defaultConfig = {
      page_title: "Middagsanbefaling",
      page_subtitle: "F√• forslag som passer budsjettet ditt i dag.",
      budget_remaining_label: "Budsjett igjen denne uka",
      max_price_label: "Maks kr pr. porsjon",
      people_count_label: "Antall personer",
      suggest_button: "Foresl√• middager",
      background_color: "#f8fffe",
      primary_color: "#4caf50",
      text_color: "#2d5f4d",
      secondary_text_color: "#5a7a6d",
      surface_color: "#ffffff",
      font_family: "Inter",
      font_size: 16
    };

    function applyConfig(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
      document.body.style.background =
        `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, #f0f9f4 100%)`;

      const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

      setText('pageTitle', config.page_title || defaultConfig.page_title);
      setText('pageSubtitle', config.page_subtitle || defaultConfig.page_subtitle);
      setText('budgetRemainingLabel', config.budget_remaining_label || defaultConfig.budget_remaining_label);
      setText('maxPriceLabel', config.max_price_label || defaultConfig.max_price_label);
      setText('peopleCountLabel', config.people_count_label || defaultConfig.people_count_label);

      const suggestBtn = document.getElementById('suggestBtn');
      if (suggestBtn) {
        suggestBtn.textContent = config.suggest_button || defaultConfig.suggest_button;
        suggestBtn.style.background = config.primary_color || defaultConfig.primary_color;
      }

      document.querySelectorAll('.stepper-btn, .fab, .btn-primary').forEach(el => {
        el.style.background = config.primary_color || defaultConfig.primary_color;
      });

      document.querySelectorAll('.budget-card, .filter-panel, .recipe-card, .modal').forEach(el => {
        el.style.background = config.surface_color || defaultConfig.surface_color;
      });

      const title = document.getElementById('pageTitle');
      if (title) title.style.fontSize = `${baseSize * 2}px`;
      const subtitle = document.getElementById('pageSubtitle');
      if (subtitle) subtitle.style.fontSize = `${baseSize}px`;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: applyConfig,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
            { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk.setConfig({ surface_color: v }) },
            { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk.setConfig({ text_color: v }) },
            { get: () => config.primary_color || defaultConfig.primary_color, set: v => window.elementSdk.setConfig({ primary_color: v }) },
            { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
          ],
          borderables: [],
          fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk.setConfig({ font_family: v }) },
          fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk.setConfig({ font_size: v }) }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["page_title", config.page_title || defaultConfig.page_title],
          ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
          ["budget_remaining_label", config.budget_remaining_label || defaultConfig.budget_remaining_label],
          ["max_price_label", config.max_price_label || defaultConfig.max_price_label],
          ["people_count_label", config.people_count_label || defaultConfig.people_count_label],
          ["suggest_button", config.suggest_button || defaultConfig.suggest_button],
        ])
      });
    }

    /* =========================
       Uke-/budsjett-n√∏kler
       ========================= */
    function getCurrentWeekMondayISO(dateObj = new Date()) {
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
      const day = (d.getDay() + 6) % 7; // 0 = mandag
      d.setDate(d.getDate() - day);
      d.setHours(12, 0, 0, 0); // DST-safe
      return d.toISOString().slice(0, 10);
    }
    function getActiveWeekISO() {
      return localStorage.getItem('activeWeekISO') || getCurrentWeekMondayISO();
    }
    function formatKr(n) {
      const v = Number.isFinite(n) ? n : 0;
      return v.toLocaleString('no-NO', {minimumFractionDigits:0, maximumFractionDigits:2});
    }

    /* =========================
       Les datasett
       ========================= */
    const RAW = document.getElementById('mealData')?.textContent || '{"recipes": []}';
    let DATA = { recipes: [] };
    try { DATA = JSON.parse(RAW); } catch(e) { console.warn('Ugyldig mealData JSON', e); }
    const RECIPES = Array.isArray(DATA.recipes) ? DATA.recipes : [];

    /* =========================
       State
       ========================= */
    const state = {
      filters: { maxPrice: 70, people: 2, categories: [], allergies: [], quickOnly: false },
      budget: { total: 0, used: 0, remaining: 0 },
      activeWeekISO: getActiveWeekISO(),
      currentRecipeId: null,
    };

    /* =========================
       Budsjett / purchases
       ========================= */
    function safeSumPurchases(arr) {
      try {
        return arr.reduce((sum, p) => {
          if (!p) return sum;
          const v = typeof p === 'object' ? (p.amount ?? p.sum ?? p.price ?? p.value ?? p.kostnad) : p;
          if (typeof v === 'number' && isFinite(v)) return sum + v;
          if (typeof v === 'string') {
            const n = parseFloat(v.replace(/[^\d.,-]/g,'').replace(',','.'));
            if (isFinite(n)) return sum + n;
          }
          return sum;
        }, 0);
      } catch { return 0; }
    }

    function loadBudgetData() {
      const weekISO = state.activeWeekISO;
      const weeklyBudgetKey = `weeklyBudget_${weekISO}`;
      const purchasesKey = `purchases_${weekISO}`;

      const fallbackBudget = parseInt((localStorage.getItem('weeklyBudget') || '').replace(/\s|kr/g,''), 10);
      const weekBudget = parseInt((localStorage.getItem(weeklyBudgetKey) || '').replace(/\s|kr/g,''), 10);

      const total = Number.isFinite(weekBudget) ? weekBudget
                  : (Number.isFinite(fallbackBudget) ? fallbackBudget : 3000);

      let used = 0;
      try {
        const raw = localStorage.getItem(purchasesKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) used = safeSumPurchases(parsed);
        }
      } catch {}

      const remaining = Math.max(0, total - used);
      state.budget = { total, used, remaining };
      updateBudgetDisplay();
    }

    function updateBudgetDisplay() {
      const { total, remaining } = state.budget;
      const budgetAmount = document.getElementById('budgetAmount');
      const progressRing = document.getElementById('progressRing');
      const progressText = document.getElementById('progressText');
      const tipCard = document.getElementById('tipCard');

      budgetAmount.textContent = `${formatKr(remaining)} kr`;

      const r = 32, circumference = 2 * Math.PI * r;
      const pct = total > 0 ? Math.max(0, Math.min(100, (remaining / total) * 100)) : 0;
      progressRing.style.strokeDasharray = `${circumference}`;
      progressRing.style.strokeDashoffset = `${circumference * (1 - pct/100)}`;
      progressText.innerHTML = `${Math.round(pct)}%<br>igjen`;

      let showTip = false, tip = '';
      if (pct <= 25) { showTip = true; tip = 'Tips: Velg vegetar/gryter for √• presse prisen ned resten av uka.'; }
      else if (pct <= 50) { showTip = true; tip = 'Tips: Planlegg 1‚Äì2 billige middager (‚â§ 40 kr/pers) for √• holde budsjettet.'; }
      document.getElementById('tipText').textContent = tip;
      tipCard.style.display = showTip ? 'flex' : 'none';
    }

    /* =========================
       Prislogikk ‚Äì ¬´Du betaler¬ª (hele pakker)
       ========================= */
    const toMl = (unit, qty) => {
      unit = String(unit||'').toLowerCase();
      if (unit === 'ss') return qty * 15;   // 1 ss ‚âà 15 ml
      if (unit === 'dl') return qty * 100;
      if (unit === 'l')  return qty * 1000;
      if (unit === 'ml') return qty;
      return null;
    };
    const toGram = (unit, qty) => {
      unit = String(unit||'').toLowerCase();
      if (unit === 'kg') return qty * 1000;
      if (unit === 'g')  return qty;
      return null;
    };

    // Brukt verdi (proporsjonal verdi av forbruk)
    function usedValueScaled(ing, factor){
      if (Number(ing.kostnad_brukt_nok) > 0) return Number(ing.kostnad_brukt_nok) * factor;

      const per = String(ing.enhetspris_per||'').toLowerCase();
      const unitPrice = Number(ing.enhetspris_nok)||0;
      const usedQty = (Number(ing.mengde_brukt)||0) * factor;
      const uG = toGram(ing.enhet, usedQty);
      const uMl = toMl(ing.enhet, usedQty);

      if (per==='kg' && uG!=null) return unitPrice * (uG/1000);
      if (per==='l'  && uMl!=null) return unitPrice * (uMl/1000);
      if (per==='stk') return unitPrice * usedQty;
      return 0;
    }

    // Hva m√• kunden betale N√Ö for en ingrediens, skalert etter personer (rund opp antall pakker)
    function payNowScaled(ing, factor){
      const unit = String(ing.enhet||'').toLowerCase();
      const per  = String(ing.enhetspris_per||'').toLowerCase();
      const usedQty = (Number(ing.mengde_brukt)||0) * factor;

      const packSize = Number( ing.pakke_st√∏rrelse || 0 ); // i samme ¬´enhet¬ª som oppgitt for varen
      const packPrice = Number( ing.pakkepris_nok || 0 );
      const unitPrice = Number( ing.enhetspris_nok || 0 );

      // 1) Vekt/volum/boks/glass/pakke ‚Üí kj√∏p hele pakker etter behov
      const PACK_UNITS = ['g','kg','ml','dl','l','ss','boks','glass','pakke'];
      if (PACK_UNITS.includes(unit) || per === 'kg' || per === 'l') {
        if (packPrice>0 && packSize>0){
          // konverter brukt mengde til samme m√•l som packSize for ss/dl/kg
          let need = usedQty;
          if (unit==='ss') need = toMl(unit, usedQty); // packSize er i ml for f.eks. soyasaus
          // for g/ml har vi already ok; for kg/dl/l just assume packSize f√∏lger data
          const packs = Math.max(1, Math.ceil( need / packSize ));
          return packs * packPrice;
        }
        // fallback: ingen pakkeinfo ‚Üí betal det som trengs (sjeldent)
        if (per==='kg'){
          const g = toGram(unit, usedQty) ?? 0;
          return unitPrice * (g/1000);
        }
        if (per==='l'){
          const ml = toMl(unit, usedQty) ?? 0;
          return unitPrice * (ml/1000);
        }
      }

      // 2) ¬´stk¬ª-logikk: velg billigst av enkeltstykk vs. multipakk
      if (unit==='stk' || per==='stk' || unit==='fedd'){
        const unitsToBuy = Math.max(1, Math.ceil(usedQty));
        const singlesCost = unitsToBuy * unitPrice;
        if (packPrice>0 && packSize>0){
          const packs = Math.ceil(unitsToBuy / packSize);
          const packCost = packs * packPrice;
          return Math.min(packCost, singlesCost || Infinity);
        }
        return singlesCost;
      }

      // 3) Fallback
      return packPrice>0 ? packPrice : 0;
    }

    // Samler ¬´Du betaler¬ª, ¬´Brukt verdi¬ª, ¬´Rester verdi¬ª for en oppskrift
    function computeMoney(recipe, targetServings){
      const baseServ = Number(recipe.porsjoner)||1;
      const factor = Math.max(0.25, (Number(targetServings)||baseServ) / baseServ);
      const rows = (recipe.ingredienser||[]).map(ing=>{
        const pay = payNowScaled(ing, factor);
        const used = usedValueScaled(ing, factor);
        const leftover = Math.max(0, pay - used);
        // vis mengde skalert i teksten
        const qty = (Number(ing.mengde_brukt)||0) * factor;
        return { ing, qty, pay, used, leftover };
      });
      const totalPay = rows.reduce((s,r)=>s+(r.pay||0),0);
      const totalUsed = rows.reduce((s,r)=>s+(r.used||0),0);
      const totalLeft = Math.max(0, totalPay - totalUsed);
      return { factor, rows, totalPay, totalUsed, totalLeft };
    }

    /* =========================
       Filtre & UI
       ========================= */
    function initPeopleFromHousehold() {
      const raw = (localStorage.getItem('householdCount') || '2').replace('+','');
      const n = Math.max(1, parseInt(raw, 10) || 2);
      state.filters.people = n;
      document.getElementById('peopleCount').textContent = String(n);
    }
    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    function setupFilters() {
      const categoryChips = document.getElementById('categoryChips');
      const allergyChips  = document.getElementById('allergyChips');
      const quickToggle   = document.getElementById('quickToggle');
      const maxPriceInput = document.getElementById('maxPrice');
      const decBtn = document.getElementById('decrementPeople');
      const incBtn = document.getElementById('incrementPeople');
      const peopleCount = document.getElementById('peopleCount');

      categoryChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-category]');
        if (!chip) return;
        const cat = chip.dataset.category;
        chip.classList.toggle('active');
        const i = state.filters.categories.indexOf(cat);
        if (i >= 0) state.filters.categories.splice(i,1); else state.filters.categories.push(cat);
      });

      allergyChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-allergy]');
        if (!chip) return;
        const a = chip.dataset.allergy;
        chip.classList.toggle('active');
        const i = state.filters.allergies.indexOf(a);
        if (i >= 0) state.filters.allergies.splice(i,1); else state.filters.allergies.push(a);
      });

      quickToggle.addEventListener('click', () => {
        quickToggle.classList.toggle('active');
        state.filters.quickOnly = !state.filters.quickOnly;
      });

      maxPriceInput.addEventListener('input', (e) => {
        const v = clamp(parseInt(e.target.value,10) || 70, 10, 200);
        state.filters.maxPrice = v;
        e.target.value = String(v);
      });

      decBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people - 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
      });
      incBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people + 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
      });

      document.addEventListener('keydown', (e) => {
        const target = e.target;
        const isChip = target.classList && target.classList.contains('chip');
        const isToggle = target.id === 'quickToggle';
        if ((isChip || isToggle) && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault(); target.click();
        }
      });
    }

    function allergyPass(recipe, selectedFlags) {
      if (!selectedFlags.length) return true;
      const flags = recipe.allergiFlags || {};
      return selectedFlags.every(k => flags[k] === false);
    }

    function cheapPerPort(recipe){
      // Bruk oppgitt pris_per_porsjon_nok om den finnes, ellers ansl√• fra brukt verdi (ikke ¬´pay now¬ª ‚Äì filteret handler om rimelighet per porsjon)
      const fallback = Number(recipe.pris_per_porsjon_nok);
      if (fallback>0) return fallback;
      // grovt anslag: summer kostnad_brukt_nok
      const used = (recipe.ingredienser||[]).reduce((s,ing)=> s + (Number(ing.kostnad_brukt_nok)||0), 0);
      const pors = Number(recipe.porsjoner)||1;
      return used>0 ? used/pors : 999;
    }

    function filterRecipes() {
      const selCats = state.filters.categories;
      const selAllergies = state.filters.allergies;
      const maxPrice = state.filters.maxPrice;
      const quick = state.filters.quickOnly;

      return RECIPES.filter(r => {
        const perPort = cheapPerPort(r);
        if (perPort > maxPrice) return false;
        if (selCats.length && !selCats.includes(String(r.kategori || '').toLowerCase())) return false;
        if (quick && Number(r.tidMin || 999) > 25) return false;
        if (!allergyPass(r, selAllergies)) return false;
        return true;
      });
    }

    function affordabilityBadgeClass(recipe) {
      // vurder om retten spiser opp mesteparten av gjenv√¶rende budsjett i dag
      const { remaining } = state.budget;
      const perPort = cheapPerPort(recipe);
      const totalForPeople = perPort * state.filters.people;
      if (remaining <= 0) return 'over';
      const ratio = totalForPeople / remaining;
      if (ratio > 1) return 'over';
      if (ratio >= 0.9) return 'warn';
      return 'ok';
    }

    function createRecipeCard(recipe) {
      const emoji = recipe.kategori === 'fisk' ? 'üêü' : (recipe.kategori === 'vegetar' ? 'üåø' : (recipe.kategori === 'kj√∏ttdeig' ? 'ü•ò' : 'üçó'));
      const perPort = cheapPerPort(recipe);
      const cls = affordabilityBadgeClass(recipe);

      const card = document.createElement('div');
      card.className = 'recipe-card';

      card.innerHTML = `
        <div class="recipe-image">${emoji}</div>
        <div class="recipe-content">
          <h3 class="recipe-name">${recipe.navn}</h3>
          <div class="recipe-chips">
            <span class="recipe-chip price">${formatKr(perPort)} kr/pers</span>
            <span class="recipe-chip">${recipe.tidMin ?? '‚Äì'} min</span>
            <span class="recipe-chip">${recipe.vanskelighetsgrad || '‚Äì'}</span>
            ${recipe.kalorierPerPorsjon ? `<span class="recipe-chip">${recipe.kalorierPerPorsjon} kcal</span>` : ''}
            <span class="recipe-chip ${cls==='over'?'price':''}">${cls==='over'?'üî¥ Over budsjett':'üü¢ Innenfor'}</span>
          </div>
          <p class="recipe-description">
            ${String(recipe.kategori||'').charAt(0).toUpperCase() + String(recipe.kategori||'').slice(1)}rett som passer perfekt til
            ${state.filters.people} ${state.filters.people === 1 ? 'person' : 'personer'}.
          </p>
          <div class="recipe-actions">
            <button class="btn btn-primary" data-action="open" data-id="${recipe.id}">Se oppskrift</button>
            <button class="btn btn-secondary" data-action="resuggest">Ny anbefaling</button>
          </div>
        </div>
      `;
      return card;
    }

    function displayRecipes(recipes) {
      const resultsSection = document.getElementById('resultsSection');
      const recipeGrid = document.getElementById('recipeGrid');
      const emptyState = document.getElementById('emptyState');

      if (!recipes.length) {
        resultsSection.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      resultsSection.style.display = 'block';

      recipeGrid.innerHTML = '';
      recipes
        .slice()
        .sort((a,b) => {
          const ap = cheapPerPort(a);
          const bp = cheapPerPort(b);
          return (ap - bp) || ((a.tidMin||999) - (b.tidMin||999));
        })
        .slice(0, 5)
        .forEach(r => recipeGrid.appendChild(createRecipeCard(r)));
    }

    /* =========================
       Modal & handleliste
       ========================= */
    function openRecipeModalById(id) {
      const recipe = RECIPES.find(r => r.id === id);
      if (!recipe) return;

      state.currentRecipeId = id;

      const modal = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalChips = document.getElementById('modalChips');
      const modalPrice = document.getElementById('modalPrice');
      const modalSub = document.getElementById('modalSubPrice');
      const ingredientsList = document.getElementById('ingredientsList');
      const stepsList = document.getElementById('stepsList');

      // Kortinfo
      const perPortCheap = cheapPerPort(recipe);
      modalTitle.textContent = recipe.navn;
      modalChips.innerHTML = `
        <span class="recipe-chip price">${formatKr(perPortCheap)} kr/pers (anslag)</span>
        <span class="recipe-chip">${recipe.tidMin ?? '‚Äì'} min</span>
        <span class="recipe-chip">${recipe.vanskelighetsgrad || '‚Äì'}</span>
        ${recipe.kalorierPerPorsjon ? `<span class="recipe-chip">${recipe.kalorierPerPorsjon} kcal</span>` : ''}
      `;

      // NY: ¬´Du betaler n√•¬ª ‚Äì hel pakke-logikk
      const money = computeMoney(recipe, state.filters.people);
      modalPrice.textContent =
        `Total du m√• betale: ${formatKr(money.totalPay)} kr for ${state.filters.people} ${state.filters.people===1?'person':'personer'}`;
      modalSub.textContent =
        `Brukt verdi: ${formatKr(money.totalUsed)} kr ‚Ä¢ Rester verdi: ${formatKr(money.totalLeft)} kr`;

      // Ingrediensliste
      ingredientsList.innerHTML = '';
      money.rows.forEach(row => {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        const unitTxt = row.ing.enhet ? ` ${row.ing.enhet}` : '';
        li.innerHTML = `
          <div class="ingredient-left">
            <input type="checkbox" class="ingredient-checkbox" checked aria-label="Merk ${row.ing.navn}">
            <div>
              <div class="ingredient-text">‚úÖ ${row.ing.navn} ‚Äî ${Math.round(row.qty*100)/100}${unitTxt}</div>
              <div class="ingredient-sub">
                Brukt verdi: ${formatKr(row.used)} kr${row.leftover>0 ? ` ‚Ä¢ Rester: ${formatKr(row.leftover)} kr` : ``}
              </div>
            </div>
          </div>
          <div class="ingredient-price">${formatKr(row.pay)} kr</div>
        `;
        ingredientsList.appendChild(li);
      });

      // Steg
      stepsList.innerHTML = '';
      (Array.isArray(recipe.steg) ? recipe.steg : []).forEach((s, i) => {
        const li = document.createElement('li');
        li.className = 'step-item';
        li.innerHTML = `<div class="step-number">${i+1}</div><div class="step-text">${String(s)}</div>`;
        stepsList.appendChild(li);
      });

      modal.classList.add('open');
      document.getElementById('modalClose').focus();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
      state.currentRecipeId = null;
    }

    function showToast(text) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = text;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    // Legg valgte ingredienser (tekst) i INBOX for aktiv uke
    function addCurrentRecipeToShoppingList() {
      const recipe = RECIPES.find(r => r.id === state.currentRecipeId);
      if (!recipe) return;

      const weekISO = state.activeWeekISO;
      const inboxKey = `shoppingList_inbox_${weekISO}`;

      let inbox = [];
      try {
        const raw = localStorage.getItem(inboxKey);
        if (raw) inbox = JSON.parse(raw);
        if (!Array.isArray(inbox)) inbox = [];
      } catch { inbox = []; }

      const chosen = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item'))
        .filter(li => li.querySelector('.ingredient-checkbox')?.checked)
        .map(li => li.querySelector('.ingredient-text')?.textContent?.replace(/^‚úÖ\s*/,'').trim())
        .filter(Boolean);

      if (!chosen.length) { showToast('Ingen ingredienser valgt.'); return; }

      const existing = new Set(inbox.map(x => String(x || '').trim().toLowerCase()));
      let added = 0;
      chosen.forEach(txt => {
        const key = txt.toLowerCase();
        if (!existing.has(key)) { inbox.push(txt); existing.add(key); added++; }
      });

      localStorage.setItem(inboxKey, JSON.stringify(inbox));

      const btn = document.getElementById('addToShoppingBtn');
      const old = btn.textContent;
      btn.textContent = added > 0 ? `Lagt til ${added}` : 'Alt fantes fra f√∏r';
      btn.disabled = true;
      setTimeout(() => { btn.textContent = old; btn.disabled = false; }, 1200);

      showToast(added > 0 ? `La til ${added} varer i handleliste` : 'Ingen nye varer lagt til');
    }

    /* =========================
       Navigasjon / events
       ========================= */
    document.getElementById('backBtn').addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = 'app.html';
    });

    document.getElementById('suggestBtn').addEventListener('click', () => {
      const filtered = filterRecipes();
      displayRecipes(filtered);
    });

    document.getElementById('randomFab').addEventListener('click', () => {
      const filtered = filterRecipes();
      if (!filtered.length) return;
      const r = filtered[Math.floor(Math.random() * filtered.length)];
      openRecipeModalById(r.id);
    });

    document.getElementById('resetFiltersBtn').addEventListener('click', () => {
      state.filters = { maxPrice: 70, people: 2, categories: [], allergies: [], quickOnly: false };
      document.getElementById('maxPrice').value = '70';
      document.getElementById('peopleCount').textContent = '2';
      document.querySelectorAll('.chip.active').forEach(chip => chip.classList.remove('active'));
      document.getElementById('quickToggle').classList.remove('active');
      displayRecipes(filterRecipes());
    });

    // Modal
    document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('addToShoppingBtn').addEventListener('click', addCurrentRecipeToShoppingList);

    document.getElementById('goToListBtn').addEventListener('click', () => {
      const r = RECIPES.find(x => x.id === state.currentRecipeId);
      const name = encodeURIComponent(r?.navn || 'oppskrift');
      location.href = `handleliste.html?added=${name}`;
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    // Accordion
    document.getElementById('ingredientsAccordion').addEventListener('click', (e) => {
      if (e.target.closest('.accordion-header')) e.currentTarget.classList.toggle('open');
    });

    // Delegert klikk for kort-knapper
    document.getElementById('recipeGrid').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === 'open') openRecipeModalById(btn.dataset.id);
      if (action === 'resuggest') displayRecipes(filterRecipes().sort(() => 0.5 - Math.random()).slice(0, 5));
    });

    /* =========================
       Init
       ========================= */
    function initPeopleFromLocalOrDefault(){
      const saved = parseInt(localStorage.getItem('defaultPeople')||'',10);
      if (Number.isFinite(saved) && saved>0) {
        state.filters.people = saved;
        document.getElementById('peopleCount').textContent = String(saved);
      } else {
        initPeopleFromHousehold();
      }
    }

    initPeopleFromLocalOrDefault();
    loadBudgetData();
    setupFilters();
    displayRecipes(filterRecipes());
    applyConfig(defaultConfig);
  </script>

  <!-- (Canva/Cloudflare-snutt beholdt ur√∏rt) -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99bfd0691443b4f7',t:'MTc2MjcxNzU2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
