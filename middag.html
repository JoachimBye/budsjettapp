<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Middagsanbefaling</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>
  <script src="/auth-helpers.js"></script>
  <script src="/js/services/household-context.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/shopping-list-service.js"></script>
  <script src="/js/services/budget-utils.js"></script>
  <script src="/js/services/budget-service.js"></script>
  <script src="/js/ui/toast.js"></script>
  <style>
    /* ------ Base ------ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(circle at 20% 20%, #f2fbf6 0, #f7fffb 30%, #f0f6f2 100%);
      color: #234434;
      overflow-x: hidden;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 28px 20px 100px; }

    /* ------ Header ------ */
    .header { margin-bottom: 18px; display: flex; flex-direction: column; gap: 12px; }
    .header-top { display: flex; align-items: center; justify-content: space-between; }
    .nav-back-btn {
      width: 42px; height: 42px; border-radius: 50%;
      border: 1px solid #dce9df; background: #fff;
      color: #2f5c46; font-size: 18px; cursor: pointer;
      box-shadow: 0 10px 26px rgba(33,67,50,.12); transition: all .2s ease;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .nav-back-btn:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 14px 32px rgba(33,67,50,.14); }
    .nav-back-btn:focus { outline: 2px solid #4caf50; outline-offset: 3px; }
    .title-wrap { display: flex; flex-direction: column; gap: 6px; }
    .page-title { font-size: 32px; font-weight: 700; color: #1f3a2d; letter-spacing: -0.5px; }
    .page-subtitle { font-size: 16px; color: #6c8276; font-weight: 500; }

    /* ------ Budget card ------ */
    .budget-card {
      background: linear-gradient(145deg, #ffffff 0%, #f5fbf6 100%);
      border-radius: 26px; padding: 22px 24px; margin-bottom: 24px;
      box-shadow: 0 18px 60px rgba(45,95,77,.12);
      display: flex; align-items: center; gap: 20px; border: 1px solid #e3eee5;
    }
    .budget-info { flex: 1; }
    .budget-label { font-size: 14px; color: #6c8276; margin-bottom: 6px; letter-spacing: 0.02em; }
    .budget-amount { font-size: 30px; font-weight: 700; color: #2f5c46; letter-spacing: -0.4px; }
    .budget-progress { width: 80px; height: 80px; position: relative; }
    .progress-ring { width: 80px; height: 80px; transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: #edf4ee; stroke-width: 8; }
    .progress-ring-fill { fill: none; stroke: #4caf50; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset .4s ease; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 13px; font-weight: 700; color: #2f5c46; text-align: center; }

    /* ------ Filters ------ */
    .filter-panel { background: #fff; border-radius: 24px; padding: 22px; margin-bottom: 24px; box-shadow: 0 16px 48px rgba(45,95,77,.1); border: 1px solid #e5efe6; display: flex; flex-direction: column; gap: 16px; }
    .filter-panel-header { display: flex; flex-direction: column; gap: 4px; }
    .filter-title { font-size: 18px; font-weight: 700; color: #1f3a2d; margin-bottom: 0; letter-spacing: -0.2px; }
    .filter-subtitle { color: #6c8276; font-size: 14px; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; align-items: stretch; }
    .filter-group { display: flex; flex-direction: column; gap: 10px; }
    .filter-label { font-size: 14px; font-weight: 600; color: #2f5c46; letter-spacing: 0.01em; display: flex; gap: 6px; align-items: baseline; }
    .filter-pill { background: #f6faf7; border: 1px solid #e4efe6; border-radius: 16px; padding: 14px 16px; box-shadow: inset 0 1px 0 rgba(255,255,255,.9); }
    .filter-value-label { font-size: 14px; color: #3e5b4c; font-weight: 600; margin-top: 6px; }

    .price-input {
      width: 100%; appearance: none; height: 10px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(76,175,80,.2), rgba(76,175,80,.12));
      outline: none; cursor: pointer;
    }
    .price-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%;
      background: #4caf50; box-shadow: 0 10px 18px rgba(76,175,80,.35); border: 2px solid #f7fbf9;
    }
    .price-input::-moz-range-thumb {
      width: 22px; height: 22px; border-radius: 50%; background: #4caf50; border: 2px solid #f7fbf9;
      box-shadow: 0 10px 18px rgba(76,175,80,.35);
    }

    .people-stepper {
      display: inline-flex; align-items: center; gap: 14px; padding: 10px 12px;
      background: #f7fbf9; border-radius: 999px; border: 1px solid #e1ece4;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      width: fit-content;
    }
    .stepper-btn {
      width: 36px; height: 36px; border-radius: 50%; border: 1px solid #cce2d4;
      background: #ffffff; color: #2f5c46; cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center; transition: all .15s ease;
      box-shadow: 0 8px 16px rgba(44,96,70,.12);
    }
    .stepper-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(44,96,70,.14); }
    .stepper-btn:focus { outline: 2px solid #4caf50; outline-offset: 3px; }
    .stepper-value { min-width: 40px; text-align: center; font-weight: 700; color: #2f5c46; font-size: 16px; }

    .chip-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .chip {
      padding: 10px 16px; border: none; border-radius: 999px; background: #f2f4f3; color: #2e4b3b;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; user-select: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }
    .chip:hover { transform: translateY(-1px); }
    .chip.active { background: #4caf50; color: #fff; box-shadow: 0 12px 26px rgba(76,175,80,.3); }
    .chip:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .toggle-chip {
      display: inline-flex; align-items: center; gap: 10px; padding: 12px 16px;
      border-radius: 14px; background: #f2f7f3; color: #2e4b3b; font-size: 14px; font-weight: 600;
      border: 1px solid #dbe8de; cursor: pointer; transition: all .2s; user-select: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9); justify-content: center;
    }
    .toggle-chip:hover { transform: translateY(-1px); }
    .toggle-chip.active { background: rgba(76,175,80,.12); color: #1f3a2d; border-color: rgba(76,175,80,.35); box-shadow: 0 12px 26px rgba(76,175,80,.16); }

    .suggest-row { display: flex; flex-direction: column; align-items: stretch; gap: 12px; }
    .suggest-btn {
      width: 100%;
      height: 54px;
      border-radius: 14px;
      font-size: 16px;
      flex: none;
      box-shadow: 0 14px 34px rgba(76,175,80,.24);
      letter-spacing: 0.01em;
    }

    /* ------ Tips ------ */
    .tip-card { background: linear-gradient(135deg, #f9fbe7 0%, #f5ffe9 100%); border: 1px solid #e6f0d3; border-radius: 16px; padding: 14px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; box-shadow: 0 12px 30px rgba(163,190,140,.15); }
    .tip-icon { font-size: 20px; }
    .tip-text { font-size: 14px; color: #5b6c4f; }

    /* ------ Results ------ */
    .results-section { margin-bottom: 16px; }
    .results-title { font-size: 22px; font-weight: 700; color: #1f3a2d; margin-bottom: 16px; }
    .recipe-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 14px; align-items: stretch; }
    .recipe-card {
      background: #fff; border-radius: 16px; padding: 14px 16px; box-shadow: 0 12px 32px rgba(45,95,77,.12);
      border: 1px solid #e5efe6; transition: all .2s ease; cursor: pointer; min-height: 110px;
      display: flex; align-items: center;
    }
    .recipe-card:hover { transform: translateY(-2px); box-shadow: 0 16px 36px rgba(45,95,77,.14); }
    .recipe-card:focus, .recipe-card:focus-within { outline: 2px solid #4caf50; outline-offset: 3px; }
    .recipe-card-inner { display: flex; gap: 12px; align-items: center; width: 100%; }
    .recipe-card-emoji-wrap {
      width: 64px; height: 64px; border-radius: 18px;
      background: radial-gradient(circle at 30% 30%, rgba(76,175,80,.14) 0%, rgba(76,175,80,.06) 50%, #f9fdfa 100%);
      display: flex; align-items: center; justify-content: center; box-shadow: inset 0 1px 0 rgba(255,255,255,.92), 0 8px 20px rgba(44,96,70,.1);
      flex-shrink: 0;
    }
    .recipe-emoji { font-size: 42px; }
    .recipe-card-body { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 0; }
    .recipe-title { font-size: 17px; font-weight: 700; color: #1f3a2d; margin: 0; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recipe-meta { display: inline-flex; align-items: center; gap: 10px; color: #5e7467; font-size: 13px; font-weight: 600; flex-wrap: wrap; }
    .meta-item { color: inherit; }
    .meta-dot { width: 4px; height: 4px; border-radius: 50%; background: #c8d7ce; display: inline-block; }
    .recipe-grid .recipe-description { display: none; }
    .recipe-grid .recipe-chips { display: none; }
    .recipe-chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .recipe-chip { padding: 6px 10px; background: #f2f7f3; color: #2e4b3b; font-size: 12px; border-radius: 10px; font-weight: 600; }
    .recipe-chip.price { background: #4caf50; color: #fff; }
    .recipe-actions { display: none; }
    .open-icon {
      width: 28px; height: 28px; border: none; background: transparent;
      color: #6c8276; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
      font-size: 20px; transition: all .2s ease; flex-shrink: 0;
    }
    .open-icon:hover { transform: translateX(2px); color: #3b5d4a; }
    .open-icon:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .meta-inline { display: inline-flex; align-items: center; gap: 10px; }
    .muted { color: #738679; }
    .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; flex: 1; }
    .btn-primary { background: #4caf50; color: #fff; }
    .btn-primary:hover { background: #45a049; }
    .btn-secondary { background: #f0f0f0; color: #5a7a6d; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    /* ------ Empty state ------ */
    .empty-state { text-align: center; padding: 44px 20px; background: #fff; border-radius: 22px; box-shadow: 0 16px 44px rgba(45,95,77,.1); border: 1px solid #e5efe6; }
    .empty-icon { font-size: 72px; color: #5a7a6d; margin-bottom: 16px; }
    .empty-title { font-size: 20px; font-weight: 700; color: #1f3a2d; margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: #5f7367; margin-bottom: 20px; }

    /* ------ Modal ------ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(45,95,77,.5); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 24px; padding: 28px; max-width: 600px; width: 100%; max-height: 90%; overflow-y: auto; box-shadow: 0 8px 32px rgba(45,95,77,.2); }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .modal-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 12px; }
    .modal-close { width: 32px; height: 32px; border: none; background: #f0f0f0; border-radius: 50%; cursor: pointer; font-size: 18px; color: #5a7a6d; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #e0e0e0; }
    .modal-close:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .modal-price { font-size: 20px; font-weight: 700; color: #4caf50; margin-bottom: 12px; }
    .modal-meta { font-size: 14px; color: #5f7367; display: inline-flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    .modal-meta-dot { width: 4px; height: 4px; border-radius: 50%; background: #c8d7ce; display: inline-block; }
    .modal-meta-inline { font-size: 14px; color: #5f7367; margin-bottom: 6px; }
    .modal .recipe-chips { gap: 6px; margin-bottom: 10px; flex-direction: column; align-items: flex-start; }
    .modal-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .modal .recipe-chip { background: #f9fbfa; color: #2f4438; box-shadow: none; border: 1px solid #e6efe6; }
    .modal .recipe-chip.price { background: #f9fbfa; color: #2f4438; }

    .accordion { border: 1px solid rgba(76,175,80,.12); border-radius: 12px; margin-bottom: 20px; }
    .accordion-header { padding: 16px 20px; background: #f8fffe; display: flex; align-items: center; font-weight: 600; color: #2d5f4d; user-select: none; }
    .accordion-content { padding: 0 0 16px; display: block; }
    .accordion-body { padding: 0 20px 0; }

    .ingredient-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .ingredient-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
    .ingredient-checkbox { width: 18px; height: 18px; accent-color: #4caf50; }
    .ingredient-text { font-size: 14px; color: #2d5f4d; }

    .steps-list { list-style: none; display: flex; flex-direction: column; gap: 16px; }
    .step-item { display: flex; gap: 12px; }
    .step-number { width: 24px; height: 24px; background: #4caf50; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .step-text { font-size: 14px; color: #2d5f4d; line-height: 1.5; }
    .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }
    .modal-note { font-size: 12px; color: #5a7a6d; margin-top: 8px; }
    .modal .btn-primary { width: 100%; border-radius: 14px; height: 52px; font-size: 16px; }
    .link-button {
      background: none; border: none; padding: 6px 0; color: #2f5c46; font-weight: 700; font-size: 13px;
      cursor: pointer; text-decoration: none; align-self: center;
    }
    .link-button:hover { text-decoration: underline; }

    /* ------ Toast ------ */
    .toast {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: #4caf50; color: #fff; padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.12); z-index: 1000; font-weight: 600;
    }

    /* ------ FAB ------ */
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%;
      background: #4caf50; color: #fff; border: none; font-size: 24px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(76,175,80,.4); display: flex; align-items: center; justify-content: center; transition: all .2s; z-index: 50;
    }
    .fab:hover { background: #45a049; transform: scale(1.05); }
    .fab:focus { outline: 3px solid #4caf50; outline-offset: 3px; }

    /* ------ Responsive ------ */
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .page-title { font-size: 28px; }
      .budget-card { flex-direction: column; text-align: center; }
      .filter-grid { grid-template-columns: 1fr; }
      .recipe-grid { grid-template-columns: 1fr; }
      .fab { bottom: 16px; right: 16px; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-top">
        <button class="nav-back-btn" id="backToAppBtn" type="button" aria-label="G√• tilbake">‚Üê</button>
      </div>
      <div class="title-wrap">
        <h1 class="page-title" id="pageTitle">Middagsanbefaling</h1>
        <p class="page-subtitle" id="pageSubtitle">F√• forslag som passer budsjettet ditt i dag.</p>
      </div>
    </header>

    <section class="budget-card" aria-live="polite">
      <div class="budget-info">
        <div class="budget-label" id="budgetRemainingLabel">Budsjett igjen denne uka:</div>
        <div class="budget-amount" id="budgetAmount">‚Äì</div>
      </div>
      <div class="budget-progress">
        <svg class="progress-ring" viewBox="0 0 80 80" aria-hidden="true">
          <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
          <circle class="progress-ring-fill" cx="40" cy="40" r="32" id="progressRing"></circle>
        </svg>
        <div class="progress-text" id="progressText">‚Äì</div>
      </div>
    </section>

    <div id="tipCard" class="tip-card" style="display:none;">
      <span class="tip-icon">üí°</span>
      <span class="tip-text" id="tipText">Tips: Bytt til vegetar for lavere pris og spar mer denne uka!</span>
    </div>

    <section class="filter-panel">
      <div class="filter-panel-header">
        <h2 class="filter-title">Filtrer middager</h2>
        <p class="filter-subtitle">Skru p√• kontrollene for √• matche budsjett, tid og cravings.</p>
      </div>

      <div class="filter-grid">
        <div class="filter-group filter-pill">
          <label for="maxPrice" class="filter-label" id="maxPriceLabel">Maks kr pr. porsjon</label>
          <div>
            <input type="range" id="maxPrice" class="price-input" value="70" min="10" max="200" step="5" />
            <div class="filter-value-label" id="maxPriceValue">‚â§ 70 kr</div>
          </div>
        </div>

        <div class="filter-group filter-pill">
          <span class="filter-label" id="peopleCountLabel">Antall personer</span>
          <div class="people-stepper">
            <button class="stepper-btn" id="decrementPeople" aria-label="Reduser antall">‚àí</button>
            <span class="stepper-value" id="peopleCount">2</span>
            <button class="stepper-btn" id="incrementPeople" aria-label="√òk antall">+</button>
          </div>
        </div>
      </div>

      <div class="filter-grid">
        <div class="filter-group filter-pill">
          <span class="filter-label">Kategori</span>
          <div class="chip-group" id="categoryChips">
            <div class="chip" data-category="kylling" tabindex="0" role="button">Kylling</div>
            <div class="chip" data-category="kj√∏ttdeig" tabindex="0" role="button">Kj√∏ttdeig</div>
            <div class="chip" data-category="fisk" tabindex="0" role="button">Fisk</div>
            <div class="chip" data-category="vegetar" tabindex="0" role="button">Vegetar</div>
          </div>
        </div>

        <div class="filter-group filter-pill">
          <span class="filter-label">Allergivennlig</span>
          <div class="chip-group" id="allergyChips">
            <div class="chip" data-allergy="gluten" tabindex="0" role="button">Glutenfri</div>
            <div class="chip" data-allergy="laktose" tabindex="0" role="button">Laktosefri</div>
            <div class="chip" data-allergy="pean√∏tt" tabindex="0" role="button">N√∏ttefri</div>
          </div>
        </div>
      </div>

      <div class="suggest-row">
        <div class="toggle-chip" id="quickToggle" tabindex="0" role="button"><span>‚ö°</span><span>Rask (‚â§ 25 min)</span></div>
        <button class="btn btn-primary suggest-btn" id="suggestBtn" type="button">Foresl√• middager</button>
      </div>
    </section>

    <section class="results-section" id="resultsSection" style="display:none;">
      <h2 class="results-title">Anbefalte middager</h2>
      <div class="recipe-grid" id="recipeGrid"></div>
    </section>

    <section class="empty-state" id="emptyState" style="display:none;">
      <div class="empty-icon">üçΩÔ∏è</div>
      <h3 class="empty-title">Ingen forslag enn√•</h3>
      <p class="empty-text">Just√©r filterne litt ‚Äì kanskje senk makspris ‚Äì s√• finner vi noe digg.</p>
      <button class="btn btn-primary" id="resetFiltersBtn">Nullstill filter</button>
    </section>
  </div>

  <button class="fab" id="randomFab" aria-label="Tilfeldig middag">üé≤</button>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="modalTitle">Oppskrift</h2>
          <div class="recipe-chips" id="modalChips"></div>
          <p class="modal-note" id="modalDescription" style="margin-bottom:8px;"></p>
          <div class="modal-price" id="modalPrice">Pris for 2 personer: ‚Äì kr</div>
          <div class="modal-note">Fjern avkrysning p√• ingredienser du allerede har ‚Äì kun krysset blir lagt til i handlelista.</div>
        </div>
        <button class="modal-close" id="modalClose" aria-label="Lukk modal">√ó</button>
      </div>

      <div class="accordion" id="ingredientsAccordion">
        <div class="accordion-header"><span>Ingredienser</span></div>
        <div class="accordion-content">
          <div class="accordion-body">
            <ul class="ingredient-list" id="ingredientsList"></ul>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom:16px;color:#2d5f4d;font-weight:600;">Fremgangsm√•te</h3>
        <ol class="steps-list" id="stepsList"></ol>
      </div>

      <div class="modal-note" id="modalTips" style="display:none;"></div>

      <div class="modal-actions">
        <button class="btn btn-primary" id="addToShoppingBtn">Legg til i handlelista</button>
        <button class="link-button" id="goToListBtn">√Öpne handlelista</button>
      </div>
    </div>
  </div>

  <script>
    const supa = window.supaClient?.getClient();
    const showToast = (message, type = 'info') => {
      if (window.toast?.show) {
        window.toast.show(message, { type });
      } else {
        console[type === 'error' ? 'error' : 'log'](message);
      }
    };

    /* =========================
       Konfig / theming (Element SDK)
       ========================= */
    const defaultConfig = {
      page_title: "Middagsanbefaling",
      page_subtitle: "F√• forslag som passer budsjettet ditt i dag.",
      budget_remaining_label: "Budsjett igjen denne uka",
      max_price_label: "Maks kr pr. porsjon",
      people_count_label: "Antall personer",
      suggest_button: "Foresl√• middager",
      background_color: "#f8fffe",
      primary_color: "#4caf50",
      text_color: "#2d5f4d",
      secondary_text_color: "#5a7a6d",
      surface_color: "#ffffff",
      font_family: "Inter",
      font_size: 16
    };

    function applyConfig(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
      document.body.style.background =
        `radial-gradient(circle at 20% 20%, ${config.background_color || defaultConfig.background_color} 0%, #f7fffb 35%, #f0f6f2 100%)`;

      const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

      setText('pageTitle', config.page_title || defaultConfig.page_title);
      setText('pageSubtitle', config.page_subtitle || defaultConfig.page_subtitle);
      setText('budgetRemainingLabel', (config.budget_remaining_label || defaultConfig.budget_remaining_label) + ':');
      setText('maxPriceLabel', config.max_price_label || defaultConfig.max_price_label);
      setText('peopleCountLabel', config.people_count_label || defaultConfig.people_count_label);

      const suggestBtn = document.getElementById('suggestBtn');
      if (suggestBtn) {
        suggestBtn.textContent = config.suggest_button || defaultConfig.suggest_button;
        suggestBtn.style.background = config.primary_color || defaultConfig.primary_color;
      }

      document.querySelectorAll('.stepper-btn, .fab, .btn-primary').forEach(el => {
        el.style.background = config.primary_color || defaultConfig.primary_color;
      });

      const surface = config.surface_color || defaultConfig.surface_color;
      document.querySelectorAll('.filter-panel, .recipe-card, .modal').forEach(el => {
        el.style.background = surface;
      });
      const budgetCard = document.querySelector('.budget-card');
      if (budgetCard) {
        budgetCard.style.background = `linear-gradient(145deg, ${surface} 0%, #f5fbf6 100%)`;
      }

      const title = document.getElementById('pageTitle');
      if (title) title.style.fontSize = `${baseSize * 2}px`;
      const subtitle = document.getElementById('pageSubtitle');
      if (subtitle) subtitle.style.fontSize = `${baseSize}px`;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: applyConfig,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
            { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk.setConfig({ surface_color: v }) },
            { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk.setConfig({ text_color: v }) },
            { get: () => config.primary_color || defaultConfig.primary_color, set: v => window.elementSdk.setConfig({ primary_color: v }) },
            { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
          ],
          borderables: [],
          fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk.setConfig({ font_family: v }) },
          fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk.setConfig({ font_size: v }) }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["page_title", config.page_title || defaultConfig.page_title],
          ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
          ["budget_remaining_label", config.budget_remaining_label || defaultConfig.budget_remaining_label],
          ["max_price_label", config.max_price_label || defaultConfig.max_price_label],
          ["people_count_label", config.people_count_label || defaultConfig.people_count_label],
          ["suggest_button", config.suggest_button || defaultConfig.suggest_button],
        ])
      });
    }

    function formatKr(n) {
      const v = Number.isFinite(n) ? n : 0;
      return v.toLocaleString('no-NO');
    }

    /* =========================
       Oppskrift-data
       ========================= */
    const dateUtils = window.dateUtils || {};
    const shoppingListService = window.shoppingListService || null;
    let allRecipes = [];
    let filteredRecipes = [];
    let currentServings = 2;

    const state = {
      filters: {
        maxPrice: 70,
        people: 2,
        categories: [],
        allergies: [], // "gluten" => ekskluder oppskrifter som inneholder gluten
        quickOnly: false,
      },
      budget: { total: 0, used: 0, remaining: 0 },
      activeWeekISO: (dateUtils.getOrInitActiveWeekISO
        ? dateUtils.getOrInitActiveWeekISO()
        : (dateUtils.mondayISO ? dateUtils.mondayISO() : new Date().toISOString().slice(0, 10))),
      currentRecipe: null,
    };
    let isBudgetLoading = false;
    let budgetLoadError = null;

    /* =========================
       Budsjett / purchases
       ========================= */
    async function loadBudgetData() {
      const weekISO = state.activeWeekISO;
      let summary = null;
      isBudgetLoading = true;
      budgetLoadError = null;
      updateBudgetDisplay();

      if (!supa) {
        budgetLoadError = 'Ingen forbindelse til databasen.';
        isBudgetLoading = false;
        updateBudgetDisplay();
        return;
      }

      if (window.budgetService?.loadWeekSummary) {
        try {
          summary = await window.budgetService.loadWeekSummary(supa, weekISO);
        } catch (err) {
          console.warn('Kunne ikke hente budsjett fra budgetService, faller tilbake til cache.', err);
          budgetLoadError = 'Kunne ikke hente budsjett ‚Äì viser cache.';
          showToast('Kunne ikke hente budsjett, viser cache.', 'error');
        }
      }

      if (summary) {
        const total = Number(summary.budget) || 0;
        const used = Number(summary.spent) || 0;
        const remainingValue = Number.isFinite(summary.remaining)
          ? summary.remaining
          : Math.max(0, total - used);
        state.budget = { total, used, remaining: remainingValue };
        isBudgetLoading = false;
        updateBudgetDisplay();
        return;
      }

      const total = window.budgetService?.readWeeklyBudgetLocal
        ? window.budgetService.readWeeklyBudgetLocal(weekISO)
        : 0;

      const localPurchases = (() => {
        try {
          const raw = localStorage.getItem(`purchases_${weekISO}`);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      })();

      const used = window.budgetUtils?.safeSumPurchases
        ? window.budgetUtils.safeSumPurchases(localPurchases)
        : localPurchases.reduce((sum, item) => sum + (Number(item?.amount || item?.sum || 0) || 0), 0);
      const remaining = Math.max(0, total - used);
      state.budget = { total, used, remaining };
      isBudgetLoading = false;
      updateBudgetDisplay();
    }

    function updateBudgetDisplay() {
      const { total, remaining } = state.budget;
      const budgetAmount = document.getElementById('budgetAmount');
      const progressRing = document.getElementById('progressRing');
      const progressText = document.getElementById('progressText');
      const tipCard = document.getElementById('tipCard');

      if (isBudgetLoading) {
        budgetAmount.textContent = '...';
        document.getElementById('budgetHint')?.classList.remove('show');
        return;
      }

      budgetAmount.textContent = `${formatKr(remaining)} kr`;

      const r = 32, circumference = 2 * Math.PI * r;
      const pct = total > 0 ? Math.max(0, Math.min(100, (remaining / total) * 100)) : 0;
      progressRing.style.strokeDasharray = `${circumference}`;
      progressRing.style.strokeDashoffset = `${circumference * (1 - pct/100)}`;
      progressText.innerHTML = `${Math.round(pct)}%<br>igjen`;

      let showTip = false, tip = '';
      if (pct <= 25) { showTip = true; tip = 'Tips: Velg vegetar/gryter for √• presse prisen ned resten av uka.'; }
      else if (pct <= 50) { showTip = true; tip = 'Tips: Planlegg 1‚Äì2 billige middager (‚â§ 40 kr/pers) for √• holde budsjettet.'; }
      document.getElementById('tipText').textContent = tip;
      if (budgetLoadError) {
        tipCard.style.display = 'flex';
        document.getElementById('tipText').textContent = budgetLoadError;
      } else {
        tipCard.style.display = showTip ? 'flex' : 'none';
      }
    }

    /* =========================
       Filtre & UI handling
       ========================= */
    function initPeopleFromHousehold() {
      const raw = (localStorage.getItem('householdCount') || '2').replace('+','');
      const n = Math.max(1, parseInt(raw, 10) || 2);
      state.filters.people = n;
      currentServings = n;
      document.getElementById('peopleCount').textContent = String(n);
    }

    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    function updateMaxPriceLabel(value) {
      const slider = document.getElementById('maxPrice');
      const min = slider ? parseInt(slider.min, 10) || 0 : 0;
      const max = slider ? parseInt(slider.max, 10) || 200 : 200;
      const safeValue = clamp(Number(value) || min, min, max);
      const label = document.getElementById('maxPriceValue');
      if (label) label.textContent = `‚â§ ${safeValue} kr`;
      if (slider) {
        const pct = max > min ? ((safeValue - min) / (max - min)) * 100 : 0;
        slider.value = String(safeValue);
        slider.style.background = `linear-gradient(90deg, #4caf50 0%, #4caf50 ${pct}%, #e7efe9 ${pct}%, #e7efe9 100%)`;
      }
    }

    function setupFilters() {
      const categoryChips = document.getElementById('categoryChips');
      const allergyChips  = document.getElementById('allergyChips');
      const quickToggle   = document.getElementById('quickToggle');
      const maxPriceInput = document.getElementById('maxPrice');
      const maxPriceValue = document.getElementById('maxPriceValue');
      const suggestBtn    = document.getElementById('suggestBtn');
      const decBtn = document.getElementById('decrementPeople');
      const incBtn = document.getElementById('incrementPeople');
      const peopleCount = document.getElementById('peopleCount');
      const startingMaxPrice = clamp(parseInt(maxPriceInput.value, 10) || state.filters.maxPrice, 10, 200);
      state.filters.maxPrice = startingMaxPrice;
      if (maxPriceValue) maxPriceValue.setAttribute('aria-live', 'polite');
      updateMaxPriceLabel(startingMaxPrice);

      categoryChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-category]');
        if (!chip) return;
        const cat = chip.dataset.category;
        chip.classList.toggle('active');
        const i = state.filters.categories.indexOf(cat);
        if (i >= 0) state.filters.categories.splice(i,1); else state.filters.categories.push(cat);
        applyFilters();
      });

      allergyChips.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip[data-allergy]');
        if (!chip) return;
        const a = chip.dataset.allergy;
        chip.classList.toggle('active');
        const i = state.filters.allergies.indexOf(a);
        if (i >= 0) state.filters.allergies.splice(i,1); else state.filters.allergies.push(a);
        applyFilters();
      });

      quickToggle.addEventListener('click', () => {
        quickToggle.classList.toggle('active');
        state.filters.quickOnly = !state.filters.quickOnly;
        applyFilters();
      });

      maxPriceInput.addEventListener('input', (e) => {
        const v = clamp(parseInt(e.target.value,10) || 70, 10, 200);
        state.filters.maxPrice = v;
        e.target.value = String(v);
        updateMaxPriceLabel(v);
        applyFilters();
      });

      decBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people - 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
        currentServings = state.filters.people;
        if (state.currentRecipe) updateModalForServings(state.currentRecipe);
      });
      incBtn.addEventListener('click', () => {
        state.filters.people = clamp(state.filters.people + 1, 1, 12);
        peopleCount.textContent = String(state.filters.people);
        currentServings = state.filters.people;
        if (state.currentRecipe) updateModalForServings(state.currentRecipe);
      });

      suggestBtn?.addEventListener('click', () => {
        applyFilters();
      });

      document.addEventListener('keydown', (e) => {
        const target = e.target;
        const isChip = target.classList && target.classList.contains('chip');
        const isToggle = target.id === 'quickToggle';
        if ((isChip || isToggle) && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault(); target.click();
        }
      });
    }

    function deriveCategory(recipe) {
      const tags = (recipe.tags || []).map(t => (t || '').toLowerCase());
      const title = (recipe.title || '').toLowerCase();
      const ingredientNames = (recipe.ingredients || []).map((ing) => (ing.name || '').toLowerCase());
      if (recipe.diet?.vegetarian) return 'vegetar';
      if (tags.includes('vegetar')) return 'vegetar';
      if (tags.includes('fisk') || title.includes('laks') || title.includes('torsk') || ingredientNames.some((n) => n.includes('fisk') || n.includes('laks') || n.includes('torsk'))) {
        return 'fisk';
      }
      if (tags.includes('kylling') || title.includes('kylling') || ingredientNames.some((n) => n.includes('kylling'))) {
        return 'kylling';
      }
      if (tags.includes('kj√∏tt') || ingredientNames.some((n) => n.includes('kj√∏ttdeig'))) {
        return 'kj√∏ttdeig';
      }
      return 'annet';
    }

    function getScaledIngredients(recipe, servings) {
      const base = recipe.default_servings || 4;
      const factor = servings / base;

      return (recipe.ingredients || []).map((ing) => ({
        ...ing,
        amount:
          typeof ing.amount === 'number'
            ? Number((ing.amount * factor).toFixed(1))
            : ing.amount
      }));
    }

    async function loadRecipes() {
      try {
        const res = await fetch('/data/dinners.json');
        if (!res.ok) {
          console.error('Kunne ikke hente middager');
          return;
        }
        const data = await res.json();
        if (Array.isArray(data)) {
          allRecipes = data;
          filteredRecipes = data;
          renderRecipeList();
        }
      } catch (err) {
        console.error('Kunne ikke laste middager', err);
      }
    }

    function applyFilters() {
      const maxPrice = state.filters.maxPrice;
      const quickOnly = state.filters.quickOnly;
      const selCats = state.filters.categories;
      const selAllergies = state.filters.allergies;

      if (!allRecipes.length) return;

      filteredRecipes = (allRecipes || []).filter((r) => {
        if (maxPrice != null && Number(r.price_per_person) > maxPrice) return false;
        if (quickOnly && Number(r.time_minutes) > 25) return false;
        if (selAllergies.length) {
          if (selAllergies.includes('gluten') && r.diet?.gluten_free === false) return false;
          if (selAllergies.includes('laktose') && r.diet?.lactose_free === false) return false;
        }
        if (selCats.length) {
          const cat = deriveCategory(r);
          if (!selCats.includes(cat)) return false;
        }
        return true;
      });

      renderRecipeList();
    }

    function formatTags(recipe) {
      return (recipe.tags || []).slice(0, 3);
    }

    function createRecipeCard(recipe) {
      const card = document.createElement('article');
      card.className = 'recipe-card';
      card.dataset.id = recipe.id;
      card.setAttribute('tabindex', '0');

      card.innerHTML = `
        <div class="recipe-card-inner">
          <div class="recipe-card-emoji-wrap"><span class="recipe-emoji">${recipe.emoji || 'üçΩÔ∏è'}</span></div>
          <div class="recipe-card-body">
            <h3 class="recipe-title">${recipe.title}</h3>
            <div class="recipe-meta">
              <span class="meta-item">ca. ${formatKr(recipe.price_per_person)} kr/pers</span>
              <span class="meta-dot"></span>
              <span class="meta-item">${recipe.time_minutes} min</span>
              <span class="meta-dot"></span>
              <span class="meta-item">${recipe.difficulty || 'lett'}</span>
            </div>
          </div>
        </div>
      `;

      const openRecipe = () => openRecipeModalById(recipe.id);
      card.addEventListener('click', openRecipe);
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openRecipe();
        }
      });
      return card;
    }

    function renderRecipeList() {
      const resultsSection = document.getElementById('resultsSection');
      const recipeGrid = document.getElementById('recipeGrid');
      const emptyState = document.getElementById('emptyState');

      const recipes = filteredRecipes || [];
      if (!recipes.length) {
        resultsSection.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      resultsSection.style.display = 'block';

      recipeGrid.innerHTML = '';
      const sorted = recipes
        .slice()
        .sort((a, b) => (a.price_per_person - b.price_per_person) || (a.time_minutes - b.time_minutes));
      sorted.forEach((r) => recipeGrid.appendChild(createRecipeCard(r)));
    }

    /* =========================
       Modal & handleliste
       ========================= */
    function renderIngredients(recipe, servings) {
      const ingredientsList = document.getElementById('ingredientsList');
      if (!ingredientsList) return;
      ingredientsList.innerHTML = '';
      const header = document.querySelector('#ingredientsAccordion .accordion-header span');
      if (header) header.textContent = `Ingredienser for ${servings} ${servings === 1 ? 'person' : 'personer'}`;
      const scaled = getScaledIngredients(recipe, servings);
      scaled.forEach((ing) => {
        const amountText = ing.amount ? `${ing.amount} ${ing.unit || ''}`.trim() : '';
        const stapleText = ing.is_staple ? ' (basisvare)' : '';
        const checkedAttr = ing.is_staple ? '' : 'checked';
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        li.dataset.ingName = ing.name || '';
        li.innerHTML = `
          <input type="checkbox" class="ingredient-checkbox" ${checkedAttr} aria-label="Merk ${ing.name}">
          <span class="ingredient-text">${amountText ? `${ing.name} ‚Äì ${amountText}` : ing.name}${stapleText}</span>
        `;
        ingredientsList.appendChild(li);
      });
    }

    function renderSteps(recipe) {
      const stepsList = document.getElementById('stepsList');
      if (!stepsList) return;
      stepsList.innerHTML = '';
      (recipe.steps || []).forEach((step, i) => {
        const li = document.createElement('li');
        li.className = 'step-item';
        li.innerHTML = `<div class="step-number">${i + 1}</div><div class="step-text">${step}</div>`;
        stepsList.appendChild(li);
      });
    }

    function updateModalForServings(recipe) {
      if (!recipe) return;
      // Skalerer ingrediensene etter valgt antall personer
      renderIngredients(recipe, currentServings);
      const modalPrice = document.getElementById('modalPrice');
      if (modalPrice) {
        const totalPrice = (Number(recipe.price_per_person) || 0) * currentServings;
        modalPrice.textContent = `Pris for ${currentServings} ${currentServings === 1 ? 'person' : 'personer'}: ${formatKr(totalPrice)} kr`;
      }
    }

    function openRecipeModalById(id) {
      const recipe = allRecipes.find((r) => r.id === id);
      if (!recipe) return;

      state.currentRecipe = recipe;
      currentServings = state.filters.people;

      const modal = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalChips = document.getElementById('modalChips');
      const modalDesc = document.getElementById('modalDescription');
      const modalTips = document.getElementById('modalTips');

      if (modalTitle) modalTitle.textContent = `${recipe.emoji || ''} ${recipe.title}`.trim();
      const tags = formatTags(recipe).map((tag) => `<span class="recipe-chip subtle">${tag}</span>`).join('');
      const metaText = `${formatKr(recipe.price_per_person)} kr/pers \u2022 ${recipe.time_minutes} min \u2022 ${recipe.difficulty || 'lett'}`;
      modalChips.innerHTML = `
        <div class="modal-meta-inline">${metaText}</div>
        ${tags ? `<div class="modal-tags">${tags}</div>` : ''}
      `;
      if (modalDesc) {
        modalDesc.style.display = recipe.short_description ? 'block' : 'none';
        modalDesc.textContent = recipe.short_description || '';
      }

      renderSteps(recipe);
      updateModalForServings(recipe);

      if (modalTips) {
        if (recipe.tips) {
          modalTips.style.display = 'block';
          modalTips.textContent = recipe.tips;
        } else {
          modalTips.style.display = 'none';
          modalTips.textContent = '';
        }
      }

      modal.classList.add('open');
      document.getElementById('modalClose').focus();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open');
      state.currentRecipe = null;
    }

    async function addRecipeToShoppingList(recipe, servings, selectedNames = null) {
      if (!recipe) return;
      let scaled = getScaledIngredients(recipe, servings).filter((ing) => !ing.is_staple);
      if (selectedNames && selectedNames.length) {
        const selectedSet = new Set(selectedNames.filter(Boolean).map((n) => n.toLowerCase()));
        scaled = scaled.filter((ing) => selectedSet.has((ing.name || '').toLowerCase()));
      }
      if (!scaled.length) {
        showToast('Ingen ingredienser √• legge til.', 'info');
        return;
      }

      const weekISO = state.activeWeekISO;

      if (shoppingListService?.addItem && supa) {
        try {
          for (const ing of scaled) {
            const amountLabel = ing.amount ? `${ing.amount} ${ing.unit || ''}`.trim() : '';
            const nameWithUnit = amountLabel ? `${ing.name} (${amountLabel})` : ing.name;
            const qty = typeof ing.amount === 'number' ? Math.max(1, Math.round(ing.amount * 10) / 10) : 1;
            // gjenbruker handleliste-tjenesten slik at Supabase/ UI oppdateres riktig
            await shoppingListService.addItem(supa, {
              weekISO,
              name: nameWithUnit,
              category: ing.shopping_category || ing.category || 'Mat & dagligvarer',
              quantity: qty
            });
          }
          showToast(`${recipe.title} ble lagt til i handlelista üçΩÔ∏è`, 'success');
          return;
        } catch (err) {
          console.warn('Kunne ikke lagre til Supabase, pr√∏ver lokalt', err);
        }
      }

      // Fallback til lokal inbox dersom Supabase ikke er tilgjengelig
      const inboxKey = `shoppingList_inbox_${weekISO}`;
      let inbox = [];
      try {
        const raw = localStorage.getItem(inboxKey);
        if (raw) inbox = JSON.parse(raw);
        if (!Array.isArray(inbox)) inbox = [];
      } catch {
        inbox = [];
      }

      const existing = new Set(inbox.map((x) => String(x || '').trim().toLowerCase()));
      scaled.forEach((ing) => {
        const amountLabel = ing.amount ? `${ing.amount} ${ing.unit || ''}`.trim() : '';
        const nameWithUnit = amountLabel ? `${ing.name} (${amountLabel})` : ing.name;
        const key = nameWithUnit.toLowerCase();
        if (!existing.has(key)) {
          inbox.push(nameWithUnit);
          existing.add(key);
        }
      });
      localStorage.setItem(inboxKey, JSON.stringify(inbox));
      showToast(`${recipe.title} ble lagt til i handlelista üçΩÔ∏è`, 'success');
    }

    async function addCurrentRecipeToShoppingList() {
      if (!state.currentRecipe) return;
      const selected = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item'))
        .filter((li) => li.querySelector('.ingredient-checkbox')?.checked)
        .map((li) => li.dataset.ingName)
        .filter(Boolean);
      if (!selected.length) {
        showToast('Ingen ingredienser valgt.', 'error');
        return;
      }
      await addRecipeToShoppingList(state.currentRecipe, currentServings, selected);
    }

    /* =========================
       Navigasjon / events
       ========================= */
    const backButton = document.getElementById('backToAppBtn') || document.getElementById('backBtn');
    backButton?.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = 'app.html';
    });

    document.getElementById('randomFab').addEventListener('click', () => {
      const pool = (filteredRecipes && filteredRecipes.length) ? filteredRecipes : allRecipes;
      if (!pool.length) return;
      const r = pool[Math.floor(Math.random() * pool.length)];
      openRecipeModalById(r.id);
    });

    document.getElementById('resetFiltersBtn').addEventListener('click', () => {
      state.filters = { maxPrice: 70, people: 2, categories: [], allergies: [], quickOnly: false };
      document.getElementById('maxPrice').value = '70';
      updateMaxPriceLabel(70);
      document.getElementById('peopleCount').textContent = '2';
      document.querySelectorAll('.chip.active').forEach(chip => chip.classList.remove('active'));
      document.getElementById('quickToggle').classList.remove('active');
      currentServings = state.filters.people;
      applyFilters();
    });

    // Modal
    document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);
    // Knytter "Legg til i handlelista"-knappen til handleliste-tjenesten
    document.getElementById('addToShoppingBtn').addEventListener('click', addCurrentRecipeToShoppingList);

    // √Öpne handleliste med toast-parameter (brukes av handleliste.html for √• vise "la til X varer fra ‚Ä¶")
    document.getElementById('goToListBtn').addEventListener('click', () => {
      const name = encodeURIComponent(state.currentRecipe?.title || 'oppskrift');
      location.href = `handleliste.html?added=${name}`;
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    /* =========================
       Init
       ========================= */
    async function bootstrap() {
      if (!supa) {
        console.error('Supabase-klient mangler');
        return;
      }
      if (window.authHelpers?.initializeAuthListener) {
        window.authHelpers.initializeAuthListener(supa);
      }
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        if (window.location.pathname !== '/middag.html') {
          return;
        }
      }
      initPeopleFromHousehold();
      await loadBudgetData();
      setupFilters();
      await loadRecipes(); // henter middager fra JSON n√•r siden starter
      applyFilters();
      applyConfig(defaultConfig);
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>

  <!-- (Canva/Cloudflare-snutt beholdt ur√∏rt) -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99bfd0691443b4f7',t:'MTc2MjcxNzU2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
