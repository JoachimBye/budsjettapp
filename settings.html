<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Innstillinger - Husholdningsbudsjett</title>

  <!-- Element / Canva -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>

  <!-- Supabase + auth-helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>
  <script src="/auth-helpers.js"></script>
  <script src="/js/services/household-context.js"></script>
  <script src="/js/services/category-service.js"></script>
  <script src="/js/services/store-service.js"></script>
  <script src="/js/ui/toast.js"></script>

  <style>
    :root {
      --bg: #f2f2f7;
      --card: #ffffff;
      --green: #10b981;
      --text-strong: #1c1c1e;
      --text-muted: #636366;
      --divider: #e5e5ea;
      --destructive: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 40px;
      min-height: 100vh;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', system-ui, sans-serif;
      color: var(--text-strong);
    }

    .settings-shell {
      max-width: 780px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 26px;
    }

    .settings-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .back-button {
      height: 42px;
      min-width: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--divider);
      background: var(--card);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-strong);
      line-height: 1;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .back-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    .settings-title-group {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .settings-eyebrow {
      margin: 4px 0 6px;
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #8e8e93;
      font-weight: 700;
    }

    .settings-title {
      margin: 0 0 6px;
      font-size: 32px;
      font-weight: 800;
      color: var(--text-strong);
    }

    .settings-subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: 16px;
      line-height: 1.45;
      max-width: 620px;
    }

    .section-block {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-heading {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .heading-left {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .section-emoji {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: var(--card);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.07);
    }

    .section-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-strong);
    }

    .section-description {
      margin: 4px 0 0;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-muted);
    }

    .ghost-button {
      border: none;
      background: transparent;
      color: var(--green);
      padding: 8px 4px;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      min-height: 36px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: color 0.2s ease, transform 0.15s ease;
    }

    .ghost-button:hover {
      color: #0f8f63;
      transform: translateY(-1px);
    }

    .budget-card {
      background: linear-gradient(145deg, #ffffff 0%, #f7fbf8 100%);
      border-radius: 22px;
      padding: 18px 18px 16px;
      box-shadow: 0 16px 44px rgba(16, 24, 40, 0.08);
    }

    .budget-hero-label {
      text-align: center;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      color: #8e8e93;
      margin: 4px 0 8px;
    }

    .budget-hero-input {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 10px;
      padding: 18px 20px;
      background: var(--card);
      border-radius: 18px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    #weekly-budget {
      font-size: 46px;
      font-weight: 700;
      text-align: center;
      border: none;
      outline: none;
      width: 100%;
      background: transparent;
      color: #0f5132;
      padding: 0;
    }

    #weekly-budget::-webkit-outer-spin-button,
    #weekly-budget::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #weekly-budget[type=number] {
      -moz-appearance: textfield;
    }

    #weekly-budget::placeholder {
      color: #c4cfc8;
    }

    .budget-currency {
      font-size: 18px;
      font-weight: 600;
      color: #8a9a8d;
      padding-bottom: 8px;
    }

    .budget-note {
      text-align: center;
      margin: 10px 0 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .inset-card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }

    .settings-list {
      display: flex;
      flex-direction: column;
    }

    .list-row {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      background: var(--card);
    }

    .list-row:not(:first-child)::before {
      content: '';
      position: absolute;
      top: 0;
      left: 20px;
      right: 0;
      height: 1px;
      background: var(--divider);
    }

    .row-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
      cursor: text;
    }

    .row-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-strong);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .row-label.editable:hover {
      color: #0f5132;
    }

    .row-value {
      color: var(--text-strong);
      font-weight: 600;
      font-size: 15px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 30px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #e5e5ea;
      transition: 0.2s;
      border-radius: 999px;
    }

    .switch-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 2px;
      bottom: 2px;
      background: var(--card);
      transition: 0.2s;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }

    .switch input:checked + .switch-slider {
      background: var(--green);
    }

    .switch input:checked + .switch-slider:before {
      transform: translateX(20px);
    }

    .switch input:disabled + .switch-slider {
      opacity: 0.5;
    }

    .add-row {
      cursor: pointer;
      color: var(--green);
      font-weight: 700;
      justify-content: flex-start;
      gap: 12px;
    }

    .add-plus {
      font-size: 20px;
      width: 20px;
      display: inline-block;
    }

    button.list-row {
      width: 100%;
      border: none;
      background: var(--card);
      font: inherit;
      padding: 14px 16px;
    }

    .empty-text, .loading-text {
      color: var(--text-muted);
      font-size: 14px;
    }

    .note-row {
      align-items: flex-start;
    }

    .note-row .row-label {
      white-space: normal;
      line-height: 1.4;
      font-weight: 500;
      color: var(--text-muted);
    }

    .household-note {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .admin-link {
      color: #8e8e93;
      font-size: 13px;
      text-decoration: none;
      margin-top: 6px;
      display: inline-block;
    }

    .admin-link:hover {
      color: #6b7280;
      text-decoration: underline;
    }

    .save-indicator {
      display: none;
      background: var(--green);
      color: white;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .save-indicator.show {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .destructive-row {
      color: var(--destructive);
      font-weight: 700;
      justify-content: center;
      cursor: pointer;
    }

    .destructive-row:hover {
      background: #fff5f5;
    }

    .list-footnote {
      margin: 8px 4px 0 4px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    @media (max-width: 640px) {
      .settings-title {
        font-size: 26px;
      }

      .section-heading {
        flex-direction: column;
        align-items: flex-start;
      }

      .ghost-button {
        width: fit-content;
      }

      #weekly-budget {
        font-size: 40px;
      }
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" />
  <link rel="stylesheet" href="/css/driver-overrides.css" />
  <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js"></script>
  <script src="/js/ui/tour-manager.js"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <div class="settings-shell">
    <header class="settings-header">
      <button class="back-button" id="back-button" type="button" aria-label="Oversikt">‚Üê Oversikt</button>
      <div class="settings-title-group">
        <div class="settings-eyebrow">Husholdningsbudsjett</div>
        <h1 id="page-title" class="settings-title">Innstillinger</h1>
        <p id="page-subtitle" class="settings-subtitle">Tilpass budsjettet og hvordan appen fungerer for husholdningen deres.</p>
      </div>
    </header>

    <section class="section-block">
      <div class="section-heading">
        <div class="heading-left">
          <div class="section-emoji">üí∞</div>
          <div>
            <p class="section-title">Ukentlig budsjett</p>
            <p class="section-description">Sett standard ukesbudsjett for mat og husholdning.</p>
          </div>
        </div>
        <button class="ghost-button" id="save-budget-btn" type="button">
          Lagre
          <span id="budget-save-indicator" class="save-indicator">Lagret</span>
        </button>
      </div>
      <div class="budget-card">
        <div class="budget-hero-label">Bel√∏p per uke</div>
        <div class="budget-hero-input">
          <input type="number" id="weekly-budget" value="3000" placeholder="3000" inputmode="decimal" min="0">
          <span class="budget-currency">kr</span>
        </div>
        <p class="budget-note">Gjelder som standard for nye uker.</p>
      </div>
    </section>

    <section class="section-block">
      <div class="section-heading">
        <div class="heading-left">
          <div class="section-emoji">üß∫</div>
          <div>
            <p class="section-title">Kategorier for kj√∏p</p>
            <p class="section-description">Velg hvilke kategorier dere vil bruke n√•r dere legger inn kj√∏p.</p>
          </div>
        </div>
      </div>
      <div class="inset-card">
        <div class="settings-list" id="category-list">
          <div class="list-row note-row loading-text">Laster kategorier‚Ä¶</div>
        </div>
      </div>
      <p class="list-footnote">Tips: Du kan trykke p√• en kategori for √• endre navn.</p>
    </section>

    <section class="section-block">
      <div class="section-heading">
        <div class="heading-left">
          <div class="section-emoji">üè™</div>
          <div>
            <p class="section-title">Butikker</p>
            <p class="section-description">Tilpass listen over butikker som vises n√•r du legger inn kj√∏p.</p>
          </div>
        </div>
      </div>
      <div class="inset-card">
        <div class="settings-list" id="store-list">
          <div class="list-row note-row loading-text">Laster butikker‚Ä¶</div>
        </div>
      </div>
      <p class="list-footnote">Tips: Du kan trykke p√• en butikk for √• endre navn.</p>
    </section>

    <section class="section-block">
      <div class="section-heading">
        <div class="heading-left">
          <div class="section-emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <div>
            <p class="section-title">Husholdning &amp; konto</p>
            <p class="section-description">Disse innstillingene gjelder for alle som bruker husholdningen.</p>
          </div>
        </div>
      </div>
      <div class="inset-card">
        <div class="list-row">
          <div class="row-left">
            <span class="row-label">Husholdning</span>
          </div>
          <span class="row-value" id="household-name">Familien</span>
        </div>
        <div class="list-row note-row">
          <div class="row-left">
            <a href="#" class="admin-link">Administrer husholdning (kommer senere)</a>
          </div>
        </div>
      </div>
    </section>

    <section class="section-block">
      <div class="inset-card">
        <button class="list-row destructive-row" type="button" id="logout-btn">Logg ut</button>
        <button class="list-row destructive-row" type="button" id="delete-account-btn">Slett konto</button>
      </div>
    </section>
  </div>

<script>
  // --------- Element / Canva config ----------
  const defaultConfig = {
    page_title: "Innstillinger",
    page_subtitle: "Tilpass budsjettet og hvordan appen fungerer for husholdningen deres.",
    household_name: "Fam. Hansen",
    back_button_text: "Oversikt"
  };

  function onConfigChange(config) {
    document.getElementById('page-title').textContent =
      config.page_title || defaultConfig.page_title;
    document.getElementById('page-subtitle').textContent =
      config.page_subtitle || defaultConfig.page_subtitle;
    document.getElementById('household-name').textContent =
      config.household_name || defaultConfig.household_name;
    const backBtn = document.getElementById('back-button');
    const backText = config.back_button_text || defaultConfig.back_button_text;
    if (backBtn) {
      backBtn.textContent = `‚Üê ${backText}`;
      backBtn.setAttribute('aria-label', backText);
    }
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [],
      borderables: [],
      fontEditable: undefined,
      fontSizeable: undefined
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["page_title", config.page_title || defaultConfig.page_title],
      ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
      ["household_name", config.household_name || defaultConfig.household_name],
      ["back_button_text", config.back_button_text || defaultConfig.back_button_text]
    ]);
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities,
      mapToEditPanelValues
    });
  }

  // --------- Supabase / auth ----------
  const supa = window.supaClient?.getClient();
  const householdCtx = window.householdContext;

  let householdId = null;
  const BUDGET_SAVE_DELAY = 800;
  let budgetSaveTimeout = null;
  let budgetDirty = false;

  // --------- Kategori / butikk-innstillinger ----------
  const categoryService = window.categoryService || null;
  const storeService = window.storeService || null;
  const FALLBACK_CATEGORIES = categoryService?.DEFAULT_CATEGORIES || [
    { name: 'ü•ï Mat & dagligvarer', enabled: true },
    { name: 'üßΩ Husholdning & rengj√∏ring', enabled: true },
    { name: 'üçû Frokost & br√∏d', enabled: true },
    { name: 'üçø Snacks & kos', enabled: true },
    { name: 'ü•¨ Frukt & gr√∏nt', enabled: true },
    { name: 'üì¶ Annet', enabled: false }
  ];
  const FALLBACK_STORES = storeService?.DEFAULT_STORES || [
    { name: 'Kiwi', enabled: true },
    { name: 'Rema 1000', enabled: true },
    { name: 'Coop Extra', enabled: true },
    { name: 'Meny', enabled: true },
    { name: 'Spar', enabled: true },
    { name: 'Joker', enabled: false },
    { name: 'Bunnpris', enabled: false }
  ];

  function cloneList(list) {
    return Array.isArray(list) ? list.map(item => ({ ...item })) : [];
  }

  let categorySettings = [];
  let storeSettings = [];

  async function fetchCategories() {
    if (categoryService?.loadCategorySettings) {
      try {
        const list = await categoryService.loadCategorySettings(supa);
        if (Array.isArray(list)) {
          categorySettings = cloneList(list);
          return;
        }
      } catch (err) {
        console.error('Kunne ikke hente kategorier fra Supabase', err);
      }
    }
    categorySettings = cloneList(FALLBACK_CATEGORIES);
  }

  async function fetchStores() {
    if (storeService?.loadStoreSettings) {
      try {
        const list = await storeService.loadStoreSettings(supa);
        if (Array.isArray(list)) {
          storeSettings = cloneList(list);
          return;
        }
      } catch (err) {
        console.error('Kunne ikke hente butikker fra Supabase', err);
      }
    }
    storeSettings = cloneList(FALLBACK_STORES);
  }

  async function toggleCategory(catId, enabled) {
    if (!catId || !categoryService?.toggleCategoryEnabled) {
      const target = categorySettings.find((cat) => cat.id === catId);
      if (target) target.enabled = enabled;
      renderCategories();
      return;
    }
    try {
      categorySettings = await categoryService.toggleCategoryEnabled(supa, catId, enabled);
      renderCategories();
      showToast('Kategori oppdatert.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke oppdatere kategori.', 'error');
      renderCategories();
    }
  }

  async function renameCategory(catId, newName) {
    if (!catId || !categoryService?.updateCategoryName) return;
    try {
      categorySettings = await categoryService.updateCategoryName(supa, catId, newName);
      renderCategories();
      showToast('Kategori oppdatert.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke endre kategori.', 'error');
    }
  }

  async function renameStore(storeId, newName) {
    if (!storeId || !storeService?.updateStoreName) return;
    try {
      storeSettings = await storeService.updateStoreName(supa, storeId, newName);
      renderStores();
      showToast('Butikk oppdatert.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke endre butikk.', 'error');
    }
  }

  async function toggleStore(storeId, enabled) {
    if (!storeId || !storeService?.toggleStoreEnabled) {
      const target = storeSettings.find((store) => store.id === storeId);
      if (target) target.enabled = enabled;
      renderStores();
      return;
    }
    try {
      storeSettings = await storeService.toggleStoreEnabled(supa, storeId, enabled);
      renderStores();
      showToast('Butikk oppdatert.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke oppdatere butikk.', 'error');
      renderStores();
    }
  }

  function renderCategories() {
    const list = document.getElementById('category-list');
    if (!list) return;
    list.innerHTML = '';

    if (!Array.isArray(categorySettings) || categorySettings.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'list-row note-row';
      const label = document.createElement('span');
      label.className = 'row-label';
      label.textContent = 'Ingen kategorier enn√•. Legg til deres f√∏rste kategori.';
      empty.appendChild(label);
      list.appendChild(empty);
    } else {
      categorySettings.forEach((cat, index) => {
        const row = document.createElement('div');
        row.className = 'list-row';
        row.dataset.index = String(index);
        row.dataset.id = cat.id || '';
        row.innerHTML = `
          <div class="row-left">
            <span class="row-label editable"></span>
          </div>
          <label class="switch">
            <input type="checkbox">
            <span class="switch-slider"></span>
          </label>
        `;

        const checkbox = row.querySelector('input[type="checkbox"]');
        const nameEl = row.querySelector('.row-label');
        const editArea = row.querySelector('.row-left');

        const labelText = cat.name || 'Kategori';

        if (nameEl) {
          nameEl.textContent = labelText;
        }

        if (checkbox) {
          checkbox.checked = !!cat.enabled;
          checkbox.setAttribute('aria-label', `Aktiver ${labelText}`);
          checkbox.addEventListener('change', async () => {
            checkbox.disabled = true;
            await toggleCategory(cat.id, checkbox.checked);
            checkbox.disabled = false;
          });
        }

        if (editArea) {
          editArea.addEventListener('click', async () => {
            const current = categorySettings[index].name || '';
            const newName = prompt('Nytt navn p√• kategori:', current);
            if (!newName) return;
            const trimmed = newName.trim();
            if (!trimmed || trimmed === current.trim()) return;
            if (!cat.id || !categoryService?.updateCategoryName) {
              categorySettings[index].name = trimmed;
              if (categoryService?.saveCategorySettings) {
                categoryService.saveCategorySettings(categorySettings);
              }
              renderCategories();
              return;
            }
            await renameCategory(cat.id, trimmed);
          });
        }

        list.appendChild(row);
      });
    }

    const addRow = document.createElement('button');
    addRow.type = 'button';
    addRow.className = 'list-row add-row';
    addRow.innerHTML = `
      <span class="add-plus">+</span>
      <span class="row-label">Legg til ny kategori</span>
    `;
    addRow.addEventListener('click', () => promptNewCategory());
    list.appendChild(addRow);
  }

  function renderStores() {
    const list = document.getElementById('store-list');
    if (!list) return;
    list.innerHTML = '';

    if (!Array.isArray(storeSettings) || storeSettings.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'list-row note-row';
      const label = document.createElement('span');
      label.className = 'row-label';
      label.textContent = 'Ingen butikker registrert enn√•.';
      empty.appendChild(label);
      list.appendChild(empty);
    } else {
      storeSettings.forEach((store, index) => {
        const row = document.createElement('div');
        row.className = 'list-row';
        row.dataset.index = String(index);
        row.dataset.id = store.id || '';
        row.innerHTML = `
          <div class="row-left">
            <span class="row-label editable"></span>
          </div>
          <label class="switch">
            <input type="checkbox">
            <span class="switch-slider"></span>
          </label>
        `;

        const checkbox = row.querySelector('input[type="checkbox"]');
        const nameEl = row.querySelector('.row-label');
        const editArea = row.querySelector('.row-left');

        const labelText = store.name || 'Butikk';

        if (nameEl) {
          nameEl.textContent = labelText;
        }

        if (checkbox) {
          checkbox.checked = store.enabled !== false;
          checkbox.setAttribute('aria-label', `Aktiver ${labelText}`);
          checkbox.addEventListener('change', async () => {
            checkbox.disabled = true;
            await toggleStore(store.id, checkbox.checked);
            checkbox.disabled = false;
          });
        }

        if (editArea) {
          editArea.addEventListener('click', async () => {
            const current = storeSettings[index].name || '';
            const newName = prompt('Nytt navn p√• butikk:', current);
            if (!newName) return;
            const trimmed = newName.trim();
            if (!trimmed || trimmed === current.trim()) return;
            if (!store.id || !storeService?.updateStoreName) {
              storeSettings[index].name = trimmed;
              if (storeService?.saveStoreSettings) {
                storeService.saveStoreSettings(storeSettings);
              }
              renderStores();
              return;
            }
            await renameStore(store.id, trimmed);
          });
        }

        list.appendChild(row);
      });
    }

    const addRow = document.createElement('button');
    addRow.type = 'button';
    addRow.className = 'list-row add-row';
    addRow.innerHTML = `
      <span class="add-plus">+</span>
      <span class="row-label">Legg til ny butikk</span>
    `;
    addRow.addEventListener('click', () => promptNewStore());
    list.appendChild(addRow);
  }

  function showToast(message, type = 'info') {
    if (window.toast?.show) {
      window.toast.show(message, { type });
      return;
    }
    const el = document.createElement('div');
    el.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      background: ${type === 'success' ? '#10b981' :
                    type === 'error'   ? '#dc2626' :
                                         '#3b82f6'};
    `;
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  function clearBudgetSaveTimer() {
    if (budgetSaveTimeout) {
      clearTimeout(budgetSaveTimeout);
      budgetSaveTimeout = null;
    }
  }

  function scheduleBudgetSave() {
    budgetDirty = true;
    const indicator = document.getElementById('budget-save-indicator');
    indicator?.classList.remove('show');
    clearBudgetSaveTimer();
    const input = document.getElementById('weekly-budget');
    const currentValue = input ? String(input.value).trim() : '';
    if (!currentValue) return;
    budgetSaveTimeout = setTimeout(() => {
      budgetDirty = false;
      saveBudget();
    }, BUDGET_SAVE_DELAY);
  }

  function flushBudgetSave() {
    if (!budgetDirty) return;
    clearBudgetSaveTimer();
    budgetDirty = false;
    saveBudget();
  }

  async function loadSettings() {
    if (!supa || !householdCtx?.getHouseholdId) {
      showToast('Supabase ikke tilgjengelig.', 'error');
      return;
    }
    try {
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = '/innlogging.html';
        return;
      }

      const resolvedHouseholdId = await householdCtx.getHouseholdId(supa);
      if (!resolvedHouseholdId) {
        showToast('Fant ikke husstand for brukeren.', 'error');
        return;
      }

      householdId = resolvedHouseholdId;

      // Hent husstandens navn + default_weekly_budget
      const { data: household, error: hErr } = await supa
        .from('households')
        .select('name, default_weekly_budget')
        .eq('id', householdId)
        .maybeSingle();

      if (hErr) {
        console.error(hErr);
        showToast('Kunne ikke hente husstandsinnstillinger.', 'error');
        return;
      }

      const budgetInput = document.getElementById('weekly-budget');
      const nameEl = document.getElementById('household-name');

      const defaultBudget = household?.default_weekly_budget ?? 3000;
      if (budgetInput) {
        budgetInput.value = defaultBudget;
      }
      localStorage.setItem('weeklyBudget', String(defaultBudget));
      budgetDirty = false;
      clearBudgetSaveTimer();

      if (household?.name && nameEl) {
        nameEl.textContent = household.name;
      }
    } catch (err) {
      console.error(err);
      showToast('Ukjent feil ved henting av innstillinger.', 'error');
    }
  }

  async function saveBudget() {
    if (!householdId) {
      showToast('Husstand ikke klar enn√•.', 'error');
      return;
    }

    const input = document.getElementById('weekly-budget');
    if (!input) return;

    let value = parseInt(input.value, 10);
    if (!isFinite(value) || value <= 0) {
      value = 3000;
      input.value = value;
    }

    const indicator = document.getElementById('budget-save-indicator');

    try {
      const { error } = await supa
        .from('households')
        .update({ default_weekly_budget: value })
        .eq('id', householdId);

      if (error) {
        console.error(error);
        showToast('Kunne ikke lagre budsjett.', 'error');
        return;
      }

      localStorage.setItem('weeklyBudget', String(value));
      budgetDirty = false;
      clearBudgetSaveTimer();
      indicator?.classList.add('show');
      showToast('Budsjett lagret for husstanden.', 'success');

      setTimeout(() => indicator?.classList.remove('show'), 2000);
    } catch (err) {
      console.error(err);
      showToast('Ukjent feil ved lagring.', 'error');
    }
  }

  function promptNewCategory() {
    const name = prompt('Navn p√• ny kategori:');
    if (!name) return;
    addCategory(name);
  }

  function promptNewStore() {
    const name = prompt('Navn p√• ny butikk:');
    if (!name) return;
    addStore(name);
  }

  async function addCategory(nameFromPrompt = null) {
    const input = document.getElementById('new-category');
    const rawName = nameFromPrompt !== null ? nameFromPrompt : (input?.value || '');
    const name = rawName.trim();
    if (!name) return;

    const fullName = name.startsWith('üì¶') ? name : `üì¶ ${name}`;
    try {
      if (categoryService?.addCategory) {
        categorySettings = await categoryService.addCategory(supa, fullName);
      } else {
        categorySettings.push({ name: fullName, enabled: true });
        if (categoryService?.saveCategorySettings) {
          categoryService.saveCategorySettings(categorySettings);
        }
      }
      renderCategories();
      if (!nameFromPrompt && input) {
        input.value = '';
      }
      showToast('Kategori lagt til.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke lagre kategori.', 'error');
    }
  }

  async function addStore(nameFromPrompt = null) {
    const input = document.getElementById('new-store');
    const rawName = nameFromPrompt !== null ? nameFromPrompt : (input?.value || '');
    const name = rawName.trim();
    if (!name) return;

    const alreadyExists = storeSettings.some(
      (store) => (store.name || '').toLowerCase() === name.toLowerCase()
    );
    if (alreadyExists) {
      showToast('Butikken finnes allerede.', 'error');
      return;
    }

    try {
      if (storeService?.addStore) {
        storeSettings = await storeService.addStore(supa, name);
      } else {
        storeSettings.push({ name, enabled: true });
        if (storeService?.saveStoreSettings) {
          storeService.saveStoreSettings(storeSettings);
        }
      }
      renderStores();
      if (!nameFromPrompt && input) {
        input.value = '';
      }
      showToast('Butikk lagret.', 'success');
    } catch (err) {
      console.error(err);
      showToast('Kunne ikke lagre butikk.', 'error');
    }
  }

  async function doLogout() {
    try {
      if (window.authHelpers?.handleLogout) {
        await window.authHelpers.handleLogout(supa);
        return; // handleLogout tar seg av redirect + localStorage-rydding
      } else {
        await supa.auth.signOut();
        window.location.href = '/innlogging.html';
      }
    } catch (err) {
      console.error(err);
      showToast('Klarte ikke √• logge ut.', 'error');
    }
  }

  function goBack() {
    window.location.href = 'app.html';
  }

  async function init() {
    if (!supa) {
      console.error('Supabase-klient mangler');
      return;
    }
    // Auth guard
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/settings.html') {
        return;
      }
    }

    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    }

    await loadSettings();

    const categoryList = document.getElementById('category-list');
    const storeList = document.getElementById('store-list');
    if (categoryList) {
      categoryList.innerHTML = '<div class="list-row note-row loading-text">Laster kategorier‚Ä¶</div>';
    }
    if (storeList) {
      storeList.innerHTML = '<div class="list-row note-row loading-text">Laster butikker‚Ä¶</div>';
    }

    await fetchCategories();
    renderCategories();

    await fetchStores();
    renderStores();

    // Knapper
    const saveBudgetBtn = document.getElementById('save-budget-btn');
    if (saveBudgetBtn) {
      saveBudgetBtn.addEventListener('click', saveBudget);
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', doLogout);
    }

    const deleteAccountBtn = document.getElementById('delete-account-btn');
    if (deleteAccountBtn) {
      deleteAccountBtn.addEventListener('click', () => {
        window.location.href = 'slett-meg.html';
      });
    }

    const backBtn = document.getElementById('back-button');
    if (backBtn) {
      backBtn.addEventListener('click', goBack);
    }

    const budgetInput = document.getElementById('weekly-budget');
    if (budgetInput) {
      budgetInput.addEventListener('input', scheduleBudgetSave);
      budgetInput.addEventListener('blur', flushBudgetSave);
    }

    // Legacy inputs (om vi vil bruke Enter-tasten via skjult felt)
    const newCategoryInput = document.getElementById('new-category');
    if (newCategoryInput) {
      newCategoryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addCategory();
        }
      });
    }

    const newStoreInput = document.getElementById('new-store');
    if (newStoreInput) {
      newStoreInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addStore();
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await init();

    // Vent for sikkerhets skyld til at lister er rendret
    await window.tourManager?.waitFor('#category-list .list-row');
    await window.tourManager?.waitFor('#store-list .list-row');

    window.tourManager?.startTourIfNeeded({
      tourId: 'settings',
      version: 1,
      options: {
        nextBtnText: 'Neste',
        prevBtnText: 'Tilbake',
        doneBtnText: 'Ferdig',
      },
      steps: [
        {
          element: '.budget-card',
          popover: {
            title: 'Ukesbudsjettet deres',
            description: 'Her setter dere summen dere √∏nsker √• bruke p√• mat og husholdning hver uke.',
            side: 'bottom'
          }
        },
        {
          element: '#category-list',
          popover: {
            title: 'Kategorier for kj√∏p',
            description: 'Skru av kategorier dere ikke bruker, og trykk p√• navnet for √• endre tekst eller emoji.',
            side: 'right'
          }
        },
        {
          element: '#store-list',
          popover: {
            title: 'Butikker',
            description: 'Tilpass listen over butikker som vises n√•r dere legger inn nye kj√∏p.',
            side: 'right'
          }
        },
        {
          element: '#logout-btn',
          popover: {
            title: 'Logg ut',
            description: 'Her kan du logge ut eller bytte husholdning.',
            side: 'top'
          }
        }
      ]
    });
  });
</script>
</body>
</html>
