<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Husholdningsbudsjett - Hovedskjerm</title>

  <!-- Element SDK (valgfri redigering/tema) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>

  <style>
    body{
      box-sizing:border-box;margin:0;padding:0;height:100%;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      display:flex;flex-direction:column;
    }
    html{height:100%;}
    .container{flex:1;display:flex;flex-direction:column;padding:30px;max-width:800px;margin:0 auto;width:100%;}

    .header{
      text-align:center;
      margin-bottom:32px;
      animation:fadeInDown .6s ease-out;
    }
    .week-header-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .week-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 18px;
      border-radius:9999px;
      background:#4caf50;
      color:#ffffff;
      font-weight:600;
      font-size:14px;
      box-shadow:0 4px 12px rgba(76,175,80,.35);
      transition:all .2s ease;
    }
    .week-pill:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(76,175,80,.4);
    }
    .week-range{
      margin:0;
      font-size:18px;
      color:#5a7a6d;
      font-weight:500;
    }

    .settings-btn{
  position:fixed;
  top:16px;
  left:16px;
  z-index:50;
  background:#ffffff;
  color:#2d5f4d;
  border:2px solid #e0e7e3;
  padding:10px 18px;
  font-size:16px;
  font-weight:700;
  border-radius:9999px;
  cursor:pointer;
  transition:all .2s ease;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

.settings-btn:hover{
  background:#f5f8f6;
  border-color:#c8d4cb;
  color:#1f2933;
}

    /* Logout knapp √∏verst til h√∏yre */
    .logout-btn{
      position:fixed;top:16px;right:16px;z-index:50;
      background:transparent;color:#8a9a8d;border:2px solid #e0e7e3;
      padding:10px 16px;font-size:14px;font-weight:600;border-radius:9999px;
      cursor:pointer;transition:all .2s ease;
    }
    .logout-btn:hover{background:#f5f8f6;border-color:#c8d4cb;color:#5a7a6d;}

    .budget-overview{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:40px;animation:fadeInUp .8s ease-out .2s both;}
    .budget-circle{position:relative;width:280px;height:280px;margin-bottom:30px;}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden;}
    .circle-progress{
      --ring-color:#4caf50; --ring-deg:0deg;
      position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;
      background:conic-gradient(var(--ring-color) 0deg, var(--ring-color) var(--ring-deg), transparent var(--ring-deg));
      transition:background .6s ease-out;
    }
    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;}
    .spent-amount{font-size:36px;font-weight:800;color:#2d5f4d;margin-bottom:8px;}
    .total-budget{font-size:20px;color:#5a7a6d;margin-bottom:15px;}
    .remaining-info{background:rgba(76,175,80,.1);padding:15px 25px;border-radius:25px;margin-bottom:20px;animation:fadeInUp .8s ease-out .3s both;}
    .remaining-amount{font-size:28px;font-weight:700;color:#4caf50;margin:0;}
    .remaining-text{font-size:16px;color:#2d5f4d;margin:5px 0 0 0;}
    .remaining-info.warn{background:rgba(249,168,37,.12);}
    .remaining-info.over{background:rgba(211,47,47,.12);}
    .remaining-amount.warn{color:#f9a825;}
    .remaining-amount.over{color:#d32f2f;}

    .meal-button{
      background:#4caf50;color:#fff;border:none;border-radius:20px;
      padding:15px 25px;font-size:18px;font-weight:600;cursor:pointer;
      transition:background .2s, transform .1s;margin-bottom:40px;
      box-shadow:0 4px 12px rgba(76,175,80,.25);
    }
    .meal-button:hover{background:#45a049;transform:translateY(-2px);}
    .meal-button:active{transform:translateY(0);}

    .action-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;animation:fadeInUp .8s ease-out .4s both;}
    .action-button{background:#fff;border:3px solid #e8f5f0;border-radius:20px;padding:25px 20px;cursor:pointer;transition:all .3s ease;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .action-button:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(76,175,80,.15);border-color:#4caf50;}
    .action-button:active{transform:translateY(-2px);}
    .action-icon{font-size:40px;margin-bottom:12px;display:block;}
    .action-text{font-size:18px;font-weight:600;color:#2d5f4d;margin:0;}

    .status-bar{text-align:center;padding:20px;background:rgba(255,255,255,.7);border-radius:15px;animation:fadeInUp .8s ease-out .5s both;}
    .status-message{font-size:18px;color:#5a7a6d;font-weight:500;margin:0;}
    .pulse{animation:pulse 2s ease-in-out;}

    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}

    @media (max-width:768px){
      .container{padding:20px;}
      .budget-circle{width:240px;height:240px;}
      .spent-amount{font-size:28px;}
      .remaining-amount{font-size:24px;}
      .action-buttons{grid-template-columns:1fr;gap:15px;}
      .action-button{min-height:100px;padding:20px;}
      .action-icon{font-size:32px;}
      .action-text{font-size:16px;}
      .meal-button{width:100%;}
      .week-range{font-size:16px;}
    }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <!-- Logg ut -->
  <button class="logout-btn" id="logoutBtn" title="Logg ut" aria-label="Logg ut">Logg ut</button>
  <button class="settings-btn" id="settingsBtn" title="Innstillinger" aria-label="Innstillinger">
  Innstillinger
</button>

  <main class="container">
    <!-- Uke-header -->
    <div class="header">
      <div class="week-header-inner">
        <div class="week-pill">
          <span id="weekText">Uke 0</span>
        </div>
        <p class="week-range" id="dateRange">dd.‚Äìdd. mmmm</p>
      </div>
    </div>

    <div class="budget-overview">
      <div class="budget-circle">
        <div class="circle-bg">
          <div class="circle-progress" id="circleProgress"></div>
        </div>
        <div class="circle-content">
          <div class="spent-amount" id="spentAmount">0 kr</div>
          <div class="total-budget" id="totalBudget">av 0 kr</div>
        </div>
      </div>

      <div class="remaining-info" id="remainingBox">
        <div class="remaining-amount" id="remainingAmount">0 kr</div>
        <div class="remaining-text" id="remainingText">igjen denne uka</div>
      </div>

      <button class="meal-button" id="mealPlanBtn">Middag for 0 kr ‚Äì vis forslag</button>
    </div>

    <div class="action-buttons">
      <button class="action-button" id="addPurchaseBtn">
        <span class="action-icon">‚ûï</span>
        <span class="action-text" id="addPurchaseText">Legg til kj√∏p</span>
      </button>
      <button class="action-button" id="shoppingListBtn">
        <span class="action-icon">üõí</span>
        <span class="action-text" id="shoppingListText">Handleliste</span>
      </button>
      <button class="action-button" id="weekReportBtn">
        <span class="action-icon">üìä</span>
        <span class="action-text" id="weekReportText">Ukesrapport</span>
      </button>
    </div>

    <div class="status-bar">
      <p class="status-message" id="statusMessage">Bra kontroll s√• langt üí™</p>
    </div>
  </main>

<script>
  // ===== Supabase init ===================================================
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===== Element/tema konfig ============================================
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    week_text: "",
    spent_text: "Du har brukt",
    remaining_text: "igjen denne uka",
    add_purchase_text: "Legg til kj√∏p",
    shopping_list_text: "Handleliste",
    week_report_text: "Ukesrapport",
    status_message: "Bra kontroll s√• langt üí™"
  };

  // ===== Global state ====================================================
  const state = {
    activeWeekISO: '',
    budget: 0,
    spent: 0,
    remaining: 0
  };

  // ---------- Uke-hjelpere ----------------------------------------------
  function mondayAtNoon(d = new Date()){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (x.getDay()+6)%7; // 0=man
    x.setDate(x.getDate()-day);
    x.setHours(12,0,0,0);
    return x;
  }

  function isoWeekNumber(date = new Date()) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function formatRangeNoNO(fromDate, toDate) {
    const optsDayMonth = { day:'numeric', month:'long' };
    const optsDay = { day:'numeric' };
    const from = fromDate.toLocaleDateString('no-NO', optsDayMonth);
    const to = toDate.toLocaleDateString(
      'no-NO',
      (fromDate.getMonth()===toDate.getMonth()? optsDay : optsDayMonth)
    );
    return `${from}‚Äì${to}`;
  }

  function getActiveWeekISO(){
    let iso = localStorage.getItem('activeWeekISO');
    if (!iso) {
      iso = mondayAtNoon().toISOString().slice(0,10);
      localStorage.setItem('activeWeekISO', iso);
    }
    return iso;
  }

  function getActiveMondayDate(){
    const iso = state.activeWeekISO || getActiveWeekISO();
    const [y,m,d] = iso.split('-').map(Number);
    return new Date(y, m-1, d, 12, 0, 0, 0);
  }

  function setWeekHeader() {
    const mon = getActiveMondayDate();
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    const weekNo = isoWeekNumber(mon);

    const weekTextEl = document.getElementById('weekText');
    const dateRangeEl = document.getElementById('dateRange');
    if (weekTextEl) weekTextEl.textContent = `Uke ${weekNo}`;
    if (dateRangeEl) dateRangeEl.textContent = formatRangeNoNO(mon, sun);
  }

  // ---------- Local fallback for budsjett/kj√∏p --------------------------
  function readWeeklyBudgetLocal(isoMonday){
    const byWeek = parseInt(localStorage.getItem(`weeklyBudget_${isoMonday}`) || '', 10);
    if (!isNaN(byWeek) && byWeek > 0) return byWeek;
    const global = parseInt(localStorage.getItem('weeklyBudget') || '', 10);
    if (!isNaN(global) && global > 0) return global;
    return 3000;
  }

  function sumPurchasesLocal(isoMonday) {
    const key = `purchases_${isoMonday}`;
    try {
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      return Array.isArray(arr)
        ? arr.reduce((acc, p) => acc + (Number(p.amount)||0), 0)
        : 0;
    } catch {
      return 0;
    }
  }

  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  // ---------- Hent uke-data fra Supabase + cache til localStorage -------
  async function loadWeekData() {
    const iso = state.activeWeekISO || getActiveWeekISO();
    state.activeWeekISO = iso;

    // 1) Budsjett ‚Äì start med local fallback
    let budget = readWeeklyBudgetLocal(iso);

    try {
      const { data:{ session } } = await supa.auth.getSession();

      if (session) {
        // F√∏rst: pr√∏v household_budgets (uke-spesifikt)
        const { data: budgetRow, error: bErr } = await supa
          .from('household_budgets')
          .select('amount')
          .eq('user_id', session.user.id)
          .eq('week_start', iso)
          .maybeSingle();

        if (!bErr && budgetRow && typeof budgetRow.amount === 'number') {
          budget = budgetRow.amount;
        } else {
          // Hvis ingen rad for denne uka ‚Üí bruk husstandens standardbudsjett
          const { data: member, error: mErr } = await supa
            .from('members')
            .select('household_id')
            .eq('user_id', session.user.id)
            .maybeSingle();

          if (!mErr && member?.household_id) {
            const { data: household, error: hErr } = await supa
              .from('households')
              .select('default_weekly_budget')
              .eq('id', member.household_id)
              .maybeSingle();

            if (!hErr && household && typeof household.default_weekly_budget === 'number') {
              budget = household.default_weekly_budget;
            }
          }
        }

        // Speil uansett siste ‚Äúsanne‚Äù budsjett til localStorage
        if (budget) {
          localStorage.setItem(`weeklyBudget_${iso}`, String(budget));
          localStorage.setItem('weeklyBudget', String(budget));
        }
      }
    } catch (err) {
      console.warn('Feil ved henting budsjett:', err);
    }

    state.budget = Number(budget) || 0;
    localStorage.setItem('budget_total', String(state.budget));

    // 2) Kj√∏p ‚Äì prim√¶rkilde: Supabase; fallback: localStorage
    let spent = 0;

    try {
      const { data: rows, error } = await supa
        .from('purchases')
        .select('amount, category')
        .eq('week_start', iso);

      if (!error && rows) {
        // cache hele listen slik at week-report kan lese den fra localStorage
        localStorage.setItem(`purchases_${iso}`, JSON.stringify(rows));
        spent = rows.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
      } else if (error) {
        console.warn('Feil ved henting kj√∏p (DB):', error);
        spent = sumPurchasesLocal(iso);
      }
    } catch (err) {
      console.warn('Feil ved henting kj√∏p (nett):', err);
      spent = sumPurchasesLocal(iso);
    }

    state.spent = spent;
    state.remaining = state.budget - state.spent;
  }

  // ---------- Oppdater UI ----------------------------------------------
  function updateBudgetDisplay() {
    const spentElement     = document.getElementById('spentAmount');
    const totalElement     = document.getElementById('totalBudget');
    const remainingElement = document.getElementById('remainingAmount');
    const remainingText    = document.getElementById('remainingText');
    const remainingBox     = document.getElementById('remainingBox');
    const circleProgress   = document.getElementById('circleProgress');
    const statusMsg        = document.getElementById('statusMessage');
    const mealBtn          = document.getElementById('mealPlanBtn');

    const total = state.budget;
    const spent = state.spent;
    const remainingRaw = total > 0 ? (total - spent) : 0;
    state.remaining = remainingRaw;

    spentElement.textContent = `${formatAmount(spent)} kr`;
    totalElement.textContent = `av ${formatAmount(total)} kr`;

    let color = '#4caf50';
    let ringDeg = 0;
    let status = 'Bra kontroll s√• langt üí™';

    if (total > 0) {
      const ratio = spent / total;
      ringDeg = Math.min(360, Math.max(0, ratio * 360));

      if (ratio >= 1.0) {
        color = '#d32f2f';
        ringDeg = 360;
        remainingBox.classList.remove('warn'); remainingBox.classList.add('over');
        remainingElement.classList.remove('warn'); remainingElement.classList.add('over');
        remainingElement.textContent = `${formatAmount(Math.abs(remainingRaw))} kr`;
        remainingText.textContent = 'overskredet';
        status = 'Over budsjett ‚Äì kutt kostnader üí∏';
      } else if (ratio >= 0.9) {
        color = '#f9a825';
        remainingBox.classList.remove('over'); remainingBox.classList.add('warn');
        remainingElement.classList.remove('over'); remainingElement.classList.add('warn');
        remainingElement.textContent = `${formatAmount(remainingRaw)} kr`;
        remainingText.textContent = 'igjen denne uka';
        status = 'N√¶r budsjett ‚Äì vurder billigere valg ‚ö†Ô∏è';
      } else {
        color = '#4caf50';
        remainingBox.classList.remove('over','warn');
        remainingElement.classList.remove('over','warn');
        remainingElement.textContent = `${formatAmount(remainingRaw)} kr`;
        remainingText.textContent = 'igjen denne uka';
        status = 'Bra kontroll s√• langt üí™';
      }
    } else {
      color = '#4caf50';
      ringDeg = 0;
      remainingBox.classList.remove('over','warn');
      remainingElement.classList.remove('over','warn');
      remainingElement.textContent = `0 kr`;
      remainingText.textContent = 'sett ukesbudsjett i innstillinger';
      status = 'Sett et ukesbudsjett for √• komme i gang üôÇ';
    }

    circleProgress.style.setProperty('--ring-color', color);
    circleProgress.style.setProperty('--ring-deg', `${ringDeg}deg`);

    if (mealBtn) {
      mealBtn.textContent = (state.remaining < 0)
        ? `Middag ‚Äì billige forslag`
        : `Middag for ${formatAmount(state.remaining)} kr ‚Äì vis forslag`;
    }

    statusMsg.textContent = status;

    [spentElement, remainingElement].forEach(el => {
      el.classList.add('pulse');
      setTimeout(()=>el.classList.remove('pulse'), 600);
    });
  }

  // ---------- Farge/tema fra Element SDK -------------------------------
  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''),16), amt=Math.round(2.55*percent);
    const R=Math.max(0,Math.min(255,(num>>16)+amt));
    const G=Math.max(0,Math.min(255,((num>>8)&0x00FF)+amt));
    const B=Math.max(0,Math.min(255,((num)&0x0000FF)+amt));
    return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
  }

  async function onConfigChange(config) {
    const backgroundColor    = config.background_color    || defaultConfig.background_color;
    const surfaceColor       = config.surface_color       || defaultConfig.surface_color;
    const textColor          = config.text_color          || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color|| defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color|| defaultConfig.secondary_text_color;
    const customFont         = config.font_family         || defaultConfig.font_family;
    const baseSize           = config.font_size           || defaultConfig.font_size;

    document.body.style.background =
      `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-2)} 100%)`;

    const elements = [
      { id: 'weekText',        size: baseSize * 0.9,  color: '#ffffff' },
      { id: 'dateRange',       size: baseSize * 1.05, color: secondaryTextColor },
      { id: 'spentAmount',     size: baseSize * 2,    color: textColor },
      { id: 'totalBudget',     size: baseSize * 1.11, color: secondaryTextColor },
      { id: 'remainingAmount', size: baseSize * 1.56, color: primaryActionColor },
      { id: 'remainingText',   size: baseSize * 0.89, color: textColor },
      { id: 'statusMessage',   size: baseSize,        color: secondaryTextColor }
    ];
    elements.forEach(el => {
      const node = document.getElementById(el.id);
      if (!node) return;
      node.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      node.style.fontSize = `${el.size}px`;
      node.style.color = el.color;
    });

    const weekPill = document.querySelector('.week-pill');
    if (weekPill) {
      weekPill.style.background = primaryActionColor;
      weekPill.style.color = '#ffffff';
    }

    document.querySelectorAll('.action-text').forEach(t=>{
      t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      t.style.color = textColor;
    });
    document.querySelectorAll('.action-button').forEach(b=>{
      b.style.background = surfaceColor;
      b.style.borderColor = adjustColor(primaryActionColor, 60);
    });

    const circleBg     = document.querySelector('.circle-bg');
    const remainingInfo= document.querySelector('.remaining-info');
    const statusBar    = document.querySelector('.status-bar');
    if (circleBg)      circleBg.style.background = adjustColor(primaryActionColor, 85);
    if (remainingInfo) remainingInfo.style.background = `${primaryActionColor}1a`;
    if (statusBar)     statusBar.style.background = `${surfaceColor}b3`;
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ background_color: v }) },
        { get: () => config.surface_color || defaultConfig.surface_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ surface_color: v }) },
        { get: () => config.text_color || defaultConfig.text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ text_color: v }) },
        { get: () => config.primary_action_color || defaultConfig.primary_action_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ primary_action_color: v }) },
        { get: () => config.secondary_text_color || defaultConfig.secondary_text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ secondary_text_color: v }) },
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_family: v })
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_size: v })
      }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["week_text",          config.week_text          || defaultConfig.week_text],
      ["spent_text",         config.spent_text         || defaultConfig.spent_text],
      ["remaining_text",     config.remaining_text     || defaultConfig.remaining_text],
      ["add_purchase_text",  config.add_purchase_text  || defaultConfig.add_purchase_text],
      ["shopping_list_text", config.shopping_list_text || defaultConfig.shopping_list_text],
      ["week_report_text",   config.week_report_text   || defaultConfig.week_report_text],
      ["status_message",     config.status_message     || defaultConfig.status_message]
    ]);
  }

  // ---------- Navigasjon ------------------------------------------------
  document.getElementById('addPurchaseBtn').addEventListener('click', () => {
    location.href = 'add-purchase.html';
  });
  document.getElementById('shoppingListBtn').addEventListener('click', () => {
    location.href = 'handleliste.html';
  });
  document.getElementById('weekReportBtn').addEventListener('click', () => {
    location.href = 'week-report.html';
  });
  document.getElementById('mealPlanBtn').addEventListener('click', () => {
    location.href = 'middag.html';
  });

  document.getElementById('settingsBtn').addEventListener('click', () => {
  location.href = 'innstillinger.html'; // bytt navn hvis filen heter noe annet
});

  // ---------- Auth + bootstrapping -------------------------------------
  async function main() {
    const logoutBtn = document.getElementById('logoutBtn');

    // Logout-knapp
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        if (window.authHelpers?.handleLogout) {
          window.authHelpers.handleLogout(supa);
        } else {
          supa.auth.signOut().finally(() => {
            window.location.href = '/innlogging.html';
          });
        }
      });
    }

    // Global auth-listener
    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    } else {
      try {
        supa.auth.onAuthStateChange((event) => {
          if (event === 'SIGNED_OUT' && window.location.pathname !== '/innlogging.html') {
            window.location.href = '/innlogging.html';
          }
        });
      } catch {}
    }

    // Auth-guard
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/app.html') return;
    } else {
      const { data:{ session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = '/innlogging.html';
        return;
      }
    }

    // Sett uke og last data
    state.activeWeekISO = getActiveWeekISO();
    await loadWeekData();
    setWeekHeader();
    updateBudgetDisplay();

    // Element SDK init
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  }

  window.addEventListener('DOMContentLoaded', main);

  // N√•r man kommer tilbake via tilbakeknappen (BFCache), refreshe tall
  window.addEventListener('pageshow', async (event) => {
    if (event.persisted) {
      state.activeWeekISO = getActiveWeekISO();
      await loadWeekData();
      setWeekHeader();
      updateBudgetDisplay();
    }
  });
</script>
</body>
</html>
