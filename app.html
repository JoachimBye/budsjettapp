<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Husholdningsbudsjett - Hovedskjerm</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);display:flex;flex-direction:column;}
    html{height:100%;}
    .container{flex:1;display:flex;flex-direction:column;padding:30px;max-width:800px;margin:0 auto;width:100%;}
    .header{text-align:center;margin-bottom:40px;animation:fadeInDown .6s ease-out;}
    .week-info{font-size:20px;color:#5a7a6d;font-weight:500;}
    .budget-overview{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:40px;animation:fadeInUp .8s ease-out .2s both;}
    .budget-circle{position:relative;width:280px;height:280px;margin-bottom:30px;}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden;}
    .circle-progress{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:conic-gradient(#4caf50 0deg,#4caf50 216deg,transparent 216deg);transition:all .8s ease-out;}
    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;}
    .spent-amount{font-size:36px;font-weight:800;color:#2d5f4d;margin-bottom:8px;}
    .total-budget{font-size:20px;color:#5a7a6d;margin-bottom:15px;}
    .remaining-info{background:rgba(76,175,80,.1);padding:15px 25px;border-radius:25px;margin-bottom:40px;animation:fadeInUp .8s ease-out .3s both;}
    .remaining-amount{font-size:28px;font-weight:700;color:#4caf50;margin:0;}
    .remaining-text{font-size:16px;color:#2d5f4d;margin:5px 0 0 0;}
    .action-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;animation:fadeInUp .8s ease-out .4s both;}
    .action-button{background:#fff;border:3px solid #e8f5f0;border-radius:20px;padding:25px 20px;cursor:pointer;transition:all .3s ease;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .action-button:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(76,175,80,.15);border-color:#4caf50;}
    .action-button:active{transform:translateY(-2px);}
    .action-icon{font-size:40px;margin-bottom:12px;display:block;}
    .action-text{font-size:18px;font-weight:600;color:#2d5f4d;margin:0;}
    .status-bar{text-align:center;padding:20px;background:rgba(255,255,255,.7);border-radius:15px;animation:fadeInUp .8s ease-out .5s both;}
    .status-message{font-size:18px;color:#5a7a6d;font-weight:500;margin:0;}
    .pulse{animation:pulse 2s ease-in-out infinite;}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
    @media (max-width:768px){
      .container{padding:20px;}
      .budget-circle{width:240px;height:240px;}
      .spent-amount{font-size:28px;}
      .remaining-amount{font-size:24px;}
      .action-buttons{grid-template-columns:1fr;gap:15px;}
      .action-button{min-height:100px;padding:20px;}
      .action-icon{font-size:32px;}
      .action-text{font-size:16px;}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <div class="week-info" id="weekInfo">Uke â€“ dd.â€“dd. mmmm</div>
    </div>

    <div class="budget-overview">
      <div class="budget-circle">
        <div class="circle-bg">
          <div class="circle-progress" id="circleProgress"></div>
        </div>
        <div class="circle-content">
          <div class="spent-amount" id="spentAmount">0 kr</div>
          <div class="total-budget" id="totalBudget">av 0 kr</div>
        </div>
      </div>

      <div class="remaining-info">
        <div class="remaining-amount" id="remainingAmount">0 kr</div>
        <div class="remaining-text" id="remainingText">igjen denne uka</div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-button" id="addPurchaseBtn">
        <span class="action-icon">âž•</span>
        <span class="action-text" id="addPurchaseText">Legg til kjÃ¸p</span>
      </button>
      <button class="action-button" id="shoppingListBtn">
        <span class="action-icon">ðŸ›’</span>
        <span class="action-text" id="shoppingListText">Handleliste</span>
      </button>
      <button class="action-button" id="weekReportBtn">
        <span class="action-icon">ðŸ“Š</span>
        <span class="action-text" id="weekReportText">Ukesrapport</span>
      </button>
    </div>

    <div class="status-bar">
      <p class="status-message" id="statusMessage">Bra kontroll sÃ¥ langt ðŸ’ª</p>
    </div>
  </main>

  <script>
    // --- Redirect hvis onboarding ikke er fullfÃ¸rt ---
    if (localStorage.getItem('setupComplete') !== 'true') {
      location.href = 'index.html';
    }

    const defaultConfig = {
      background_color:"#f8fffe",surface_color:"#ffffff",text_color:"#2d5f4d",
      primary_action_color:"#4caf50",secondary_text_color:"#5a7a6d",
      font_family:"Inter",font_size:18,
      week_text:"",spent_text:"Du har brukt",remaining_text:"igjen denne uka",
      add_purchase_text:"Legg til kjÃ¸p",shopping_list_text:"Handleliste",
      week_report_text:"Ukesrapport",status_message:"Bra kontroll sÃ¥ langt ðŸ’ª"
    };

    // --- Uke-hjelpere (manâ€“sÃ¸n, NO format) ---
    function getWeekInfo(date=new Date()){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay(); // 0=Sun ... 6=Sat
      const diffToMon = (day === 0 ? -6 : 1 - day);
      const monday = new Date(d); monday.setUTCDate(d.getUTCDate() + diffToMon);
      const sunday = new Date(monday); sunday.setUTCDate(monday.getUTCDate() + 6);

      const weekNumber = getISOWeek(d);
      const fmt = new Intl.DateTimeFormat('no-NO',{day:'numeric',month:'long'});
      return {
        week: weekNumber,
        label: `Uke ${weekNumber} â€“ ${fmt.format(monday)}â€“${fmt.format(sunday)}`,
        mondayISO: monday.toISOString().slice(0,10) // for nÃ¸kkel
      };
    }

    function getISOWeek(date){
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = (tmp.getUTCDay()||7);
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
      return Math.ceil((((tmp - yearStart)/86400000)+1)/7);
    }

    const week = getWeekInfo();
    document.getElementById('weekInfo').textContent = week.label;

    // --- Last onboardede verdier ---
    const totalFromLS = parseInt(localStorage.getItem('weeklyBudget'),10);
    // fallback: 3000 hvis ikke satt
    const TOTAL = isNaN(totalFromLS) ? 3000 : totalFromLS;

    // forbruksnÃ¸kkel pr uke
    const SPENT_KEY = `spent_${week.mondayISO}`;
    const spentFromLS = parseInt(localStorage.getItem(SPENT_KEY),10);
    let budgetData = {
      total: TOTAL,
      spent: isNaN(spentFromLS) ? 0 : Math.max(0, spentFromLS),
      remaining: 0
    };
    budgetData.remaining = Math.max(0, budgetData.total - budgetData.spent);

    // --- Farge som settes av elementSdk (fallback til default) ---
    let currentPrimary = defaultConfig.primary_action_color;

    function adjustColor(color, percent){
      const num = parseInt(color.replace('#',''),16);
      const amt = Math.round(2.55*percent);
      const R = Math.max(0, Math.min(255,(num>>16)+amt));
      const G = Math.max(0, Math.min(255,(num>>8&0x00FF)+amt));
      const B = Math.max(0, Math.min(255,(num&0x0000FF)+amt));
      return '#' + (0x1000000 + R*0x10000 + G*0x100 + B).toString(16).slice(1);
    }

    function formatAmount(n){ return (n||0).toLocaleString('no-NO'); }

    function updateBudgetDisplay(){
      const spentEl = document.getElementById('spentAmount');
      const totalEl = document.getElementById('totalBudget');
      const remainingEl = document.getElementById('remainingAmount');
      const circle = document.getElementById('circleProgress');

      spentEl.textContent = `${formatAmount(budgetData.spent)} kr`;
      totalEl.textContent = `av ${formatAmount(budgetData.total)} kr`;
      remainingEl.textContent = `${formatAmount(budgetData.remaining)} kr`;

      const deg = Math.max(0, Math.min(360, (budgetData.spent / Math.max(1,budgetData.total)) * 360));
      circle.style.background = `conic-gradient(${currentPrimary} 0deg, ${currentPrimary} ${deg}deg, transparent ${deg}deg)`;

      [spentEl, remainingEl].forEach(el=>{
        el.classList.add('pulse');
        setTimeout(()=>el.classList.remove('pulse'), 1200);
      });
    }

    function persistSpent(){
      localStorage.setItem(SPENT_KEY, String(budgetData.spent));
    }

    // --- elementSdk-tematilpasning ---
    async function onConfigChange(config){
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;

      currentPrimary = primaryActionColor;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-2)} 100%)`;
      const els = [
        ['weekInfo', baseSize*1.11, secondaryTextColor],
        ['spentAmount', baseSize*2, textColor],
        ['totalBudget', baseSize*1.11, secondaryTextColor],
        ['remainingAmount', baseSize*1.56, primaryActionColor],
        ['remainingText', baseSize*0.89, textColor],
        ['statusMessage', baseSize, secondaryTextColor]
      ];
      els.forEach(([id,size,color])=>{
        const e=document.getElementById(id);
        e.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
        e.style.fontSize = `${size}px`;
        e.style.color = color;
      });

      document.querySelectorAll('.action-text').forEach(t=>{
        t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
        t.style.color = textColor;
      });
      document.querySelectorAll('.action-button').forEach(b=>{
        b.style.background = surfaceColor;
        b.style.borderColor = adjustColor(primaryActionColor, 60);
      });

      document.querySelector('.circle-bg').style.background = adjustColor(primaryActionColor, 85);
      document.querySelector('.remaining-info').style.background = `${primaryActionColor}1a`;
      document.querySelector('.status-bar').style.background = `${surfaceColor}b3`;

      updateBudgetDisplay();
    }

    function mapToCapabilities(config){
      return {
        recolorables:[
          {get:()=>config.background_color||defaultConfig.background_color,set:v=>window.elementSdk?.setConfig({background_color:v})},
          {get:()=>config.surface_color||defaultConfig.surface_color,set:v=>window.elementSdk?.setConfig({surface_color:v})},
          {get:()=>config.text_color||defaultConfig.text_color,set:v=>window.elementSdk?.setConfig({text_color:v})},
          {get:()=>config.primary_action_color||defaultConfig.primary_action_color,set:v=>window.elementSdk?.setConfig({primary_action_color:v})},
          {get:()=>config.secondary_text_color||defaultConfig.secondary_text_color,set:v=>window.elementSdk?.setConfig({secondary_text_color:v})}
        ],
        borderables:[],
        fontEditable:{get:()=>config.font_family||defaultConfig.font_family,set:v=>window.elementSdk?.setConfig({font_family:v})},
        fontSizeable:{get:()=>config.font_size||defaultConfig.font_size,set:v=>window.elementSdk?.setConfig({font_size:v})}
      };
    }

    function mapToEditPanelValues(config){
      return new Map([
        ['week_text', week.label],
        ['spent_text', config.spent_text || defaultConfig.spent_text],
        ['remaining_text', config.remaining_text || defaultConfig.remaining_text],
        ['add_purchase_text', config.add_purchase_text || defaultConfig.add_purchase_text],
        ['shopping_list_text', config.shopping_list_text || defaultConfig.shopping_list_text],
        ['week_report_text', config.week_report_text || defaultConfig.week_report_text],
        ['status_message', config.status_message || defaultConfig.status_message]
      ]);
    }

    // --- Knapper ---
    document.getElementById('addPurchaseBtn').addEventListener('click', ()=>{
      // Demo: legg til 150 kr (kan byttes til prompt/egendefinert dialog)
      budgetData.spent = Math.max(0, budgetData.spent + 150);
      budgetData.remaining = Math.max(0, budgetData.total - budgetData.spent);
      persistSpent();
      updateBudgetDisplay();
      console.log('Added purchase: 150');
    });

    document.getElementById('shoppingListBtn').addEventListener('click', ()=>{
      // Plassholder â€“ behold design
      console.log('Open shopping list');
    });

    document.getElementById('weekReportBtn').addEventListener('click', ()=>{
      // Plassholder â€“ behold design
      console.log('Open week report');
    });

    // Init visning
    document.getElementById('addPurchaseText').textContent = defaultConfig.add_purchase_text;
    document.getElementById('shoppingListText').textContent = defaultConfig.shopping_list_text;
    document.getElementById('weekReportText').textContent = defaultConfig.week_report_text;
    document.getElementById('remainingText').textContent = defaultConfig.remaining_text;

    updateBudgetDisplay();

    if (window.elementSdk){
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }
  </script>

  <!-- Canva/Cloudflare snippet beholdt -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99be81dc8277b4f7',t:'MTc2MjcwMzg2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
