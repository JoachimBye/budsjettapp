<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Husholdningsbudsjett - Hovedskjerm</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);display:flex;flex-direction:column;}
    html{height:100%;}
    .container{flex:1;display:flex;flex-direction:column;padding:30px;max-width:800px;margin:0 auto;width:100%;}
    .header{text-align:center;margin-bottom:40px;animation:fadeInDown .6s ease-out;}
    .week-info{font-size:20px;color:#5a7a6d;font-weight:500;}
    .budget-overview{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:40px;animation:fadeInUp .8s ease-out .2s both;}
    .budget-circle{position:relative;width:280px;height:280px;margin-bottom:30px;}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden;}
    .circle-progress{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:conic-gradient(#4caf50 0deg,#4caf50 216deg,transparent 216deg);transition:all .8s ease-out;}
    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;}
    .spent-amount{font-size:36px;font-weight:800;color:#2d5f4d;margin-bottom:8px;}
    .total-budget{font-size:20px;color:#5a7a6d;margin-bottom:15px;}
    .remaining-info{background:rgba(76,175,80,.1);padding:15px 25px;border-radius:25px;margin-bottom:40px;animation:fadeInUp .8s ease-out .3s both;}
    .remaining-amount{font-size:28px;font-weight:700;color:#4caf50;margin:0;}
    .remaining-text{font-size:16px;color:#2d5f4d;margin:5px 0 0 0;}
    .action-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;animation:fadeInUp .8s ease-out .4s both;}
    .action-button{background:#fff;border:3px solid #e8f5f0;border-radius:20px;padding:25px 20px;cursor:pointer;transition:all .3s ease;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .action-button:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(76,175,80,.15);border-color:#4caf50;}
    .action-button:active{transform:translateY(-2px);}
    .action-icon{font-size:40px;margin-bottom:12px;display:block;}
    .action-text{font-size:18px;font-weight:600;color:#2d5f4d;margin:0;}
    .status-bar{text-align:center;padding:20px;background:rgba(255,255,255,.7);border-radius:15px;animation:fadeInUp .8s ease-out .5s both;}
    .status-message{font-size:18px;color:#5a7a6d;font-weight:500;margin:0;}
    .pulse{animation:pulse 2s ease-in-out infinite;}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
    @media (max-width:768px){
      .container{padding:20px;}
      .budget-circle{width:240px;height:240px;}
      .spent-amount{font-size:28px;}
      .remaining-amount{font-size:24px;}
      .action-buttons{grid-template-columns:1fr;gap:15px;}
      .action-button{min-height:100px;padding:20px;}
      .action-icon{font-size:32px;}
      .action-text{font-size:16px;}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <div class="week-info" id="weekInfo">Uke â€“ dd.â€“dd. mmmm</div>
    </div>

    <div class="budget-overview">
      <div class="budget-circle">
        <div class="circle-bg">
          <div class="circle-progress" id="circleProgress"></div>
        </div>
        <div class="circle-content">
          <div class="spent-amount" id="spentAmount">0 kr</div>
          <div class="total-budget" id="totalBudget">av 0 kr</div>
        </div>
      </div>

      <div class="remaining-info">
        <div class="remaining-amount" id="remainingAmount">0 kr</div>
        <div class="remaining-text" id="remainingText">igjen denne uka</div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-button" id="addPurchaseBtn">
        <span class="action-icon">âž•</span>
        <span class="action-text" id="addPurchaseText">Legg til kjÃ¸p</span>
      </button>
      <button class="action-button" id="shoppingListBtn">
        <span class="action-icon">ðŸ›’</span>
        <span class="action-text" id="shoppingListText">Handleliste</span>
      </button>
      <button class="action-button" id="weekReportBtn">
        <span class="action-icon">ðŸ“Š</span>
        <span class="action-text" id="weekReportText">Ukesrapport</span>
      </button>
    </div>

    <div class="status-bar">
      <p class="status-message" id="statusMessage">Bra kontroll sÃ¥ langt ðŸ’ª</p>
    </div>
  </main>

<script>
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    week_text: "Uke 45 â€“ 4.â€“10. november",
    spent_text: "Du har brukt",
    remaining_text: "igjen denne uka",
    add_purchase_text: "Legg til kjÃ¸p",
    shopping_list_text: "Handleliste",
    week_report_text: "Ukesrapport",
    status_message: "Bra kontroll sÃ¥ langt ðŸ’ª"
  };

  // Budget data
  let budgetData = {
    total: 3000,
    spent: 1850,     // vil bli overskrevet av loadFromStorage()
    remaining: 1150  // vil bli overskrevet av loadFromStorage()
  };

  // ---- NYTT: hent/summer kjÃ¸p fra localStorage for gjeldende uke ----
  function getCurrentWeekMondayISO(dateObj = new Date()) {
    // Mandag = 0
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = (d.getDay() + 6) % 7; // 0=mandag, 6=sÃ¸ndag
    d.setDate(d.getDate() - day);
    return d.toISOString().slice(0, 10);
  }

  function loadFromStorage() {
    const mondayISO = getCurrentWeekMondayISO();
    const key = `purchases_${mondayISO}`;
    const purchases = JSON.parse(localStorage.getItem(key) || '[]');
    const spent = purchases.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

    budgetData.spent = spent;
    budgetData.remaining = Math.max(0, budgetData.total - budgetData.spent);
    updateBudgetDisplay();
  }
  // -------------------------------------------------------------------

  async function onConfigChange(config) {
    const backgroundColor = config.background_color || defaultConfig.background_color;
    const surfaceColor = config.surface_color || defaultConfig.surface_color;
    const textColor = config.text_color || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
    const customFont = config.font_family || defaultConfig.font_family;
    const baseSize = config.font_size || defaultConfig.font_size;

    document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor, -2)} 100%)`;
    
    // Update text content
    document.getElementById('weekInfo').textContent = config.week_text || defaultConfig.week_text;
    document.getElementById('remainingText').textContent = config.remaining_text || defaultConfig.remaining_text;
    document.getElementById('addPurchaseText').textContent = config.add_purchase_text || defaultConfig.add_purchase_text;
    document.getElementById('shoppingListText').textContent = config.shopping_list_text || defaultConfig.shopping_list_text;
    document.getElementById('weekReportText').textContent = config.week_report_text || defaultConfig.week_report_text;
    document.getElementById('statusMessage').textContent = config.status_message || defaultConfig.status_message;

    // Update fonts and colors
    const elements = [
      { id: 'weekInfo', size: baseSize * 1.11, color: secondaryTextColor },
      { id: 'spentAmount', size: baseSize * 2, color: textColor },
      { id: 'totalBudget', size: baseSize * 1.11, color: secondaryTextColor },
      { id: 'remainingAmount', size: baseSize * 1.56, color: primaryActionColor },
      { id: 'remainingText', size: baseSize * 0.89, color: textColor },
      { id: 'statusMessage', size: baseSize, color: secondaryTextColor }
    ];

    elements.forEach(el => {
      const element = document.getElementById(el.id);
      element.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      element.style.fontSize = `${el.size}px`;
      element.style.color = el.color;
    });

    // Update action buttons
    const actionTexts = document.querySelectorAll('.action-text');
    actionTexts.forEach(text => {
      text.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      text.style.color = textColor;
    });

    const actionButtons = document.querySelectorAll('.action-button');
    actionButtons.forEach(button => {
      button.style.background = surfaceColor;
      button.style.borderColor = adjustColor(primaryActionColor, 60);
    });

    // Update circle colors
    const circleBg = document.querySelector('.circle-bg');
    circleBg.style.background = adjustColor(primaryActionColor, 85);

    const circleProgress = document.getElementById('circleProgress');
    const percentage = (budgetData.spent / budgetData.total) * 360;
    circleProgress.style.background = `conic-gradient(${primaryActionColor} 0deg, ${primaryActionColor} ${percentage}deg, transparent ${percentage}deg)`;

    // Update remaining info background
    const remainingInfo = document.querySelector('.remaining-info');
    remainingInfo.style.background = `${primaryActionColor}1a`;

    // Update status bar
    const statusBar = document.querySelector('.status-bar');
    statusBar.style.background = `${surfaceColor}b3`;
  }

  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));
    const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
  }

  function formatAmount(amount) {
    return amount.toLocaleString('no-NO');
  }

  function updateBudgetDisplay() {
    const spentElement = document.getElementById('spentAmount');
    const totalElement = document.getElementById('totalBudget');
    const remainingElement = document.getElementById('remainingAmount');
    const circleProgress = document.getElementById('circleProgress');

    spentElement.textContent = `${formatAmount(budgetData.spent)} kr`;
    totalElement.textContent = `av ${formatAmount(budgetData.total)} kr`;
    remainingElement.textContent = `${formatAmount(budgetData.remaining)} kr`;

    const percentage = (budgetData.total > 0 ? (budgetData.spent / budgetData.total) : 0) * 360;
    circleProgress.style.background = `conic-gradient(#4caf50 0deg, #4caf50 ${percentage}deg, transparent ${percentage}deg)`;
    
    [spentElement, remainingElement].forEach(el => {
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 2000);
    });
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        {
          get: () => config.background_color || defaultConfig.background_color,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ background_color: value });
            }
          }
        },
        {
          get: () => config.surface_color || defaultConfig.surface_color,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ surface_color: value });
            }
          }
        },
        {
          get: () => config.text_color || defaultConfig.text_color,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ text_color: value });
            }
          }
        },
        {
          get: () => config.primary_action_color || defaultConfig.primary_action_color,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ primary_action_color: value });
            }
          }
        },
        {
          get: () => config.secondary_text_color || defaultConfig.secondary_text_color,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ secondary_text_color: value });
            }
          }
        }
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: (value) => {
          if (window.elementSdk) {
            window.elementSdk.setConfig({ font_family: value });
          }
        }
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: (value) => {
          if (window.elementSdk) {
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["week_text", config.week_text || defaultConfig.week_text],
      ["spent_text", config.spent_text || defaultConfig.spent_text],
      ["remaining_text", config.remaining_text || defaultConfig.remaining_text],
      ["add_purchase_text", config.add_purchase_text || defaultConfig.add_purchase_text],
      ["shopping_list_text", config.shopping_list_text || defaultConfig.shopping_list_text],
      ["week_report_text", config.week_report_text || defaultConfig.week_report_text],
      ["status_message", config.status_message || defaultConfig.status_message]
    ]);
  }

  // ---- ENDREDE lyttere ----
  // GÃ¥ til "Legg til kjÃ¸p"
  document.getElementById('addPurchaseBtn').addEventListener('click', () => {
    location.href = 'add-purchase.html';
  });

  document.getElementById('shoppingListBtn').addEventListener('click', () => {
    console.log('Opening shopping list');
  });

  document.getElementById('weekReportBtn').addEventListener('click', () => {
    location.href = 'week-report.html';
  });
  // --------------------------

  // Init: last data fra storage og tegn
  loadFromStorage();

  // Oppdater nÃ¥r siden vises (ogsÃ¥ fra historikk)
  window.addEventListener('pageshow', loadFromStorage);

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities,
      mapToEditPanelValues
    });
  }
</script>

 </body>
</html>
