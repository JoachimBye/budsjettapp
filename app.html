<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Husholdningsbudsjett - Hovedskjerm</title>

  <!-- Element SDK (valgfri redigering/tema) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/budget-utils.js"></script>
  <script src="/js/services/budget-service.js"></script>
  <script src="/js/ui/toast.js"></script>
  <script src="/js/ui/coach.js"></script>

  <style>
    body{
      box-sizing:border-box;margin:0;padding:0;height:100%;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      display:flex;flex-direction:column;
    }
    html{height:100%;}
    .container{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:30px;
      max-width:800px;
      margin:0 auto;
      width:100%;
    }

    .header{
      text-align:center;
      margin-bottom:32px;
      animation:fadeInDown .6s ease-out;
    }
    .week-header-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .week-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 18px;
      border-radius:9999px;
      background:#4caf50;
      color:#ffffff;
      font-weight:600;
      font-size:14px;
      box-shadow:0 4px 12px rgba(76,175,80,.35);
      transition:all .2s ease;
    }
    .week-pill:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(76,175,80,.4);
    }
    .week-range{
      margin:0;
      font-size:18px;
      color:#5a7a6d;
      font-weight:500;
    }

    /* Hovedseksjon budsjett */
    .budget-overview{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      margin-bottom:24px;
      animation:fadeInUp .8s ease-out .2s both;
    }
    .budget-circle{
      position:relative;
      width:280px;
      height:280px;
      margin-bottom:10px;
    }
    .circle-bg{
      width:100%;
      height:100%;
      border-radius:50%;
      background:#e8f5f0;
      position:relative;
      overflow:hidden;
    }
    .circle-progress{
      --ring-color:#4caf50;
      --ring-deg:0deg;
      position:absolute;
      top:0;left:0;
      width:100%;height:100%;
      border-radius:50%;
      background:conic-gradient(var(--ring-color) 0deg, var(--ring-color) var(--ring-deg), transparent var(--ring-deg));
      transition:background .6s ease-out;
    }
    .circle-content{
      position:absolute;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      z-index:10;
      max-width:80%;
    }


    /* Ny hero: IGJEN ‚Äì alltid god kontrast mot ringen */
.remaining-amount{
  font-size:36px;
  font-weight:800;
  color:#2d5f4d;   /* m√∏rk, lesbar tekst */
  margin:0 0 4px 0;
}

/* brukes bare hvis du vil ha litt fargestemning i tillegg */
.remaining-amount.warn{color:#7c5a00;}   /* m√∏rkere ‚Äúgul/brun‚Äù */
.remaining-amount.over{color:#ffffff;}   /* hvit tekst p√• r√∏d ring */

.remaining-text.warn{color:#7c5a00;}
.remaining-text.over{color:#ffffff;}



    .remaining-text{
      font-size:16px;
      color:#2d5f4d;
      margin:0 0 8px 0;
    }

    .spent-summary{
      font-size:15px;
      color:#5a7a6d;
      font-weight:500;
    }

    /* Prim√¶r CTA: Legg til kj√∏p */
    .primary-cta{
      display:block;
      width:100%;
      margin:20px 0 24px;
      padding:16px 22px;
      border-radius:9999px;
      border:none;
      font-size:18px;
      font-weight:700;
      background:linear-gradient(135deg,#4caf50,#45a049);
      color:#fff;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(76,175,80,.35);
      transition:transform .08s ease, box-shadow .08s ease;
      text-align:center;
    }
    .primary-cta:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 24px rgba(76,175,80,.4);
    }
    .primary-cta:active{
      transform:translateY(0);
      box-shadow:0 4px 12px rgba(76,175,80,.3);
    }

    /* Sekund√¶re handlinger (grid) */
    .action-buttons{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:20px;
      margin-bottom:32px;
      animation:fadeInUp .8s ease-out .3s both;
    }
    .action-button{
      background:#fff;
      border:3px solid #e8f5f0;
      border-radius:20px;
      padding:22px 18px;
      cursor:pointer;
      transition:all .3s ease;
      text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
      min-height:110px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .action-button:hover{
      transform:translateY(-5px);
      box-shadow:0 8px 20px rgba(76,175,80,.15);
      border-color:#4caf50;
    }
    .action-button:active{transform:translateY(-2px);}
    .action-icon{
      font-size:32px;
      margin-bottom:8px;
      display:block;
    }
    .action-text{
      font-size:16px;
      font-weight:600;
      color:#2d5f4d;
      margin:0;
    }

    .status-bar{
      text-align:center;
      padding:20px;
      background:rgba(255,255,255,.7);
      border-radius:15px;
      animation:fadeInUp .8s ease-out .4s both;
    }
    .status-message{
      font-size:18px;
      color:#5a7a6d;
      font-weight:500;
      margin:0;
    }
    .pulse{animation:pulse 2s ease-in-out;}

    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}

    @media (max-width:768px){
      .container{padding:20px;}
      .budget-circle{width:240px;height:240px;}
      .remaining-amount{font-size:30px;}
      .week-range{font-size:16px;}
      .action-buttons{
        grid-template-columns:1fr;
        gap:15px;
      }
      .action-button{
        min-height:100px;
        padding:18px;
      }
      .action-icon{font-size:28px;}
      .action-text{font-size:15px;}
      .primary-cta{width:100%;}
    }

    /* Coach overlay (intro-guide) */
    .coach-overlay{
      position:fixed;
      inset:0;
      z-index:500;
      display:none;
      pointer-events:auto;
    }
    .coach-highlight{
      position:fixed;
      border-radius:16px;
      border:2px solid #4caf50;
      box-shadow:0 0 0 9999px rgba(0,0,0,0.55);
      transition:all 0.25s ease;
      pointer-events:none;
      opacity:0;
    }
    .coach-tooltip{
      position:fixed;
      max-width:320px;
      background:#ffffff;
      border-radius:16px;
      padding:14px 16px 12px 16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.25);
      color:#2d5f4d;
      font-size:14px;
      line-height:1.4;
      transition:opacity 0.25s ease, top 0.25s ease;
      opacity:0;
    }
    .coach-title{
      font-weight:700;
      margin-bottom:4px;
      font-size:15px;
    }
    .coach-text{margin:0;}
    .coach-step-label{
      margin-top:6px;
      font-size:12px;
      color:#5a7a6d;
    }
    .coach-buttons{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }
    .coach-btn{
      border:none;
      border-radius:9999px;
      padding:6px 12px;
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
      transition:background 0.2s, color 0.2s;
    }
    .coach-btn.coach-skip{
      background:transparent;
      color:#5a7a6d;
    }
    .coach-btn.coach-prev{
      background:#f0f0f0;
      color:#2d5f4d;
    }
    .coach-btn.coach-next{
      background:#4caf50;
      color:#ffffff;
    }
    .coach-btn.coach-next:hover{
      background:#45a049;
    }

    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <main class="container">
    <!-- Uke-header -->
    <div class="header">
      <div class="week-header-inner">
        <div class="week-pill">
          <span id="weekText">Uke 0</span>
        </div>
        <p class="week-range" id="dateRange">dd.‚Äìdd. mmmm</p>
      </div>
    </div>

    <!-- Budsjett-sirkel med n√∏kkeltall -->
    <div class="budget-overview">
      <div class="budget-circle">
        <div class="circle-bg">
          <div class="circle-progress" id="circleProgress"></div>
        </div>
        <div class="circle-content">
          <div class="remaining-amount" id="remainingAmount">0kr</div>
          <div class="remaining-text" id="remainingText">igjen denne uka</div>
          <div class="spent-summary" id="spentSummary">Brukt 0 kr av 0 kr</div>
        </div>
      </div>
    </div>

    <!-- Prim√¶r handling -->
    <button class="primary-cta" id="addPurchaseBtn">
      Legg til kj√∏p
    </button>

    <!-- Sekund√¶re handlinger -->
    <div class="action-buttons">
      <button class="action-button" id="shoppingListBtn">
        <span class="action-icon">üõí</span>
        <span class="action-text" id="shoppingListText">Handleliste</span>
      </button>
      <button class="action-button" id="weekReportBtn">
        <span class="action-icon">üìä</span>
        <span class="action-text" id="weekReportText">Ukesrapport</span>
      </button>
      <button class="action-button" id="mealPlanBtn">
        <span class="action-icon">üçΩÔ∏è</span>
        <span class="action-text">Middagsforslag</span>
      </button>
      <button class="action-button" id="settingsBtn">
        <span class="action-icon">‚öôÔ∏è</span>
        <span class="action-text">Innstillinger</span>
      </button>
    </div>

    <div class="status-bar">
      <p class="status-message" id="statusMessage">Bra kontroll s√• langt üí™</p>
    </div>
  </main>

  <!-- Coach overlay: forklarer alt p√• siden -->
  <div class="coach-overlay" id="coachOverlay">
    <div class="coach-highlight" id="coachHighlight"></div>
    <div class="coach-tooltip" id="coachTooltip">
      <div class="coach-title" id="coachTitle"></div>
      <p class="coach-text" id="coachText"></p>
      <div class="coach-step-label" id="coachStepLabel"></div>
      <div class="coach-buttons">
        <button type="button" class="coach-btn coach-skip" id="coachSkipBtn">Hopp over</button>
        <button type="button" class="coach-btn coach-prev" id="coachPrevBtn">Tilbake</button>
        <button type="button" class="coach-btn coach-next" id="coachNextBtn">Neste</button>
      </div>
    </div>
  </div>

<script>
  // ===== Supabase init ===================================================
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const showToast = (message, type = 'info') => {
    if (window.toast?.show) {
      window.toast.show(message, { type });
    } else {
      console[type === 'error' ? 'error' : 'log'](message);
    }
  };

  // ===== Element/tema konfig ============================================
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    week_text: "",
    spent_text: "Du har brukt",
    remaining_text: "igjen denne uka",
    add_purchase_text: "Legg til kj√∏p",
    shopping_list_text: "Handleliste",
    week_report_text: "Ukesrapport",
    status_message: "Bra kontroll s√• langt üí™"
  };

  // ===== Global state ====================================================
  const state = {
    activeWeekISO: '',
    budget: 0,
    spent: 0,
    remaining: 0
  };
  let isSummaryLoading = false;
  let summaryLoadError = null;
  const dateUtils = window.dateUtils || {};
  const budgetService = window.budgetService || null;
  const budgetUtils = window.budgetUtils || {};

  // ---------- Uke-hjelpere ----------------------------------------------
  function resolveActiveWeekISO() {
    if (dateUtils.getOrInitActiveWeekISO) {
      return dateUtils.getOrInitActiveWeekISO();
    }

    const storedISO = dateUtils.getActiveWeekISO ? dateUtils.getActiveWeekISO() : null;
    const computeMonday = () => {
      if (dateUtils.mondayISO) return dateUtils.mondayISO();
      const today = new Date();
      const day = (today.getDay() + 6) % 7;
      today.setDate(today.getDate() - day);
      today.setHours(12, 0, 0, 0);
      return today.toISOString().slice(0, 10);
    };
    const currentMonday = computeMonday();

    if (!storedISO || storedISO < currentMonday) {
      const activeISO = currentMonday;
      if (dateUtils.setActiveWeekISO) {
        dateUtils.setActiveWeekISO(activeISO);
      } else {
        localStorage.setItem('activeWeekISO', activeISO);
      }
      return activeISO;
    }

    return storedISO;
  }

  function getActiveMondayDate(){
    const iso =
      state.activeWeekISO ||
      resolveActiveWeekISO();
    const [y, m, d] = iso.split('-').map(Number);
    return new Date(y, m - 1, d, 12, 0, 0, 0);
  }

  function setWeekHeader() {
    const mon = getActiveMondayDate();
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    const weekNo = dateUtils.isoWeekNumber ? dateUtils.isoWeekNumber(mon) : '';

    const weekTextEl = document.getElementById('weekText');
    const dateRangeEl = document.getElementById('dateRange');
    if (weekTextEl) weekTextEl.textContent = `Uke ${weekNo}`;
    if (dateRangeEl) {
      const range = dateUtils.formatRangeNoNO
        ? dateUtils.formatRangeNoNO(mon, sun)
        : `${mon.toLocaleDateString('no-NO')}‚Äì${sun.toLocaleDateString('no-NO')}`;
      dateRangeEl.textContent = range;
    }
  }

  // ---------- Local fallback for budsjett/kj√∏p --------------------------
  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  function readJSON(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw) ?? fallback;
    } catch {
      return fallback;
    }
  }

  // ---------- Hent uke-data fra Supabase + cache til localStorage -------
  async function loadWeekData() {
    const iso =
      state.activeWeekISO ||
      resolveActiveWeekISO();

    isSummaryLoading = true;
    summaryLoadError = null;
    updateBudgetDisplay();

    try {
      let summary = null;
      if (budgetService?.loadWeekSummary) {
        summary = await budgetService.loadWeekSummary(supa, iso);
      }

      if (summary) {
        state.activeWeekISO = summary.weekISO;
        state.budget = summary.budget;
        state.spent = summary.spent;
        state.remaining = summary.remaining;
        return;
      }

      const fallbackBudget = budgetService?.readWeeklyBudgetLocal
        ? budgetService.readWeeklyBudgetLocal(iso)
        : 3000;
      const localPurchases = readJSON(`purchases_${iso}`, []);
      const fallbackSpent = budgetUtils.safeSumPurchases
        ? budgetUtils.safeSumPurchases(localPurchases)
        : 0;

      state.activeWeekISO = iso;
      state.budget = fallbackBudget;
      state.spent = fallbackSpent;
      state.remaining = state.budget - state.spent;
      summaryLoadError = 'Kunne ikke hente ukedata ‚Äì viser lagret informasjon.';
      showToast('Kunne ikke hente ukedata, viser cache.', 'error');
    } catch (err) {
      console.error('loadWeekData', err);
      summaryLoadError = 'Kunne ikke hente ukedata.';
      showToast('Kunne ikke hente ukedata.', 'error');
    } finally {
      isSummaryLoading = false;
      updateBudgetDisplay();
    }
  }

  // ---------- Oppdater UI ----------------------------------------------
function updateBudgetDisplay() {
  const remainingElement = document.getElementById('remainingAmount');
  const remainingText    = document.getElementById('remainingText');
  const spentSummaryEl   = document.getElementById('spentSummary');
  const circleProgress   = document.getElementById('circleProgress');
  const statusMsg        = document.getElementById('statusMessage');
  const mealBtn          = document.getElementById('mealPlanBtn');

  if (isSummaryLoading) {
    if (remainingElement) {
      remainingElement.textContent = '...';
      remainingElement.style.color = '#5a7a6d';
    }
    if (remainingText) {
      remainingText.textContent = 'Henter ukedata‚Ä¶';
      remainingText.style.color = '#5a7a6d';
    }
    if (spentSummaryEl) {
      spentSummaryEl.textContent = 'Henter data‚Ä¶';
    }
    if (circleProgress) {
      circleProgress.style.setProperty('--ring-color', '#d1d5db');
      circleProgress.style.setProperty('--ring-deg', '0deg');
    }
    if (statusMsg) {
      statusMsg.textContent = 'Henter ukedata‚Ä¶';
    }
    return;
  }

  const total = state.budget;
  const spent = state.spent;
  const remainingRaw = total > 0 ? (total - spent) : 0;
  state.remaining = remainingRaw;

  // Oppdater "Brukt X av Y"
  if (spentSummaryEl) {
    spentSummaryEl.textContent = `Brukt ${formatAmount(spent)} kr av ${formatAmount(total)} kr`;
  }

  // Reset tekstfarger til "normal" hver gang
  remainingElement.style.color = '#2d5f4d';
  remainingText.style.color    = '#2d5f4d';
  remainingElement.classList.remove('warn','over');
  remainingText.classList.remove('warn','over');

  let color  = '#4caf50';   // ring-farge
  let ringDeg = 0;
  let status = 'Bra kontroll s√• langt üí™';

  if (total > 0) {
    const ratio = spent / total;
    ringDeg = Math.min(360, Math.max(0, ratio * 360));

    if (ratio >= 1.0) {
      // OVER budsjett ‚Äì full r√∏d ring, hvit tekst for maks kontrast
      color = '#d32f2f';
      ringDeg = 360;

      remainingElement.classList.add('over');
      remainingText.classList.add('over');
      remainingElement.textContent = `${formatAmount(Math.abs(remainingRaw))} kr`;
      remainingText.textContent    = 'overskredet';

      status = 'Over budsjett ‚Äì kutt kostnader üí∏';

    } else if (ratio >= 0.7) {
      // N√ÜR budsjett ‚Äì gul ring, m√∏rk gul/brun tekst
      color = '#f9a825';

      remainingElement.classList.add('warn');
      remainingText.classList.add('warn');
      remainingElement.textContent = `${formatAmount(remainingRaw)} kr`;
      remainingText.textContent    = 'igjen denne uka';

      status = 'N√¶r budsjett ‚Äì vurder billigere valg ‚ö†Ô∏è';

    } else {
      // God kontroll ‚Äì gr√∏nn ring, m√∏rk tekst
      color = '#4caf50';
      remainingElement.textContent = `${formatAmount(remainingRaw)} kr`;
      remainingText.textContent    = 'igjen denne uka';
      status = 'Bra kontroll s√• langt üí™';
    }
  } else {
    // Ikke satt budsjett
    color = '#4caf50';
    ringDeg = 0;
    remainingElement.style.color = '#2d5f4d';
    remainingText.style.color    = '#5a7a6d';
    remainingElement.textContent = `0 kr`;
    remainingText.textContent    = 'sett ukesbudsjett i innstillinger';
    status = 'Sett et ukesbudsjett for √• komme i gang üôÇ';
  }

  circleProgress.style.setProperty('--ring-color', color);
  circleProgress.style.setProperty('--ring-deg', `${ringDeg}deg`);

  if (mealBtn) {
    mealBtn.textContent = (state.remaining < 0)
      ? `Middag ‚Äì billige forslag`
      : `Middag for ${formatAmount(state.remaining)} kr ‚Äì vis forslag`;
  }

  if (summaryLoadError) {
    statusMsg.textContent = summaryLoadError;
  } else {
    statusMsg.textContent = status;
  }

  // Liten ‚Äúpulse‚Äù n√•r tallene oppdateres
  if (remainingElement) {
    remainingElement.classList.add('pulse');
    setTimeout(() => remainingElement.classList.remove('pulse'), 600);
  }
}

  // ---------- Farge/tema fra Element SDK -------------------------------
  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''),16), amt=Math.round(2.55*percent);
    const R=Math.max(0,Math.min(255,(num>>16)+amt));
    const G=Math.max(0,Math.min(255,((num>>8)&0x00FF)+amt));
    const B=Math.max(0,Math.min(255,((num)&0x0000FF)+amt));
    return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
  }

  async function onConfigChange(config) {
    const backgroundColor    = config.background_color    || defaultConfig.background_color;
    const surfaceColor       = config.surface_color       || defaultConfig.surface_color;
    const textColor          = config.text_color          || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color|| defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color|| defaultConfig.secondary_text_color;
    const customFont         = config.font_family         || defaultConfig.font_family;
    const baseSize           = config.font_size           || defaultConfig.font_size;

    document.body.style.background =
      `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-2)} 100%)`;

    const elements = [
      { id: 'weekText',        size: baseSize * 0.9,  color: '#ffffff' },
      { id: 'dateRange',       size: baseSize * 1.05, color: secondaryTextColor },
      { id: 'remainingAmount', size: baseSize * 2,    color: primaryActionColor },
      { id: 'remainingText',   size: baseSize * 0.95, color: textColor },
      { id: 'statusMessage',   size: baseSize,        color: secondaryTextColor }
    ];
    elements.forEach(el => {
      const node = document.getElementById(el.id);
      if (!node) return;
      node.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      node.style.fontSize = `${el.size}px`;
      node.style.color = el.color;
    });

    const weekPill = document.querySelector('.week-pill');
    if (weekPill) {
      weekPill.style.background = primaryActionColor;
      weekPill.style.color = '#ffffff';
    }

    document.querySelectorAll('.action-text').forEach(t=>{
      t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      t.style.color = textColor;
    });
    document.querySelectorAll('.action-button').forEach(b=>{
      b.style.background = surfaceColor;
      b.style.borderColor = adjustColor(primaryActionColor, 60);
    });

    const circleBg  = document.querySelector('.circle-bg');
    const statusBar = document.querySelector('.status-bar');
    if (circleBg)  circleBg.style.background = adjustColor(primaryActionColor, 85);
    if (statusBar) statusBar.style.background = `${surfaceColor}b3`;
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ background_color: v }) },
        { get: () => config.surface_color || defaultConfig.surface_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ surface_color: v }) },
        { get: () => config.text_color || defaultConfig.text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ text_color: v }) },
        { get: () => config.primary_action_color || defaultConfig.primary_action_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ primary_action_color: v }) },
        { get: () => config.secondary_text_color || defaultConfig.secondary_text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ secondary_text_color: v }) },
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_family: v })
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_size: v })
      }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["week_text",          config.week_text          || defaultConfig.week_text],
      ["spent_text",         config.spent_text         || defaultConfig.spent_text],
      ["remaining_text",     config.remaining_text     || defaultConfig.remaining_text],
      ["add_purchase_text",  config.add_purchase_text  || defaultConfig.add_purchase_text],
      ["shopping_list_text", config.shopping_list_text || defaultConfig.shopping_list_text],
      ["week_report_text",   config.week_report_text   || defaultConfig.week_report_text],
      ["status_message",     config.status_message     || defaultConfig.status_message]
    ]);
  }

  // ---------- Coach overlay (intro p√• hovedsiden) -----------------------
  const COACH_SEEN_KEY = 'app_coach_seen_v1';
  let coachInstance = null;

  const coachSteps = [
    {
      id: 'week',
      selector: '.week-header-inner',
      title: 'Uke og dato üëã',
      text:  'Her ser du hvilken uke du jobber i n√•, og datoene for uka. Alt du ser ellers p√• skjermen gjelder denne uka.'
    },
    {
      id: 'circle',
      selector: '.budget-circle',
      title: 'Budsjett-sirkelen',
      text:  'Sirkelen viser hvor stor del av ukesbudsjettet som er brukt. Jo mer gr√∏nt som fyller ringen, jo n√¶rmere budsjettgrensen er dere.'
    },
    {
      id: 'remaining',
      selector: '#remainingAmount',
      title: 'Hvor mye som er igjen',
      text:  'Dette tallet er helten i appen ‚Äì hvor mye dere har igjen √• bruke denne uka. Fargen endrer seg n√•r dere n√¶rmer dere eller g√•r over budsjettet.'
    },
    {
      id: 'spentSummary',
      selector: '#spentSummary',
      title: 'Brukt av totalt',
      text:  'Her ser dere hvor mye som er brukt til n√•, og hva hele ukesbudsjettet er. Det gj√∏r det lett √• se forholdet mellom brukt og totalt.'
    },
    {
      id: 'addPurchase',
      selector: '#addPurchaseBtn',
      title: 'Legg til nytt kj√∏p',
      text:  'Dette er hovedknappen i appen. Hver gang noen har v√¶rt i butikken, trykker dere her for √• registrere kvitteringen.'
    },
    {
      id: 'shopping',
      selector: '#shoppingListBtn',
      title: 'Handleliste',
      text:  'Her kan dere holde styr p√• hva som skal kj√∏pes inn. Tanken er at hele husstanden deler samme liste p√• nettbrettet.'
    },
    {
      id: 'weekReport',
      selector: '#weekReportBtn',
      title: 'Ukesrapport',
      text:  'Ukesrapporten gir et dypere innblikk: hva pengene gikk til, hvilke kategorier som dominerer, og m√∏nstre fra uka.'
    },
    {
      id: 'meal',
      selector: '#mealPlanBtn',
      title: 'Middagsforslag ut fra budsjett',
      text:  'Denne siden gir middagsforslag tilpasset hvor mye dere har igjen. M√•let er √• gj√∏re det enkelt √• ta billige, smarte valg.'
    },
    {
      id: 'settings',
      selector: '#settingsBtn',
      title: 'Innstillinger for husstanden',
      text:  'Under Innstillinger kan dere sette ukesbudsjett, kategorier og andre valg som styrer hvordan appen oppf√∏rer seg.'
    },
    {
      id: 'status',
      selector: '.status-bar',
      title: 'Kort status for uka',
      text:  'Her f√•r dere en kort vurdering av situasjonen: om dere ligger godt an, n√¶rmer dere smertegrensen, eller har g√•tt over budsjettet.'
    }
  ];

  function setupCoach() {
    if (!window.coach) return;
    coachInstance = window.coach.create({
      steps: coachSteps,
      storageKey: COACH_SEEN_KEY,
    });
  }

  function startCoachTour() {
    coachInstance?.start();
  }

  function endCoachTour() {
    coachInstance?.stop();
  }

  function shouldStartCoachTour() {
    if (!coachInstance) return false;
    return !coachInstance.hasSeen();
  }

  // ---------- Navigasjon ------------------------------------------------
  document.getElementById('addPurchaseBtn').addEventListener('click', () => {
    location.href = 'add-purchase.html';
  });
  document.getElementById('shoppingListBtn').addEventListener('click', () => {
    location.href = 'handleliste.html';
  });
  document.getElementById('weekReportBtn').addEventListener('click', () => {
    location.href = 'week-report.html';
  });
  document.getElementById('mealPlanBtn').addEventListener('click', () => {
    location.href = 'middag.html';
  });
  document.getElementById('settingsBtn').addEventListener('click', () => {
    location.href = 'settings.html';
  });

  // ---------- Auth + bootstrapping -------------------------------------
  async function main() {
    // Global auth-listener
    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    } else {
      try {
        supa.auth.onAuthStateChange((event) => {
          if (event === 'SIGNED_OUT' && window.location.pathname !== '/innlogging.html') {
            window.location.href = '/innlogging.html';
          }
        });
      } catch {}
    }

    // Auth-guard
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/app.html') return;
    } else {
      const { data:{ session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = '/innlogging.html';
        return;
      }
    }

    // Sett uke og last data
    state.activeWeekISO = resolveActiveWeekISO();
    await loadWeekData();
    setWeekHeader();
    updateBudgetDisplay();

    // Element SDK init
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Coach overlay
    setupCoach();
    if (shouldStartCoachTour()) {
      setTimeout(() => {
        startCoachTour();
      }, 800);
    }
  }

  window.addEventListener('DOMContentLoaded', main);

  // N√•r man kommer tilbake via tilbakeknappen (BFCache), refreshe tall
  window.addEventListener('pageshow', async (event) => {
    if (event.persisted) {
      state.activeWeekISO = resolveActiveWeekISO();
      await loadWeekData();
      setWeekHeader();
      updateBudgetDisplay();
    }
  });
</script>
</body>
</html>
