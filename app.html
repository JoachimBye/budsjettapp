<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Husholdningsbudsjett - Hovedskjerm</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    :root{
      --green:#4caf50;
      --amber:#fbc02d;
      --orange:#ff9800;
      --red:#e53935;
      --bg-grad:#f8fffe;
      --text:#2d5f4d;
      --text-2:#5a7a6d;
      --surface:#ffffff;
    }
    body{box-sizing:border-box;margin:0;padding:0;height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,var(--bg-grad) 0%,#f0f9f4 100%);display:flex;flex-direction:column;color:var(--text);}
    html{height:100%;}
    .container{flex:1;display:flex;flex-direction:column;padding:30px;max-width:800px;margin:0 auto;width:100%;}
    .header{text-align:center;margin-bottom:40px;animation:fadeInDown .6s ease-out;}
    .week-info{font-size:20px;color:var(--text-2);font-weight:500;}
    .budget-overview{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-bottom:40px;animation:fadeInUp .8s ease-out .2s both;}
    .budget-circle{position:relative;width:280px;height:280px;margin-bottom:24px;}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden;box-shadow:inset 0 0 0 12px #f3fbf7;}
    .circle-progress{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:conic-gradient(var(--green) 0deg,var(--green) 0deg,transparent 0deg);transition:background .6s ease;}
    /* Ytre ‚Äúovershoot‚Äù-bue som viser hvor mye man er over budsjett (maks ~30%) */
    .circle-overshoot{
      position:absolute;inset:-8px;border-radius:50%;
      background:conic-gradient(var(--red) 0deg, var(--red) 0deg, transparent 0deg);
      mask:radial-gradient(circle at center, transparent 72%, #000 73%);
      pointer-events:none;transition:background .6s ease, opacity .2s ease;
      opacity:0;
    }
    .circle-overshoot.show{opacity:1;}

    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;}
    .spent-amount{font-size:36px;font-weight:800;color:var(--text);margin-bottom:6px;}
    .total-budget{font-size:18px;color:var(--text-2);margin-bottom:4px;}
    .center-note{font-size:13px;color:var(--text-2);}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .remaining-info{background:rgba(76,175,80,.1);padding:16px 18px;border-radius:14px;margin-bottom:16px;animation:fadeInUp .8s ease-out .3s both;text-align:center;min-width:280px}
    .remaining-amount{font-size:28px;font-weight:700;margin:0;}
    .remaining-text{font-size:14px;margin:4px 0 0 0;color:var(--text);}

    /* Trygt pr. dag-chip */
    .safe-chip{display:inline-block;margin-top:10px;background:#f0f9f4;border:1px solid rgba(76,175,80,.25);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--text-2);}

    /* Hovedknapp for middagsforslag */
    .meal-button{
      background:var(--green);color:#fff;border:none;border-radius:20px;
      padding:15px 25px;font-size:18px;font-weight:600;cursor:pointer;
      transition:background .2s, transform .1s;margin:24px 0 40px;
      box-shadow:0 4px 12px rgba(76,175,80,.25);
    }
    .meal-button:hover{background:#45a049;transform:translateY(-2px);}
    .meal-button:active{transform:translateY(0);}

    .action-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;animation:fadeInUp .8s ease-out .4s both;}
    .action-button{background:#fff;border:3px solid #e8f5f0;border-radius:20px;padding:25px 20px;cursor:pointer;transition:all .3s ease;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .action-button:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(76,175,80,.15);border-color:var(--green);}
    .action-button:active{transform:translateY(-2px);}
    .action-icon{font-size:40px;margin-bottom:12px;display:block;}
    .action-text{font-size:18px;font-weight:600;color:var(--text);margin:0;}
    .status-bar{text-align:center;padding:20px;background:rgba(255,255,255,.7);border-radius:15px;animation:fadeInUp .8s ease-out .5s both;}
    .status-message{font-size:18px;color:var(--text-2);font-weight:500;margin:0;}
    .pulse{animation:pulse 2s ease-in-out;}

    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}

    @media (max-width:768px){
      .container{padding:20px;}
      .budget-circle{width:240px;height:240px;}
      .spent-amount{font-size:28px;}
      .remaining-amount{font-size:24px;}
      .action-buttons{grid-template-columns:1fr;gap:15px;}
      .action-button{min-height:100px;padding:20px;}
      .action-icon{font-size:32px;}
      .action-text{font-size:16px;}
      .meal-button{width:100%;}
      .remaining-info{min-width:unset;width:100%;}
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <div class="week-info" id="weekInfo">Uke ‚Äì dd.‚Äìdd. mmmm</div>
    </div>

    <div class="budget-overview" aria-live="polite">
      <div class="budget-circle" role="img" aria-label="Budsjettforl√∏p">
        <div class="circle-bg">
          <div class="circle-progress" id="circleProgress"></div>
          <div class="circle-overshoot" id="circleOvershoot"></div>
        </div>
        <div class="circle-content">
          <div class="spent-amount" id="spentAmount">0 kr</div>
          <div class="total-budget" id="totalBudget">av 0 kr</div>
          <div class="center-note" id="centerNote">0%</div>
          <span class="sr-only" id="ariaStatus"></span>
        </div>
      </div>

      <div class="remaining-info" id="remainingBox">
        <div class="remaining-amount" id="remainingAmount">0 kr</div>
        <div class="remaining-text" id="remainingText">igjen denne uka</div>
        <div class="safe-chip" id="safeChip" style="display:none;">Trygt pr. dag: ‚Äì kr</div>
      </div>

      <button class="meal-button" id="mealPlanBtn">Middag for 0 kr ‚Äì vis forslag</button>
    </div>

    <div class="action-buttons">
      <button class="action-button" id="addPurchaseBtn">
        <span class="action-icon">‚ûï</span>
        <span class="action-text" id="addPurchaseText">Legg til kj√∏p</span>
      </button>
      <button class="action-button" id="shoppingListBtn">
        <span class="action-icon">üõí</span>
        <span class="action-text" id="shoppingListText">Handleliste</span>
      </button>
      <button class="action-button" id="weekReportBtn">
        <span class="action-icon">üìä</span>
        <span class="action-text" id="weekReportText">Ukesrapport</span>
      </button>
    </div>

    <div class="status-bar">
      <p class="status-message" id="statusMessage">Bra kontroll s√• langt üí™</p>
    </div>
  </main>

<script>
  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    week_text: "",
    spent_text: "Du har brukt",
    remaining_text: "igjen denne uka",
    add_purchase_text: "Legg til kj√∏p",
    shopping_list_text: "Handleliste",
    week_report_text: "Ukesrapport",
    status_message: "Bra kontroll s√• langt üí™"
  };

  // ---------- Uke-hjelpere ----------
  function mondayAtNoon(d = new Date()){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (x.getDay()+6)%7; // 0=man
    x.setDate(x.getDate()-day);
    x.setHours(12,0,0,0); // 12:00 for DST-sikkerhet
    return x;
  }
  function isoWeekNumber(date = new Date()) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  function formatRangeNoNO(fromDate, toDate) {
    const optsDayMonth = { day:'numeric', month:'long' };
    const optsDay = { day:'numeric' };
    const from = fromDate.toLocaleDateString('no-NO', optsDayMonth);
    const to = toDate.toLocaleDateString('no-NO', (fromDate.getMonth()===toDate.getMonth()? optsDay : optsDayMonth));
    return `${from}‚Äì${to}`;
  }
  function getActiveWeekISO(){
    const pinned = localStorage.getItem('activeWeekISO');
    if (pinned) return pinned;
    return mondayAtNoon().toISOString().slice(0,10);
  }
  function getActiveMondayDate(){
    const iso = getActiveWeekISO();
    const [y,m,d] = iso.split('-').map(Number);
    return new Date(y, m-1, d, 12, 0, 0, 0);
  }
  function dayIndexMonday0(date=new Date()){
    const n=(date.getDay()+6)%7; // 0=Mon..6=Sun
    return n;
  }
  function daysLeftIncludingToday(date=new Date()){
    const idx=dayIndexMonday0(date);
    return 7-idx; // Mon->7 ... Sun->1
  }

  function setWeekHeader() {
    const mon = getActiveMondayDate();
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    const weekNo = isoWeekNumber(mon);
    document.getElementById('weekInfo').textContent = `Uke ${weekNo} ‚Äì ${formatRangeNoNO(mon, sun)}`;
  }

  // ---------- Budsjett/kj√∏p (for aktiv uke) ----------
  let budgetData = { total: 0, spent: 0, remaining: 0 };

  function readWeeklyBudgetFor(isoMonday){
    const byWeek = parseInt((localStorage.getItem(`weeklyBudget_${isoMonday}`) || '').replace(/\D/g,''), 10);
    if (!isNaN(byWeek) && byWeek > 0) return byWeek;
    const global = parseInt((localStorage.getItem('weeklyBudget') || '').replace(/\D/g,''), 10);
    if (!isNaN(global) && global > 0) return global;
    return 3000;
  }

  function sumPurchasesFor(isoMonday) {
    const key = `purchases_${isoMonday}`;
    try{
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      if (!Array.isArray(arr)) return 0;
      return arr.reduce((acc, p) => acc + (Number(p?.amount)||0), 0);
    }catch{ return 0; }
  }

  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  function pickColorByPct(pct){
    if (pct < 0.6) return getComputedStyle(document.documentElement).getPropertyValue('--green') || '#4caf50';
    if (pct < 0.9) return getComputedStyle(document.documentElement).getPropertyValue('--amber') || '#fbc02d';
    if (pct <= 1.0) return getComputedStyle(document.documentElement).getPropertyValue('--orange') || '#ff9800';
    return getComputedStyle(document.documentElement).getPropertyValue('--red') || '#e53935';
  }

  function updateStatusCopy(pct, remaining){
    const msg = document.getElementById('statusMessage');
    if (budgetData.total <= 0){
      msg.textContent = 'Sett ukesbudsjett for √• komme i gang ‚öôÔ∏è';
      return;
    }
    if (remaining < 0){
      msg.textContent = 'Over budsjett ‚Äì pr√∏v 1‚Äì2 rimelige middager og stram inn litt ‚ö†Ô∏è';
      return;
    }
    if (pct < 0.6) msg.textContent = 'Bra kontroll s√• langt üí™';
    else if (pct < 0.9) msg.textContent = 'Du n√¶rmer deg grensen ‚Äì f√∏lg litt med üëÄ';
    else msg.textContent = 'P√• budsjettgrensen ‚Äì v√¶r obs p√• forbruket! üü†';
  }

  function updateDailyChip(remaining){
    const chip = document.getElementById('safeChip');
    if (remaining <= 0){
      chip.style.display = 'none';
      return;
    }
    const dl = daysLeftIncludingToday(new Date());
    const perDay = Math.max(0, Math.floor(remaining / dl));
    chip.textContent = `Trygt pr. dag: ${formatAmount(perDay)} kr`;
    chip.style.display = 'inline-block';
  }

  function updateMealButton(remaining){
    const mealBtn = document.getElementById('mealPlanBtn');
    if (remaining >= 0){
      mealBtn.textContent = `Middag for ${formatAmount(remaining)} kr ‚Äì vis forslag`;
    } else {
      mealBtn.textContent = `Over budsjett ‚Äì se billige middager`;
    }
  }

  function updateRing(spent, total){
    const progress = document.getElementById('circleProgress');
    const overshoot = document.getElementById('circleOvershoot');
    const note = document.getElementById('centerNote');
    const aria = document.getElementById('ariaStatus');

    if (total <= 0){
      // N√∏ytral
      progress.style.background = `conic-gradient(#cfd8dc 0deg, #cfd8dc 0deg, transparent 0deg)`;
      overshoot.classList.remove('show');
      note.textContent = `0%`;
      aria.textContent = `Ingen budsjett satt`;
      return;
    }

    const pct = spent / total;
    const clampedPct = Math.min(1, Math.max(0, pct));
    const deg = clampedPct * 360;
    const color = pickColorByPct(pct);

    // Hovedring
    progress.style.background = `conic-gradient(${color} 0deg, ${color} ${deg}deg, transparent ${deg}deg)`;

    // Overshoot-bue (maks 30% av full sirkel)
    if (pct > 1){
      const overshootPct = Math.min(pct - 1, 0.30);
      const overDeg = overshootPct * 360;
      overshoot.style.background = `conic-gradient(var(--red) 0deg, var(--red) ${overDeg}deg, transparent ${overDeg}deg)`;
      overshoot.classList.add('show');
    } else {
      overshoot.classList.remove('show');
    }

    const pctText = `${Math.round(Math.min(pct,1)*100)}%`;
    note.textContent = pctText;
    aria.textContent = `Brukt ${formatAmount(spent)} av ${formatAmount(total)} kroner, ${pctText}`;
  }

  function updateBudgetDisplay() {
    const spentElement = document.getElementById('spentAmount');
    const totalElement = document.getElementById('totalBudget');
    const remainingElement = document.getElementById('remainingAmount');
    const remainingText = document.getElementById('remainingText');
    const remainingBox = document.getElementById('remainingBox');

    const { total, spent, remaining } = budgetData;

    // Tekstfelt
    spentElement.textContent     = `${formatAmount(spent)} kr`;
    totalElement.textContent     = `av ${formatAmount(total)} kr`;

    // Remaining / overskredet
    if (total <= 0){
      remainingElement.textContent = `‚Äî`;
      remainingText.textContent = `sett et ukesbudsjett`;
      remainingBox.style.background = `#fff3cd`;
      remainingElement.style.color = `#856404`;
    } else if (remaining >= 0){
      remainingElement.textContent = `${formatAmount(remaining)} kr`;
      remainingText.textContent = `igjen denne uka`;
      remainingBox.style.background = `rgba(76,175,80,.1)`;
      remainingElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--green') || '#4caf50';
    } else {
      const over = Math.abs(remaining);
      remainingElement.textContent = `${formatAmount(over)} kr`;
      remainingText.textContent = `overskredet denne uka`;
      remainingBox.style.background = `#fdecea`;
      remainingElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--red') || '#e53935';
    }

    // Ring
    updateRing(spent, total);

    // Daglig chip + knapp + status
    updateDailyChip(remaining);
    updateMealButton(remaining);

    // Animasjonspuls
    [spentElement, remainingElement].forEach(el => {
      el.classList.add('pulse');
      setTimeout(()=>el.classList.remove('pulse'), 600);
    });

    // Statuskopi
    const pct = total > 0 ? spent/total : 0;
    updateStatusCopy(pct, remaining);
  }

  function recalcFromStorage() {
    const weekISO = getActiveWeekISO();
    budgetData.total = readWeeklyBudgetFor(weekISO);
    localStorage.setItem('budget_total', String(budgetData.total)); // for week-report o.l.
    budgetData.spent = sumPurchasesFor(weekISO);
    budgetData.remaining = budgetData.total - budgetData.spent; // kan v√¶re negativ
    updateBudgetDisplay();
  }

  // ---------- UI farger fra config ----------
  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''),16), amt=Math.round(2.55*percent);
    const R=Math.max(0,Math.min(255,(num>>16)+amt));
    const G=Math.max(0,Math.min(255,((num>>8)&0x00FF)+amt));
    const B=Math.max(0,Math.min(255,((num)&0x0000FF)+amt));
    return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
  }

  async function onConfigChange(config) {
    const backgroundColor   = config.background_color   || defaultConfig.background_color;
    const surfaceColor      = config.surface_color      || defaultConfig.surface_color;
    const textColor         = config.text_color         || defaultConfig.text_color;
    const primaryActionColor= config.primary_action_color|| defaultConfig.primary_action_color;
    const secondaryTextColor= config.secondary_text_color|| defaultConfig.secondary_text_color;
    const customFont        = config.font_family        || defaultConfig.font_family;
    const baseSize          = config.font_size          || defaultConfig.font_size;

    document.body.style.background =
      `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-2)} 100%)`;

    const mapStyle = (id, size, color)=>{
      const node = document.getElementById(id);
      node.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      node.style.fontSize = `${size}px`;
      node.style.color = color;
    };
    mapStyle('weekInfo', baseSize * 1.11, secondaryTextColor);
    mapStyle('spentAmount', baseSize * 2, textColor);
    mapStyle('totalBudget', baseSize * 1.0, secondaryTextColor);
    mapStyle('remainingAmount', baseSize * 1.56, primaryActionColor);
    mapStyle('remainingText', baseSize * 0.95, textColor);
    mapStyle('statusMessage', baseSize, secondaryTextColor);

    document.querySelectorAll('.action-text').forEach(t=>{
      t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      t.style.color = textColor;
    });
    document.querySelectorAll('.action-button').forEach(b=>{
      b.style.background = surfaceColor;
      b.style.borderColor = adjustColor(primaryActionColor, 60);
    });

    document.documentElement.style.setProperty('--green', primaryActionColor);
    document.documentElement.style.setProperty('--text', textColor);
    document.documentElement.style.setProperty('--text-2', secondaryTextColor);
    document.documentElement.style.setProperty('--surface', surfaceColor);

    document.querySelector('.circle-bg').style.background = adjustColor(primaryActionColor, 85);
    document.getElementById('remainingBox').style.background = `${primaryActionColor}1a`;
    document.querySelector('.status-bar').style.background = `${surfaceColor}b3`;
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk && window.elementSdk.setConfig({ background_color: v }) },
        { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk && window.elementSdk.setConfig({ surface_color: v }) },
        { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk && window.elementSdk.setConfig({ text_color: v }) },
        { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: v => window.elementSdk && window.elementSdk.setConfig({ primary_action_color: v }) },
        { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk && window.elementSdk.setConfig({ secondary_text_color: v }) },
      ],
      borderables: [],
      fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk && window.elementSdk.setConfig({ font_family: v }) },
      fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk && window.elementSdk.setConfig({ font_size: v }) }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["week_text", config.week_text || defaultConfig.week_text],
      ["spent_text", config.spent_text || defaultConfig.spent_text],
      ["remaining_text", config.remaining_text || defaultConfig.remaining_text],
      ["add_purchase_text", config.add_purchase_text || defaultConfig.add_purchase_text],
      ["shopping_list_text", config.shopping_list_text || defaultConfig.shopping_list_text],
      ["week_report_text", config.week_report_text || defaultConfig.week_report_text],
      ["status_message", config.status_message || defaultConfig.status_message]
    ]);
  }

  // ---------- Navigasjon ----------
  document.getElementById('addPurchaseBtn').addEventListener('click', () => {
    location.href = 'add-purchase.html';
  });
  document.getElementById('shoppingListBtn').addEventListener('click', () => {
    location.href = 'handleliste.html';
  });
  document.getElementById('weekReportBtn').addEventListener('click', () => {
    location.href = 'week-report.html';
  });
  document.getElementById('mealPlanBtn').addEventListener('click', () => {
    location.href = 'middag.html';
  });

  // Oppdater ved lagring/endring fra andre faner/sider
  window.addEventListener('storage', (e) => {
    const weekISO = getActiveWeekISO();
    if (e.key === `purchases_${weekISO}` || e.key === `weeklyBudget_${weekISO}` || e.key === 'weeklyBudget') {
      recalcFromStorage();
    }
  });

  // ---------- Init / refresh ----------
  function init() {
    setWeekHeader();
    recalcFromStorage();
  }
  window.addEventListener('DOMContentLoaded', init);
  window.addEventListener('pageshow', init);

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities,
      mapToEditPanelValues
    });
  }
</script>
</body>
</html>
