<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Husholdningsbudsjett - Hovedskjerm</title>

  <!-- Element SDK (valgfri redigering/tema) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>
  <script src="/js/services/household-context.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/budget-utils.js"></script>
  <script src="/js/services/budget-service.js"></script>
  <script src="/js/ui/toast.js"></script>
  <script src="/js/ui/animate.js"></script>

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f6f9ff 0%, #eef7f1 100%);
      --surface: #ffffff;
      --text-main: #1c1c1e;
      --text-muted: #8e8e93;
      --accent-soft-green: #e8f5e9;
      --brand-green: #4caf50;
      --brand-green-dark: #2d5c45;
      --border-light: #e5e5ea;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:'Inter','SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:var(--bg-gradient);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
    }
    html{height:100%;}

    .app-shell{
      max-width:520px;
      margin:0 auto;
      padding:16px 16px 24px;
      width:100%;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .container{flex:1;}

    .hero-section{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hero-card{
      background:#ffffff;
      border-radius:24px;
      padding:20px 18px 18px;
      box-shadow:0 12px 30px rgba(0,0,0,0.06);
      border:1px solid rgba(229,229,234,0.7);
      display:flex;
      flex-direction:column;
      gap:14px;
      animation:fadeInDown .6s ease-out;
    }
    .hero-top{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      text-align:center;
    }
    .week-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:var(--accent-soft-green);
      color:var(--brand-green-dark);
      font-size:12px;
      font-weight:600;
      letter-spacing:0.01em;
      box-shadow:0 8px 18px rgba(76,175,80,0.18);
    }
    .week-range{
      margin:0;
      font-size:14px;
      color:var(--text-muted);
      font-weight:500;
    }

    .hero-content{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .budget-circle{
      position:relative;
      width:240px;
      height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:4px auto 0;
    }
    .circle-bg{
      width:100%;
      height:100%;
      border-radius:50%;
      background:#ffffff;
      position:relative;
      overflow:hidden;
    }
    .progress-ring{
      position:absolute;
      inset:16px;
      width:calc(100% - 32px);
      height:calc(100% - 32px);
      transform:rotate(-90deg);
    }
    .progress-ring circle{
      fill:none;
      stroke-width:10;
    }
    .progress-ring .progress-ring-bg{
      stroke:var(--border-light);
      fill:none;
    }
    .progress-ring .progress-ring-progress{
      stroke:var(--brand-green, #2d5c45);
      stroke-linecap:round;
      fill:none;
      transition:stroke-dashoffset 1.2s cubic-bezier(0.2,0.8,0.2,1), stroke 0.4s ease;
      transform-origin:center;
      filter:drop-shadow(0 6px 14px rgba(76,175,80,0.3));
    }
    .progress-ring .progress-ring-center{
      fill:#ffffff;
      stroke:none;
      transform:rotate(90deg);
      transform-origin:center;
    }
    .circle-content{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      z-index:10;
      padding:0 18px;
    }
    .budget-pop{
      animation:popIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    }
    @keyframes popIn{
      0%{transform:scale(0.88);opacity:0;}
      100%{transform:scale(1);opacity:1;}
    }

    /* IGJEN ‚Äì tall */
    .remaining-amount{
      font-size:32px;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      color:var(--text-main);
      margin:0 0 4px 0;
    }
    .remaining-amount.warn{color:#a06412;}
    .remaining-amount.over{color:#ffffff;}
    .remaining-text{
      font-size:14px;
      color:var(--text-muted);
      margin:0;
    }
    .remaining-text.warn{color:#a06412;}
    .remaining-text.over{color:#ffffff;}

    .spent-summary{
      font-size:14px;
      color:var(--text-muted);
      font-weight:500;
      text-align:center;
      margin-top:6px;
    }

    .hero-meta{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      text-align:center;
    }
    .hero-action{
      display:flex;
      justify-content:center;
      margin-top:4px;
    }
    .status-pill{
      font-size:13px;
      font-weight:600;
      color:var(--brand-green-dark);
      background:var(--accent-soft-green);
      border-radius:14px;
      padding:8px 12px;
      width:100%;
      max-width:360px;
      box-shadow:0 10px 24px rgba(76,175,80,0.16);
      margin:2px auto 0;
      text-align:center;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .actions-section{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .primary-action-wrapper{
      display:flex;
      justify-content:center;
      margin:4px 0 8px;
    }
    .primary-cta{
      min-width:220px;
      height:48px;
      padding:0 20px;
      border-radius:999px;
      border:none;
      font-size:16px;
      font-weight:700;
      background:var(--brand-green-dark);
      color:#ffffff;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(45,92,69,0.35);
      transition:transform 0.08s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.12s ease;
    }
    .primary-cta:hover{box-shadow:0 12px 24px rgba(45,92,69,0.32);}
    .primary-cta:active{
      transform:scale(0.97);
      box-shadow:0 6px 12px rgba(45,92,69,0.25);
    }

    .nav-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media (min-width:600px){
      .nav-grid{gap:16px;}
    }
    .nav-card{
      background:#ffffff;
      border-radius:18px;
      padding:16px 18px;
      box-shadow:0 4px 12px rgba(0,0,0,0.04);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
      cursor:pointer;
      border:1px solid rgba(229,229,234,0.8);
      transition:transform 0.08s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .nav-card:active{
      transform:scale(0.97);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    .nav-card-icon{
      width:32px;
      height:32px;
      border-radius:999px;
      background:var(--accent-soft-green);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--brand-green-dark);
      font-size:18px;
    }
    .nav-card-label{
      font-size:15px;
      font-weight:600;
      color:var(--text-main);
    }
    .nav-card-subtitle{
      font-size:13px;
      color:var(--text-muted);
      line-height:1.4;
    }

    .recent-section{
      background:rgba(255,255,255,0.78);
      border-radius:18px;
      padding:14px 14px 16px;
      box-shadow:0 10px 24px rgba(0,0,0,0.04);
      border:1px solid rgba(229,229,234,0.6);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .section-title{
      font-size:16px;
      font-weight:700;
      color:var(--text-main);
      margin:0 0 8px 0;
    }
    .recent-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .recent-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:12px;
      background:#ffffff;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
      font-size:14px;
      border:1px solid rgba(229,229,234,0.8);
      gap:8px;
    }
    .recent-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .recent-store{
      font-weight:600;
      color:var(--text-main);
    }
    .recent-meta{
      font-size:12px;
      color:var(--text-muted);
    }
    .recent-amount{
      font-size:14px;
      font-weight:700;
      color:var(--text-main);
    }
    .recent-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .recent-delete-btn{
      margin-left:2px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      opacity:0.7;
      transition:opacity 0.15s ease, transform 0.08s ease;
    }
    .recent-delete-btn:hover{
      opacity:1;
      transform:scale(1.05);
    }
    .recent-delete-btn:focus-visible{
      outline:2px solid var(--brand-green);
      outline-offset:2px;
    }
    .recent-empty{
      padding:16px 14px;
      border-radius:16px;
      background:#f2f2f7;
      text-align:center;
    }
    .recent-empty-icon{
      font-size:24px;
      margin-bottom:6px;
    }
    .recent-empty-title{
      font-size:14px;
      font-weight:600;
      color:var(--text-main);
      margin:0 0 4px 0;
    }
    .recent-empty-text{
      font-size:13px;
      color:var(--text-muted);
      margin:0;
    }

    .budget-over .week-pill{
      background:#ffecec;
      color:#b3261e;
      box-shadow:0 8px 18px rgba(179,38,30,0.15);
    }
    .budget-over .status-pill{
      background:#ffecec;
      color:#b3261e;
      box-shadow:0 8px 20px rgba(179,38,30,0.18);
    }
    .pulse{animation:pulse 2s ease-in-out;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width:768px){
      .app-shell{padding:14px 14px 22px;}
      .budget-circle{width:220px;height:220px;}
      .progress-ring{inset:14px;}
      .remaining-amount{font-size:30px;}
      .week-range{font-size:13px;}
      /* Sticky CTA can be enabled later if needed */
    }

    @view-transition { navigation: auto; }
  </style>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" />
  <link rel="stylesheet" href="/css/driver-overrides.css" />
  <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js"></script>
  <script src="/js/ui/tour-manager.js"></script>
</head>
<body>
  <main class="app-shell container">
    <section class="hero-section">
      <div class="hero-card">
        <div class="hero-top">
          <div class="week-pill">
            <span id="weekText">Uke 0</span>
          </div>
          <p class="week-range" id="dateRange">dd.‚Äìdd. mmmm</p>
        </div>

        <div class="hero-content">
          <div class="budget-circle">
            <div class="circle-bg">
              <svg class="progress-ring" viewBox="0 0 160 160" aria-hidden="true">
                <circle class="progress-ring-bg" cx="80" cy="80" r="70" fill="none"></circle>
                <circle class="progress-ring-progress" id="budgetProgressRing" cx="80" cy="80" r="70" fill="none"></circle>
                <circle class="progress-ring-center" cx="80" cy="80" r="52"></circle>
              </svg>
            </div>
            <div class="circle-content budget-pop">
              <div class="remaining-amount" id="remainingAmount">0 kr</div>
              <div class="remaining-text" id="remainingText">igjen denne uka</div>
            </div>
          </div>
          <div class="spent-summary" id="spentSummary">Brukt 0 kr av 0 kr</div>
        </div>

        <div class="status-pill" id="motivationMessage">Bra kontroll s√• langt üí™</div>

        <div class="hero-action">
          <button class="primary-cta" id="addPurchaseBtn">
            Legg til kj√∏p
          </button>
        </div>
      </div>
    </section>

    <section class="actions-section">
      <div class="nav-grid">
        <button class="nav-card" id="shoppingListBtn">
          <div class="nav-card-icon">üß∫</div>
          <div class="nav-card-label action-text" id="shoppingListText">Handleliste</div>
          <div class="nav-card-subtitle">Alt dere trenger √• kj√∏pe</div>
        </button>
        <button class="nav-card" id="weekReportBtn">
          <div class="nav-card-icon">üìä</div>
          <div class="nav-card-label action-text" id="weekReportText">Ukesrapport</div>
          <div class="nav-card-subtitle">Se hvordan uka gikk</div>
        </button>
        <button class="nav-card" id="mealPlanBtn">
          <div class="nav-card-icon">üçΩÔ∏è</div>
          <div class="nav-card-label">Middagsforslag</div>
          <div class="nav-card-subtitle" id="mealPlanSubtitle">Se forslag som passer budsjettet deres</div>
        </button>
        <button class="nav-card" id="settingsBtn">
          <div class="nav-card-icon">‚öôÔ∏è</div>
          <div class="nav-card-label">Innstillinger</div>
          <div class="nav-card-subtitle">Budsjett og husholdning</div>
        </button>
      </div>
    </section>

    <section class="recent-section">
      <div class="section-header">
        <h2 class="section-title">Siste kj√∏p</h2>
      </div>
      <div id="recentActivity" class="recent-body">
        <!-- fylles av JS -->
      </div>
    </section>
  </main>

<script>
  // ===== Supabase init ===================================================
  const supa = window.supaClient?.getClient();
  const showToast = (message, type = 'info') => {
    if (window.toast?.show) {
      window.toast.show(message, { type });
    } else {
      console[type === 'error' ? 'error' : 'log'](message);
    }
  };

  // ===== Element/tema konfig ============================================
  const defaultConfig = {
    background_color: "#f6f9ff",
    surface_color: "#ffffff",
    text_color: "#1c1c1e",
    primary_action_color: "#4caf50",
    secondary_text_color: "#8e8e93",
    font_family: "Inter",
    font_size: 18,
    week_text: "",
    spent_text: "Du har brukt",
    remaining_text: "igjen denne uka",
    add_purchase_text: "Legg til kj√∏p",
    shopping_list_text: "Handleliste",
    week_report_text: "Ukesrapport",
    status_message: "Bra kontroll s√• langt üí™"
  };

  // ===== Global state ====================================================
  const state = {
    activeWeekISO: '',
    budget: 0,
    spent: 0,
    remaining: 0,
    lastSpent: 0,
    lastRemaining: 0
  };
  let isSummaryLoading = false;
  let summaryLoadError = null;
  let cachedHouseholdId = null;
  const dateUtils = window.dateUtils || {};
  const budgetService = window.budgetService || null;
  const budgetUtils = window.budgetUtils || {};
  const householdCtx = window.householdContext;

  // ---------- Uke-hjelpere ----------------------------------------------
  function resolveActiveWeekISO() {
    if (dateUtils.getOrInitActiveWeekISO) {
      return dateUtils.getOrInitActiveWeekISO();
    }
    if (dateUtils.mondayISO) return dateUtils.mondayISO();
    const today = new Date();
    today.setHours(12, 0, 0, 0);
    return today.toISOString().slice(0, 10);
  }

  function getActiveMondayDate(){
    const iso =
      state.activeWeekISO ||
      resolveActiveWeekISO();
    if (dateUtils.dateFromISOLocal) {
      return dateUtils.dateFromISOLocal(iso);
    }
    const [y, m, d] = iso.split('-').map(Number);
    return new Date(y, m - 1, d, 12, 0, 0, 0);
  }

  function setWeekHeader() {
    const mon = getActiveMondayDate();
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    const weekNo = dateUtils.isoWeekNumber ? dateUtils.isoWeekNumber(mon) : '';

    const weekTextEl = document.getElementById('weekText');
    const dateRangeEl = document.getElementById('dateRange');
    if (weekTextEl) weekTextEl.textContent = `Uke ${weekNo}`;
    if (dateRangeEl) {
      const range = dateUtils.formatRangeNoNO
        ? dateUtils.formatRangeNoNO(mon, sun)
        : `${mon.toLocaleDateString('no-NO')}‚Äì${sun.toLocaleDateString('no-NO')}`;
      dateRangeEl.textContent = range;
    }
  }

  // ---------- Local fallback for budsjett/kj√∏p --------------------------
  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }
  function escapeHTML(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function readJSON(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw) ?? fallback;
    } catch {
      return fallback;
    }
  }

  // ---------- Hent uke-data fra Supabase + cache til localStorage -------
  async function loadWeekData() {
    const iso =
      state.activeWeekISO ||
      resolveActiveWeekISO();

    isSummaryLoading = true;
    summaryLoadError = null;
    updateBudgetDisplay();

    try {
      let summary = null;
      if (budgetService?.loadWeekSummary) {
        summary = await budgetService.loadWeekSummary(supa, iso);
      }

      if (summary) {
        state.activeWeekISO = summary.weekISO;
        state.budget = summary.budget;
        state.spent = summary.spent;
        state.remaining = summary.remaining;
        return;
      }

      const fallbackBudget = budgetService?.readWeeklyBudgetLocal
        ? budgetService.readWeeklyBudgetLocal(iso)
        : 3000;
      const localPurchases = readJSON(`purchases_${iso}`, []);
      const fallbackSpent = budgetUtils.safeSumPurchases
        ? budgetUtils.safeSumPurchases(localPurchases)
        : 0;

      state.activeWeekISO = iso;
      state.budget = fallbackBudget;
      state.spent = fallbackSpent;
      state.remaining = state.budget - state.spent;
      summaryLoadError = 'Kunne ikke hente ukedata ‚Äì viser lagret informasjon.';
      showToast('Kunne ikke hente ukedata, viser cache.', 'error');
    } catch (err) {
      console.error('loadWeekData', err);
      summaryLoadError = 'Kunne ikke hente ukedata.';
      showToast('Kunne ikke hente ukedata.', 'error');
    } finally {
      isSummaryLoading = false;
      updateBudgetDisplay();
    }
  }

  async function resolveHouseholdId() {
    if (cachedHouseholdId) return cachedHouseholdId;
    if (!householdCtx?.getHouseholdId) return null;
    try {
      const id = await householdCtx.getHouseholdId(supa);
      cachedHouseholdId = id;
      return id;
    } catch (err) {
      console.warn('resolveHouseholdId feilet', err);
      return null;
    }
  }

  async function loadRecentActivity() {
    const activityContainer = document.getElementById('recentActivity');
    if (!activityContainer) return;
    const weekISO = state.activeWeekISO || resolveActiveWeekISO();
    activityContainer.innerHTML = `
      <div class="recent-empty">
        <div class="recent-empty-icon">‚è≥</div>
        <p class="recent-empty-title">Henter siste kj√∏p‚Ä¶</p>
        <p class="recent-empty-text">Vent litt mens vi laster.</p>
      </div>
    `;

    let rows = [];
    const householdId = await resolveHouseholdId();
    if (householdId) {
      try {
        const { data, error } = await supa
          .from('purchases')
          .select('id, amount, store, week_start, purchased_at, created_at, category')
          .eq('household_id', householdId)
          .order('purchased_at', { ascending: false })
          .order('created_at', { ascending: false })
          .limit(3);

        if (!error && Array.isArray(data)) {
          rows = data;
        } else if (error) {
          console.warn('Kunne ikke hente siste kj√∏p', error);
        }
      } catch (err) {
        console.warn('loadRecentActivity feilet', err);
      }
    }

    if (!rows || rows.length === 0) {
      const localPurchases = readJSON(`purchases_${weekISO}`, []);
      if (Array.isArray(localPurchases) && localPurchases.length > 0) {
        rows = localPurchases.slice(-3).reverse();
      }
    }

    if (!rows || rows.length === 0) {
      activityContainer.innerHTML = `
        <div class="recent-empty">
          <div class="recent-empty-icon">üõí</div>
          <p class="recent-empty-title">Ingen registrerte kj√∏p enn√•</p>
          <p class="recent-empty-text">
            Har dere v√¶rt superflinke, eller bare glemt √• registrere? üòâ
          </p>
        </div>
      `;
      return;
    }

    const normalizedRows = rows.map((p) => {
      const amount = Number(p.amount || p.sum || 0);
      const amountText = `${formatAmount(amount)} kr`;
      const whenRaw = p.purchased_at || p.date || p.created_at || p.week_start;
      let dateText = '';
      if (whenRaw) {
        try {
          dateText = dateUtils.formatShortDate
            ? dateUtils.formatShortDate(whenRaw)
            : new Date(whenRaw).toLocaleDateString('no-NO');
        } catch {
          dateText = '';
        }
      }
      return {
        id: p.id,
        store: p.store || 'Butikk',
        amountText,
        dateText,
      };
    });

    activityContainer.innerHTML = `
      <div class="recent-list">
        ${normalizedRows.map((p) => {
          const deleteBtn = p.id
            ? `<button class="recent-delete-btn" onclick="handleDeleteRecentPurchase('${String(p.id).replace(/'/g, "\\'")}')" aria-label="Slett kj√∏p">üóë</button>`
            : '';
          const metaText = p.dateText ? escapeHTML(p.dateText) : 'Nylig';
          return `
            <div class="recent-item">
              <div class="recent-main">
                <span class="recent-store">${escapeHTML(p.store)}</span>
                <span class="recent-meta">${metaText}</span>
              </div>
              <div class="recent-right">
                <span class="recent-amount">${p.amountText}</span>
                ${deleteBtn}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  async function handleDeleteRecentPurchase(purchaseId) {
    if (!purchaseId) return;

    const confirmed = window.confirm('Vil du slette dette kj√∏pet?');
    if (!confirmed) return;

    if (!budgetService?.deletePurchaseById) {
      console.warn('deletePurchaseById mangler p√• budgetService');
      return;
    }

    const { error } = await budgetService.deletePurchaseById(supa, purchaseId);

    if (error) {
      console.error('Kunne ikke slette kj√∏pet', error);
      showToast('Kunne ikke slette kj√∏pet. Pr√∏v igjen.', 'error');
      return;
    }

    const weekISO = state.activeWeekISO || resolveActiveWeekISO();
    if (budgetService?.removePurchaseFromLocalCache) {
      try {
        budgetService.removePurchaseFromLocalCache(purchaseId, weekISO);
      } catch (err) {
        console.warn('Klarte ikke fjerne kj√∏p fra lokal cache', err);
      }
    } else {
      console.warn('removePurchaseFromLocalCache mangler p√• budgetService');
    }

    try {
      if (typeof loadWeekData === 'function') {
        await loadWeekData();
      }
      if (typeof loadRecentActivity === 'function') {
        await loadRecentActivity();
      }
      if (typeof updateBudgetDisplay === 'function') {
        updateBudgetDisplay();
      }
    } catch (e) {
      console.warn('Feil ved reloading etter sletting', e);
    }

    showToast('Kj√∏pet er slettet ‚úÖ', 'success');
  }

  // ---------- Oppdater UI ----------------------------------------------
function updateBudgetDisplay() {
  const remainingElement = document.getElementById('remainingAmount');
  const remainingText    = document.getElementById('remainingText');
  const spentSummaryEl   = document.getElementById('spentSummary');
  const motivationMsg    = document.getElementById('motivationMessage');
  const mealSubtitle     = document.getElementById('mealPlanSubtitle');
  const progressRing     = document.getElementById('budgetProgressRing');

  const radius = progressRing?.r?.baseVal?.value || 70;
  const circumference = 2 * Math.PI * radius;
  if (progressRing) {
    progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
  }

  if (isSummaryLoading) {
    if (remainingElement) {
      remainingElement.textContent = '...';
      remainingElement.style.color = '#8e8e93';
    }
    if (remainingText) {
      remainingText.textContent = 'Henter ukedata‚Ä¶';
      remainingText.style.color = '#8e8e93';
    }
    if (spentSummaryEl) {
      spentSummaryEl.textContent = 'Henter data‚Ä¶';
    }
    if (progressRing) {
      progressRing.style.stroke = '#d1d5db';
      progressRing.style.strokeDashoffset = circumference;
    }
    if (motivationMsg) {
      motivationMsg.textContent = 'Henter ukedata‚Ä¶';
    }
    return;
  }

  const total = state.budget;
  const spent = state.spent;
  const remainingRaw = total > 0 ? (total - spent) : 0;
  state.remaining = remainingRaw;
  const formatKr = (v) => `${formatAmount(Math.max(0, Math.round(v)))} kr`;
  const startSpent = typeof state.lastSpent === 'number' ? state.lastSpent : 0;
  const startRemaining = typeof state.lastRemaining === 'number' ? state.lastRemaining : 0;
  const remainingDisplay = remainingRaw < 0 ? Math.abs(remainingRaw) : remainingRaw;
  const startRemainingDisplay = startRemaining < 0 ? Math.abs(startRemaining) : Math.max(startRemaining, 0);

  // Oppdater "Brukt X av Y"
  if (spentSummaryEl) {
    const summaryFormatter = (v) => `Brukt ${formatAmount(Math.round(v))} kr av ${formatAmount(total)} kr`;
    if (window.uiAnimate?.animateValue) {
      window.uiAnimate.animateValue(spentSummaryEl, startSpent, spent, 1200, summaryFormatter);
    } else {
      spentSummaryEl.textContent = summaryFormatter(spent);
    }
  }

  // Reset tekstfarger til "normal" hver gang
  if (remainingElement) {
    remainingElement.style.color = '#1c1c1e';
    remainingElement.classList.remove('warn','over');
  }
  if (remainingText) {
    remainingText.style.color    = '#8e8e93';
    remainingText.classList.remove('warn','over');
  }

  let color  = '#4caf50';   // ring-farge
  let status = 'Bra kontroll s√• langt üí™';
  let warningText = '';
  let paceText = '';
  const ratio = total > 0 ? (spent / total) : 0;

  if (total > 0) {
    if (ratio >= 1.0) {
      // OVER budsjett ‚Äì full r√∏d ring, hvit tekst for maks kontrast
      color = '#d32f2f';

      remainingElement?.classList.add('over');
      remainingText?.classList.add('over');
      if (remainingText) remainingText.textContent = 'overskredet';

      warningText = 'Over budsjett ‚Äì kutt kostnader üí∏';
      status = warningText;

    } else if (ratio >= 0.7) {
      // N√ÜR budsjett ‚Äì gul ring, m√∏rk gul/brun tekst
      color = '#f9a825';

      remainingElement?.classList.add('warn');
      remainingText?.classList.add('warn');
      if (remainingText) remainingText.textContent = 'igjen denne uka';

      warningText = 'N√¶r budsjett ‚Äì vurder billigere valg ‚ö†Ô∏è';
      status = warningText;

    } else {
      // God kontroll ‚Äì gr√∏nn ring, m√∏rk tekst
      color = '#4caf50';
      if (remainingText) remainingText.textContent = 'igjen denne uka';
      status = 'Bra kontroll s√• langt üí™';
    }
  } else {
    // Ikke satt budsjett
    color = '#4caf50';
    if (remainingElement) remainingElement.style.color = '#1c1c1e';
    if (remainingText) {
      remainingText.style.color    = '#8e8e93';
      remainingText.textContent    = 'sett ukesbudsjett i innstillinger';
    }
    status = 'Sett et ukesbudsjett for √• komme i gang üôÇ';
  }

  if (remainingElement) {
    if (window.uiAnimate?.animateValue) {
      window.uiAnimate.animateValue(
        remainingElement,
        startRemainingDisplay,
        remainingDisplay,
        1500,
        (v) => `${formatAmount(Math.round(v))} kr`
      );
    } else {
      remainingElement.textContent = formatKr(remainingDisplay);
    }
  }

  if (progressRing) {
    const pct = total > 0 ? Math.min(spent / total, 1) : 0;
    const offset = circumference * (1 - pct);

    // smooth progress-ring animation
    if (!progressRing.dataset.initialized) {
      progressRing.style.transition = 'none';
      progressRing.style.strokeDashoffset = circumference;
      progressRing.getBoundingClientRect(); // force reflow
      progressRing.style.transition =
        'stroke-dashoffset 1.2s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 0.4s ease';
      progressRing.dataset.initialized = 'true';

      setTimeout(() => {
        progressRing.style.stroke = color;
        progressRing.style.strokeDashoffset = offset;
      }, 100);
    } else {
      progressRing.style.stroke = color;
      progressRing.style.strokeDashoffset = offset;
    }
  }

  if (mealSubtitle) {
    mealSubtitle.textContent = 'Se forslag som passer budsjettet deres';
  }

  if (total > 0) {
    const today = new Date();
    const dayIndex = (today.getDay() + 6) % 7; // 0 = mandag
    const weekProgress = (dayIndex + 1) / 7;
    const budgetRatio = spent / total;

    let text = 'üëç Dere f√∏lger budsjettet ganske bra.';
    if (budgetRatio > weekProgress + 0.15) {
      text = 'üî• Forbruket er litt h√∏yt for denne ukedagen ‚Äì ta en rolig dag?';
    } else if (budgetRatio < weekProgress - 0.1) {
      text = 'üê¢ Dere ligger godt an denne uka ‚Äì super kontroll!';
    }

    paceText = text;
  }

  let motivationText = 'Bra kontroll s√• langt üí™';
  if (summaryLoadError) {
    motivationText = summaryLoadError;
  } else if (warningText) {
    motivationText = warningText;
  } else if (paceText) {
    motivationText = paceText;
  } else {
    motivationText = status || 'Bra kontroll s√• langt üí™';
  }

  if (motivationMsg) {
    motivationMsg.textContent = motivationText;
  }

  // Liten ‚Äúpulse‚Äù n√•r tallene oppdateres
  if (remainingElement) {
    remainingElement.classList.add('pulse');
    setTimeout(() => remainingElement.classList.remove('pulse'), 600);
  }

  const container = document.querySelector('.container');
  if (container) {
    container.classList.toggle('budget-over', remainingRaw < 0);
  }

  state.lastRemaining = remainingRaw;
  state.lastSpent = spent;
}

  // ---------- Farge/tema fra Element SDK -------------------------------
  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#',''),16), amt=Math.round(2.55*percent);
    const R=Math.max(0,Math.min(255,(num>>16)+amt));
    const G=Math.max(0,Math.min(255,((num>>8)&0x00FF)+amt));
    const B=Math.max(0,Math.min(255,((num)&0x0000FF)+amt));
    return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
  }

  async function onConfigChange(config) {
    const backgroundColor    = config.background_color    || defaultConfig.background_color;
    const surfaceColor       = config.surface_color       || defaultConfig.surface_color;
    const textColor          = config.text_color          || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color|| defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color|| defaultConfig.secondary_text_color;
    const customFont         = config.font_family         || defaultConfig.font_family;
    const baseSize           = config.font_size           || defaultConfig.font_size;

    document.body.style.background =
      `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-2)} 100%)`;

    const elements = [
      { id: 'weekText',        size: baseSize * 0.9,  color: '#ffffff' },
      { id: 'dateRange',       size: baseSize * 1.05, color: secondaryTextColor },
      { id: 'remainingAmount', size: baseSize * 2,    color: primaryActionColor },
      { id: 'remainingText',   size: baseSize * 0.95, color: textColor },
      { id: 'motivationMessage', size: baseSize,      color: secondaryTextColor }
    ];
    elements.forEach(el => {
      const node = document.getElementById(el.id);
      if (!node) return;
      node.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      node.style.fontSize = `${el.size}px`;
      node.style.color = el.color;
    });

    const weekPill = document.querySelector('.week-pill');
    if (weekPill) {
      weekPill.style.background = primaryActionColor;
      weekPill.style.color = '#ffffff';
    }

    document.querySelectorAll('.nav-card-label').forEach(t=>{
      t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      t.style.color = textColor;
    });
    document.querySelectorAll('.nav-card-subtitle').forEach(t=>{
      t.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      t.style.color = secondaryTextColor;
    });
    document.querySelectorAll('.nav-card').forEach(b=>{
      b.style.background = surfaceColor;
      b.style.borderColor = adjustColor(primaryActionColor, 60);
    });

    const circleBg  = document.querySelector('.circle-bg');
    const statusPill = document.querySelector('.status-pill');
    if (circleBg)  circleBg.style.background = '#ffffff';
    if (statusPill) statusPill.style.background = adjustColor(primaryActionColor, 82);
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ background_color: v }) },
        { get: () => config.surface_color || defaultConfig.surface_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ surface_color: v }) },
        { get: () => config.text_color || defaultConfig.text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ text_color: v }) },
        { get: () => config.primary_action_color || defaultConfig.primary_action_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ primary_action_color: v }) },
        { get: () => config.secondary_text_color || defaultConfig.secondary_text_color,
          set: v => window.elementSdk && window.elementSdk.setConfig({ secondary_text_color: v }) },
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_family: v })
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: v => window.elementSdk && window.elementSdk.setConfig({ font_size: v })
      }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["week_text",          config.week_text          || defaultConfig.week_text],
      ["spent_text",         config.spent_text         || defaultConfig.spent_text],
      ["remaining_text",     config.remaining_text     || defaultConfig.remaining_text],
      ["add_purchase_text",  config.add_purchase_text  || defaultConfig.add_purchase_text],
      ["shopping_list_text", config.shopping_list_text || defaultConfig.shopping_list_text],
      ["week_report_text",   config.week_report_text   || defaultConfig.week_report_text],
      ["status_message",     config.status_message     || defaultConfig.status_message]
    ]);
  }

  // ---------- Navigasjon ------------------------------------------------
  document.getElementById('addPurchaseBtn').addEventListener('click', () => {
    location.href = 'add-purchase.html';
  });
  document.getElementById('shoppingListBtn').addEventListener('click', () => {
    location.href = 'handleliste.html';
  });
  document.getElementById('weekReportBtn').addEventListener('click', () => {
    location.href = 'week-report.html';
  });
  document.getElementById('mealPlanBtn').addEventListener('click', () => {
    location.href = 'middag.html';
  });
  document.getElementById('settingsBtn').addEventListener('click', () => {
    location.href = 'settings.html';
  });

  // ---------- Auth + bootstrapping -------------------------------------
  async function main() {
    if (!supa) {
      console.error('Supabase-klient mangler');
      return;
    }
    // Global auth-listener
    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    } else {
      try {
        supa.auth.onAuthStateChange((event) => {
          if (event === 'SIGNED_OUT' && window.location.pathname !== '/innlogging.html') {
            window.location.href = '/innlogging.html';
          }
        });
      } catch {}
    }

    // Auth-guard
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/app.html') return;
    } else {
      const { data:{ session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = '/innlogging.html';
        return;
      }
    }

    // Sett uke og last data
    state.activeWeekISO = resolveActiveWeekISO();
    await loadWeekData();
    setWeekHeader();
    updateBudgetDisplay();
    await loadRecentActivity();

    // Element SDK init
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

  }

  window.addEventListener('DOMContentLoaded', async () => {
    await main();

    window.tourManager?.startTourIfNeeded({
      tourId: 'dashboard',
      version: 1,
      steps: [
        {
          element: '.budget-circle',
          popover: {
            title: 'Ukesbudsjett',
            description: 'Her ser dere hvor mye dere har brukt og hva som er igjen denne uka.',
            side: 'bottom'
          }
        },
        {
          element: '.nav-grid',
          popover: {
            title: 'Flere sider',
            description: 'Trykk her for √• g√• til handleliste, ukesrapport og middagsforslag.',
            side: 'bottom'
          }
        },
        {
          element: '#addPurchaseBtn',
          popover: {
            title: 'Legg til kj√∏p',
            description: 'N√•r dere har handlet, registrerer dere kj√∏p her.',
            side: 'top'
          }
        },
        {
          element: '.recent-section',
          popover: {
            title: 'Siste kj√∏p',
            description: 'Her finner dere de siste kj√∏pene dere har registrert.',
            side: 'top'
          }
        }
      ]
    });
  });

  // N√•r man kommer tilbake via tilbakeknappen (BFCache), refreshe tall
  window.addEventListener('pageshow', async (event) => {
    if (event.persisted) {
      state.activeWeekISO = resolveActiveWeekISO();
      await loadWeekData();
      setWeekHeader();
      updateBudgetDisplay();
      await loadRecentActivity();
    }
  });
</script>
</body>
</html>
