<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ukesrapport ‚Äì Husholdningsbudsjett</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      overflow-y: auto;
    }
    html {
      height: 100%;
    }
    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      animation: fadeInDown .6s ease-out;
    }
    .title {
      font-size: 32px;
      font-weight: 700;
      color: #2d5f4d;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .description {
      font-size: 17px;
      color: #5a7a6d;
      line-height: 1.5;
      max-width: 620px;
      margin: 0 auto;
    }

    .content-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 32px;
      margin-bottom: 32px;
    }

    .card {
      background: #fff;
      border-radius: 20px;
      padding: 24px 24px 26px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }

    /* Status / hero-kort */
    .budget-overview {
      animation: fadeInUp .8s ease-out .1s both;
    }
    .budget-overview.status-under {
      border-left: 6px solid #4caf50;
    }
    .budget-overview.status-near {
      border-left: 6px solid #f9a825;
    }
    .budget-overview.status-over {
      border-left: 6px solid #f57c00;
    }

    .status-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .status-emoji {
      font-size: 40px;
      flex-shrink: 0;
    }
    .status-text-block {
      flex: 1;
      min-width: 0;
    }
    .status-title {
      font-size: 20px;
      font-weight: 700;
      color: #2d5f4d;
      margin-bottom: 4px;
    }
    .status-subtitle {
      font-size: 15px;
      color: #5a7a6d;
    }

    .week-like-btn {
      border-radius: 9999px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #ffffff;
      padding: 8px 14px;
      font-size: 16px;
      font-weight: 600;
      color: #2d5f4d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
      flex-shrink: 0;
    }
    .week-like-btn:hover {
      box-shadow: 0 2px 8px rgba(45,95,77,0.2);
      background: #f8fffe;
      transform: translateY(-1px);
    }
    .week-like-btn.liked {
      background: #4caf50;
      color: #fff;
      border-color: #4caf50;
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 4px 14px rgba(76,175,80,0.4);
    }

    /* Termometer / budsjettlinje */
    .thermo-container {
      margin-top: 10px;
    }
    .thermo-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #5a7a6d;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 4px 12px;
    }
    .thermo-track {
      position: relative;
      width: 100%;
      height: 18px;
      background: #e8f5f0;
      border-radius: 9999px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .thermo-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      border-radius: 9999px;
      transition: width 0.8s ease-out, background 0.4s ease-out;
      background: #4caf50;
    }
    .thermo-fill.near {
      background: #f9a825;
    }
    .thermo-fill.over {
      background: #f57c00;
    }

    .thermo-values-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 15px;
      color: #2d5f4d;
    }
    .thermo-value-label {
      font-weight: 600;
    }

    .budget-numbers {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 8px 18px;
      margin-top: 10px;
    }
    .budget-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 4px;
    }
    .budget-label {
      font-size: 15px;
      font-weight: 500;
      color: #5a7a6d;
    }
    .budget-amount {
      font-size: 17px;
      font-weight: 700;
      color: #2d5f4d;
    }
    .budget-amount.saved {
      color: #4caf50;
      font-size: 18px;
    }
    .celebration-icon {
      margin-left: 6px;
      font-size: 20px;
    }

    /* Seksjonstitler */
    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #2d5f4d;
      margin-bottom: 18px;
      text-align: center;
    }

    /* Kategorier */
    .categories-section {
      animation: fadeInUp .8s ease-out .2s both;
    }
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 16px;
    }
    .category-item {
      text-align: center;
      padding: 18px 14px 16px;
      background: #fafffe;
      border-radius: 15px;
      border: 2px solid #e8f5f0;
    }
    .category-icon {
      font-size: 34px;
      margin-bottom: 6px;
      display: block;
    }
    .category-name {
      font-size: 15px;
      font-weight: 600;
      color: #2d5f4d;
      margin-bottom: 6px;
    }
    .category-bar {
      width: 100%;
      height: 8px;
      background: #e8f5f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .category-progress {
      height: 100%;
      background: #4caf50;
      border-radius: 4px;
      transition: width 1s ease-out .2s;
    }
    .category-percentage {
      font-size: 16px;
      font-weight: 700;
      color: #4caf50;
    }
    .category-tag {
      margin-top: 4px;
      font-size: 12px;
      font-weight: 500;
      color: #f57c00;
    }

    /* Innsikter */
    .insights-section {
      animation: fadeInUp .8s ease-out .3s both;
    }
    .insights-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 12px 12px;
      background: #f8fffe;
      border-radius: 14px;
      border-left: 4px solid #4caf50;
    }
    .insight-item.warn {
      border-left-color: #f9a825;
    }
    .insight-item.over {
      border-left-color: #f57c00;
    }
    .insight-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .insight-text {
      font-size: 15px;
      color: #2d5f4d;
      line-height: 1.5;
      margin: 0;
    }

    /* Tips / fokus for neste uke */
    .tips-section {
      animation: fadeInUp .8s ease-out .35s both;
    }
    .tips-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tip-card {
      padding: 14px 14px 12px;
      border-radius: 14px;
      background: #f8fffe;
      border: 1px solid #e0efe6;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .tip-text {
      font-size: 15px;
      color: #2d5f4d;
    }
    .tip-focus-btn {
      align-self: flex-start;
      border-radius: 9999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #4caf50;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
    }
    .tip-focus-btn:hover {
      background: #45a049;
      box-shadow: 0 2px 8px rgba(76,175,80,0.3);
      transform: translateY(-1px);
    }
    .tip-focus-btn.selected {
      background: #2d5f4d;
    }

    /* Mini-historikk */
    .history-section {
      animation: fadeInUp .8s ease-out .4s both;
    }
    .history-row {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .history-item {
      flex: 1;
      min-width: 120px;
      padding: 10px 10px 8px;
      border-radius: 12px;
      background: #f8fffe;
      text-align: center;
      border: 1px solid #e0efe6;
    }
    .history-week {
      font-size: 13px;
      color: #5a7a6d;
      margin-bottom: 4px;
    }
    .history-emoji {
      font-size: 20px;
      margin-bottom: 2px;
    }
    .history-label {
      font-size: 13px;
      color: #2d5f4d;
      font-weight: 500;
    }

    /* Knappeseksjon */
    .button-section {
      text-align: center;
      animation: fadeInUp .8s ease-out .45s both;
      margin-bottom: 10px;
    }
    .start-week-button {
      background: linear-gradient(135deg,#4caf50 0%,#45a049 100%);
      color: #fff;
      border: none;
      padding: 18px 46px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(76,175,80,.3);
      transition: all .3s ease;
      margin-bottom: 12px;
    }
    .start-week-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(76,175,80,.4);
      background: linear-gradient(135deg,#45a049 0%,#3d8b40 100%);
    }
    .start-week-button:active {
      transform: translateY(-1px);
    }
    .back-button-main {
      background: transparent;
      color: #8a9a8d;
      border: 2px solid #e0e7e3;
      padding: 12px 32px;
      font-size: 15px;
      font-weight: 500;
      border-radius: 30px;
      cursor: pointer;
      transition: all .3s ease;
    }
    .back-button-main:hover {
      background:#f5f8f6;
      border-color:#c8d4cb;
      color:#5a7a6d;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2d5f4d;
      color: #fff;
      padding: 10px 16px;
      border-radius: 9999px;
      font-size: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      z-index: 2000;
      opacity: 0;
      animation: toastFade .2s ease-out forwards;
    }
    @keyframes toastFade {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Konfetti */
    .confetti-piece {
      position: fixed;
      top: -10px;
      font-size: 20px;
      animation: confettiFall 1.2s ease-out forwards;
      pointer-events: none;
      z-index: 2000;
    }
    @keyframes confettiFall {
      from { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
      to   { transform: translateY(120px) translateX(10px) rotate(360deg); opacity: 0; }
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @media (max-width:768px){
      .container{padding:20px;}
      .title{font-size:26px;}
      .description{font-size:15px;}
      .status-title{font-size:18px;}
      .status-subtitle{font-size:14px;}
      .thermo-track{height:16px;}
      .categories-grid{grid-template-columns:1fr;}
      .start-week-button{font-size:17px;padding:16px 40px;}
    }
  </style>

  <!-- Supabase + auth-helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/auth-helpers.js"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Ukesrapport ‚Äì <span id="weekLabel">Uke</span></h1>
      <p class="description" id="descriptionText">En vennlig oppsummering av uka ‚Äì er dere under, p√• eller over budsjett?</p>
    </div>

    <div class="content-section">
      <!-- Status + budsjett-termometer -->
      <section class="card budget-overview" id="statusCard">
        <div class="status-header">
          <div class="status-emoji" id="statusEmoji">üëè</div>
          <div class="status-text-block">
            <div class="status-title" id="statusTitle">Kjempebra jobba!</div>
            <div class="status-subtitle" id="statusSubtitle">Dere sparte 0 kr denne uka.</div>
          </div>
          <button class="week-like-btn" id="weekLikeBtn">
            <span>üëç</span><span>Gi uka en tommel opp</span>
          </button>
        </div>

        <div class="thermo-container">
          <div class="thermo-label-row">
            <span>Ukens budsjett</span>
            <span id="thermoPctLabel">Brukt 0 % av budsjettet</span>
          </div>
          <div class="thermo-track">
            <div class="thermo-fill" id="thermoFill"></div>
          </div>
          <div class="thermo-values-row">
            <span><span class="thermo-value-label">Budsjett:</span> <span id="budgetAmount">0 kr</span></span>
            <span><span class="thermo-value-label">Brukt:</span> <span id="spentAmount">0 kr</span></span>
            <span><span class="thermo-value-label" id="diffLabel">Igjen:</span> <span id="diffAmount">0 kr</span></span>
          </div>
        </div>

        <div class="budget-numbers">
          <div class="budget-item">
            <span class="budget-label">Ukens budsjett</span>
            <span class="budget-amount" id="budgetAmountDetail">0 kr</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Totalt brukt</span>
            <span class="budget-amount" id="spentAmountDetail">0 kr</span>
          </div>
          <div class="budget-item" id="savedRow" style="display:none;">
            <span class="budget-label">Sparte denne uka</span>
            <span class="budget-amount saved" id="savedAmount">
              0 kr<span class="celebration-icon">üéâ</span>
            </span>
          </div>
        </div>
      </section>

      <!-- Kategorier -->
      <section class="card categories-section">
        <h2 class="section-title">Hvor gikk pengene?</h2>
        <div class="categories-grid" id="categoriesGrid"></div>
      </section>

      <!-- Innsikter -->
      <section class="card insights-section">
        <h2 class="section-title">Dette la vi merke til</h2>
        <div class="insights-list" id="insightsList"></div>
      </section>

      <!-- Tips for neste uke -->
      <section class="card tips-section">
        <h2 class="section-title">Pr√∏v dette neste uke</h2>
        <div class="tips-list" id="tipsList"></div>
      </section>

      <!-- Mini-historikk -->
      <section class="card history-section">
        <h2 class="section-title">Slik har de siste ukene g√•tt</h2>
        <div class="history-row" id="historyRow"></div>
      </section>
    </div>

    <div class="button-section">
      <button class="start-week-button" id="startWeekButton">Start planlegging for neste uke</button><br/>
      <button class="back-button-main" id="backButton">Tilbake til handlelisten</button>
    </div>
  </main>

<script>
(function () {
  // ---------- Supabase init ----------
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- State ----------
  const state = {
    weekISO: null,
    totalBudget: 0,
    spent: 0,
    saved: 0,
    pct: 0,
    byCategory: {},
    status: null
  };

  const TIP_CANDIDATES = [
    {
      id: 'restemiddag',
      text: 'Pr√∏v √• ha √©n restemiddag denne uken. Bruk opp det dere har i kj√∏leskap og skap.'
    },
    {
      id: 'planlegg-middager',
      text: 'Planlegg middager for 3 dager av gangen f√∏r dere skriver handlelista. Det sparer dere for dyre sm√•turer.'
    },
    {
      id: 'sjekk-kjoleskap',
      text: 'Se hva dere allerede har i kj√∏leskapet f√∏r dere handler, s√• unng√•r dere dobbeltkj√∏p.'
    },
    {
      id: 'l√∏rdagsgodt',
      text: 'Bestem p√• forh√•nd hvor mye dere vil bruke p√• snacks og l√∏rdagsgodt denne uka.'
    },
    {
      id: 'drikke-en-gang',
      text: 'Kj√∏p inn brus og juice kun √©n gang denne uken, ikke litt og litt hver dag.'
    }
  ];

  // ---------- Utils ----------
  function formatAmount(n){
    return (Number(n)||0).toLocaleString('no-NO');
  }

  function mondayOf(dateObj = new Date()){
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = (d.getDay()+6)%7; // 0=mandag
    d.setDate(d.getDate()-day);
    d.setHours(12,0,0,0); // 12:00 for DST-sikkerhet
    return d;
  }
  function sundayOf(dateObj = new Date()){
    const m = mondayOf(dateObj);
    const s = new Date(m); s.setDate(m.getDate()+6); return s;
  }
  function weekNumberISO(dateObj = new Date()){
    const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  function weekLabelFromISO(isoMonday){
    const [y,m,d] = isoMonday.split('-').map(Number);
    const mon = new Date(y, m-1, d, 12,0,0,0);
    const sun = new Date(mon); sun.setDate(mon.getDate()+6);
    const nf = new Intl.DateTimeFormat('no-NO',{ day:'numeric', month:'long' });
    const wn = weekNumberISO(mon);
    return `Uke ${wn} ‚Äì ${nf.format(mon)}‚Äì${nf.format(sun)}`;
  }
  function safeGet(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function getActiveWeekISO(){
    return localStorage.getItem('activeWeekISO') || mondayOf().toISOString().slice(0,10);
  }
  function addWeeksToISO(isoMonday, offset){
    const [y,m,d] = isoMonday.split('-').map(Number);
    const base = new Date(y, m-1, d, 12,0,0,0);
    base.setDate(base.getDate() + offset*7);
    return base.toISOString().slice(0,10);
  }

  function guessIcon(name){
    const n = (name||'').toLowerCase();
    if (n.includes('mat')) return 'ü•ï';
    if (n.includes('snacks') || n.includes('drikke') || n.includes('brus') || n.includes('godt')) return 'üç´';
    if (n.includes('hushold')) return 'üßº';
    if (n.includes('frokost') || n.includes('br√∏d')) return 'üçû';
    if (n.includes('kj√∏tt')) return 'ü•©';
    if (n.includes('frukt') || n.includes('gr√∏nt')) return 'üçé';
    return 'üß∫';
  }
  function escapeHTML(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function showToast(text){
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = text;
    document.body.appendChild(el);
    setTimeout(() => {
      el.style.opacity = '0';
      setTimeout(() => el.remove(), 250);
    }, 2000);
  }

  function launchConfetti(){
    const emojis = ['üéâ','‚ú®','üéä','üëè'];
    for (let i = 0; i < 14; i++){
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      const left = 20 + Math.random()*60; // 20‚Äì80%
      piece.style.left = left + 'vw';
      piece.style.animationDelay = (Math.random()*0.3).toFixed(2) + 's';
      document.body.appendChild(piece);
      setTimeout(() => piece.remove(), 1500);
    }
  }

  // ---------- Status-tekst / tone ----------
  function computeStatus(){
    const budget = state.totalBudget;
    const spent  = state.spent;

    if (spent === 0){
      return {
        type: 'empty',
        emoji: 'üïí',
        title: 'Rolig uke s√• langt',
        subtitle: 'Ingen registrerte kj√∏p enn√•. Husk √• legge inn handlekvitteringer n√•r dere har v√¶rt i butikken.'
      };
    }

    if (!budget || budget <= 0){
      return {
        type: 'neutral',
        emoji: '‚ÑπÔ∏è',
        title: 'Uka er registrert',
        subtitle: `Dere har registrert kj√∏p for ${formatAmount(spent)} kr denne uken.`
      };
    }

    const diff = spent - budget;
    const ratio = spent / budget;

    if (diff < -50) {
      return {
        type: 'under',
        emoji: 'üëè',
        title: 'Kjempebra jobba!',
        subtitle: `Dere brukte mindre enn planlagt og sparte ${formatAmount(-diff)} kr denne uka.`
      };
    }

    if (Math.abs(diff) <= budget * 0.05) {
      return {
        type: 'near',
        emoji: 'üëç',
        title: 'God kontroll!',
        subtitle: 'Dere traff omtrent p√• budsjettet denne uka. Fortsett p√• samme m√•te neste uke.'
      };
    }

    if (diff > 0) {
      return {
        type: 'over',
        emoji: 'üí°',
        title: 'Denne uka ble litt dyrere',
        subtitle: `Forbruket ble cirka ${formatAmount(diff)} kr over budsjettet. Under ser dere hvor pengene gikk og noen enkle tips.`
      };
    }

    // Litt under, men ikke s√• mye
    return {
      type: 'under',
      emoji: 'üëè',
      title: 'Bra gjennomf√∏rt!',
      subtitle: `Dere ligger litt under budsjett ‚Äì ${formatAmount(-diff)} kr spart denne uka.`
    };
  }

  // ---------- Hent budsjett + kj√∏p ----------
  async function loadWeekData() {
    const weekISO = getActiveWeekISO();
    state.weekISO = weekISO;

    let totalBudget = 0;
    let purchases = [];

    let session = null;
    try {
      const { data } = await supa.auth.getSession();
      session = data?.session || null;
    } catch (err) {
      console.warn('Feil ved henting session:', err);
    }

    // Budsjett fra DB
    if (session) {
      try {
        const { data: budgetRow, error: bErr } = await supa
          .from('household_budgets')
          .select('amount')
          .eq('user_id', session.user.id)
          .eq('week_start', weekISO)
          .maybeSingle();

        if (bErr) {
          console.warn('Feil ved henting budsjett:', bErr);
        } else if (budgetRow?.amount) {
          totalBudget = Number(budgetRow.amount) || 0;
        }
      } catch (err) {
        console.warn('Feil ved budsjett-oppslag:', err);
      }
    }

    // Fallback til localStorage hvis ingen budsjett-rad
    if (!totalBudget) {
      const byWeekStr = localStorage.getItem(`weeklyBudget_${weekISO}`);
      const byWeek = parseInt(byWeekStr || '', 10);
      if (!isNaN(byWeek) && byWeek > 0) {
        totalBudget = byWeek;
      } else {
        const globalStr = localStorage.getItem('weeklyBudget');
        const global = parseInt(globalStr || '', 10);
        totalBudget = (!isNaN(global) && global > 0) ? global : 3000;
      }
    }

    // Kj√∏p fra DB
    let dbRows = [];
    if (session) {
      try {
        const { data: rows, error: pErr } = await supa
          .from('purchases')
          .select('amount, category')
          .eq('week_start', weekISO);

        if (pErr) {
          console.warn('Feil ved henting kj√∏p:', pErr);
        } else if (Array.isArray(rows)) {
          dbRows = rows.map(r => ({
            amount: Number(r.amount) || 0,
            category: r.category || null
          }));
        }
      } catch (err) {
        console.warn('Feil ved kj√∏ps-oppslag:', err);
      }
    }

    // Local fallback-kj√∏p (tidligere handleliste/middag-data)
    const localKey = `purchases_${weekISO}`;
    const localPurchases = safeGet(localKey, []);

    // Kombiner (DB + lokal cache)
    purchases = [...dbRows, ...localPurchases];

    const spent = purchases.reduce((s,p)=> s + (Number(p.amount)||0), 0);
    const saved = Math.max(0, totalBudget - spent);
    const pct   = totalBudget>0 ? Math.round(spent/totalBudget*100) : 0;

    const byCategory = purchases.reduce((acc,p)=>{
      const cat = (p.category && String(p.category).trim()) || 'Uten kategori';
      acc[cat] = (acc[cat]||0) + (Number(p.amount)||0);
      return acc;
    }, {});

    state.totalBudget = totalBudget;
    state.spent       = spent;
    state.saved       = saved;
    state.pct         = pct;
    state.byCategory  = byCategory;
    state.status      = computeStatus();

    // Speil litt til localStorage for andre sider
    localStorage.setItem('budget_total', String(totalBudget));
    localStorage.setItem('activeWeekISO', weekISO);
  }

  // ---------- Render ----------
  function renderHeader(){
    document.getElementById('weekLabel').textContent = weekLabelFromISO(state.weekISO);
    // Header-tekst kan st√• som er, hero-kortet tar hovedbudskapet
  }

  function renderStatusCard(){
    const status = state.status || { type:'neutral', emoji:'‚ÑπÔ∏è', title:'Ukesrapport', subtitle:'' };

    const statusCard   = document.getElementById('statusCard');
    const statusEmoji  = document.getElementById('statusEmoji');
    const statusTitle  = document.getElementById('statusTitle');
    const statusSub    = document.getElementById('statusSubtitle');
    const budgetAmount = document.getElementById('budgetAmount');
    const budgetDetail = document.getElementById('budgetAmountDetail');
    const spentAmount  = document.getElementById('spentAmount');
    const spentDetail  = document.getElementById('spentAmountDetail');
    const diffAmount   = document.getElementById('diffAmount');
    const diffLabel    = document.getElementById('diffLabel');
    const savedRow     = document.getElementById('savedRow');
    const savedEl      = document.getElementById('savedAmount');
    const thermoFill   = document.getElementById('thermoFill');
    const thermoPctLabel = document.getElementById('thermoPctLabel');

    statusCard.classList.remove('status-under','status-near','status-over');
    if (status.type === 'under') statusCard.classList.add('status-under');
    if (status.type === 'near')  statusCard.classList.add('status-near');
    if (status.type === 'over')  statusCard.classList.add('status-over');

    statusEmoji.textContent = status.emoji;
    statusTitle.textContent = status.title;
    statusSub.textContent   = status.subtitle;

    budgetAmount.textContent = `${formatAmount(state.totalBudget)} kr`;
    budgetDetail.textContent = `${formatAmount(state.totalBudget)} kr`;
    spentAmount.textContent  = `${formatAmount(state.spent)} kr`;
    spentDetail.textContent  = `${formatAmount(state.spent)} kr`;

    const diff = state.spent - state.totalBudget;
    if (state.totalBudget > 0){
      if (diff <= 0){
        diffLabel.textContent = 'Igjen:';
        diffAmount.textContent = `${formatAmount(-diff)} kr`;
      } else {
        diffLabel.textContent = 'Over budsjett:';
        diffAmount.textContent = `${formatAmount(diff)} kr`;
      }
    } else {
      diffLabel.textContent = 'Totalt:';
      diffAmount.textContent = `${formatAmount(state.spent)} kr`;
    }

    if (state.saved > 0){
      savedRow.style.display = '';
      savedEl.innerHTML = `${formatAmount(state.saved)} kr<span class="celebration-icon">üéâ</span>`;
    } else {
      savedRow.style.display = 'none';
    }

    const pct = Math.max(0, Math.min(150, state.pct));
    thermoFill.style.width = Math.min(100, pct) + '%';
    thermoFill.classList.remove('near','over');
    if (status.type === 'near') thermoFill.classList.add('near');
    if (status.type === 'over') thermoFill.classList.add('over');
    thermoPctLabel.textContent = `Brukt ${Math.min(pct,150)} % av budsjettet`;
  }

  function renderCategories(){
    const grid = document.getElementById('categoriesGrid');
    grid.innerHTML = '';

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    const total = Math.max(1, state.spent);

    if (entries.length === 0){
      const empty = document.createElement('div');
      empty.className = 'insight-item';
      empty.innerHTML = `<span class="insight-icon">‚ÑπÔ∏è</span>
        <p class="insight-text">Ingen registrerte kj√∏p denne uken enn√•.</p>`;
      grid.appendChild(empty);
      return;
    }

    // Vis maks 5 st√∏rste kategorier
    const maxToShow = 5;
    entries.slice(0, maxToShow).forEach(([name, value], idx)=>{
      const percent = Math.round((value/total)*100);
      const item = document.createElement('div');
      item.className = 'category-item';
      const isTop = (idx === 0);
      item.innerHTML = `
        <span class="category-icon">${guessIcon(name)}</span>
        <div class="category-name">${escapeHTML(name)}</div>
        <div class="category-bar">
          <div class="category-progress" style="width:${percent}%;"></div>
        </div>
        <div class="category-percentage">${percent}%</div>
        ${isTop ? '<div class="category-tag">Mest denne uka</div>' : ''}
      `;
      grid.appendChild(item);
    });
  }

  function addInsight(icon, text, extraClass){
    const li = document.createElement('div');
    li.className = 'insight-item';
    if (extraClass) li.classList.add(extraClass);
    li.innerHTML = `<span class="insight-icon">${icon}</span><p class="insight-text">${escapeHTML(text)}</p>`;
    document.getElementById('insightsList').appendChild(li);
  }

  function renderInsights(){
    const list = document.getElementById('insightsList');
    list.innerHTML = '';

    const budget = state.totalBudget;
    const spent  = state.spent;

    if (spent === 0){
      addInsight('üïí', 'Ingen registrerte kj√∏p enda ‚Äì husk √• legge inn handlekvitteringer n√•r dere handler.');
      return;
    }

    if (budget > 0 && spent < budget){
      addInsight('üëè', `Bra kontroll! Dere brukte under budsjett og sparte ${formatAmount(budget - spent)} kr denne uken.`);
    } else if (budget > 0 && spent > budget){
      addInsight('‚ö†Ô∏è', `Budsjettet er overskredet med ${formatAmount(spent - budget)} kr. Det skjer ‚Äì under ser dere hvilke kategorier som dro opp forbruket.`, 'over');
    } else {
      addInsight('‚ÑπÔ∏è', `Dere har registrert kj√∏p for ${formatAmount(spent)} kr denne uken.`);
    }

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    if (entries.length >= 1){
      const [topCat, topVal] = entries[0];
      const pct = Math.round((topVal/Math.max(1,spent))*100);
      addInsight('üéØ', `St√∏rst andel gikk til ¬´${topCat}¬ª (${pct} % av ukens forbruk).`);
    }
    if (entries.length >= 2){
      const [lowCat, lowVal] = entries[entries.length-1];
      const pct = Math.round((lowVal/Math.max(1,spent))*100);
      addInsight('üëç', `Lav andel p√• ¬´${lowCat}¬ª (${pct} %).`, 'warn');
    }

    // Enkel m√•nedsprognose basert p√• denne uka (bare en gjetning)
    const forecast = spent * 4;
    addInsight('üìà', `Fortsetter dere slik, blir m√•nedsforbruket omtrent ${formatAmount(forecast)} kr (bare en enkel gjetning).`);
  }

  function renderTips(){
    const list = document.getElementById('tipsList');
    list.innerHTML = '';

    // Velg noen tips ‚Äì enkel logikk basert p√• status
    let candidates = TIP_CANDIDATES.slice();
    if (state.status?.type === 'over'){
      // Priorit√©r snacks/kontrolltips
      candidates.sort((a,b)=>{
        const aScore = /snacks|brus|godt/i.test(a.text) ? -1 : 0;
        const bScore = /snacks|brus|godt/i.test(b.text) ? -1 : 0;
        return aScore - bScore;
      });
    }

    const selectedTips = candidates.slice(0,3);
    const nextWeekISO = addWeeksToISO(state.weekISO, 1);

    selectedTips.forEach(tip => {
      const card = document.createElement('div');
      card.className = 'tip-card';
      const btnId = `tipBtn_${tip.id}`;
      card.innerHTML = `
        <div class="tip-text">${escapeHTML(tip.text)}</div>
        <button class="tip-focus-btn" id="${btnId}">
          <span>üèÜ</span><span>Velg som fokus for neste uke</span>
        </button>
      `;
      list.appendChild(card);

      const btn = card.querySelector('.tip-focus-btn');
      btn.addEventListener('click', () => {
        // Lagre fokus i localStorage ‚Äì andre sider kan hente dette
        const payload = {
          text: tip.text,
          fromWeek: state.weekISO,
          forWeek: nextWeekISO,
          ts: Date.now()
        };
        localStorage.setItem('nextWeekFocus', JSON.stringify(payload));

        // Marker knapp visuelt, fjern "selected" fra andre
        document.querySelectorAll('.tip-focus-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        showToast('Vi husker dette fokuset til neste uke ‚ú®');
      });
    });
  }

  function renderHistory(){
    const row = document.getElementById('historyRow');
    row.innerHTML = '';

    // Siste 4 uker inkl. denne (3 tilbake i tid)
    for (let offset = -3; offset <= 0; offset++){
      const iso = addWeeksToISO(state.weekISO, offset);
      const [y,m,d] = iso.split('-').map(Number);
      const dateMon = new Date(y, m-1, d, 12,0,0,0);
      const wn = weekNumberISO(dateMon);

      // Leser kun localStorage for historikk
      const purchasesKey = `purchases_${iso}`;
      const localPurchases = safeGet(purchasesKey, []);
      const spent = localPurchases.reduce((s,p)=> s + (Number(p.amount)||0), 0);

      let budgetStr = localStorage.getItem(`weeklyBudget_${iso}`);
      if (!budgetStr && offset === 0){
        // Bruk aktivt budsjett hvis vi st√•r i samme uke
        budgetStr = String(state.totalBudget || '');
      }
      const budget = parseInt(budgetStr || '', 10) || state.totalBudget || 0;

      let emoji = '‚Ä¢';
      let label = 'Ingen data';

      if (spent === 0 && !budgetStr){
        emoji = '‚Ä¢';
        label = 'Ingen data';
      } else if (budget > 0 && spent < budget){
        emoji = 'üëç';
        label = 'Under budsjett';
      } else if (budget > 0 && spent > budget){
        emoji = '‚ö†Ô∏è';
        label = 'Over budsjett';
      } else if (spent === 0){
        emoji = 'üïí';
        label = 'Ingen kj√∏p';
      } else {
        emoji = '‚ÑπÔ∏è';
        label = 'Registrert';
      }

      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div class="history-week">Uke ${wn}</div>
        <div class="history-emoji">${emoji}</div>
        <div class="history-label">${label}</div>
      `;
      row.appendChild(item);
    }
  }

  // ---------- Start ny uke / navigasjon ----------
  function setupButtons(){
    document.getElementById('startWeekButton').addEventListener('click', ()=>{
      const thisMon = new Date(state.weekISO + 'T12:00:00');
      const nextMon = new Date(thisMon);
      nextMon.setDate(thisMon.getDate()+7);
      const nextISO = nextMon.toISOString().slice(0,10);

      // Kopier budsjett videre til neste uke (localStorage-fallback)
      localStorage.setItem(`weeklyBudget_${nextISO}`, String(state.totalBudget));
      localStorage.setItem('weeklyBudget', String(state.totalBudget));

      // Nullstill lokal cache for neste uke
      localStorage.setItem(`purchases_${nextISO}`, '[]');

      localStorage.setItem('lastClosedWeekISO', state.weekISO);
      localStorage.setItem('activeWeekISO', nextISO);

      window.location.href = 'app.html';
    });

    document.getElementById('backButton').addEventListener('click', ()=>{
      window.location.href = 'handleliste.html';
    });

    const likeBtn = document.getElementById('weekLikeBtn');
    likeBtn.addEventListener('click', ()=>{
      likeBtn.classList.add('liked');
      launchConfetti();
      showToast('Bra at dere feirer uka! üéâ');
      setTimeout(()=> likeBtn.classList.remove('liked'), 1200);
    });
  }

  // ---------- Init ----------
  async function init(){
    // Auth guard
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
    }

    await loadWeekData();
    renderHeader();
    renderStatusCard();
    renderCategories();
    renderInsights();
    renderTips();
    renderHistory();
    setupButtons();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
