<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ukesrapport ‚Äì Husholdningsbudsjett</title>
  <style>
    body{
      box-sizing:border-box;
      margin:0;
      padding:0;
      height:100%;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);
      overflow-y:auto;
    }
    html{height:100%;}
    .container{
      max-width:800px;
      margin:0 auto;
      padding:30px;
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .header{
      text-align:center;
      margin-bottom:32px;
      animation:fadeInDown .6s ease-out;
    }
    .title{
      font-size:32px;
      font-weight:700;
      color:#2d5f4d;
      margin-bottom:10px;
      line-height:1.3;
    }
    .description{
      font-size:18px;
      color:#5a7a6d;
      line-height:1.5;
      max-width:600px;
      margin:0 auto;
    }

    .content-section{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:30px;
      margin-bottom:40px;
    }

    .card{
      background:#fff;
      border-radius:20px;
      padding:24px 24px 22px 24px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }

    /* --- Uke-kort (enklere struktur) --- */
    .week-card{
      animation:fadeInUp .8s ease-out .1s both;
    }

    /* Topp: status */
    .status-top{
      margin-bottom:20px;
    }
    .status-line{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .status-emoji{
      font-size:26px;
    }
    .status-title{
      font-size:20px;
      font-weight:700;
      color:#2d5f4d;
    }
    .status-subtitle{
      margin:0;
      font-size:16px;
      color:#5a7a6d;
    }

    /* Midten: termometer */
    .thermo{
      margin:18px 0 18px 0;
    }
    .thermo-caption{
      font-size:14px;
      color:#5a7a6d;
      margin-bottom:8px;
    }
    .thermo-track{
      width:100%;
      height:18px;
      background:#e8f5f0;
      border-radius:999px;
      overflow:hidden;
      position:relative;
    }
    .thermo-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition:width .7s ease-out, background-color .3s ease-out;
    }
    .thermo-fill.green{
      background:#4caf50;
    }
    .thermo-fill.yellow{
      background:#f9a825;
    }
    .thermo-fill.red{
      background:#d32f2f;
    }
    .thermo-percent{
      margin-top:8px;
      font-size:15px;
      color:#2d5f4d;
      font-weight:500;
    }

    /* Bunn: √©n rad med tall */
    .numbers-row{
      display:flex;
      gap:16px;
      margin-top:10px;
      flex-wrap:wrap;
      border-top:1px solid #f0f4f2;
      padding-top:12px;
    }
    .numbers-item{
      flex:1;
      min-width:120px;
    }
    .numbers-label{
      font-size:13px;
      color:#5a7a6d;
      margin-bottom:2px;
    }
    .numbers-value{
      font-size:18px;
      font-weight:700;
      color:#2d5f4d;
    }
    .numbers-value.positive{
      color:#2e7d32;
    }
    .numbers-value.negative{
      color:#d32f2f;
    }

    /* Liten tommel-opp nederst */
    .status-footer{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }
    .week-like-link{
      border:none;
      background:none;
      padding:0;
      font-size:14px;
      color:#5a7a6d;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .week-like-link:hover{
      color:#2d5f4d;
      text-decoration:underline;
    }

    /* Kategorier & innsikter (fra tidligere) */
    .categories-section{
      animation:fadeInUp .8s ease-out .2s both;
    }
    .insights-section{
      animation:fadeInUp .8s ease-out .3s both;
    }
    .section-title{
      font-size:22px;
      font-weight:700;
      color:#2d5f4d;
      margin-bottom:18px;
      text-align:center;
    }
    .categories-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:18px;
    }
    .category-item{
      text-align:center;
      padding:16px 12px 18px 12px;
      background:#fafffe;
      border-radius:15px;
      border:2px solid #e8f5f0;
    }
    .category-icon{
      font-size:34px;
      margin-bottom:6px;
      display:block;
    }
    .category-name{
      font-size:15px;
      font-weight:600;
      color:#2d5f4d;
      margin-bottom:6px;
    }
    .category-bar{
      width:100%;
      height:8px;
      background:#e8f5f0;
      border-radius:4px;
      overflow:hidden;
      margin-bottom:6px;
    }
    .category-progress{
      height:100%;
      background:#4caf50;
      border-radius:4px;
      transition:width 1s ease-out .2s;
    }
    .category-percentage{
      font-size:16px;
      font-weight:700;
      color:#4caf50;
    }

    .insights-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .insight-item{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:14px 12px;
      background:#f8fffe;
      border-radius:15px;
      border-left:4px solid #4caf50;
    }
    .insight-icon{
      font-size:20px;
      flex-shrink:0;
      margin-top:1px;
    }
    .insight-text{
      font-size:15px;
      color:#2d5f4d;
      line-height:1.5;
      margin:0;
    }

    /* Knappene nederst */
    .button-section{
      text-align:center;
      animation:fadeInUp .8s ease-out .4s both;
    }
    .start-week-button{
      background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);
      color:#fff;
      border:none;
      padding:18px 48px;
      font-size:18px;
      font-weight:700;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(76,175,80,.3);
      transition:all .3s ease;
      margin-bottom:14px;
    }
    .start-week-button:hover{
      transform:translateY(-3px);
      box-shadow:0 12px 28px rgba(76,175,80,.4);
      background:linear-gradient(135deg,#45a049 0%,#3d8b40 100%);
    }
    .start-week-button:active{transform:translateY(-1px);}
    .back-button{
      background:transparent;
      color:#8a9a8d;
      border:2px solid #e0e7e3;
      padding:12px 34px;
      font-size:15px;
      font-weight:500;
      border-radius:30px;
      cursor:pointer;
      transition:all .3s ease;
    }
    .back-button:hover{
      background:#f5f8f6;
      border-color:#c8d4cb;
      color:#5a7a6d;
    }

    @keyframes fadeInDown{
      from{opacity:0;transform:translateY(-30px);}
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(30px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media (max-width:768px){
      .container{padding:20px;}
      .title{font-size:28px;}
      .description{font-size:16px;}
      .categories-grid{grid-template-columns:1fr;}
      .start-week-button{font-size:17px;padding:16px 40px;}
      .numbers-row{flex-direction:column;}
    }
  </style>

  <!-- Supabase + auth-helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/auth-helpers.js"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Ukesrapport ‚Äì <span id="weekLabel">Uke</span></h1>
      <p class="description" id="descriptionText">
        Oppsummering av ukens forbruk og hvordan dere ligger an.
      </p>
    </div>

    <div class="content-section">
      <!-- Enkelt uke-kort -->
      <section class="card week-card">
        <!-- 1. Topp: status -->
        <div class="status-top">
          <div class="status-line">
            <span class="status-emoji" id="statusEmoji">üïí</span>
            <span class="status-title" id="statusTitle">Rolig uke s√• langt</span>
          </div>
          <p class="status-subtitle" id="statusSubtitle">
            Ingen registrerte kj√∏p enda denne uka.
          </p>
        </div>

        <!-- 2. Midten: termometer -->
        <div class="thermo">
          <div class="thermo-caption">
            Slik ligger dere an mot ukens budsjett
          </div>
          <div class="thermo-track">
            <div class="thermo-fill" id="thermoFill"></div>
          </div>
          <div class="thermo-percent" id="thermoPercentText">
            Brukt 0 % av budsjettet
          </div>
        </div>

        <!-- 3. Bunn: √©n rad med tall -->
        <div class="numbers-row">
          <div class="numbers-item">
            <div class="numbers-label">Budsjett</div>
            <div class="numbers-value" id="nrBudget">0 kr</div>
          </div>
          <div class="numbers-item">
            <div class="numbers-label">Brukt</div>
            <div class="numbers-value" id="nrSpent">0 kr</div>
          </div>
          <div class="numbers-item">
            <div class="numbers-label" id="nrDiffLabel">Igjen</div>
            <div class="numbers-value positive" id="nrDiffValue">0 kr</div>
          </div>
        </div>

        <!-- 4. Liten feel-good nederst -->
        <div class="status-footer">
          <button class="week-like-link" id="weekLikeBtn">
            üëç Gi denne uka en tommel opp
          </button>
        </div>
      </section>

      <!-- Kategorier -->
      <section class="card categories-section">
        <h2 class="section-title">Hvor gikk pengene?</h2>
        <div class="categories-grid" id="categoriesGrid"></div>
      </section>

      <!-- Innsikter -->
      <section class="card insights-section">
        <h2 class="section-title">Dette la vi merke til</h2>
        <div class="insights-list" id="insightsList"></div>
      </section>
    </div>

    <div class="button-section">
      <button class="start-week-button" id="startWeekButton">Start ny uke</button><br/>
      <button class="back-button" id="backButton">Tilbake til oversikten</button>
    </div>
  </main>

<script>
(function () {
  // ---------- Supabase init ----------
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- State ----------
  const state = {
    weekISO: null,
    totalBudget: 0,
    spent: 0,
    saved: 0,
    pct: 0,
    byCategory: {}
  };

  // ---------- Utils ----------
  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  function mondayOf(dateObj = new Date()){
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = (d.getDay()+6)%7; // 0=mandag
    d.setDate(d.getDate()-day);
    d.setHours(12,0,0,0); // 12:00 for DST-sikkerhet
    return d;
  }
  function sundayOf(dateObj = new Date()){
    const m = mondayOf(dateObj);
    const s = new Date(m); s.setDate(m.getDate()+6); return s;
  }
  function weekNumberISO(dateObj = new Date()){
    const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  function weekLabelFromISO(isoMonday){
    const [y,m,d] = isoMonday.split('-').map(Number);
    const mon = new Date(y, m-1, d, 12,0,0,0);
    const sun = new Date(mon); sun.setDate(mon.getDate()+6);
    const nf = new Intl.DateTimeFormat('no-NO',{ day:'numeric', month:'long' });
    const wn = weekNumberISO(mon);
    return `Uke ${wn} ‚Äì ${nf.format(mon)}‚Äì${nf.format(sun)}`;
  }
  function safeGet(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function getActiveWeekISO(){
    return localStorage.getItem('activeWeekISO') || mondayOf().toISOString().slice(0,10);
  }

  function guessIcon(name){
    const n = (name||'').toLowerCase();
    if (n.includes('mat')) return 'ü•ï';
    if (n.includes('snacks') || n.includes('drikke') || n.includes('brus') || n.includes('godt')) return 'üç´';
    if (n.includes('hushold')) return 'üßº';
    if (n.includes('frokost') || n.includes('br√∏d')) return 'üçû';
    if (n.includes('kj√∏tt')) return 'ü•©';
    if (n.includes('frukt') || n.includes('gr√∏nt')) return 'üçé';
    return 'üß∫';
  }
  function escapeHTML(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  // ---------- Hent budsjett + kj√∏p ----------
  async function loadWeekData() {
    const weekISO = getActiveWeekISO();
    state.weekISO = weekISO;

    let totalBudget = 0;
    let purchases = [];

    let session = null;
    try {
      const { data } = await supa.auth.getSession();
      session = data?.session || null;
    } catch (err) {
      console.warn('Feil ved henting session:', err);
    }

    // Budsjett fra DB
    if (session) {
      try {
        const { data: budgetRow, error: bErr } = await supa
          .from('household_budgets')
          .select('amount')
          .eq('user_id', session.user.id)
          .eq('week_start', weekISO)
          .maybeSingle();

        if (bErr) {
          console.warn('Feil ved henting budsjett:', bErr);
        } else if (budgetRow?.amount) {
          totalBudget = Number(budgetRow.amount) || 0;
        }
      } catch (err) {
        console.warn('Feil ved budsjett-oppslag:', err);
      }
    }

    // Fallback til localStorage
    if (!totalBudget) {
      const byWeekStr = localStorage.getItem(`weeklyBudget_${weekISO}`);
      const byWeek = parseInt(byWeekStr || '', 10);
      if (!isNaN(byWeek) && byWeek > 0) {
        totalBudget = byWeek;
      } else {
        const globalStr = localStorage.getItem('weeklyBudget');
        const global = parseInt(globalStr || '', 10);
        totalBudget = (!isNaN(global) && global > 0) ? global : 3000;
      }
    }

    // Kj√∏p fra DB
    let dbRows = [];
    if (session) {
      try {
        const { data: rows, error: pErr } = await supa
          .from('purchases')
          .select('amount, category')
          .eq('week_start', weekISO);

        if (pErr) {
          console.warn('Feil ved henting kj√∏p:', pErr);
        } else if (Array.isArray(rows)) {
          dbRows = rows.map(r => ({
            amount: Number(r.amount) || 0,
            category: r.category || null
          }));
        }
      } catch (err) {
        console.warn('Feil ved kj√∏ps-oppslag:', err);
      }
    }

    // Local fallback-kj√∏p
    const localKey = `purchases_${weekISO}`;
    const localPurchases = safeGet(localKey, []);

    purchases = [...dbRows, ...localPurchases];

    const spent = purchases.reduce((s,p)=> s + (Number(p.amount)||0), 0);
    const saved = Math.max(0, totalBudget - spent);
    const pct   = totalBudget>0 ? Math.round(spent/totalBudget*100) : 0;

    const byCategory = purchases.reduce((acc,p)=>{
      const cat = (p.category && String(p.category).trim()) || 'Uten kategori';
      acc[cat] = (acc[cat]||0) + (Number(p.amount)||0);
      return acc;
    }, {});

    state.totalBudget = totalBudget;
    state.spent       = spent;
    state.saved       = saved;
    state.pct         = pct;
    state.byCategory  = byCategory;

    // Speil litt til localStorage
    localStorage.setItem('budget_total', String(totalBudget));
    localStorage.setItem('activeWeekISO', weekISO);
  }

  // ---------- Render header ----------
  function renderHeader(){
    const weekLabel = document.getElementById('weekLabel');
    if (weekLabel && state.weekISO){
      weekLabel.textContent = weekLabelFromISO(state.weekISO);
    }
  }

  // ---------- Render uke-kort ----------
  function renderOverview(){
    const b = state.totalBudget || 0;
    const s = state.spent || 0;
    const saved = Math.max(0, b - s);
    const over = Math.max(0, s - b);
    const pctUsedRaw = b > 0 ? Math.round((s / b) * 100) : 0;
    const pctUsed = Math.max(0, pctUsedRaw);

    const statusEmojiEl = document.getElementById('statusEmoji');
    const statusTitleEl = document.getElementById('statusTitle');
    const statusSubtitleEl = document.getElementById('statusSubtitle');
    const thermoFill = document.getElementById('thermoFill');
    const thermoPercentText = document.getElementById('thermoPercentText');
    const nrBudget = document.getElementById('nrBudget');
    const nrSpent = document.getElementById('nrSpent');
    const nrDiffLabel = document.getElementById('nrDiffLabel');
    const nrDiffValue = document.getElementById('nrDiffValue');

    if (!thermoFill) return;

    // Tall i bunnen
    if (nrBudget) nrBudget.textContent = `${formatAmount(b)} kr`;
    if (nrSpent) nrSpent.textContent = `${formatAmount(s)} kr`;

    if (over > 0) {
      if (nrDiffLabel) nrDiffLabel.textContent = 'Over';
      if (nrDiffValue) {
        nrDiffValue.textContent = `${formatAmount(over)} kr`;
        nrDiffValue.classList.remove('positive');
        nrDiffValue.classList.add('negative');
      }
    } else {
      if (nrDiffLabel) nrDiffLabel.textContent = 'Igjen';
      if (nrDiffValue) {
        nrDiffValue.textContent = `${formatAmount(saved)} kr`;
        nrDiffValue.classList.remove('negative');
        nrDiffValue.classList.add('positive');
      }
    }

    // Termometer-bredde
    let widthPct = 0;
    if (b > 0 && s > 0) {
      widthPct = Math.min(100, Math.max(5, pctUsed)); // minst litt synlig hvis brukt >0
    }
    thermoFill.style.width = widthPct + '%';

    // Termometer-farge
    thermoFill.classList.remove('green','yellow','red');
    if (s === 0) {
      // ingen farge, bare lys bakgrunn
    } else if (pctUsed <= 90) {
      thermoFill.classList.add('green');
    } else if (pctUsed <= 110) {
      thermoFill.classList.add('yellow');
    } else {
      thermoFill.classList.add('red');
    }

    if (thermoPercentText) {
      const pctText = Math.max(0, Math.round(pctUsed));
      thermoPercentText.textContent = `Brukt ${pctText}% av budsjettet`;
    }

    // Status-tekst (topp)
    if (s === 0) {
      if (statusEmojiEl) statusEmojiEl.textContent = 'üïí';
      if (statusTitleEl) statusTitleEl.textContent = 'Rolig uke s√• langt';
      if (statusSubtitleEl) statusSubtitleEl.textContent =
        'Ingen registrerte kj√∏p enda denne uka.';
    } else if (over <= 0 && pctUsed <= 90) {
      if (statusEmojiEl) statusEmojiEl.textContent = 'üëè';
      if (statusTitleEl) statusTitleEl.textContent = 'Kjempebra uke!';
      if (statusSubtitleEl) statusSubtitleEl.textContent =
        `Dere har brukt ${formatAmount(s)} kr og har ${formatAmount(saved)} kr igjen.`;
    } else if (over <= 0) {
      if (statusEmojiEl) statusEmojiEl.textContent = 'üëç';
      if (statusTitleEl) statusTitleEl.textContent = 'God kontroll';
      if (statusSubtitleEl) statusSubtitleEl.textContent =
        'Dere ligger omtrent p√• budsjett denne uka.';
    } else {
      if (statusEmojiEl) statusEmojiEl.textContent = '‚ö†Ô∏è';
      if (statusTitleEl) statusTitleEl.textContent = 'Litt dyrere uke';
      if (statusSubtitleEl) statusSubtitleEl.textContent =
        `Dere brukte ca. ${formatAmount(over)} kr mer enn planlagt.`;
    }
  }

  // ---------- Render kategorier ----------
  function renderCategories(){
    const grid = document.getElementById('categoriesGrid');
    if (!grid) return;
    grid.innerHTML = '';

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    const total = Math.max(1, state.spent);

    if (entries.length === 0){
      const empty = document.createElement('div');
      empty.className = 'insight-item';
      empty.innerHTML = `<span class="insight-icon">‚ÑπÔ∏è</span>
        <p class="insight-text">Ingen registrerte kj√∏p denne uken enn√•.</p>`;
      grid.appendChild(empty);
      return;
    }

    entries.forEach(([name, value])=>{
      const percent = Math.round((value/total)*100);
      const item = document.createElement('div');
      item.className = 'category-item';
      item.innerHTML = `
        <span class="category-icon">${guessIcon(name)}</span>
        <div class="category-name">${escapeHTML(name)}</div>
        <div class="category-bar">
          <div class="category-progress" style="width:${percent}%"></div>
        </div>
        <div class="category-percentage">${percent}%</div>
      `;
      grid.appendChild(item);
    });
  }

  // ---------- Innsikter ----------
  function addInsight(icon, text){
    const li = document.createElement('div');
    li.className = 'insight-item';
    li.innerHTML = `<span class="insight-icon">${icon}</span><p class="insight-text">${escapeHTML(text)}</p>`;
    document.getElementById('insightsList').appendChild(li);
  }

  function renderInsights(){
    const list = document.getElementById('insightsList');
    if (!list) return;
    list.innerHTML = '';

    const b = state.totalBudget || 0;
    const s = state.spent || 0;
    const saved = Math.max(0, b - s);
    const over = Math.max(0, s - b);

    if (s === 0){
      addInsight('üïí', 'Ingen registrerte kj√∏p enda ‚Äì husk √• loggf√∏re handlekvitteringer n√•r dere handler.');
    } else if (over > 0){
      addInsight('‚ö†Ô∏è', `Budsjettet er overskredet med ${formatAmount(over)} kr. Vurder √• redusere snacks/drikke eller dyre sm√•turer neste uke.`);
    } else if (saved > 0){
      addInsight('üëè', `Bra kontroll! Dere brukte under budsjett og sparte ${formatAmount(saved)} kr denne uken.`);
    } else {
      addInsight('üí°', 'Stabil uke. Fortsett med planlagte handler ‚Äì grunnvarer p√• tilbud gir best effekt.');
    }

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    if (entries.length >= 1){
      const [topCat, topVal] = entries[0];
      addInsight('üéØ', `St√∏rst andel gikk til ¬´${topCat}¬ª (${Math.round((topVal/Math.max(1,state.spent))*100)}%).`);
    }
    if (entries.length >= 2){
      const [lowCat, lowVal] = entries[entries.length-1];
      addInsight('üëç', `Lav andel p√• ¬´${lowCat}¬ª (${Math.round((lowVal/Math.max(1,state.spent))*100)}%).`);
    }
  }

  // ---------- Knappene nederst ----------
  function setupButtons(){
    const startBtn = document.getElementById('startWeekButton');
    const backBtn  = document.getElementById('backButton');
    const likeBtn  = document.getElementById('weekLikeBtn');

    if (startBtn){
      startBtn.addEventListener('click', ()=>{
        const thisMon = new Date(state.weekISO + 'T12:00:00');
        const nextMon = new Date(thisMon);
        nextMon.setDate(thisMon.getDate()+7);
        const nextISO = nextMon.toISOString().slice(0,10);

        localStorage.setItem(`weeklyBudget_${nextISO}`, String(state.totalBudget));
        localStorage.setItem('weeklyBudget', String(state.totalBudget));
        localStorage.setItem(`purchases_${nextISO}`, '[]');
        localStorage.setItem('lastClosedWeekISO', state.weekISO);
        localStorage.setItem('activeWeekISO', nextISO);

        window.location.href = 'app.html';
      });
    }

    if (backBtn){
      backBtn.addEventListener('click', ()=>{
        window.location.href = 'app.html';
      });
    }

    if (likeBtn){
      likeBtn.addEventListener('click', ()=>{
        likeBtn.textContent = 'Takk! üëç';
        likeBtn.disabled = true;
        likeBtn.style.opacity = '0.85';
      });
    }
  }

  // ---------- Init ----------
  async function init(){
    // Auth guard (hvis brukt)
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
    }

    await loadWeekData();
    renderHeader();
    renderOverview();
    renderCategories();
    renderInsights();
    setupButtons();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
