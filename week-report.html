<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ukesrapport ‚Äì Husholdningsbudsjett</title>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);overflow-y:auto;}
    html{height:100%;}
    .container{max-width:800px;margin:0 auto;padding:30px;min-height:100%;display:flex;flex-direction:column;}
    .header{text-align:center;margin-bottom:40px;animation:fadeInDown .6s ease-out;}
    .title{font-size:32px;font-weight:700;color:#2d5f4d;margin-bottom:15px;line-height:1.3;}
    .description{font-size:18px;color:#5a7a6d;line-height:1.5;max-width:600px;margin:0 auto;}

    .content-section{flex:1;display:flex;flex-direction:column;gap:40px;margin-bottom:40px;}

    .card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
    .budget-overview{animation:fadeInUp .8s ease-out .1s both;}
    .categories-section{animation:fadeInUp .8s ease-out .2s both;}
    .insights-section{animation:fadeInUp .8s ease-out .3s both;}

    .budget-circle-container{display:flex;align-items:center;justify-content:space-between;gap:40px;flex-wrap:wrap;}
    .budget-circle{position:relative;width:200px;height:200px;flex-shrink:0;}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden;}
    .circle-progress{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:conic-gradient(#4caf50 0deg,#4caf50 0deg,transparent 0deg);transition:background .8s ease-out;}
    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;}
    .circle-percentage{font-size:28px;font-weight:800;color:#2d5f4d;margin-bottom:5px;}
    .circle-label{font-size:14px;color:#5a7a6d;font-weight:500;}

    .budget-details{flex:1;min-width:280px}
    .budget-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f9f4;}
    .budget-item:last-child{border-bottom:none}
    .budget-item.saved{background:rgba(76,175,80,.1);border-radius:12px;padding:16px;margin-top:15px;border-bottom:none}
    .budget-label{font-size:18px;font-weight:600;color:#2d5f4d;}
    .budget-amount{font-size:20px;font-weight:700;color:#2d5f4d;}
    .budget-amount.saved{color:#4caf50;font-size:22px;}
    .celebration-icon{margin-left:8px;font-size:22px;}

    .section-title{font-size:24px;font-weight:700;color:#2d5f4d;margin-bottom:25px;text-align:center;}
    .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
    .category-item{text-align:center;padding:20px;background:#fafffe;border-radius:15px;border:2px solid #e8f5f0;}
    .category-icon{font-size:40px;margin-bottom:10px;display:block;}
    .category-name{font-size:16px;font-weight:600;color:#2d5f4d;margin-bottom:8px;}
    .category-bar{width:100%;height:8px;background:#e8f5f0;border-radius:4px;overflow:hidden;margin-bottom:8px;}
    .category-progress{height:100%;background:#4caf50;border-radius:4px;transition:width 1s ease-out .2s;}
    .category-percentage{font-size:18px;font-weight:700;color:#4caf50;}

    .insights-list{display:flex;flex-direction:column;gap:16px;}
    .insight-item{display:flex;align-items:flex-start;gap:12px;padding:16px;background:#f8fffe;border-radius:15px;border-left:4px solid #4caf50;}
    .insight-icon{font-size:22px;flex-shrink:0;margin-top:2px;}
    .insight-text{font-size:16px;color:#2d5f4d;line-height:1.5;margin:0;}

    .button-section{text-align:center;animation:fadeInUp .8s ease-out .4s both;}
    .start-week-button{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);color:#fff;border:none;padding:22px 56px;font-size:20px;font-weight:700;border-radius:50px;cursor:pointer;box-shadow:0 8px 20px rgba(76,175,80,.3);transition:all .3s ease;margin-bottom:18px;}
    .start-week-button:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(76,175,80,.4);background:linear-gradient(135deg,#45a049 0%,#3d8b40 100%);}
    .start-week-button:active{transform:translateY(-1px);}
    .back-button{background:transparent;color:#8a9a8d;border:2px solid #e0e7e3;padding:14px 40px;font-size:16px;font-weight:500;border-radius:30px;cursor:pointer;transition:all .3s ease;}
    .back-button:hover{background:#f5f8f6;border-color:#c8d4cb;color:#5a7a6d;}

    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width:768px){
      .container{padding:20px;}
      .title{font-size:28px;}
      .description{font-size:16px;}
      .budget-circle{width:160px;height:160px;}
      .circle-percentage{font-size:24px;}
      .categories-grid{grid-template-columns:1fr;}
      .start-week-button{font-size:18px;padding:18px 44px;}
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Ukesrapport ‚Äì <span id="weekLabel">Uke</span></h1>
      <p class="description" id="descriptionText">Oppsummering av ukens forbruk og hvordan dere ligger an til neste uke.</p>
    </div>

    <div class="content-section">
      <!-- Budsjettoversikt -->
      <section class="card budget-overview">
        <div class="budget-circle-container">
          <div class="budget-circle">
            <div class="circle-bg">
              <div class="circle-progress" id="circleProgress"></div>
            </div>
            <div class="circle-content">
              <div class="circle-percentage" id="circlePercentage">0%</div>
              <div class="circle-label">brukt</div>
            </div>
          </div>

          <div class="budget-details">
            <div class="budget-item">
              <span class="budget-label">Budsjett:</span>
              <span class="budget-amount" id="budgetAmount">0 kr</span>
            </div>
            <div class="budget-item">
              <span class="budget-label">Brukt:</span>
              <span class="budget-amount" id="spentAmount">0 kr</span>
            </div>
            <div class="budget-item saved" id="savedRow" style="display:none;">
              <span class="budget-label">Sparte:</span>
              <span class="budget-amount saved" id="savedAmount">0 kr<span class="celebration-icon">üéâ</span></span>
            </div>
          </div>
        </div>
      </section>

      <!-- Kategorier -->
      <section class="card categories-section">
        <h2 class="section-title">Kategorier</h2>
        <div class="categories-grid" id="categoriesGrid">
          <!-- fylles via JS -->
        </div>
      </section>

      <!-- Innsikter -->
      <section class="card insights-section">
        <h2 class="section-title">Innsikter</h2>
        <div class="insights-list" id="insightsList">
          <!-- fylles via JS -->
        </div>
      </section>
    </div>

    <div class="button-section">
      <button class="start-week-button" id="startWeekButton">Start ny uke</button><br/>
      <button class="back-button" id="backButton">Tilbake til oversikten</button>
    </div>
  </main>

<script>
(function () {
  // ---------- Utils ----------
  function formatAmount(n){ return (Number(n)||0).toLocaleString('no-NO'); }

  // VIKTIG: bruk 12:00 for stabil uke-n√∏kkel (match app.html / add-purchase.html)
  function mondayOf(dateObj = new Date()){
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = (d.getDay()+6)%7; // 0=mandag
    d.setDate(d.getDate()-day);
    d.setHours(12,0,0,0);
    return d;
  }
  function sundayOf(dateObj = new Date()){
    const m = mondayOf(dateObj);
    const s = new Date(m);
    s.setDate(m.getDate()+6);
    return s;
  }
  function weekNumberISO(dateObj = new Date()){
    const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  function weekLabelForMondayISO(mondayISO){
    const [y,m,day] = mondayISO.split('-').map(Number);
    const mon = new Date(y, m-1, day, 12, 0, 0, 0);
    const sun = new Date(mon); sun.setDate(mon.getDate()+6);
    const wn  = weekNumberISO(mon);
    const nfStart = new Intl.DateTimeFormat('no-NO',{ day:'numeric', month:'long' });
    const nfEnd   = new Intl.DateTimeFormat('no-NO',{ day:'numeric', month:'long' });
    return `Uke ${wn} ‚Äì ${nfStart.format(mon)}‚Äì${nfEnd.format(sun)}`;
  }

  function safeGet(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function safeSet(key, value){
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  }

  function readWeeklyBudgetFor(isoMonday){
    const byWeek = parseFloat(localStorage.getItem(`weeklyBudget_${isoMonday}`));
    if (!isNaN(byWeek) && byWeek > 0) return byWeek;
    const global = parseFloat(localStorage.getItem('weeklyBudget'));
    if (!isNaN(global) && global > 0) return global;
    return 3000;
  }

  // ---------- State ----------
  let currentWeekISO = mondayOf().toISOString().slice(0,10);

  function computeState(weekISO){
    const purchases = safeGet(`purchases_${weekISO}`, []);
    const totalBudget = readWeeklyBudgetFor(weekISO);
    const spent = purchases.reduce((s,p)=> s + (Number(p.amount)||0), 0);
    const saved = Math.max(0, totalBudget - spent);
    const pct   = Math.min(100, totalBudget>0 ? Math.round(spent/totalBudget*100) : 0);
    const byCategory = purchases.reduce((acc,p)=>{
      const cat = (p.category && String(p.category).trim()) || 'Uten kategori';
      acc[cat] = (acc[cat]||0) + (Number(p.amount)||0);
      return acc;
    }, {});
    return { purchases, totalBudget, spent, saved, pct, byCategory };
  }

  // ---------- Renderers ----------
  function renderHeader(){
    document.getElementById('weekLabel').textContent = weekLabelForMondayISO(currentWeekISO);
  }
  function renderOverview(state){
    document.getElementById('budgetAmount').textContent = `${formatAmount(state.totalBudget)} kr`;
    document.getElementById('spentAmount').textContent  = `${formatAmount(state.spent)} kr`;

    const savedRow = document.getElementById('savedRow');
    const savedEl  = document.getElementById('savedAmount');
    if (state.saved > 0){
      savedRow.style.display = '';
      savedEl.innerHTML = `${formatAmount(state.saved)} kr<span class="celebration-icon">üéâ</span>`;
    } else {
      savedRow.style.display = 'none';
    }

    const circleProgress   = document.getElementById('circleProgress');
    const circlePercentage = document.getElementById('circlePercentage');
    const deg = Math.min(360, Math.round((state.pct/100)*360));
    circleProgress.style.background = `conic-gradient(#4caf50 0deg, #4caf50 ${deg}deg, transparent ${deg}deg)`;
    circlePercentage.textContent = `${state.pct}%`;
  }
  function renderCategories(state){
    const grid = document.getElementById('categoriesGrid');
    grid.innerHTML = '';

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    const total = Math.max(1, state.spent);
    if (entries.length === 0){
      const empty = document.createElement('div');
      empty.className = 'insight-item';
      empty.innerHTML = `<span class="insight-icon">‚ÑπÔ∏è</span>
        <p class="insight-text">Ingen registrerte kj√∏p denne uken enn√•.</p>`;
      grid.appendChild(empty);
      return;
    }
    entries.forEach(([name, value])=>{
      const percent = Math.round((value/total)*100);
      const item = document.createElement('div');
      item.className = 'category-item';
      const icon = guessIcon(name);
      item.innerHTML = `
        <span class="category-icon">${icon}</span>
        <div class="category-name">${escapeHTML(name)}</div>
        <div class="category-bar"><div class="category-progress" style="width:${percent}%"></div></div>
        <div class="category-percentage">${percent}%</div>
      `;
      grid.appendChild(item);
    });
  }
  function renderInsights(state){
    const list = document.getElementById('insightsList');
    list.innerHTML = '';

    if (state.saved > 0){
      addInsight('üëè', `Bra kontroll! Dere brukte under budsjett og sparte ${formatAmount(state.saved)} kr denne uken.`);
    } else if (state.spent === 0){
      addInsight('üïí', 'Ingen registrerte kj√∏p enda ‚Äì husk √• loggf√∏re handlekvitteringer n√•r dere handler.');
    } else if (state.spent > state.totalBudget){
      addInsight('‚ö†Ô∏è', `Budsjettet er overskredet med ${formatAmount(state.spent - state.totalBudget)} kr. Vurder √• redusere snacks/drikke eller kj√∏pe basisvarer p√• tilbud neste uke.`);
    } else {
      addInsight('üí°', 'Stabil uke. Fortsett med planlagte handler ‚Äì grunnvarer p√• tilbud gir best effekt.');
    }

    const entries = Object.entries(state.byCategory).sort((a,b)=> b[1]-a[1]);
    if (entries.length >= 1){
      const [topCat, topVal] = entries[0];
      addInsight('üéØ', `St√∏rst andel gikk til ¬´${topCat}¬ª (${Math.round((topVal/Math.max(1,state.spent))*100)}%). Sjekk om noe kan flyttes til rimeligere alternativer.`);
    }
    if (entries.length >= 2){
      const [lowCat, lowVal] = entries[entries.length-1];
      addInsight('üëç', `Lav andel p√• ¬´${lowCat}¬ª (${Math.round((lowVal/Math.max(1,state.spent))*100)}%) ‚Äì godt tegn p√• kontroll.`);
    }
  }
  function addInsight(icon, text){
    const li = document.createElement('div');
    li.className = 'insight-item';
    li.innerHTML = `<span class="insight-icon">${icon}</span><p class="insight-text">${escapeHTML(text)}</p>`;
    document.getElementById('insightsList').appendChild(li);
  }
  function guessIcon(name){
    const n = (name||'').toLowerCase();
    if (n.includes('mat')) return 'ü•ï';
    if (n.includes('snacks') || n.includes('drikke') || n.includes('brus') || n.includes('godt')) return 'üç´';
    if (n.includes('hushold')) return 'üßº';
    if (n.includes('frokost') || n.includes('br√∏d')) return 'üçû';
    if (n.includes('kj√∏tt')) return 'ü•©';
    if (n.includes('frukt') || n.includes('gr√∏nt')) return 'üçé';
    return 'üß∫';
  }
  function escapeHTML(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  // ---------- Start ny uke ----------
  document.getElementById('startWeekButton').addEventListener('click', ()=>{
    // finn neste uke
    const [y,m,d] = currentWeekISO.split('-').map(Number);
    const mon = new Date(y, m-1, d, 12,0,0,0);
    const nextMon = new Date(mon); nextMon.setDate(mon.getDate()+7);
    const nextISO = nextMon.toISOString().slice(0,10);

    // init neste uke i storage
    if (localStorage.getItem(`weeklyBudget_${nextISO}`) === null) {
      const currentBudget = readWeeklyBudgetFor(currentWeekISO);
      localStorage.setItem(`weeklyBudget_${nextISO}`, String(currentBudget));
    }
    if (localStorage.getItem(`purchases_${nextISO}`) === null) {
      localStorage.setItem(`purchases_${nextISO}`, '[]');
    }

    // speil aktivt budsjett for andre sider
    const nextBudget = readWeeklyBudgetFor(nextISO);
    localStorage.setItem('budget_total', String(nextBudget));
    localStorage.setItem('lastClosedWeekISO', currentWeekISO);

    // bytt state til neste uke og re-render (RESET VISNINGEN)
    currentWeekISO = nextISO;
    const state = computeState(currentWeekISO); // dette gir spent=0, tomme kategorier osv. f√∏rste gang
    renderHeader();
    renderOverview(state);
    renderCategories(state);
    renderInsights(state);
  });

  document.getElementById('backButton').addEventListener('click', ()=>{
    window.location.href = 'app.html';
  });

  // ---------- Init ----------
  function init(){
    renderHeader();
    const state = computeState(currentWeekISO);
    renderOverview(state);
    renderCategories(state);
    renderInsights(state);
  }
  init();
})();
</script>
</body>
</html>
