<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Husholdningsbudsjett - Budsjettvalg</title>

  <!-- Element SDK -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Supabase JS v2 (for auth-guard) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      display: flex; align-items: center; justify-content: center;
    }
    html { height: 100%; }
    .container { width: 90%; max-width: 700px; text-align: center; padding: 40px; }
    .header { margin-bottom: 50px; animation: fadeInDown 0.8s ease-out; }
    .title { font-size: 32px; font-weight: 700; color: #2d5f4d; margin-bottom: 20px; line-height: 1.3; }
    .description { font-size: 18px; color: #5a7a6d; line-height: 1.6; max-width: 500px; margin: 0 auto; }
    .budget-section { margin-bottom: 40px; animation: fadeInUp 0.8s ease-out 0.2s both; }
    .budget-controls { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 30px; }
    .budget-button {
      background: #4caf50; color: white; border: none; width: 60px; height: 60px; border-radius: 50%;
      font-size: 28px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); display: flex; align-items: center; justify-content: center;
    }
    .budget-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4); background: #45a049; }
    .budget-button:active { transform: scale(0.95); }
    .budget-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 2px 6px rgba(76, 175, 80, 0.2); }
    .budget-display {
      background: white; border: 3px solid #4caf50; border-radius: 20px; padding: 30px 40px;
      min-width: 200px; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.15);
    }
    .budget-amount { font-size: 48px; font-weight: 800; color: #2d5f4d; margin: 0; line-height: 1; }
    .budget-currency { font-size: 24px; color: #5a7a6d; margin-top: 5px; }
    .recommendation {
      background: rgba(76, 175, 80, 0.1); border-radius: 15px; padding: 20px; margin-bottom: 40px;
      animation: fadeInUp 0.8s ease-out 0.3s both;
    }
    .recommendation-text { font-size: 16px; color: #2d5f4d; margin: 0; font-weight: 500; }
    .button-section { animation: fadeInUp 0.8s ease-out 0.4s both; }
    .continue-button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white; border: none; padding: 20px 60px; font-size: 22px; font-weight: 600;
      border-radius: 50px; cursor: pointer; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease; margin-bottom: 20px;
    }
    .continue-button:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(76, 175, 80, 0.4); background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%); }
    .continue-button:active { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3); }
    .back-button {
      background: transparent; color: #8a9a8d; border: 2px solid #e0e7e3; padding: 15px 40px;
      font-size: 18px; font-weight: 500; border-radius: 30px; cursor: pointer; transition: all 0.3s ease;
    }
    .back-button:hover { background: #f5f8f6; border-color: #c8d4cb; color: #5a7a6d; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp   { from { opacity: 0; transform: translateY(30px); }  to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse      { 0% { transform: scale(1);} 50% { transform: scale(1.05);} 100% { transform: scale(1);} }
    .budget-display.updated { animation: pulse 0.3s ease-out; }
    @media (max-width: 768px) {
      .title { font-size: 26px; }
      .description { font-size: 16px; }
      .budget-controls { gap: 20px; }
      .budget-button { width: 50px; height: 50px; font-size: 24px; }
      .budget-amount { font-size: 36px; }
      .budget-display { padding: 25px 30px; min-width: 160px; }
      .continue-button { font-size: 20px; padding: 18px 50px; }
    }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Hva ønsker dere at ukens matbudsjett skal være?</h1>
      <p class="description" id="descriptionText">Velg hvor mye dere vil bruke totalt på mat denne uken. Budsjettet kan justeres senere.</p>
    </div>

    <div class="budget-section">
      <div class="budget-controls">
        <button class="budget-button" id="decreaseBtn">−</button>
        <div class="budget-display" id="budgetDisplay">
          <div class="budget-amount" id="budgetAmount">3 000</div>
          <div class="budget-currency">kr</div>
        </div>
        <button class="budget-button" id="increaseBtn">+</button>
      </div>
    </div>

    <div class="recommendation">
      <p class="recommendation-text" id="recommendationText">Anbefalt for 2 personer: ca. 2 800–3 500 kr per uke.</p>
    </div>

    <div class="button-section">
      <button class="continue-button" id="continueButton">Fortsett</button><br>
      <button class="back-button" id="backButton">Tilbake</button>
    </div>
  </main>

<script>
  // ===== Supabase init + auth-guard =====
  const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  (async () => {
    const { data: { session } } = await supa.auth.getSession();
    if (!session) { location.href = '/innlogging.html'; }
  })();

  const defaultConfig = {
    background_color: "#f8fffe",
    surface_color: "#ffffff",
    text_color: "#2d5f4d",
    primary_action_color: "#4caf50",
    secondary_text_color: "#5a7a6d",
    font_family: "Inter",
    font_size: 18,
    main_title: "Hva ønsker dere at ukens matbudsjett skal være?",
    description_text: "Velg hvor mye dere vil bruke totalt på mat denne uken. Budsjettet kan justeres senere.",
    recommendation_text: "Anbefalt for 2 personer: ca. 2 800–3 500 kr per uke.",
    continue_button_text: "Fortsett",
    back_button_text: "Tilbake"
  };

  // ---------- LOGIKK ----------
  const householdRaw = (localStorage.getItem('householdCount') || '2').replace('+','');
  const householdCount = Math.max(1, parseInt(householdRaw, 10) || 2);

  const minBudget = 1000;
  const maxBudget = 8000;
  const step = 100;

  function getCurrentWeekMondayISO(dateObj = new Date()) {
    const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
    const day = (d.getDay() + 6) % 7; // 0=mandag
    d.setDate(d.getDate() - day);
    d.setHours(12,0,0,0);
    return d.toISOString().slice(0, 10); // "YYYY-MM-DD"
  }

  function recommendedRange(n) {
    const low = 1700 + (n - 1) * 800;
    const high = 2300 + (n - 1) * 1200;
    const rLow = Math.round(low / 100) * 100;
    const rHigh = Math.round(high / 100) * 100;
    return [rLow, rHigh];
  }

  function recommendedMid(n) {
    const [low, high] = recommendedRange(n);
    return Math.round(((low + high) / 2) / 100) * 100;
  }

  function adjustColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));
    const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
  }

  function formatBudget(amount) {
    return amount.toLocaleString('no-NO');
  }

  function updateRecommendation() {
    const recElement = document.getElementById('recommendationText');
    const [low, high] = recommendedRange(householdCount);
    recElement.textContent =
      `Anbefalt for ${householdCount} ${householdCount === 1 ? 'person' : 'personer'}: ca. ${formatBudget(low)}–${formatBudget(high)} kr per uke.`;
  }

  let currentBudget = (() => {
    const saved = parseInt((localStorage.getItem('weeklyBudget') || '').replace(/\s|kr/g,''), 10);
    if (!isNaN(saved) && saved >= minBudget && saved <= maxBudget) return saved;
    return Math.min(maxBudget, Math.max(minBudget, recommendedMid(householdCount)));
  })();

  function updateBudgetDisplay() {
    const budgetAmount = document.getElementById('budgetAmount');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');

    currentBudget = Math.max(minBudget, Math.min(maxBudget, currentBudget));
    budgetAmount.textContent = formatBudget(currentBudget);

    budgetDisplay.classList.remove('updated');
    setTimeout(() => budgetDisplay.classList.add('updated'), 10);
    setTimeout(() => budgetDisplay.classList.remove('updated'), 300);

    decreaseBtn.disabled = currentBudget <= minBudget;
    increaseBtn.disabled = currentBudget >= maxBudget;
  }

  async function onConfigChange(config) {
    const backgroundColor = config.background_color || defaultConfig.background_color;
    const surfaceColor = config.surface_color || defaultConfig.surface_color;
    const textColor = config.text_color || defaultConfig.text_color;
    const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
    const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
    const customFont = config.font_family || defaultConfig.font_family;
    const baseSize = config.font_size || defaultConfig.font_size;

    document.body.style.background =
      `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor, -2)} 100%)`;

    const titleElement = document.getElementById('mainTitle');
    titleElement.textContent = config.main_title || defaultConfig.main_title;
    titleElement.style.color = textColor;
    titleElement.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    titleElement.style.fontSize = `${baseSize * 1.78}px`;

    const descElement = document.getElementById('descriptionText');
    descElement.textContent = config.description_text || defaultConfig.description_text;
    descElement.style.color = secondaryTextColor;
    descElement.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    descElement.style.fontSize = `${baseSize}px`;

    const recElement = document.getElementById('recommendationText');
    recElement.style.color = textColor;
    recElement.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;

    const continueButton = document.getElementById('continueButton');
    continueButton.textContent = config.continue_button_text || defaultConfig.continue_button_text;
    continueButton.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    continueButton.style.fontSize = `${baseSize * 1.22}px`;
    continueButton.style.background =
      `linear-gradient(135deg, ${primaryActionColor} 0%, ${adjustColor(primaryActionColor, -10)} 100%)`;

    const backButton = document.getElementById('backButton');
    backButton.textContent = config.back_button_text || defaultConfig.back_button_text;
    backButton.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;

    document.querySelectorAll('.budget-button').forEach(button => {
      button.style.background = primaryActionColor;
      button.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
    });

    const budgetDisplay = document.getElementById('budgetDisplay');
    budgetDisplay.style.background = surfaceColor;
    budgetDisplay.style.borderColor = primaryActionColor;

    const budgetAmount = document.getElementById('budgetAmount');
    budgetAmount.style.color = textColor;
    budgetAmount.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;

    const recommendation = document.querySelector('.recommendation');
    recommendation.style.background = `${primaryActionColor}1a`;
  }

  function mapToCapabilities(config) {
    return {
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk && window.elementSdk.setConfig({ background_color: v }) },
        { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk && window.elementSdk.setConfig({ surface_color: v }) },
        { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk && window.elementSdk.setConfig({ text_color: v }) },
        { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: v => window.elementSdk && window.elementSdk.setConfig({ primary_action_color: v }) },
        { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk && window.elementSdk.setConfig({ secondary_text_color: v }) },
      ],
      borderables: [],
      fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk && window.elementSdk.setConfig({ font_family: v }) },
      fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk && window.elementSdk.setConfig({ font_size: v }) }
    };
  }

  function mapToEditPanelValues(config) {
    return new Map([
      ["main_title", config.main_title || defaultConfig.main_title],
      ["description_text", config.description_text || defaultConfig.description_text],
      ["recommendation_text", config.recommendation_text || defaultConfig.recommendation_text],
      ["continue_button_text", config.continue_button_text || defaultConfig.continue_button_text],
      ["back_button_text", config.back_button_text || defaultConfig.back_button_text]
    ]);
  }

  // ---------- Event listeners ----------
  document.getElementById('decreaseBtn').addEventListener('click', () => {
    if (currentBudget > minBudget) { currentBudget -= step; updateBudgetDisplay(); }
  });
  document.getElementById('increaseBtn').addEventListener('click', () => {
    if (currentBudget < maxBudget) { currentBudget += step; updateBudgetDisplay(); }
  });

  document.getElementById('continueButton').addEventListener('click', async () => {
    const button = document.getElementById('continueButton');
    button.style.transform = 'scale(0.95)';

    setTimeout(async () => {
      button.style.transform = '';

      // 1) Normaliser og lagre globalt budsjett
      const budgetInt = Math.max(
        minBudget,
        Math.min(
          maxBudget,
          parseInt(String(currentBudget).replace(/\s|kr/g,''), 10) || 0
        )
      );
      localStorage.setItem('weeklyBudget', String(budgetInt));

      // 2) Finn ISO for aktiv uke (mandag 12:00) og sett som aktiv
      const mondayISO = getCurrentWeekMondayISO();
      localStorage.setItem('activeWeekISO', mondayISO);

      // 3) Lagre uke-spesifikt budsjett for aktiv uke
      localStorage.setItem(`weeklyBudget_${mondayISO}`, String(budgetInt));

      // Tøm ev. ukedata for ny start i denne uken
      ['purchases_', 'shoppingList_'].forEach(prefix => {
        localStorage.removeItem(`${prefix}${mondayISO}`);
      });
      localStorage.removeItem('budget_total');

      /* (VALGFRITT) Lagre budsjettet i DB per bruker/husstand dersom du har en kolonne
         f.eks. members.default_weekly_budget INT og/eller household_budgets-tabell.
      const { data: { session } } = await supa.auth.getSession();
      if (session) {
        await supa.from('members')
          .update({ default_weekly_budget: budgetInt })
          .eq('user_id', session.user.id);
      }
      */

      // 4) Videre i onboarding
      location.href = 'onboarding3.html';
    }, 150);
  });

  document.getElementById('backButton').addEventListener('click', () => {
    const button = document.getElementById('backButton');
    button.style.transform = 'scale(0.95)';
    setTimeout(() => {
      button.style.transform = '';
      location.href = 'onboarding1.html';
    }, 150);
  });

  // ---------- Init ----------
  updateRecommendation();
  updateBudgetDisplay();

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities,
      mapToEditPanelValues
    });
  }
</script>

<!-- (beholdt) -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99be74c32080b4f7',t:'MTc2MjcwMzMyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
