<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planlegg uka</title>

  <!-- Canva / Element SDK -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- (valgfritt) Tailwind, men vi bruker mest egen CSS -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      color: #2d5f4d;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 20px 110px;
    }

    /* Header */
    .header { margin-bottom: 20px; }
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: #5a7a6d;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 12px;
      transition: background 0.2s;
      font-family: inherit;
    }
    .back-button:hover { background: rgba(76, 175, 80, 0.1); }
    .back-button:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: #2d5f4d;
      margin: 10px 0 4px;
      text-align: center;
    }
    .page-subtitle {
      font-size: 16px;
      color: #5a7a6d;
      text-align: center;
    }

    .header-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .inbox-button,
    .mode-toggle {
      border-radius: 9999px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #ffffff;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 500;
      color: #2d5f4d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      font-family: inherit;
    }
    .inbox-button:hover,
    .mode-toggle:hover {
      background: rgba(76,175,80,0.06);
      box-shadow: 0 1px 4px rgba(45,95,77,0.12);
    }
    .mode-toggle.active {
      background: #4caf50;
      color: #ffffff;
      border-color: #4caf50;
    }

    /* Seksjoner */
    .section {
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-subtitle {
      font-size: 14px;
      color: #5a7a6d;
      margin-bottom: 12px;
    }

    /* Ukens middager */
    .weekly-menu-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .weekly-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: #ffffff;
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: 0 2px 6px rgba(45,95,77,0.1);
    }
    .weekly-day-label {
      font-weight: 600;
      color: #2d5f4d;
      flex-shrink: 0;
    }
    .weekly-dish {
      flex: 1;
      font-size: 14px;
      color: #5a7a6d;
      padding: 4px 8px;
      border-radius: 10px;
      background: #f8fffe;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .weekly-add-btn {
      border: none;
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: #4caf50;
      color: #ffffff;
      flex-shrink: 0;
      transition: background 0.2s, transform 0.1s;
    }
    .weekly-add-btn:hover { background: #45a049; }
    .weekly-add-btn:active { transform: scale(0.96); }
    .weekly-dish.empty {
      color: #9e9e9e;
      font-style: italic;
    }

    /* Faste varer */
    .frequent-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .frequent-chip {
      padding: 8px 12px;
      border-radius: 9999px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #ffffff;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.08s;
    }
    .frequent-chip:hover {
      background: rgba(76,175,80,0.06);
      box-shadow: 0 1px 4px rgba(45,95,77,0.12);
    }
    .frequent-chip:active { transform: scale(0.96); }

    /* Handleliste / kategorier */
    .category-card {
      background: #ffffff;
      border-radius: 20px;
      margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(45,95,77,0.08);
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .category-card:hover {
      box-shadow: 0 4px 12px rgba(45,95,77,0.12);
    }
    .category-header {
      padding: 16px 18px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: background 0.2s;
    }
    .category-card.open .category-header {
      background: rgba(76,175,80,0.04);
    }
    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d5f4d;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .category-count {
      font-size: 13px;
      color: #5a7a6d;
      font-weight: 400;
    }
    .category-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .category-card.open .category-content {
      max-height: 2000px;
      opacity: 1;
    }
    .category-inner {
      padding: 0 16px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Item-kort */
    .item-card {
      background: #f8fffe;
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(76,175,80,0.15);
      transition: background 0.2s, border-color 0.2s, opacity 0.2s;
    }
    .item-card.checked {
      background: #eeeeee;
      opacity: 0.85;
      text-decoration-line: line-through;
      text-decoration-color: #9e9e9e;
    }
    .item-checkbox {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      cursor: pointer;
      accent-color: #4caf50;
    }
    .item-details {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }
    .item-name {
      font-size: 15px;
      font-weight: 500;
      color: #2d5f4d;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .stepper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #ffffff;
      border-radius: 9999px;
      padding: 3px 6px;
      border: 1px solid rgba(76,175,80,0.25);
    }
    .stepper-btn {
      border: none;
      border-radius: 9999px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: #4caf50;
      color: #ffffff;
      flex-shrink: 0;
      transition: background 0.2s, transform 0.08s;
    }
    .stepper-btn:hover { background: #45a049; }
    .stepper-btn:active { transform: scale(0.94); }
    .stepper-value {
      min-width: 24px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #2d5f4d;
    }

    .item-delete-btn {
      border: none;
      border-radius: 9999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      color: #9e9e9e;
      flex-shrink: 0;
      transition: background 0.2s, color 0.2s;
    }
    .item-delete-btn:hover {
      background: rgba(211,47,47,0.08);
      color: #d32f2f;
    }

    /* FAB */
    /* Skjul +-knappen ‚Äì vi bruker kategorikortene i stedet */
.fab {
  display: none;
}
    .fab:hover {
      background: #45a049;
      transform: scale(1.05);
    }
    .fab:active { transform: scale(0.94); }

    .store-mode .fab {
      display: none;
    }

    /* I butikk-modus: vis kun handlelista */
.store-mode #weeklySection,
.store-mode #frequentSection {
  display: none;
}

.store-mode .page-subtitle {
  display: none;
}

/* Litt mindre luft i butikk-modus om du vil */
.store-mode .container {
  padding-top: 12px;
}

    /* Modal felles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #ffffff;
      border-radius: 22px;
      padding: 22px 22px 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 8px 28px rgba(0,0,0,0.35);
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 14px;
    }
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #f8fffe;
      font-family: inherit;
      font-size: 15px;
      color: #2d5f4d;
    }
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76,175,80,0.15);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    .btn {
      flex: 1;
      border-radius: 12px;
      border: none;
      padding: 11px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.08s;
    }
    .btn-primary {
      background: #4caf50;
      color: #ffffff;
    }
    .btn-primary:hover { background: #45a049; }
    .btn-primary:active { transform: scale(0.97); }
    .btn-secondary {
      background: #f0f0f0;
      color: #5a7a6d;
    }
    .btn-secondary:hover { background: #e0e0e0; }

    /* Footer */
    .footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      border-top: 1px solid rgba(76,175,80,0.12);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      box-shadow: 0 -2px 8px rgba(45,95,77,0.12);
      z-index: 25;
    }
    .footer-total {
      font-size: 15px;
      font-weight: 600;
      color: #2d5f4d;
    }
    .footer-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .footer-btn {
      border-radius: 9999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.08s;
    }
    .footer-btn.mark-all {
      background: #4caf50;
      color: #ffffff;
    }
    .footer-btn.mark-all:hover { background: #45a049; }
    .footer-btn.clear {
      background: #f0f0f0;
      color: #5a7a6d;
    }
    .footer-btn.clear:hover { background: #e0e0e0; }

    /* Kj√∏pt-seksjon i butikk-modus */
    .purchased-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #5a7a6d;
      margin: 6px 0;
    }

    .store-mode .category-card .item-card.checked {
      opacity: 0.4;
    }

    @media (max-width: 640px) {
      .container { padding: 16px 16px 110px; }
      .page-title { font-size: 26px; }
      .weekly-row { flex-direction: column; align-items: flex-start; }
      .weekly-add-btn { align-self: flex-end; }
      .footer { flex-direction: column; align-items: stretch; }
      .footer-actions { justify-content: stretch; }
      .footer-btn { flex: 1; text-align: center; }
      .fab { bottom: 120px; right: 20px; }
    }

    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-button" id="backBtn" aria-label="G√• tilbake">‚Üê Tilbake</button>
      <h1 class="page-title" id="pageTitle">Planlegg uka</h1>
      <p class="page-subtitle" id="pageSubtitle">
        Lag ukens middager, legg til faste varer og f√• en enkel handleliste üìù
      </p>

      <div class="header-actions">
        <button class="inbox-button" id="inboxBtn" style="display:none;">
          üì® Fra middagsplan (<span id="inboxCount">0</span>)
        </button>
        <button class="mode-toggle" id="modeToggleBtn">Start butikk-modus üõí</button>
      </div>
    </header>

    <!-- DEL 1: Ukens middager -->
    <section class="section" id="weeklySection">
      <h2 class="section-title">Ukens middager</h2>
      <p class="section-subtitle">
        Trykk p√• en dag og skriv inn hva dere skal ha til middag.
      </p>
      <div class="weekly-menu-list" id="weeklyMenuList"></div>
    </section>

    <!-- DEL 2: Faste varer -->
    <section class="section" id="frequentSection">
      <h2 class="section-title">Faste varer</h2>
      <p class="section-subtitle">
        Her dukker ting opp som dere ofte legger til p√• handlelisten. Trykk for √• legge til.
      </p>
      <div class="frequent-grid" id="frequentGrid"></div>
    </section>

    <!-- DEL 3: Handleliste -->
    <section class="section" id="shoppingSection">
      <h2 class="section-title">Handleliste</h2>
      <p class="section-subtitle" id="shoppingEmptyText">
        Handlelisten er tom. Start med √• legge til en middag eller en fast vare.
      </p>
      <div id="categoriesContainer"></div>

      <div id="purchasedContainer" style="margin-top:8px;"></div>
    </section>
  </div>

  <!-- Flytende + for √• legge til vare -->
  <button class="fab" id="fabBtn" aria-label="Legg til ny vare">+</button>

  <!-- Modal: Legg til vare -->
  <div class="modal-overlay" id="itemModalOverlay">
    <div class="modal" role="dialog" aria-labelledby="itemModalTitle">
      <h2 class="modal-title" id="itemModalTitle">Legg til vare</h2>
      <form id="addItemForm">
        <div class="form-group">
          <label class="form-label" for="itemNameInput">Varenavn</label>
          <input type="text" id="itemNameInput" class="form-input" placeholder="F.eks. Melk 1L" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="itemCategorySelect">Kategori</label>
          <select id="itemCategorySelect" class="form-select">
            <option value="Matvarer">Matvarer</option>
            <option value="Snacks/drikke">Snacks/drikke</option>
            <option value="Husholdning">Husholdning</option>
            <option value="Annet">Annet</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Antall</label>
          <div class="stepper">
            <button type="button" class="stepper-btn" id="modalDecBtn">‚àí</button>
            <span class="stepper-value" id="modalQty">1</span>
            <button type="button" class="stepper-btn" id="modalIncBtn">+</button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="itemCancelBtn">Avbryt</button>
          <button type="submit" class="btn btn-primary">Legg til</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Middag p√• dag -->
  <div class="modal-overlay" id="menuModalOverlay">
    <div class="modal" role="dialog" aria-labelledby="menuModalTitle">
      <h2 class="modal-title" id="menuModalTitle">Middag</h2>
      <form id="weeklyMenuForm">
        <div class="form-group">
          <label class="form-label" for="menuTextInput">Hva skal dere ha?</label>
          <input type="text" id="menuTextInput" class="form-input" placeholder="F.eks. Laks og poteter">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="menuCancelBtn">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer (antall varer + handlinger) -->
  <footer class="footer">
    <div class="footer-total" id="footerTotal">Antall varer i handlelista: 0</div>
    <div class="footer-actions">
      <button class="footer-btn mark-all" id="markAllBtn">Merk alle som kj√∏pt</button>
      <button class="footer-btn clear" id="clearBtn">T√∏m kj√∏pte</button>
    </div>
  </footer>

<script>
  // ---------- Konfig for Canva / Element ----------
  const defaultConfig = {
    page_title: "Planlegg uka",
    page_subtitle: "Lag ukens middager, legg til faste varer og f√• en enkel handleliste üìù",
    total_label: "Antall varer i handlelista",
    background_color: "#f8fffe",
    primary_color: "#4caf50",
    text_color: "#2d5f4d",
    secondary_text_color: "#5a7a6d",
    surface_color: "#ffffff",
    font_family: "Inter",
    font_size: 16
  };
  let currentConfig = { ...defaultConfig };

  // ---------- Utils ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const fmtInt = (n) => Number(n || 0).toLocaleString("no-NO");

  function mondayISO(date = new Date()) {
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = (d.getDay() + 6) % 7; // 0=mandag
    d.setDate(d.getDate() - day);
    d.setHours(12,0,0,0);
    return d.toISOString().slice(0,10);
  }

  function getLS(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const val = JSON.parse(raw);
      return val ?? fallback;
    } catch {
      return fallback;
    }
  }
  function setLS(key, val) {
    try {
      localStorage.setItem(key, JSON.stringify(val));
    } catch {}
  }

  // ---------- N√∏kler ----------
  const WEEK_ISO = mondayISO();
  const WEEK_LIST_KEY   = `shoppingList_${WEEK_ISO}`;
  const WEEK_MENU_KEY   = `weeklyMenu_${WEEK_ISO}`;
  const FREQ_KEY        = `frequentItems`;
  const INBOX_KEY       = `shoppingList_inbox_${WEEK_ISO}`;

  // ---------- State ----------
  const DAYS = [
    { key: "mon", label: "Mandag"  },
    { key: "tue", label: "Tirsdag" },
    { key: "wed", label: "Onsdag"  },
    { key: "thu", label: "Torsdag" },
    { key: "fri", label: "Fredag"  },
    { key: "sat", label: "L√∏rdag"  },
    { key: "sun", label: "S√∏ndag"  }
  ];

  const defaultMenu = {
    mon: "", tue: "", wed: "", thu: "", fri: "", sat: "", sun: ""
  };

  const defaultCategories = [
    { name: "Matvarer",       open: true,  items: [] },
    { name: "Snacks/drikke",  open: false, items: [] },
    { name: "Husholdning",    open: false, items: [] },
    { name: "Annet",          open: false, items: [] }
  ];

  const defaultFrequentItems = [
    { name: "Melk",        category: "Matvarer",      timesUsed: 3 },
    { name: "Br√∏d",        category: "Matvarer",      timesUsed: 3 },
    { name: "Ost",         category: "Matvarer",      timesUsed: 2 },
    { name: "Kaffe",       category: "Snacks/drikke", timesUsed: 2 },
    { name: "Epler",       category: "Matvarer",      timesUsed: 1 },
    { name: "T√∏rkepapir",  category: "Husholdning",   timesUsed: 1 }
  ];

  let weeklyMenu    = getLS(WEEK_MENU_KEY, defaultMenu);
  let categories    = getLS(WEEK_LIST_KEY, defaultCategories);
  let frequentItems = getLS(FREQ_KEY, defaultFrequentItems);
  let isStoreMode   = false;

  // Sikrer oss mot gamle tomme localStorage-verdier
  if (!Array.isArray(categories) || categories.length === 0) {
    categories = JSON.parse(JSON.stringify(defaultCategories));
    saveCategories();
  }

  let modalQty      = 1;
  let currentMenuDayKey = null;

  // ---------- Persist helpers ----------
  function saveMenu()      { setLS(WEEK_MENU_KEY, weeklyMenu); }
  function saveCategories(){ setLS(WEEK_LIST_KEY, categories); }
  function saveFrequent()  { setLS(FREQ_KEY, frequentItems); }

  // ---------- Weekly menu ----------
  function renderWeeklyMenu() {
    const container = $("#weeklyMenuList");
    if (!container) return;
    container.innerHTML = "";

    DAYS.forEach(day => {
      const row = document.createElement("div");
      row.className = "weekly-row";

      const label = document.createElement("div");
      label.className = "weekly-day-label";
      label.textContent = day.label;

      const dish = document.createElement("div");
      dish.className = "weekly-dish";
      const text = weeklyMenu[day.key] || "";
      if (!text) {
        dish.textContent = "Ingen middag valgt enn√•";
        dish.classList.add("empty");
      } else {
        dish.textContent = text;
      }

      const btn = document.createElement("button");
      btn.className = "weekly-add-btn";
      btn.textContent = text ? "Endre" : "Legg til";
      btn.addEventListener("click", () => openMenuModal(day.key, day.label));

      row.appendChild(label);
      row.appendChild(dish);
      row.appendChild(btn);
      container.appendChild(row);
    });
  }

  function openMenuModal(dayKey, dayLabel) {
    currentMenuDayKey = dayKey;
    const overlay = $("#menuModalOverlay");
    const title   = $("#menuModalTitle");
    const input   = $("#menuTextInput");

    if (title) title.textContent = `Middag p√• ${dayLabel}`;
    if (input) {
      input.value = weeklyMenu[dayKey] || "";
      setTimeout(() => input.focus(), 20);
    }
    if (overlay) overlay.classList.add("open");
  }

  function closeMenuModal() {
    const overlay = $("#menuModalOverlay");
    if (overlay) overlay.classList.remove("open");
    currentMenuDayKey = null;
  }
  // ---------- Frequent items ----------
  function trackFrequentItem(name, category) {
    const cleanName = String(name || "").trim();
    if (!cleanName) return;

    const existing = frequentItems.find(f => f.name.toLowerCase() === cleanName.toLowerCase());
    if (existing) {
      existing.timesUsed = (existing.timesUsed || 0) + 1;
    } else {
      frequentItems.push({
        name: cleanName,
        category: category || "Matvarer",
        timesUsed: 1
      });
    }
    saveFrequent();
    renderFrequentItems();
  }

  function renderFrequentItems() {
    const grid = $("#frequentGrid");
    if (!grid) return;

    const sorted = [...frequentItems].sort((a,b) => (b.timesUsed||0) - (a.timesUsed||0));
    const top = sorted.slice(0, 10);

    grid.innerHTML = "";
    if (top.length === 0) {
      grid.textContent = "Her dukker det opp varer dere bruker ofte, etter hvert som dere bygger handlelister.";
      return;
    }

    top.forEach(item => {
      const chip = document.createElement("button");
      chip.className = "frequent-chip";
      chip.type = "button";
      chip.textContent = item.name;
      chip.addEventListener("click", () => {
        addItemToCategoryByName(item.name, item.category, 1);
      });
      grid.appendChild(chip);
    });
  }

  // ---------- Handleliste / kategorier ----------
  function findCategoryIndex(name) {
    let idx = categories.findIndex(c => c.name === name);
    if (idx === -1) {
      categories.push({ name, open: true, items: [] });
      idx = categories.length - 1;
    }
    return idx;
  }

  function addItemToCategoryByName(name, categoryName, quantity = 1) {
    const catIdx = findCategoryIndex(categoryName || "Matvarer");
    const cat = categories[catIdx];

    cat.items.push({
      name: String(name || "").trim(),
      quantity: Math.max(1, Number(quantity) || 1),
      checked: false
    });

    cat.open = true;
    trackFrequentItem(name, categoryName);
    saveCategories();
    renderCategories();
  }

  function createItemCard(item, ci, ii) {
    const card = document.createElement("div");
    card.className = "item-card" + (item.checked ? " checked" : "");
    card.dataset.categoryIndex = ci;
    card.dataset.itemIndex = ii;

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "item-checkbox";
    checkbox.checked = !!item.checked;
    checkbox.addEventListener("change", (e) => {
      e.stopPropagation();
      toggleItemChecked(ci, ii);
    });

    const details = document.createElement("div");
    details.className = "item-details";

    const nameEl = document.createElement("div");
    nameEl.className = "item-name";
    nameEl.textContent = item.name;

    const stepper = document.createElement("div");
    stepper.className = "stepper";
    const decBtn = document.createElement("button");
    decBtn.type = "button";
    decBtn.className = "stepper-btn";
    decBtn.textContent = "‚àí";
    decBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      updateQuantity(ci, ii, -1);
    });
    const valEl = document.createElement("span");
    valEl.className = "stepper-value";
    valEl.textContent = item.quantity;
    const incBtn = document.createElement("button");
    incBtn.type = "button";
    incBtn.className = "stepper-btn";
    incBtn.textContent = "+";
    incBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      updateQuantity(ci, ii, 1);
    });
    stepper.appendChild(decBtn);
    stepper.appendChild(valEl);
    stepper.appendChild(incBtn);

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "item-delete-btn";
    delBtn.innerHTML = "üóë";
    delBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      deleteItem(ci, ii);
    });

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.alignItems = "center";
    right.style.gap = "6px";
    right.appendChild(stepper);
    right.appendChild(delBtn);

    details.appendChild(nameEl);
    details.appendChild(right);

    card.appendChild(checkbox);
    card.appendChild(details);

    card.addEventListener("click", () => {
      toggleItemChecked(ci, ii);
    });

    return card;
  }

function renderCategories() {
  const container = $("#categoriesContainer");
  const purchasedContainer = $("#purchasedContainer");
  const emptyText = $("#shoppingEmptyText");
  if (!container) return;

  container.innerHTML = "";
  if (purchasedContainer) purchasedContainer.innerHTML = "";

  let totalItems = 0;
  let purchasedItemsFlat = [];

  categories.forEach((cat, ci) => {
    const card = document.createElement("div");
    // alltid √•pen ‚Äì vi bruker headeren som "legg til"-knapp, ikke til √• √•pne/lukke
    card.className = "category-card open";
    card.dataset.categoryIndex = ci;
    card.addEventListener("click", (e) => {
      if (e.target.closest(".item-card")) return;
      openItemModal(cat.name);
    });

    // HEADER: hele feltet er n√• "legg til vare i denne kategorien"
    const header = document.createElement("div");
    header.className = "category-header";
    header.setAttribute("role", "button");
    header.setAttribute("tabindex", "0");
    header.setAttribute("aria-expanded", "true");
    header.innerHTML = `
      <div class="category-title">
        ${cat.name}
        <span class="category-count">(${cat.items.length})</span>
      </div>
    `;
    header.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openItemModal(cat.name);
      }
    });

    const content = document.createElement("div");
    content.className = "category-content";
    // vi tvinger den "√•pen"
    content.style.maxHeight = "2000px";
    content.style.opacity = "1";

    const inner = document.createElement("div");
    inner.className = "category-inner";

    // Ikke noe inline-input ‚Äì selve kortet fungerer som "legg til"

    // Varer i denne kategorien
    cat.items.forEach((item, ii) => {
      const qty = Math.max(1, Number(item.quantity) || 1);
      totalItems += qty;

      if (isStoreMode && item.checked) {
        purchasedItemsFlat.push({ item, ci, ii, categoryName: cat.name });
      } else {
        inner.appendChild(createItemCard(item, ci, ii));
      }
    });

    content.appendChild(inner);
    card.appendChild(header);
    card.appendChild(content);
    container.appendChild(card);
  });

  // Kj√∏pt-liste i butikk-modus
  if (isStoreMode && purchasedItemsFlat.length > 0 && purchasedContainer) {
    const title = document.createElement("div");
    title.className = "purchased-section-title";
    title.textContent = `Kj√∏pt denne turen (${purchasedItemsFlat.length} ulike varer)`;
    purchasedContainer.appendChild(title);

    purchasedItemsFlat.forEach(p => {
      purchasedContainer.appendChild(createItemCard(p.item, p.ci, p.ii));
    });
  }

  // Tom-tekst
  if (emptyText) {
    emptyText.style.display = totalItems === 0 ? "block" : "none";
  }

  updateFooter(totalItems);
}

  // ---------- Mutators ----------

  function toggleItemChecked(ci, ii) {
    const it = categories[ci].items[ii];
    it.checked = !it.checked;
    saveCategories();
    renderCategories();
  }

  function updateQuantity(ci, ii, delta) {
    const it = categories[ci].items[ii];
    const newQty = Math.max(1, (Number(it.quantity) || 1) + delta);
    it.quantity = newQty;
    saveCategories();
    renderCategories();
  }

  function deleteItem(ci, ii) {
    categories[ci].items.splice(ii, 1);
    saveCategories();
    renderCategories();
  }

  function markAllChecked() {
    categories.forEach(cat => {
      cat.items.forEach(i => { i.checked = true; });
    });
    saveCategories();
    renderCategories();
  }

  function clearChecked() {
    categories.forEach(cat => {
      cat.items = cat.items.filter(i => !i.checked);
    });
    saveCategories();
    renderCategories();
  }

  // ---------- Footer ----------
  function updateFooter(totalItems) {
    const footerTotal = $("#footerTotal");
    if (!footerTotal) return;
    const label = currentConfig.total_label || defaultConfig.total_label;
    footerTotal.textContent = `${label}: ${fmtInt(totalItems)}`;
  }

  // ---------- FAB / vare-modal ----------
  function openItemModal(categoryName) {
    const overlay = $("#itemModalOverlay");
    const nameInput = $("#itemNameInput");

    modalQty = 1;
    $("#modalQty").textContent = "1";

    // forh√•ndsvelg kategori hvis vi fikk en, ellers Matvarer
    const catSelect = $("#itemCategorySelect");
    if (catSelect) {
      catSelect.value = categoryName || "Matvarer";
    }

    if (nameInput) {
      nameInput.value = "";
      setTimeout(() => nameInput.focus(), 20);
    }
    if (overlay) overlay.classList.add("open");
  }

  function closeItemModal() {
    const overlay = $("#itemModalOverlay");
    if (overlay) overlay.classList.remove("open");
  }

  // ---------- Inbox fra middagsplan ----------
  function getInboxItems() {
    try {
      const arr = JSON.parse(localStorage.getItem(INBOX_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function mergeInboxItems() {
    const inbox = getInboxItems();
    if (!Array.isArray(inbox) || inbox.length === 0) return 0;

    let matIdx = findCategoryIndex("Matvarer");
    const cat = categories[matIdx];

    const existing = new Set(
      cat.items.map(i => String(i.name || "").trim().toLowerCase())
    );

    let added = 0;
    inbox.forEach(name => {
      const clean = String(name || "").trim();
      if (!clean) return;
      const key = clean.toLowerCase();
      if (existing.has(key)) return;
      cat.items.push({ name: clean, quantity: 1, checked: false });
      existing.add(key);
      trackFrequentItem(clean, "Matvarer");
      added++;
    });

    setLS(INBOX_KEY, []);
    if (added > 0) cat.open = true;
    saveCategories();
    return added;
  }

  function initInboxButton() {
    const inboxBtn = $("#inboxBtn");
    const inboxCountSpan = $("#inboxCount");
    if (!inboxBtn || !inboxCountSpan) return;

    const items = getInboxItems();
    if (!items || items.length === 0) {
      inboxBtn.style.display = "none";
      return;
    }

    inboxBtn.style.display = "inline-flex";
    inboxCountSpan.textContent = items.length;

    inboxBtn.addEventListener("click", () => {
      const ok = confirm(`Legg til ${items.length} varer fra middagsplanen i handlelista?`);
      if (!ok) return;
      const added = mergeInboxItems();
      renderCategories();
      inboxBtn.style.display = "none";
      if (added > 0) {
        showToast(`La til ${added} varer fra middagsplanen ‚úÖ`);
      }
    });
  }

  function showToast(text) {
    const t = document.createElement("div");
    t.textContent = text;
    t.style.position = "fixed";
    t.style.top = "12px";
    t.style.left = "50%";
    t.style.transform = "translateX(-50%)";
    t.style.background = "#4caf50";
    t.style.color = "#ffffff";
    t.style.padding = "8px 12px";
    t.style.borderRadius = "9999px";
    t.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
    t.style.zIndex = "1000";
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2300);
  }

  // ---------- Butikk-modus ----------
const modeToggleBtn = $("#modeToggleBtn");
if (modeToggleBtn) {
  modeToggleBtn.addEventListener("click", () => {
    isStoreMode = !isStoreMode;
    document.body.classList.toggle("store-mode", isStoreMode);

    if (isStoreMode) {
      modeToggleBtn.textContent = "Avslutt butikk-modus";
      modeToggleBtn.classList.add("active");

      // Scroll ned til handlelista n√•r butikk-modus startes
      const shoppingSection = $("#shoppingSection");
      if (shoppingSection) {
        shoppingSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    } else {
      modeToggleBtn.textContent = "Start butikk-modus üõí";
      modeToggleBtn.classList.remove("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    renderCategories();
  });
}

  // ---------- Tilbake-knapp ----------
  const backBtn = $("#backBtn");
  if (backBtn) {
    backBtn.addEventListener("click", () => {
      const ref = document.referrer || "";
      const cameFromApp = /(^|\/)app\.html(\?|#|$)/.test(ref);
      if (cameFromApp) {
        history.back();
      } else {
        window.location.href = "app.html";
      }
    });
  }

  // ---------- Element SDK (tema / tekst) ----------
  function onConfigChange(cfg) {
    currentConfig = { ...currentConfig, ...cfg };

    const font = currentConfig.font_family || defaultConfig.font_family;
    const baseSize = currentConfig.font_size || defaultConfig.font_size;
    const bg = currentConfig.background_color || defaultConfig.background_color;
    const txt = currentConfig.text_color || defaultConfig.text_color;
    const secTxt = currentConfig.secondary_text_color || defaultConfig.secondary_text_color;
    const primary = currentConfig.primary_color || defaultConfig.primary_color;
    const surface = currentConfig.surface_color || defaultConfig.surface_color;

    document.body.style.fontFamily = `${font}, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
    document.body.style.background = `linear-gradient(135deg, ${bg} 0%, #f0f9f4 100%)`;

    const title = $("#pageTitle");
    const subtitle = $("#pageSubtitle");
    if (title) {
      title.textContent = currentConfig.page_title || defaultConfig.page_title;
      title.style.fontSize = `${baseSize * 2}px`;
      title.style.color = txt;
    }
    if (subtitle) {
      subtitle.textContent = currentConfig.page_subtitle || defaultConfig.page_subtitle;
      subtitle.style.fontSize = `${baseSize}px`;
      subtitle.style.color = secTxt;
    }

    // Overflater / prim√¶rfarge
    $$(".category-card, .modal").forEach(el => {
      el.style.background = surface;
    });
    $$(".fab, .weekly-add-btn, .stepper-btn, .footer-btn.mark-all, .btn-primary").forEach(el => {
      el.style.background = primary;
      el.style.color = "#ffffff";
    });

    const footerTotal = $("#footerTotal");
    if (footerTotal) {
      const totalLabel = currentConfig.total_label || defaultConfig.total_label;
      const currentNum = footerTotal.textContent.replace(/\D+/g, "");
      const n = parseInt(currentNum || "0", 10);
      footerTotal.textContent = `${totalLabel}: ${fmtInt(n)}`;
    }
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
          { get: () => config.surface_color    || defaultConfig.surface_color,    set: v => window.elementSdk.setConfig({ surface_color: v }) },
          { get: () => config.text_color       || defaultConfig.text_color,       set: v => window.elementSdk.setConfig({ text_color: v }) },
          { get: () => config.primary_color    || defaultConfig.primary_color,    set: v => window.elementSdk.setConfig({ primary_color: v }) },
          { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: v  => window.elementSdk.setConfig({ font_family: v })
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: v  => window.elementSdk.setConfig({ font_size: v })
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
        ["total_label", config.total_label || defaultConfig.total_label]
      ])
    });
  }

  // ---------- Event-listeners for modaler og footer ----------
  // FAB
  $("#fabBtn")?.addEventListener("click", () => openItemModal());

  // Vare-modal
  $("#itemCancelBtn")?.addEventListener("click", closeItemModal);
  $("#itemModalOverlay")?.addEventListener("click", (e) => {
    if (e.target === $("#itemModalOverlay")) closeItemModal();
  });
  $("#modalDecBtn")?.addEventListener("click", () => {
    modalQty = Math.max(1, modalQty - 1);
    $("#modalQty").textContent = String(modalQty);
  });
  $("#modalIncBtn")?.addEventListener("click", () => {
    modalQty += 1;
    $("#modalQty").textContent = String(modalQty);
  });
  $("#addItemForm")?.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = $("#itemNameInput").value.trim();
    const cat  = $("#itemCategorySelect").value;
    if (!name) return;
    addItemToCategoryByName(name, cat, modalQty);
    closeItemModal();
  });

  // Middags-modal
  $("#menuCancelBtn")?.addEventListener("click", closeMenuModal);
  $("#menuModalOverlay")?.addEventListener("click", (e) => {
    if (e.target === $("#menuModalOverlay")) closeMenuModal();
  });
  $("#weeklyMenuForm")?.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!currentMenuDayKey) {
      closeMenuModal();
      return;
    }
    const txt = $("#menuTextInput").value.trim();
    weeklyMenu[currentMenuDayKey] = txt;
    saveMenu();
    renderWeeklyMenu();
    closeMenuModal();
  });

  // Footer-knapper
  $("#markAllBtn")?.addEventListener("click", markAllChecked);
  $("#clearBtn")?.addEventListener("click", clearChecked);

  // ---------- Init ----------
  renderWeeklyMenu();
  renderFrequentItems();
  renderCategories();
  initInboxButton();
</script>
</body>
</html>
