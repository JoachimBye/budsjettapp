<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Handleliste</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      color: #2d5f4d;
      overflow-x: hidden;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }

    /* Header */
    .header { margin-bottom: 16px; }
    .back-button {
      display: inline-flex; align-items: center; gap: 6px; background: none; border: none;
      color: #5a7a6d; font-size: 14px; cursor: pointer; padding: 8px 12px; border-radius: 12px;
      transition: background 0.2s; font-family: inherit;
    }
    .back-button:hover { background: rgba(76, 175, 80, 0.1); }
    .back-button:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .page-title { font-size: 32px; font-weight: 700; color: #2d5f4d; margin: 12px 0 4px 0; text-align: center;}
    .page-subtitle { font-size: 16px; color: #5a7a6d; text-align: center; }

    .header-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .inbox-button,
    .mode-toggle {
      border-radius: 9999px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #ffffff;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 500;
      color: #2d5f4d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      font-family: inherit;
    }
    .inbox-button:hover,
    .mode-toggle:hover {
      background: rgba(76,175,80,0.06);
      box-shadow: 0 1px 4px rgba(45,95,77,0.12);
    }
    .mode-toggle.active {
      background: #4caf50;
      color: #ffffff;
      border-color: #4caf50;
    }

    /* Budget Card */
    .budget-card {
      background: #ffffff; border-radius: 20px; padding: 16px 20px; margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(45, 95, 77, 0.08);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    .budget-item { display: flex; flex-direction: column; gap: 4px; }
    .budget-label { font-size: 13px; color: #5a7a6d; font-weight: 500; }
    .budget-amount { font-size: 18px; font-weight: 700; color: #2d5f4d; transition: transform 0.3s; }
    .budget-amount.pulse { animation: pulse 0.4s ease; }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }

    .budget-warning {
      margin: 6px 2px 18px 2px;
      font-size: 14px;
      font-weight: 500;
      color: #2d5f4d;
    }
    .budget-warning.ok { color: #2e7d32; }
    .budget-warning.warn { color: #f9a825; }
    .budget-warning.over { color: #d32f2f; }

    /* Category Cards */
    .category-card {
      background: #ffffff; border-radius: 20px; margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(45,95,77,0.08); overflow: hidden; transition: box-shadow 0.2s;
    }
    .category-card:hover { box-shadow: 0 4px 12px rgba(45,95,77,0.12); }
    .category-header {
      padding: 20px; cursor: pointer; display: flex; justify-content: space-between;
      align-items: center; user-select: none; transition: background 0.2s;
    }
    .category-header:hover { background: rgba(76, 175, 80, 0.05); }
    .category-header:focus { outline: 2px solid #4caf50; outline-offset: -2px; }
    .category-title { font-size: 18px; font-weight: 600; color: #2d5f4d; display: flex; align-items: center; gap: 8px; }
    .category-count { font-size: 14px; color: #5a7a6d; font-weight: 400; }
    .category-chevron { font-size: 20px; color: #4caf50; transition: transform 0.3s; }
    .category-card.open .category-chevron { transform: rotate(180deg); }
    .category-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 0; }
    .category-card.open .category-content { max-height: 2000px; opacity: 1; }
    .category-items { padding: 0 20px 20px 20px; display: flex; flex-direction: column; gap: 12px; }

    .purchased-section .category-header {
      background: #f8fffe;
      border-top: 1px solid rgba(76,175,80,0.2);
    }

    /* Item Card */
    .item-card {
      background: #f8fffe; border-radius: 15px; padding: 16px;
      display: flex; align-items: center; gap: 12px;
      transition: all 0.2s; border: 1px solid rgba(76,175,80,0.1);
    }
    .item-card.checked { background: #f0f0f0; opacity: 0.8; }
    .item-card:hover { border-color: rgba(76,175,80,0.3); }
    .item-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #4caf50; flex-shrink: 0; }
    .item-checkbox:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .item-details { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    .item-name { font-size: 16px; font-weight: 500; color: #2d5f4d; transition: text-decoration 0.2s; }
    .item-card.checked .item-name { text-decoration: line-through; }
    .item-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }

    .stepper {
      display: flex; align-items: center; gap: 8px; background: #ffffff;
      border-radius: 12px; padding: 4px; border: 1px solid rgba(76,175,80,0.2);
    }
    .stepper-btn {
      width: 28px; height: 28px; border: none; background: #4caf50; color: white; border-radius: 8px; cursor: pointer;
      font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; flex-shrink: 0;
    }
    .stepper-btn:hover { background: #45a049; }
    .stepper-btn:active { background: #3d8b40; }
    .stepper-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .stepper-value { min-width: 30px; text-align: center; font-weight: 600; color: #2d5f4d; font-size: 14px; }

    .price-input {
      width: 80px; padding: 6px 10px; border: 1px solid rgba(76,175,80,0.2); border-radius: 10px;
      font-size: 14px; font-family: inherit; color: #2d5f4d; background: #ffffff;
    }
    .price-input:focus { outline: 2px solid #4caf50; outline-offset: 0; border-color: #4caf50; }
    .item-total {
      font-size: 16px; font-weight: 700; color: #4caf50; min-width: 70px; text-align: right;
      transition: transform 0.3s;
    }
    .item-total.pulse { animation: pulse 0.4s ease; }

    .item-menu-btn {
      width: 32px; height: 32px; border: none; background: none; color: #5a7a6d; cursor: pointer;
      border-radius: 8px; font-size: 18px; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; flex-shrink: 0; position: relative;
    }
    .item-menu-btn:hover { background: rgba(76,175,80,0.1); }
    .item-menu-btn:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .item-menu {
      position: absolute; top: 100%; right: 0; background: #ffffff; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(45,95,77,0.15); padding: 8px; min-width: 180px; z-index: 100; display: none;
    }
    .item-menu.open { display: block; }
    .menu-item {
      padding: 10px 12px; cursor: pointer; border-radius: 8px; font-size: 14px; color: #2d5f4d;
      transition: background 0.2s; display: block; width: 100%; text-align: left; border: none;
      background: none; font-family: inherit;
    }
    .menu-item:hover { background: rgba(76,175,80,0.1); }
    .menu-item:focus { outline: 2px solid #4caf50; outline-offset: -2px; }
    .menu-item.delete { color: #d32f2f; }
    .menu-item.delete:hover { background: rgba(211,47,47,0.1); }

    /* FAB */
    .fab {
      position: fixed; bottom: 100px; right: 24px; width: 60px; height: 60px; border-radius: 50%;
      background: #4caf50; color: white; border: none; font-size: 28px; cursor: pointer;
      box-shadow: 0 4px 16px rgba(76,175,80,0.4); display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; z-index: 50;
    }
    .fab:hover { background: #45a049; transform: scale(1.05); box-shadow: 0 6px 20px rgba(76,175,80,0.5); }
    .fab:active { transform: scale(0.95); }
    .fab:focus { outline: 3px solid #4caf50; outline-offset: 3px; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45,95,77,0.5);
      display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #ffffff; border-radius: 24px; padding: 28px; max-width: 500px; width: 100%;
      box-shadow: 0 8px 32px rgba(45,95,77,0.2); max-height: 90%; overflow-y: auto;
    }
    .modal-title { font-size: 24px; font-weight: 700; color: #2d5f4d; margin-bottom: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 14px; font-weight: 600; color: #2d5f4d; margin-bottom: 8px; }
    .form-input, .form-select {
      width: 100%; padding: 12px 16px; border: 1px solid rgba(76,175,80,0.2); border-radius: 12px;
      font-size: 16px; font-family: inherit; color: #2d5f4d; background: #f8fffe; transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus {
      outline: none; border-color: #4caf50; box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
    }
    .modal-actions { display: flex; gap: 12px; margin-top: 28px; }
    .btn {
      flex: 1; padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .btn-primary { background: #4caf50; color: white; }
    .btn-primary:hover { background: #45a049; }
    .btn-primary:active { background: #3d8b40; }
    .btn-primary:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .btn-secondary { background: #f0f0f0; color: #5a7a6d; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-secondary:focus { outline: 2px solid #5a7a6d; outline-offset: 2px; }

    /* Footer */
    .footer {
      position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; border-top: 1px solid rgba(76,175,80,0.1);
      padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
      gap: 16px; box-shadow: 0 -2px 8px rgba(45,95,77,0.08); flex-wrap: wrap; z-index: 40;
    }
    .footer-total { font-size: 18px; font-weight: 700; color: #2d5f4d; }
    .footer-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .footer-btn {
      padding: 10px 16px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .footer-btn.mark-all { background: #4caf50; color: white; }
    .footer-btn.mark-all:hover { background: #45a049; }
    .footer-btn.mark-all:focus { outline: 2px solid #4caf50; outline-offset: 2px; }
    .footer-btn.clear { background: #f0f0f0; color: #5a7a6d; }
    .footer-btn.clear:hover { background: #e0e0e0; }
    .footer-btn.clear:focus { outline: 2px solid #5a7a6d; outline-offset: 2px; }

    .footer-btn.done {
      background: #2d5f4d;
      color: #ffffff;
    }
    .footer-btn.done:hover { background: #244538; }
    .footer-btn.done:focus { outline: 2px solid #2d5f4d; outline-offset: 2px; }

    /* Store mode */
    .store-mode .fab {
      display: none;
    }
    .store-mode .item-card {
      padding: 18px;
    }
    .store-mode .item-checkbox {
      width: 30px;
      height: 30px;
    }

    /* Coach overlay (guide-bobler) */
    .coach-overlay {
      position: fixed;
      inset: 0;
      z-index: 500;
      display: none;
      pointer-events: auto;
    }
    .coach-highlight {
      position: fixed;
      border-radius: 16px;
      border: 2px solid #4caf50;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
      transition: all 0.25s ease;
      pointer-events: none;
    }
    .coach-tooltip {
      position: fixed;
      max-width: 320px;
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px 12px 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      color: #2d5f4d;
      font-size: 14px;
      line-height: 1.4;
    }
    .coach-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .coach-text {
      margin: 0;
    }
    .coach-step-label {
      margin-top: 6px;
      font-size: 12px;
      color: #5a7a6d;
    }
    .coach-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .coach-btn {
      border: none;
      border-radius: 9999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, color 0.2s;
    }
    .coach-btn.coach-skip {
      background: transparent;
      color: #5a7a6d;
    }
    .coach-btn.coach-prev {
      background: #f0f0f0;
      color: #2d5f4d;
    }
    .coach-btn.coach-next {
      background: #4caf50;
      color: #ffffff;
    }
    .coach-btn.coach-next:hover { background: #45a049; }

    /* Responsive */
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .page-title { font-size: 28px; }
      .item-controls { flex-direction: column; align-items: flex-start; width: 100%; }
      .price-input { width: 100%; }
      .footer { flex-direction: column; align-items: stretch; }
      .footer-actions { width: 100%; }
      .footer-btn { flex: 1; }
      .fab { bottom: 140px; right: 16px; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-button" id="backBtn" aria-label="G√• tilbake"> ‚Üê Tilbake </button>
      <h1 class="page-title" id="pageTitle">Handleliste</h1>
      <p class="page-subtitle" id="pageSubtitle">Planlegg ukens innkj√∏p og kryss av etter hvert ‚úÖ</p>

      <div class="header-actions">
        <button class="inbox-button" id="inboxBtn" style="display:none;">
          üì® Fra middagsplan (<span id="inboxCount">0</span>)
        </button>
        <button class="mode-toggle" id="modeToggleBtn">Start butikk-modus üõí</button>
      </div>
    </header>

    <div class="budget-card">
      <div class="budget-item">
        <span class="budget-label" id="budgetLabel">Ukas budsjett</span>
        <span class="budget-amount" id="budgetAmount">3 000 kr</span>
      </div>
      <div class="budget-item">
        <span class="budget-label" id="spentLabel">Brukt s√• langt</span>
        <span class="budget-amount" id="spentAmount">0 kr</span>
      </div>
      <div class="budget-item">
        <span class="budget-label" id="estimatedLabel">Estimert sum i liste</span>
        <span class="budget-amount" id="estimatedSum">0 kr</span>
      </div>
      <div class="budget-item">
        <span class="budget-label" id="remainingLabel">Gjenst√•r etter handlelista</span>
        <span class="budget-amount" id="remainingAfter">0 kr</span>
      </div>
    </div>

    <p id="budgetWarning" class="budget-warning" style="display:none;"></p>

    <div id="categoriesContainer"></div>
    <div id="purchasedContainer"></div>
  </div>

  <button class="fab" id="fabBtn" aria-label="Legg til ny vare">+</button>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <h2 class="modal-title" id="modalTitle">Legg til vare</h2>
      <form id="addItemForm">
        <div class="form-group">
          <label for="itemName" class="form-label">Varenavn</label>
          <input type="text" id="itemName" class="form-input" required placeholder="F.eks. Melk 1L">
        </div>
        <div class="form-group">
          <label for="itemCategory" class="form-label">Kategori</label>
          <select id="itemCategory" class="form-select">
            <option value="Matvarer">Matvarer</option>
            <option value="Snacks/drikke">Snacks/drikke</option>
            <option value="Husholdning">Husholdning</option>
            <option value="Annet">Annet</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Antall</label>
          <div class="stepper">
            <button type="button" class="stepper-btn" id="modalDecrement" aria-label="Reduser antall">‚àí</button>
            <span class="stepper-value" id="modalQuantity">1</span>
            <button type="button" class="stepper-btn" id="modalIncrement" aria-label="√òk antall">+</button>
          </div>
        </div>
        <div class="form-group">
          <label for="itemPrice" class="form-label">Estimert pris (kr)</label>
          <input type="number" id="itemPrice" class="form-input" min="0" step="1" placeholder="0">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Avbryt</button>
          <button type="submit" class="btn btn-primary">Legg til</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-total" id="footerTotal">Totalt i handlelista: 0 kr</div>
    <div class="footer-actions">
      <button class="footer-btn mark-all" id="markAllBtn">Merk alle som kj√∏pt</button>
      <button class="footer-btn clear" id="clearBtn">T√∏m kj√∏pte</button>
      <button class="footer-btn done" id="doneBtn" style="display:none;">Ferdig ‚Äì registrer kj√∏p</button>
    </div>
  </footer>

  <!-- Coach overlay root (guide-bobler) -->
  <div class="coach-overlay" id="coachOverlay">
    <div class="coach-highlight" id="coachHighlight"></div>
    <div class="coach-tooltip" id="coachTooltip">
      <div class="coach-title" id="coachTitle"></div>
      <p class="coach-text" id="coachText"></p>
      <div class="coach-step-label" id="coachStepLabel"></div>
      <div class="coach-buttons">
        <button type="button" class="coach-btn coach-skip" id="coachSkipBtn">Hopp over</button>
        <button type="button" class="coach-btn coach-prev" id="coachPrevBtn">Tilbake</button>
        <button type="button" class="coach-btn coach-next" id="coachNextBtn">Neste</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Konfig ----------
  const defaultConfig = {
    page_title: "Handleliste",
    page_subtitle: "Planlegg ukens innkj√∏p og kryss av etter hvert ‚úÖ",
    budget_label: "Ukas budsjett",
    estimated_label: "Estimert sum i liste",
    total_label: "Totalt i handlelista",
    mark_all_button: "Merk alle som kj√∏pt",
    clear_button: "T√∏m kj√∏pte",
    background_color: "#f8fffe",
    primary_color: "#4caf50",
    text_color: "#2d5f4d",
    secondary_text_color: "#5a7a6d",
    surface_color: "#ffffff",
    font_family: "Inter",
    font_size: 16
  };
  let currentConfig = { ...defaultConfig };

  const COACH_SEEN_KEY = 'shoppingList_coach_seen_v1';

  // ---------- Utils ----------
  const fmt = (n) => (Number(n)||0).toLocaleString('no-NO');

  function mondayISO12(d = new Date()){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (x.getDay()+6)%7; // 0=man
    x.setDate(x.getDate()-day);
    x.setHours(12,0,0,0); // 12:00 for DST
    return x.toISOString().slice(0,10);
  }
  function getActiveWeekISO(){
    return localStorage.getItem('activeWeekISO') || mondayISO12();
  }

  const get = (k, fb) => { try { return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(fb)); } catch { return fb; } };
  const set = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

  // ---------- N√∏kler ----------
  const WEEK_ISO = getActiveWeekISO();
  const WEEK_LIST_KEY = `shoppingList_${WEEK_ISO}`;
  const INBOX_KEY = `shoppingList_inbox_${WEEK_ISO}`;

  // ---------- Budsjettoppslag ----------
  function parseMoneyStr(s){
    if (s == null) return NaN;
    const n = String(s).replace(/\s|kr/g,'').replace(',','.');
    const v = parseFloat(n);
    return isNaN(v) ? NaN : v;
  }
  function readWeeklyBudgetFor(isoMonday){
    const byWeekRaw = localStorage.getItem(`weeklyBudget_${isoMonday}`);
    const byWeek = parseMoneyStr(byWeekRaw);
    if (!isNaN(byWeek) && byWeek > 0) return byWeek;

    const globalRaw = localStorage.getItem('weeklyBudget');
    const global = parseMoneyStr(globalRaw);
    if (!isNaN(global) && global > 0) return global;

    return 3000;
  }
  function sumPurchasesLocal(isoMonday) {
    const key = `purchases_${isoMonday}`;
    try {
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      return Array.isArray(arr)
        ? arr.reduce((acc, p) => acc + (Number(p.amount) || 0), 0)
        : 0;
    } catch {
      return 0;
    }
  }

  function getInboxItems() {
    try {
      const arr = JSON.parse(localStorage.getItem(INBOX_KEY) || '[]');
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  // ---------- Default data ----------
const defaultCategories = [
  { name: "Matvarer",       open: true,  items: [] },
  { name: "Snacks/drikke",  open: false, items: [] },
  { name: "Husholdning",    open: false, items: [] },
  { name: "Annet",          open: false, items: [] }
];
  // ---------- State ----------
  let categories = get(WEEK_LIST_KEY, defaultCategories);
  let modalQuantity = 1;
  let spentSoFar = 0;
  let isStoreMode = false;

  // coach state
  let coachCurrentStep = 0;
  let coachActive = false;
  let prevBodyOverflow = '';
  const coachOverlay = document.getElementById('coachOverlay');
  const coachHighlight = document.getElementById('coachHighlight');
  const coachTooltip = document.getElementById('coachTooltip');
  const coachTitleEl = document.getElementById('coachTitle');
  const coachTextEl = document.getElementById('coachText');
  const coachStepLabelEl = document.getElementById('coachStepLabel');
  const coachSkipBtn = document.getElementById('coachSkipBtn');
  const coachPrevBtn = document.getElementById('coachPrevBtn');
  const coachNextBtn = document.getElementById('coachNextBtn');

  // ---------- DOM helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);


  const modalPriceInput = document.getElementById('itemPrice');
if (modalPriceInput) {
  modalPriceInput.addEventListener('focus', (e) => {
    // Hvis det st√•r 0 eller er tomt ‚Üí gj√∏r feltet klart for skriving
    if (!e.target.value || e.target.value === '0') {
      e.target.value = '';
    }
  });
}

  // ---------- Init statiske tekster + budsjett ----------
  $('#pageTitle').textContent = defaultConfig.page_title;
  $('#pageSubtitle').textContent = defaultConfig.page_subtitle;
  $('#budgetLabel').textContent = defaultConfig.budget_label;
  $('#estimatedLabel').textContent = defaultConfig.estimated_label;
  $('#markAllBtn').textContent = defaultConfig.mark_all_button;
  $('#clearBtn').textContent = defaultConfig.clear_button;

  const weeklyBudget = readWeeklyBudgetFor(WEEK_ISO);
  $('#budgetAmount').textContent = `${fmt(weeklyBudget)} kr`;
  spentSoFar = sumPurchasesLocal(WEEK_ISO);
  $('#spentAmount').textContent = `${fmt(spentSoFar)} kr`;

  // ---------- Item card ----------
  function createItemCard(item, categoryIndex, itemIndex) {
    const card = document.createElement('div');
    card.className = `item-card ${item.checked ? 'checked' : ''}`;
    card.dataset.categoryIndex = categoryIndex;
    card.dataset.itemIndex = itemIndex;

    let touchStartX = null;
    card.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
      }
    });
    card.addEventListener('touchend', (e) => {
      if (touchStartX === null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (dx < -60) {
        deleteItem(categoryIndex, itemIndex);
      }
      touchStartX = null;
    });

    card.addEventListener('click', (e) => {
      if (e.target.closest('.item-checkbox') ||
          e.target.closest('.stepper') ||
          e.target.closest('.price-input') ||
          e.target.closest('.item-menu-btn')) {
        return;
      }
      toggleItemChecked(categoryIndex, itemIndex);
    });

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'item-checkbox';
    checkbox.checked = item.checked;
    checkbox.setAttribute('aria-label', `Merk ${item.name} som kj√∏pt`);
    checkbox.addEventListener('change', () => { toggleItemChecked(categoryIndex, itemIndex); });

    const details = document.createElement('div');
    details.className = 'item-details';

    const nameEl = document.createElement('div');
    nameEl.className = 'item-name';
    nameEl.textContent = item.name;

    const controls = document.createElement('div');
    controls.className = 'item-controls';

    const stepper = document.createElement('div');
    stepper.className = 'stepper';
    stepper.innerHTML = `
      <button class="stepper-btn" aria-label="Reduser antall">‚àí</button>
      <span class="stepper-value">${item.quantity}</span>
      <button class="stepper-btn" aria-label="√òk antall">+</button>
    `;
    stepper.children[0].addEventListener('click', (ev) => { ev.stopPropagation(); updateQuantity(categoryIndex, itemIndex, -1); });
    stepper.children[2].addEventListener('click', (ev) => { ev.stopPropagation(); updateQuantity(categoryIndex, itemIndex, 1); });

    const price = document.createElement('input');
    price.type = 'number';
    price.className = 'price-input';
    price.value = item.price;
    price.min = '0';
    price.step = '1';
    price.setAttribute('aria-label', `Pris for ${item.name}`);
    price.addEventListener('click', (ev) => ev.stopPropagation());
    price.addEventListener('input', (e) => updatePrice(categoryIndex, itemIndex, e.target.value));

    price.addEventListener('focus', (e) => {
  // Hvis prisen er 0 ‚Üí marker hele tallet, s√• det erstattes direkte
  if (e.target.value === '0') {
    e.target.select();
  }
});

    const total = document.createElement('div');
    total.className = 'item-total';
    total.textContent = `${fmt(item.quantity * item.price)} kr`;

    const menuBtn = document.createElement('button');
    menuBtn.className = 'item-menu-btn';
    menuBtn.textContent = '‚Ä¢‚Ä¢‚Ä¢';
    menuBtn.setAttribute('aria-label', '√Öpne meny');
    menuBtn.setAttribute('aria-haspopup', 'true');

    const menu = document.createElement('div');
    menu.className = 'item-menu';
    menu.innerHTML = `
      <button class="menu-item">Rediger</button>
      <button class="menu-item">Flytt til...</button>
      <button class="menu-item delete">Slett</button>
    `;
    menu.children[0].addEventListener('click', () => { closeAllMenus(); });
    menu.children[1].addEventListener('click', () => { closeAllMenus(); });
    menu.children[2].addEventListener('click', () => { deleteItem(categoryIndex, itemIndex); closeAllMenus(); });

    menuBtn.appendChild(menu);
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      closeAllMenus();
      menu.classList.toggle('open');
    });

    controls.appendChild(stepper);
    controls.appendChild(price);
    controls.appendChild(total);

    details.appendChild(nameEl);
    details.appendChild(controls);

    card.appendChild(checkbox);
    card.appendChild(details);
    card.appendChild(menuBtn);

    return card;
  }

  // ---------- Rendering ----------
  function renderCategories() {
    const container = $('#categoriesContainer');
    const purchasedContainer = $('#purchasedContainer');
    container.innerHTML = '';
    if (purchasedContainer) purchasedContainer.innerHTML = '';

    const purchasedItems = [];

    categories.forEach((category, categoryIndex) => {
      const card = document.createElement('div');
      card.className = `category-card ${category.open ? 'open' : ''}`;
      card.dataset.categoryIndex = categoryIndex;

      const header = document.createElement('div');
      header.className = 'category-header';
      header.setAttribute('role', 'button');
      header.setAttribute('tabindex', '0');
      header.setAttribute('aria-expanded', String(category.open));
      header.innerHTML = `
        <div class="category-title">
          ${category.name}
          <span class="category-count">(${category.items.length})</span>
        </div>
        <span class="category-chevron">‚ñº</span>
      `;
      header.addEventListener('click', () => toggleCategory(categoryIndex));
      header.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCategory(categoryIndex); }
      });

      const content = document.createElement('div');
      content.className = 'category-content';

      const list = document.createElement('div');
      list.className = 'category-items';

      category.items.forEach((item, itemIndex) => {
        if (item.checked) {
          purchasedItems.push({ item, categoryIndex, itemIndex, categoryName: category.name });
        }
        if (!isStoreMode || !item.checked) {
          list.appendChild(createItemCard(item, categoryIndex, itemIndex));
        }
      });

      content.appendChild(list);
      card.appendChild(header);
      card.appendChild(content);

      if (!isStoreMode || category.items.length > 0) {
        container.appendChild(card);
      }
    });

    if (isStoreMode && purchasedItems.length > 0 && purchasedContainer) {
      const pCard = document.createElement('div');
      pCard.className = 'category-card purchased-section open';

      const pHeader = document.createElement('div');
      pHeader.className = 'category-header';
      pHeader.innerHTML = `
        <div class="category-title">
          Kj√∏pt denne turen
          <span class="category-count">(${purchasedItems.length})</span>
        </div>
        <span class="category-chevron">‚ñº</span>
      `;

      const pContent = document.createElement('div');
      pContent.className = 'category-content';
      pContent.style.maxHeight = '2000px';
      pContent.style.opacity = '1';

      const pList = document.createElement('div');
      pList.className = 'category-items';

      purchasedItems.forEach(p => {
        pList.appendChild(createItemCard(p.item, p.categoryIndex, p.itemIndex));
      });

      pContent.appendChild(pList);
      pCard.appendChild(pHeader);
      pCard.appendChild(pContent);
      purchasedContainer.appendChild(pCard);
    }

    updateTotals(false);
  }

  // ---------- Mutators ----------
  function persist() { set(WEEK_LIST_KEY, categories); }

  function toggleCategory(index) {
    categories[index].open = !categories[index].open;
    const card = document.querySelector(`.category-card[data-category-index="${index}"]`);
    if (card) {
      card.classList.toggle('open');
      card.querySelector('.category-header')?.setAttribute('aria-expanded', String(categories[index].open));
    }
    persist();
  }

  function toggleItemChecked(ci, ii) {
    const it = categories[ci].items[ii];
    it.checked = !it.checked;

    persist();
    renderCategories();
  }

  function updateQuantity(ci, ii, delta) {
    const it = categories[ci].items[ii];
    it.quantity = Math.max(1, it.quantity + delta);
    persist();
    renderCategories();
  }

  function updatePrice(ci, ii, value) {
    const it = categories[ci].items[ii];
    it.price = parseFloat(value) || 0;
    persist();
    renderCategories();
  }

  function deleteItem(ci, ii) {
    categories[ci].items.splice(ii, 1);
    persist();
    renderCategories();
  }

  // ---------- Totals + budsjett-hint ----------
  function updateTotals(pulse = true) {
    let total = 0;
    categories.forEach(c => c.items.forEach(i => {
      total += i.quantity * i.price;
    }));

    const estimatedSum = $('#estimatedSum');
    const footerTotal = $('#footerTotal');
    const remainingAfterEl = $('#remainingAfter');
    const warningEl = $('#budgetWarning');

    if (estimatedSum) {
      estimatedSum.textContent = `${fmt(total)} kr`;
      if (pulse) {
        estimatedSum.classList.add('pulse');
        setTimeout(()=>estimatedSum.classList.remove('pulse'), 400);
      }
    }

    if (footerTotal) {
      const label = currentConfig.total_label || defaultConfig.total_label;
      footerTotal.textContent = `${label}: ${fmt(total)} kr`;
    }

    const remainingBefore = weeklyBudget - spentSoFar;
    const remainingAfter = remainingBefore - total;

    if (remainingAfterEl) {
      remainingAfterEl.textContent = `${fmt(remainingAfter)} kr`;
      if (pulse) {
        remainingAfterEl.classList.add('pulse');
        setTimeout(()=>remainingAfterEl.classList.remove('pulse'), 400);
      }
    }

    if (!warningEl) return;

    warningEl.classList.remove('ok', 'warn', 'over');

    if (remainingBefore <= 0 && total > 0) {
      warningEl.style.display = 'block';
      warningEl.classList.add('over');
      warningEl.textContent =
        `Du er allerede over ukesbudsjettet med ${fmt(Math.abs(remainingBefore))} kr f√∏r denne handlelista. ` +
        `Vurder √• kutte ned p√• enkelte varer.`;
    } else if (remainingAfter < 0) {
      warningEl.style.display = 'block';
      warningEl.classList.add('over');
      warningEl.textContent =
        `üí° Lista di vil ta dere ${fmt(Math.abs(remainingAfter))} kr over det som er igjen av ukesbudsjettet. ` +
        `Se om du kan fjerne eller bytte ut noen varer.`;
    } else if (remainingAfter <= remainingBefore * 0.1 && total > 0) {
      warningEl.style.display = 'block';
      warningEl.classList.add('warn');
      warningEl.textContent =
        `Du vil sitte igjen med ${fmt(remainingAfter)} kr etter denne handelen. ` +
        `Det kan v√¶re lurt √• v√¶re ekstra bevisst p√• snacks/drikke og impulskj√∏p.`;
    } else if (total > 0) {
      warningEl.style.display = 'block';
      warningEl.classList.add('ok');
      warningEl.textContent =
        `Bra! Etter denne handlelista vil dere fortsatt ha ${fmt(remainingAfter)} kr igjen av ukesbudsjettet.`;
    } else {
      warningEl.style.display = 'none';
      warningEl.textContent = '';
    }
  }

  // ---------- Meny lukking ----------
  function closeAllMenus() { document.querySelectorAll('.item-menu').forEach(m => m.classList.remove('open')); }
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.item-menu-btn')) closeAllMenus();
  });

  // ---------- FAB / Modal ----------
  $('#fabBtn').addEventListener('click', () => {
    $('#modalOverlay').classList.add('open');
    $('#itemName').focus();
  });
  $('#modalOverlay').addEventListener('click', (e) => {
    if (e.target === $('#modalOverlay')) closeModal();
  });
  $('#cancelBtn').addEventListener('click', closeModal);
  function closeModal() {
    $('#modalOverlay').classList.remove('open');
    $('#addItemForm').reset();
    modalQuantity = 1;
    $('#modalQuantity').textContent = '1';
  }
  $('#modalDecrement').addEventListener('click', () => {
    modalQuantity = Math.max(1, modalQuantity-1);
    $('#modalQuantity').textContent = modalQuantity;
  });
  $('#modalIncrement').addEventListener('click', () => {
    modalQuantity += 1;
    $('#modalQuantity').textContent = modalQuantity;
  });

  $('#addItemForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = $('#itemName').value.trim();
    const categoryName = $('#itemCategory').value;
    const price = parseFloat($('#itemPrice').value) || 0;
    if (!name) return;

    const idx = categories.findIndex(c => c.name === categoryName);
    if (idx === -1) return;

    categories[idx].items.push({ name, quantity: modalQuantity, price, checked: false });
    persist();
    renderCategories();
    closeModal();
  });

  // ---------- ‚ÄúMerk alle som kj√∏pt‚Äù ----------
  $('#markAllBtn').addEventListener('click', () => {
    categories.forEach((cat) => {
      cat.items.forEach((it) => {
        it.checked = true;
      });
    });
    persist();
    renderCategories();
  });

  // ---------- T√∏m kj√∏pte ----------
  $('#clearBtn').addEventListener('click', () => {
    categories.forEach(c => {
      c.items = c.items.filter(i => !i.checked);
    });
    persist();
    renderCategories();
  });

  // ---------- Ferdig ‚Äì registrer kj√∏p ----------
  $('#doneBtn').addEventListener('click', () => {
    let totalChecked = 0;
    categories.forEach(c => c.items.forEach(i => {
      if (i.checked) totalChecked += i.quantity * i.price;
    }));
    if (totalChecked <= 0) {
      alert('Kryss av minst √©n vare f√∏r du registrerer kj√∏pet.');
      return;
    }
    set(`shoppingRun_total_${WEEK_ISO}`, {
      total: totalChecked,
      weekISO: WEEK_ISO,
      ts: Date.now()
    });
    window.location.href = `add-purchase.html?from=shopping&week=${encodeURIComponent(WEEK_ISO)}`;
  });

  // ---------- Tilbake-knapp ----------
  $('#backBtn').addEventListener('click', () => {
    const ref = document.referrer || '';
    const cameFromApp = /(^|\/)app\.html(\?|#|$)/.test(ref);
    if (cameFromApp) { history.back(); } else { location.href = 'app.html'; }
  });

  // ---------- Canva element SDK (styling) ----------
  async function onConfigChange(config) {
    currentConfig = { ...currentConfig, ...config };

    const customFont = currentConfig.font_family || defaultConfig.font_family;
    const baseSize = currentConfig.font_size || defaultConfig.font_size;
    const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

    document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
    document.body.style.background = `linear-gradient(135deg, ${currentConfig.background_color || defaultConfig.background_color} 0%, #f0f9f4 100%)`;

    const pageTitle = $('#pageTitle');
    if (pageTitle) {
      pageTitle.textContent = currentConfig.page_title || defaultConfig.page_title;
      pageTitle.style.fontSize = `${baseSize * 2}px`;
      pageTitle.style.color = currentConfig.text_color || defaultConfig.text_color;
    }

    const pageSubtitle = $('#pageSubtitle');
    if (pageSubtitle) {
      pageSubtitle.textContent = currentConfig.page_subtitle || defaultConfig.page_subtitle;
      pageSubtitle.style.fontSize = `${baseSize}px`;
      pageSubtitle.style.color = currentConfig.secondary_text_color || defaultConfig.secondary_text_color;
    }

    $('#budgetLabel').textContent = currentConfig.budget_label || defaultConfig.budget_label;
    $('#estimatedLabel').textContent = currentConfig.estimated_label || defaultConfig.estimated_label;
    $('#markAllBtn').textContent = currentConfig.mark_all_button || defaultConfig.mark_all_button;
    $('#clearBtn').textContent = currentConfig.clear_button || defaultConfig.clear_button;

    const footerTotal = $('#footerTotal');
    if (footerTotal) {
      const totalNumber = footerTotal.textContent.replace(/[^\d,.-]/g,'').replace(',','.');
      footerTotal.textContent = `${currentConfig.total_label || defaultConfig.total_label}: ${fmt(parseFloat(totalNumber)||0)} kr`;
    }

    $$('.btn-primary, .fab, .stepper-btn').forEach(el => {
      el.style.background = currentConfig.primary_color || defaultConfig.primary_color;
    });
    $$('.budget-card, .category-card, .modal').forEach(el => {
      el.style.background = currentConfig.surface_color || defaultConfig.surface_color;
    });
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
          { get: () => config.surface_color || defaultConfig.surface_color, set: v => window.elementSdk.setConfig({ surface_color: v }) },
          { get: () => config.text_color || defaultConfig.text_color, set: v => window.elementSdk.setConfig({ text_color: v }) },
          { get: () => config.primary_color || defaultConfig.primary_color, set: v => window.elementSdk.setConfig({ primary_color: v }) },
          { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
        ],
        borderables: [],
        fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: v => window.elementSdk.setConfig({ font_family: v }) },
        fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: v => window.elementSdk.setConfig({ font_size: v }) },
      }),
      mapToEditPanelValues: (config) => new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
        ["budget_label", config.budget_label || defaultConfig.budget_label],
        ["estimated_label", config.estimated_label || defaultConfig.estimated_label],
        ["total_label", config.total_label || defaultConfig.total_label],
        ["mark_all_button", config.mark_all_button || defaultConfig.mark_all_button],
        ["clear_button", config.clear_button || defaultConfig.clear_button],
      ])
    });
  }

  // ---------- Inbox merge (fra middag.html) ----------
  function showToast(text) {
    const t = document.createElement('div');
    t.textContent = text;
    t.style.position = 'fixed';
    t.style.top = '12px';
    t.style.left = '50%';
    t.style.transform = 'translateX(-50%)';
    t.style.background = '#4caf50';
    t.style.color = '#fff';
    t.style.padding = '10px 14px';
    t.style.borderRadius = '12px';
    t.style.boxShadow = '0 4px 12px rgba(0,0,0,.12)';
    t.style.zIndex = '1000';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  function mergeInboxItems() {
    let inbox = [];
    try { inbox = JSON.parse(localStorage.getItem(INBOX_KEY)) || []; } catch {}

    if (!Array.isArray(inbox) || inbox.length === 0) return 0;

    let matIdx = categories.findIndex(c => c.name === 'Matvarer');
    if (matIdx === -1) {
      categories.push({ name: 'Matvarer', open: true, items: [] });
      matIdx = categories.length - 1;
    }

    const existing = new Set(
      categories.flatMap(c => c.items).map(i => String(i.name).trim().toLowerCase())
    );

    let added = 0;
    inbox.forEach(name => {
      const clean = String(name || '').trim();
      if (!clean) return;
      const key = clean.toLowerCase();
      if (existing.has(key)) return;
      categories[matIdx].items.push({
        name: clean,
        quantity: 1,
        price: 0,
        checked: false
      });
      existing.add(key);
      added++;
    });

    try { localStorage.setItem(INBOX_KEY, JSON.stringify([])); } catch {}

    if (added > 0) categories[matIdx].open = true;

    persist();
    return added;
  }

  function initInbox() {
    const inboxBtn = $('#inboxBtn');
    const inboxCountSpan = $('#inboxCount');
    const items = getInboxItems();
    const params = new URLSearchParams(location.search);
    const addedFrom = params.get('added') || 'oppskrift';

    if (!inboxBtn || !inboxCountSpan) return;
    if (items.length === 0) {
      inboxBtn.style.display = 'none';
      return;
    }

    inboxBtn.style.display = 'inline-flex';
    inboxCountSpan.textContent = items.length;

    inboxBtn.addEventListener('click', () => {
      const confirmed = confirm(`Legg til ${items.length} varer fra ${addedFrom}?`);
      if (!confirmed) return;

      const mergedCount = mergeInboxItems();
      renderCategories();
      if (mergedCount > 0) {
        showToast(`La til ${mergedCount} varer fra ‚Äú${addedFrom}‚Äù`);
        const matCard = Array.from(document.querySelectorAll('.category-card'))
          .find(card => card.querySelector('.category-title')?.textContent?.includes('Matvarer'));
        if (matCard) matCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        inboxBtn.style.display = 'none';
      }
    });
  }

  // ---------- Butikk-modus ----------
  const modeToggleBtn = $('#modeToggleBtn');
  const doneBtn = $('#doneBtn');

  if (modeToggleBtn) {
    modeToggleBtn.addEventListener('click', () => {
      isStoreMode = !isStoreMode;
      document.body.classList.toggle('store-mode', isStoreMode);
      if (isStoreMode) {
        modeToggleBtn.textContent = 'Avslutt butikk-modus';
        modeToggleBtn.classList.add('active');
        if (doneBtn) doneBtn.style.display = 'inline-flex';
      } else {
        modeToggleBtn.textContent = 'Start butikk-modus üõí';
        modeToggleBtn.classList.remove('active');
        if (doneBtn) doneBtn.style.display = 'none';
      }
      renderCategories();
    });
  }

  // ---------- Coach steps (guide-bobler) ----------
  const coachSteps = [
    {
      id: 'addItem',
      selector: '#fabBtn',
      title: 'Legg til ny vare',
      text: 'Trykk p√• denne gr√∏nne knappen n√•r dere kommer p√• noe nytt dere trenger √• kj√∏pe.',
      ensure: () => {
        // Vi vil v√¶re i planleggingsmodus
        if (isStoreMode) {
          isStoreMode = false;
          document.body.classList.remove('store-mode');
          if (modeToggleBtn) {
            modeToggleBtn.textContent = 'Start butikk-modus üõí';
            modeToggleBtn.classList.remove('active');
          }
          if (doneBtn) doneBtn.style.display = 'none';
          renderCategories();
        }
        window.scrollTo({ top: 0, behavior: 'auto' });
      }
    },
    {
      id: 'storeMode',
      selector: '#modeToggleBtn',
      title: 'Start butikk-modus',
      text: 'N√•r dere er i butikken, trykker dere her for √• gj√∏re det enklere √• krysse av varene etter hvert som dere finner dem.',
      ensure: () => {
        if (isStoreMode) {
          isStoreMode = false;
          document.body.classList.remove('store-mode');
          if (modeToggleBtn) {
            modeToggleBtn.textContent = 'Start butikk-modus üõí';
            modeToggleBtn.classList.remove('active');
          }
          if (doneBtn) doneBtn.style.display = 'none';
          renderCategories();
        }
      }
    },
    {
      id: 'finish',
      selector: '#doneBtn',
      title: 'Ferdig med handlingen',
      text: 'N√•r dere er ferdige i butikken og har krysset av det dere har kj√∏pt, trykker dere her for √• registrere kj√∏pet og oppdatere budsjettet.',
      ensure: () => {
        // S√∏rg for at butikk-modus er p√•, slik at knappen vises
        if (!isStoreMode) {
          isStoreMode = true;
          document.body.classList.add('store-mode');
          if (modeToggleBtn) {
            modeToggleBtn.textContent = 'Avslutt butikk-modus';
            modeToggleBtn.classList.add('active');
          }
          if (doneBtn) doneBtn.style.display = 'inline-flex';
          renderCategories();
        }
      }
    }
  ];

  function positionCoachForElement(el) {
    if (!el || !coachHighlight || !coachTooltip) return;

    const rect = el.getBoundingClientRect();
    const padding = 8;

    const left = rect.left - padding;
    const top = rect.top - padding;
    const width = rect.width + padding * 2;
    const height = rect.height + padding * 2;

    coachHighlight.style.left = `${left}px`;
    coachHighlight.style.top = `${top}px`;
    coachHighlight.style.width = `${width}px`;
    coachHighlight.style.height = `${height}px`;

    coachTooltip.style.left = '50%';
    coachTooltip.style.transform = 'translateX(-50%)';

    // Vi m√• vite h√∏yden p√• tooltip for √• plassere den over/under feltet
    requestAnimationFrame(() => {
      const ttRect = coachTooltip.getBoundingClientRect();
      const viewportH = window.innerHeight || document.documentElement.clientHeight;
      const placeAbove = rect.top > viewportH / 2;

      let ttTop;
      if (placeAbove) {
        ttTop = Math.max(16, rect.top - ttRect.height - 16);
      } else {
        ttTop = Math.min(viewportH - ttRect.height - 16, rect.bottom + 16);
      }
      coachTooltip.style.top = `${ttTop}px`;
    });
  }

  function goToCoachStep(index) {
    if (!coachOverlay) return;
    if (index < 0 || index >= coachSteps.length) {
      endCoachTour();
      return;
    }
    coachCurrentStep = index;
    const step = coachSteps[coachCurrentStep];

    if (step.ensure) step.ensure();

    const target = document.querySelector(step.selector);
    if (!target) {
      // Hopp videre hvis elementet ikke finnes
      if (coachCurrentStep < coachSteps.length - 1) {
        goToCoachStep(coachCurrentStep + 1);
      } else {
        endCoachTour();
      }
      return;
    }

    coachTitleEl.textContent = step.title;
    coachTextEl.textContent = step.text;
    coachStepLabelEl.textContent = `Steg ${coachCurrentStep + 1} av ${coachSteps.length}`;

    coachPrevBtn.disabled = coachCurrentStep === 0;
    coachNextBtn.textContent = coachCurrentStep === coachSteps.length - 1 ? 'Ferdig' : 'Neste';

    positionCoachForElement(target);
  }

  function startCoachTour() {
    if (!coachOverlay) return;
    coachActive = true;
    coachOverlay.style.display = 'block';
    prevBodyOverflow = document.body.style.overflow || '';
    document.body.style.overflow = 'hidden';
    goToCoachStep(0);
  }

  function endCoachTour() {
    coachActive = false;
    if (coachOverlay) coachOverlay.style.display = 'none';
    document.body.style.overflow = prevBodyOverflow || '';
    try { localStorage.setItem(COACH_SEEN_KEY, '1'); } catch {}
  }

  function shouldStartCoachTour() {
    try {
      return localStorage.getItem(COACH_SEEN_KEY) !== '1';
    } catch {
      return true;
    }
  }

  // coach-knapper
  if (coachSkipBtn) {
    coachSkipBtn.addEventListener('click', () => {
      endCoachTour();
    });
  }
  if (coachPrevBtn) {
    coachPrevBtn.addEventListener('click', () => {
      if (coachCurrentStep > 0) {
        goToCoachStep(coachCurrentStep - 1);
      }
    });
  }
  if (coachNextBtn) {
    coachNextBtn.addEventListener('click', () => {
      if (coachCurrentStep < coachSteps.length - 1) {
        goToCoachStep(coachCurrentStep + 1);
      } else {
        endCoachTour();
      }
    });
  }

  window.addEventListener('resize', () => {
    if (!coachActive) return;
    const step = coachSteps[coachCurrentStep];
    if (!step) return;
    const target = document.querySelector(step.selector);
    if (target) {
      positionCoachForElement(target);
    }
  });

  // ---------- F√∏rste render ----------
  renderCategories();
  initInbox();

  if (shouldStartCoachTour()) {
    setTimeout(() => {
      startCoachTour();
    }, 600);
  }
</script>
</body>
</html>
