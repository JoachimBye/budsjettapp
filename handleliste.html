<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planlegg uka</title>

  <!-- Canva / Element SDK -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- (valgfritt) Tailwind, men vi bruker mest egen CSS -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>
  <script src="/auth-helpers.js"></script>
  <script src="/js/ui/toast.js"></script>
  <script src="/js/services/household-context.js"></script>
  <script src="/js/services/date-utils.js"></script>
  <script src="/js/services/category-service.js"></script>
  <script src="/js/services/shopping-list-service.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f4 100%);
      color: #2d5f4d;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 20px 110px;
    }

    /* Header */
    .header { margin-bottom: 20px; }
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: #5a7a6d;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 12px;
      transition: background 0.2s;
      font-family: inherit;
    }
    .back-button:hover { background: rgba(76, 175, 80, 0.1); }
    .back-button:focus { outline: 2px solid #4caf50; outline-offset: 2px; }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: #2d5f4d;
      margin: 10px 0 4px;
      text-align: center;
    }
    .page-subtitle {
      font-size: 16px;
      color: #5a7a6d;
      text-align: center;
    }

    .header-actions {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
      justify-content: center;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    .inbox-button {
      border-radius: 9999px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #ffffff;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      color: #2d5f4d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      font-family: inherit;
      width: fit-content;
      align-self: center;
    }
    .mode-toggle {
      border-radius: 14px;
      border: none;
      background: linear-gradient(120deg, #4caf50, #6ac76e);
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease, filter 0.2s ease;
      font-family: inherit;
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.25);
      width: 100%;
    }
    .inbox-button:hover {
      background: rgba(76,175,80,0.06);
      box-shadow: 0 1px 4px rgba(45,95,77,0.12);
    }
    .mode-toggle:hover {
      filter: brightness(1.05);
      box-shadow: 0 16px 36px rgba(76, 175, 80, 0.25);
    }
    .mode-toggle:active {
      transform: translateY(1px);
    }
    .mode-toggle.active {
      background: linear-gradient(120deg, #2f7f3f, #4caf50);
      color: #ffffff;
      box-shadow: 0 10px 26px rgba(47, 127, 63, 0.35);
    }
    .store-mode .mode-toggle {
      display: none;
    }

    /* Seksjoner */
    .section {
      margin-top: 24px;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-subtitle {
      font-size: 14px;
      color: #5a7a6d;
      margin-bottom: 12px;
    }

    .loading-text,
    .error-text {
      text-align: center;
      padding: 20px;
      font-size: 14px;
      color: #5a7a6d;
    }

    .error-text {
      color: #dc2626;
    }

    /* Ukens middager */
    .weekly-menu-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .weekly-row {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 10px 28px rgba(45,95,77,0.14);
      border: 1px solid rgba(76,175,80,0.12);
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      position: relative;
    }
    .weekly-row::after {
      content: "‚Ä∫";
      color: #9e9e9e;
      font-size: 16px;
      margin-left: auto;
    }
    .weekly-row:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(45,95,77,0.18);
      border-color: rgba(76,175,80,0.24);
    }
    .weekly-row:active { transform: translateY(0); }
    .weekly-day-label {
      font-weight: 700;
      color: #2d5f4d;
      flex-shrink: 0;
      min-width: 92px;
    }
    .weekly-dish {
      flex: 1;
      font-size: 14px;
      color: #2d5f4d;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .weekly-dish.empty {
      color: #9e9e9e;
      font-style: normal;
    }

    /* Faste varer */
    .frequent-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .frequent-chip {
      padding: 10px 14px;
      border-radius: 9999px;
      border: none;
      background: #ebeef2;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #2d5f4d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.08s, color 0.2s;
      box-shadow: 0 3px 10px rgba(45,95,77,0.08);
    }
    .frequent-chip:hover {
      background: #e1e5ea;
      box-shadow: 0 6px 16px rgba(45,95,77,0.14);
    }
    .frequent-chip:active {
      transform: scale(0.98);
      background: #4caf50;
      color: #ffffff;
      box-shadow: 0 10px 26px rgba(76,175,80,0.22);
    }
    .frequent-chip.active {
      background: #4caf50;
      color: #ffffff;
      box-shadow: 0 10px 26px rgba(76,175,80,0.22);
    }

    /* Handleliste / kategorier */
    .category-card {
      background: transparent;
      border-radius: 20px;
      margin-bottom: 18px;
      overflow: visible;
      transition: box-shadow 0.2s;
    }
    .category-header {
      padding: 10px 4px 8px 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: background 0.2s;
    }
    .category-card.open .category-header {
      background: transparent;
    }
    .category-title {
      font-size: 16px;
      font-weight: 700;
      color: #2d5f4d;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .category-count {
      font-size: 13px;
      color: #7a8b83;
      font-weight: 500;
    }
    .category-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .category-card.open .category-content {
      max-height: 2000px;
      opacity: 1;
    }
    .category-inner {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 32px rgba(45,95,77,0.12);
      border: 1px solid #e6efe9;
      overflow: hidden;
    }

    /* Item-rader */
    .item-card {
      background: #ffffff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #e5e5ea;
      transition: background-color 0.2s ease, opacity 0.25s ease;
      position: relative;
      cursor: pointer;
      min-height: 60px;
    }
    .category-inner .item-card:last-child {
      border-bottom: none;
    }
    .item-card:hover {
      background: #f9fbfa;
    }
    .item-card.checked {
      background: #f3f7f5;
      opacity: 0.65;
    }
    .item-checkbox {
      accent-color: #4caf50;
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .item-card.checked .item-checkbox {
      transform: scale(1.12);
    }
    .item-details {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-width: 0;
    }
    .item-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    .item-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .item-name {
      position: relative;
      display: inline-block;
      font-size: 15px;
      font-weight: 600;
      color: #2d5f4d;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: color 0.3s ease;
      flex: 1;
      min-width: 0;
      max-width: 100%;
    }
    .item-card.checked .item-name {
      color: #7a8b83;
    }
    .item-card.checked .item-name::after {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 2px;
      background: #7a8b83;
      transform-origin: left;
      animation: strike 0.3s ease-out forwards;
    }
    @keyframes strike {
      from { transform: scaleX(0); }
      to   { transform: scaleX(1); }
    }

    .item-quantity {
      font-weight: 700;
      color: #5a7a6d;
      min-width: 54px;
      text-align: right;
    }

    .store-mode .item-quantity {
      color: #2d5f4d;
    }

    .item-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stepper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f9f9f9;
      border-radius: 14px;
      padding: 4px 8px;
      border: 1px solid #e5e5ea;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .stepper-btn {
      border: none;
      border-radius: 10px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: #ffffff;
      color: #2d5f4d;
      flex-shrink: 0;
      transition: background 0.2s, transform 0.08s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .stepper-btn:hover { background: #f0f0f0; }
    .stepper-btn:active { transform: scale(0.94); }
    .stepper-value {
      min-width: 24px;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: #2d5f4d;
    }

    .item-delete-btn {
      border-radius: 10px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: transparent;
      color: #c7c7cc;
      flex-shrink: 0;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
      border: 1px solid #e6efe9;
    }
    .item-delete-btn:hover {
      background: #f7f9f8;
      color: #d32f2f;
      border-color: #f0dede;
    }

    /* FAB */
    /* Skjul +-knappen ‚Äì vi bruker kategorikortene i stedet */
.fab {
  display: none;
}
    .fab:hover {
      background: #45a049;
      transform: scale(1.05);
    }
    .fab:active { transform: scale(0.94); }

    .store-mode .fab {
      display: none;
    }

    /* I butikk-modus: vis kun handlelista */
.store-mode #weeklySection,
.store-mode #frequentSection {
  display: none;
}

.store-mode .page-subtitle {
  display: none;
}

/* Litt mindre luft i butikk-modus om du vil */
.store-mode .container {
  padding-top: 12px;
}

.store-mode .item-controls,
.store-mode .item-delete-btn,
.store-mode .stepper {
  display: none !important;
}

.store-mode .item-card {
  padding: 14px 16px;
}

.store-mode .item-card.checked {
  opacity: 0.45;
}

    /* Modal felles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #ffffff;
      border-radius: 22px;
      padding: 22px 22px 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 8px 28px rgba(0,0,0,0.35);
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 14px;
    }
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(76,175,80,0.2);
      background: #f8fffe;
      font-family: inherit;
      font-size: 15px;
      color: #2d5f4d;
    }
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76,175,80,0.15);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    .btn {
      flex: 1;
      border-radius: 12px;
      border: none;
      padding: 11px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.08s;
    }
    .btn-primary {
      background: #4caf50;
      color: #ffffff;
    }
    .btn-primary:hover { background: #45a049; }
    .btn-primary:active { transform: scale(0.97); }
    .btn-secondary {
      background: #f0f0f0;
      color: #5a7a6d;
    }
    .btn-secondary:hover { background: #e0e0e0; }

    /* Footer */
    .footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      border-top: 1px solid rgba(76,175,80,0.12);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      box-shadow: 0 -2px 8px rgba(45,95,77,0.12);
      z-index: 25;
      backdrop-filter: blur(6px);
    }
    .footer-total {
      font-size: 15px;
      font-weight: 600;
      color: #2d5f4d;
    }
    .footer-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .footer-btn {
      border-radius: 9999px;
      border: 1px solid transparent;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, transform 0.08s;
    }
    .footer-btn.mark-all {
      background: #4caf50;
      color: #ffffff;
    }
    .footer-btn.mark-all:hover { background: #45a049; }
    .footer-btn.clear {
      background: transparent;
      color: #2d5f4d;
      border-color: #dbe6df;
    }
    .footer-btn.clear:hover { background: #f5f7f6; }
    .footer-btn.exit-store {
      display: none;
      background: #2d5f4d;
      color: #ffffff;
      border-color: #2d5f4d;
    }
    .footer-btn.exit-store:hover { background: #254d3f; }
    .store-mode .footer-btn.exit-store {
      display: inline-flex;
    }

    /* Kj√∏pt-seksjon i butikk-modus */
    .purchased-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #5a7a6d;
      margin: 6px 0;
    }

    .store-mode .category-card .item-card.checked {
      opacity: 0.4;
    }

    @media (max-width: 640px) {
      .container { padding: 16px 16px 110px; }
      .page-title { font-size: 26px; }
      .weekly-row { padding: 12px 14px; }
      .weekly-row::after { margin-left: 12px; }
      .footer { flex-direction: column; align-items: stretch; }
      .footer-actions { justify-content: stretch; }
      .footer-btn { flex: 1; text-align: center; }
      .fab { bottom: 120px; right: 20px; }
    }

    @view-transition { navigation: auto; }
  </style>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" />
  <link rel="stylesheet" href="/css/driver-overrides.css" />
  <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js"></script>
  <script src="/js/ui/tour-manager.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-button" id="backBtn" aria-label="G√• tilbake">‚Üê Tilbake</button>
      <h1 class="page-title" id="pageTitle">Planlegg uka</h1>
      <p class="page-subtitle" id="pageSubtitle">
        Lag ukens middager, legg til faste varer og f√• en enkel handleliste üìù
      </p>

      <div class="header-actions">
        <button class="inbox-button" id="inboxBtn" style="display:none;">
          üì® Fra middagsplan (<span id="inboxCount">0</span>)
        </button>
        <button class="mode-toggle" id="modeToggleBtn">Start butikk-modus üõí</button>
      </div>
    </header>

    <!-- DEL 1: Ukens middager -->
    <section class="section" id="weeklySection">
      <h2 class="section-title">Ukens middager</h2>
      <p class="section-subtitle">
        Trykk p√• en dag og skriv inn hva dere skal ha til middag.
      </p>
      <div class="weekly-menu-list" id="weeklyMenuList"></div>
    </section>

    <!-- DEL 2: Faste varer -->
    <section class="section" id="frequentSection">
      <h2 class="section-title">Faste varer</h2>
      <p class="section-subtitle">
        Her dukker ting opp som dere ofte legger til p√• handlelisten. Trykk for √• legge til.
      </p>
      <div class="frequent-grid" id="frequentGrid"></div>
    </section>

    <!-- DEL 3: Handleliste -->
    <section class="section" id="shoppingSection">
      <h2 class="section-title">Handleliste</h2>
      <p class="section-subtitle" id="shoppingEmptyText">
        Handlelisten er tom akkurat n√•. Legg til det dere trenger f√∏r dere drar p√• butikken üõí
      </p>
      <div id="categoriesContainer"></div>

      <div id="purchasedContainer" style="margin-top:8px;"></div>
    </section>
  </div>

  <!-- Flytende + for √• legge til vare -->
  <button class="fab" id="fabBtn" aria-label="Legg til ny vare">+</button>

  <!-- Modal: Legg til vare -->
  <div class="modal-overlay" id="itemModalOverlay">
    <div class="modal" role="dialog" aria-labelledby="itemModalTitle">
      <h2 class="modal-title" id="itemModalTitle">Legg til vare</h2>
      <form id="addItemForm">
        <div class="form-group">
          <label class="form-label" for="itemNameInput">Varenavn</label>
          <input type="text" id="itemNameInput" class="form-input" placeholder="F.eks. Melk 1L" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="itemCategorySelect">Kategori</label>
          <select id="itemCategorySelect" class="form-select">
            <option value="Matvarer">Matvarer</option>
            <option value="Snacks/drikke">Snacks/drikke</option>
            <option value="Husholdning">Husholdning</option>
            <option value="Annet">Annet</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Antall</label>
          <div class="stepper">
            <button type="button" class="stepper-btn" id="modalDecBtn">‚àí</button>
            <span class="stepper-value" id="modalQty">1</span>
            <button type="button" class="stepper-btn" id="modalIncBtn">+</button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="itemCancelBtn">Avbryt</button>
          <button type="submit" class="btn btn-primary">Legg til</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Middag p√• dag -->
  <div class="modal-overlay" id="menuModalOverlay">
    <div class="modal" role="dialog" aria-labelledby="menuModalTitle">
      <h2 class="modal-title" id="menuModalTitle">Middag</h2>
      <form id="weeklyMenuForm">
        <div class="form-group">
          <label class="form-label" for="menuTextInput">Hva skal dere ha?</label>
          <input type="text" id="menuTextInput" class="form-input" placeholder="F.eks. Laks og poteter">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="menuCancelBtn">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer (antall varer + handlinger) -->
  <footer class="footer">
    <div class="footer-total" id="footerTotal">Antall varer i handlelista: 0</div>
    <div class="footer-actions">
      <button class="footer-btn exit-store" id="exitStoreBtn">Ferdig i butikken</button>
      <button class="footer-btn mark-all" id="markAllBtn">Merk alle som kj√∏pt</button>
      <button class="footer-btn clear" id="clearBtn">T√∏m kj√∏pte</button>
    </div>
  </footer>

<script>
  // ---------- Konfig for Canva / Element ----------
  const defaultConfig = {
    page_title: "Planlegg uka",
    page_subtitle: "Lag ukens middager, legg til faste varer og f√• en enkel handleliste üìù",
    total_label: "Antall varer i handlelista",
    background_color: "#f8fffe",
    primary_color: "#4caf50",
    text_color: "#2d5f4d",
    secondary_text_color: "#5a7a6d",
    surface_color: "#ffffff",
    font_family: "Inter",
    font_size: 16
  };
  let currentConfig = { ...defaultConfig };

  // ---------- Supabase ----------
  const supa = window.supaClient?.getClient();
  const householdCtx = window.householdContext;

  // ---------- Utils ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const fmtInt = (n) => Number(n || 0).toLocaleString("no-NO");
  const dateUtils = window.dateUtils || {};
  const shoppingListService = window.shoppingListService || null;
  const showToast = (message, type = "info") => {
    if (window.toast?.show) {
      window.toast.show(message, { type });
    } else {
      console[type === "error" ? "error" : "log"](message);
    }
  };

  function getLS(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const val = JSON.parse(raw);
      return val ?? fallback;
    } catch {
      return fallback;
    }
  }
  function setLS(key, val) {
    try {
      localStorage.setItem(key, JSON.stringify(val));
    } catch {}
  }

  function createItemId() {
    return `item_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
  }

  function saveShoppingListForWeek(weekISO, items) {
    try {
      localStorage.setItem(`shoppingList_${weekISO}`, JSON.stringify(items));
    } catch (err) {
      console.warn('Klarte ikke √• lagre handleliste', err);
    }
  }

  function migrateLegacyCategories(oldCategories) {
    const migrated = [];
    oldCategories.forEach(cat => {
      if (!cat || typeof cat !== "object") return;
      const targetCategory = resolveCategoryName(cat.name);
      (cat.items || []).forEach(item => {
        const cleanName = String(item?.name || "").trim();
        if (!cleanName) return;
        const qty = Math.max(1, Number(item.quantity) || 1);
        migrated.push({
          id: item.id || createItemId(),
          name: cleanName,
          category: resolveCategoryName(item.category || targetCategory),
          quantity: qty,
          checked: !!item.checked
        });
      });
    });
    return migrated;
  }

  function loadShoppingListForWeek(weekISO) {
    let parsed = null;
    try {
      const raw = localStorage.getItem(`shoppingList_${weekISO}`);
      if (!raw) return [];
      parsed = JSON.parse(raw);
    } catch {
      return [];
    }

    if (!Array.isArray(parsed)) {
      return [];
    }

    const looksLegacy = parsed.some(entry => entry && typeof entry === "object" && Array.isArray(entry.items));
    if (looksLegacy) {
      const migrated = migrateLegacyCategories(parsed);
      saveShoppingListForWeek(weekISO, migrated);
      return migrated;
    }

    let mutated = false;
    const sanitized = parsed
      .map(item => {
        if (!item || typeof item !== "object") return null;
        const cleanName = String(item.name || "").trim();
        if (!cleanName) return null;
        const qty = Math.max(1, Number(item.quantity) || 1);
        const resolvedCategory = resolveCategoryName(item.category);
        const id = item.id || createItemId();
        if (!item.id || resolvedCategory !== item.category || qty !== item.quantity || cleanName !== item.name) {
          mutated = true;
        }
        return {
          id,
          name: cleanName,
          category: resolvedCategory,
          quantity: qty,
          checked: !!item.checked
        };
      })
      .filter(Boolean);

    if (mutated) {
      saveShoppingListForWeek(weekISO, sanitized);
    }

    return sanitized;
  }

  // ---------- N√∏kler ----------
  const ACTIVE_WEEK_ISO = dateUtils.getOrInitActiveWeekISO
    ? dateUtils.getOrInitActiveWeekISO()
    : (dateUtils.mondayISO ? dateUtils.mondayISO() : new Date().toISOString().slice(0, 10));
  const WEEK_MENU_KEY   = `weeklyMenu_${ACTIVE_WEEK_ISO}`;
  const FREQ_KEY        = `frequentItems`;
  const INBOX_KEY       = `shoppingList_inbox_${ACTIVE_WEEK_ISO}`;

  // ---------- State ----------
  const DAYS = [
    { key: "mon", label: "Mandag"  },
    { key: "tue", label: "Tirsdag" },
    { key: "wed", label: "Onsdag"  },
    { key: "thu", label: "Torsdag" },
    { key: "fri", label: "Fredag"  },
    { key: "sat", label: "L√∏rdag"  },
    { key: "sun", label: "S√∏ndag"  }
  ];

  const defaultMenu = {
    mon: "", tue: "", wed: "", thu: "", fri: "", sat: "", sun: ""
  };

  const defaultFrequentItems = [
    { name: "Melk",        category: "Matvarer",      timesUsed: 3 },
    { name: "Br√∏d",        category: "Matvarer",      timesUsed: 3 },
    { name: "Ost",         category: "Matvarer",      timesUsed: 2 },
    { name: "Kaffe",       category: "Snacks/drikke", timesUsed: 2 },
    { name: "Epler",       category: "Matvarer",      timesUsed: 1 },
    { name: "T√∏rkepapir",  category: "Husholdning",   timesUsed: 1 }
  ];

  const categoryService = window.categoryService || null;
  const FALLBACK_CATEGORY_SETTINGS = categoryService?.DEFAULT_CATEGORIES || [
    { name: "ü•ï Mat & dagligvarer", enabled: true },
    { name: "üßΩ Husholdning & rengj√∏ring", enabled: true },
    { name: "üçû Frokost & br√∏d", enabled: true },
    { name: "üçø Snacks & kos", enabled: true },
    { name: "ü•¨ Frukt & gr√∏nt", enabled: true },
    { name: "üì¶ Annet", enabled: false }
  ];
  const LEGACY_CATEGORY_MAP = {
    "matvarer": "ü•ï Mat & dagligvarer",
    "snacks/drikke": "üçø Snacks & kos",
    "snacks og kos": "üçø Snacks & kos",
    "snacks & kos": "üçø Snacks & kos",
    "husholdning": "üßΩ Husholdning & rengj√∏ring",
    "husholdning & rengj√∏ring": "üßΩ Husholdning & rengj√∏ring",
    "annet": "üì¶ Annet"
  };

  let weeklyMenu    = { ...defaultMenu };
  let frequentItems = getLS(FREQ_KEY, defaultFrequentItems);
  let isStoreMode   = false;
  let allCategories = [];
  let visibleCategories = [];
  refreshCategorySettings();
  let shoppingItems = [];

  let modalQty      = 1;
  let currentMenuDayKey = null;
  let currentHouseholdId = null;
  let shoppingRealtimeChannel = null;
  let menuRealtimeChannel = null;
  let isShoppingLoading = true;
  let shoppingLoadError = null;
  let isMenuLoading = true;
  let menuLoadError = null;
  let isShoppingReloadScheduled = false;
  let isMenuReloadScheduled = false;

  async function ensureHouseholdId() {
    if (currentHouseholdId) return currentHouseholdId;
    if (!shoppingListService?.getHouseholdId) return null;
    try {
      currentHouseholdId = await shoppingListService.getHouseholdId(supa);
      return currentHouseholdId;
    } catch (err) {
      console.error("Kunne ikke hente husstand fra Supabase", err);
      showToast("Kunne ikke hente husstand. Last siden p√• nytt.", "error");
      return null;
    }
  }

  function applyShoppingItems(list) {
    if (!Array.isArray(list)) {
      shoppingItems = [];
      saveShoppingItems();
      return;
    }

    shoppingItems = list
      .map((item) => {
        if (!item || typeof item !== "object") return null;
        const cleanName = String(item.name || "").trim();
        if (!cleanName) return null;
        const resolvedCategory = resolveCategoryName(item.category);
        const qty = Math.max(1, Number(item.quantity) || 1);
        return {
          id: item.id || createItemId(),
          name: cleanName,
          category: resolvedCategory,
          quantity: qty,
          checked: item.checked === true,
        };
      })
      .filter(Boolean);

    saveShoppingItems();
  }

  async function loadShoppingItemsData(options = {}) {
    const silent = options.silent === true;
    if (!silent) {
      isShoppingLoading = true;
      shoppingLoadError = null;
      renderCategories();
    }

    try {
      await ensureHouseholdId();
      if (shoppingListService?.loadItemsForWeek) {
        const remote = await shoppingListService.loadItemsForWeek(supa, ACTIVE_WEEK_ISO);
        if (Array.isArray(remote)) {
          applyShoppingItems(remote);
          if (!silent) {
            isShoppingLoading = false;
            renderCategories();
          } else {
            renderCategories();
          }
          return;
        }
      }
      shoppingLoadError = "Fant ingen handleliste i skyen ‚Äì viser lagrede data.";
      applyShoppingItems(loadShoppingListForWeek(ACTIVE_WEEK_ISO));
    } catch (err) {
      console.error("Kunne ikke hente handleliste", err);
      shoppingLoadError = "Kunne ikke hente handleliste ‚Äì viser cache.";
      applyShoppingItems(loadShoppingListForWeek(ACTIVE_WEEK_ISO));
      showToast("Kunne ikke hente handleliste, viser lagrede data.", "error");
    } finally {
      if (!silent) {
        isShoppingLoading = false;
      }
      renderCategories();
    }
  }

  async function loadWeeklyMenuData(options = {}) {
    const silent = options.silent === true;
    if (!silent) {
      isMenuLoading = true;
      menuLoadError = null;
      renderWeeklyMenu();
    }

    try {
      await ensureHouseholdId();
      if (shoppingListService?.loadWeeklyMenu) {
        const remote = await shoppingListService.loadWeeklyMenu(supa, ACTIVE_WEEK_ISO);
        if (remote && typeof remote === "object") {
          weeklyMenu = { ...defaultMenu, ...remote };
          saveMenuLocal();
          if (!silent) {
            isMenuLoading = false;
            renderWeeklyMenu();
          } else {
            renderWeeklyMenu();
          }
          return;
        }
      }
      weeklyMenu = getLS(WEEK_MENU_KEY, defaultMenu);
      menuLoadError = "Fant ingen meny i skyen ‚Äì viser lokale data.";
    } catch (err) {
      console.error("Kunne ikke hente middagsplan", err);
      weeklyMenu = getLS(WEEK_MENU_KEY, defaultMenu);
      menuLoadError = "Kunne ikke hente middagsplan ‚Äì viser cache.";
      showToast("Kunne ikke hente middagsplan, viser lagrede data.", "error");
    } finally {
      if (!silent) {
        isMenuLoading = false;
      }
      renderWeeklyMenu();
    }
  }

  async function saveMenuEntry(dayKey, dishName) {
    const trimmed = String(dishName || "").trim();
    weeklyMenu[dayKey] = trimmed;

    if (shoppingListService?.saveDishForDay) {
      try {
        const updated = await shoppingListService.saveDishForDay(supa, {
          weekISO: ACTIVE_WEEK_ISO,
          dayKey,
          dishName: trimmed,
        });
        if (updated && typeof updated === "object") {
          weeklyMenu = { ...defaultMenu, ...updated };
          saveMenuLocal();
          return;
        }
      } catch (err) {
        console.error("Kunne ikke lagre middagsplan", err);
      }
    }

    saveMenuLocal();
  }

  function scheduleShoppingReload() {
    if (isShoppingReloadScheduled) return;
    isShoppingReloadScheduled = true;
    setTimeout(async () => {
      await loadShoppingItemsData({ silent: true });
      isShoppingReloadScheduled = false;
    }, 200);
  }

  function scheduleMenuReload() {
    if (isMenuReloadScheduled) return;
    isMenuReloadScheduled = true;
    setTimeout(async () => {
      await loadWeeklyMenuData({ silent: true });
      isMenuReloadScheduled = false;
    }, 200);
  }

  function cleanupRealtimeChannels() {
    if (shoppingRealtimeChannel) {
      supa.removeChannel(shoppingRealtimeChannel);
      shoppingRealtimeChannel = null;
    }
    if (menuRealtimeChannel) {
      supa.removeChannel(menuRealtimeChannel);
      menuRealtimeChannel = null;
    }
  }

  async function setupRealtimeChannels() {
    const householdId = await ensureHouseholdId();
    if (!householdId || typeof supa.channel !== "function") return;

    cleanupRealtimeChannels();

    shoppingRealtimeChannel = supa
      .channel(`shopping_list_${householdId}_${ACTIVE_WEEK_ISO}`)
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'shopping_list_items', filter: `household_id=eq.${householdId}` },
        (payload) => {
          const week = (payload.new?.week_start || payload.old?.week_start);
          if (week !== ACTIVE_WEEK_ISO) return;
          scheduleShoppingReload();
        }
      )
      .subscribe();

    menuRealtimeChannel = supa
      .channel(`weekly_menu_${householdId}_${ACTIVE_WEEK_ISO}`)
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'weekly_menu', filter: `household_id=eq.${householdId}` },
        (payload) => {
          const week = (payload.new?.week_start || payload.old?.week_start);
          if (week !== ACTIVE_WEEK_ISO) return;
          scheduleMenuReload();
        }
      )
      .subscribe();
  }

  // ---------- Persist helpers ----------
  function saveMenuLocal()      { setLS(WEEK_MENU_KEY, weeklyMenu); }
  function saveShoppingItems(){ saveShoppingListForWeek(ACTIVE_WEEK_ISO, shoppingItems); }
  function saveFrequent()  { setLS(FREQ_KEY, frequentItems); }

  function cloneCategoryList(list) {
    return Array.isArray(list) ? list.map(cat => ({ ...cat })) : [];
  }

  function refreshCategorySettings() {
    let settings = [];
    if (categoryService?.loadCategorySettings) {
      try {
        settings = categoryService.loadCategorySettings();
      } catch (err) {
        console.warn("Kunne ikke laste kategorier fra settings", err);
      }
    }

    if (!Array.isArray(settings) || settings.length === 0) {
      settings = cloneCategoryList(FALLBACK_CATEGORY_SETTINGS);
      if (categoryService?.saveCategorySettings) {
        categoryService.saveCategorySettings(settings);
      }
    }

    allCategories = settings;
    visibleCategories = settings.filter(cat => cat.enabled !== false);
    if (visibleCategories.length === 0) {
      visibleCategories = cloneCategoryList(settings);
    }
  }

  function getCategoriesForRendering() {
    if (visibleCategories.length > 0) return visibleCategories;
    if (allCategories.length > 0) return allCategories;
    return cloneCategoryList(FALLBACK_CATEGORY_SETTINGS);
  }

  function getAllCategoryNames() {
    return allCategories.map(cat => cat.name);
  }

  function getDefaultCategoryName() {
    const list = getCategoriesForRendering();
    if (list.length > 0) return list[0].name;
    return FALLBACK_CATEGORY_SETTINGS[0]?.name || "Annet";
  }

  function resolveCategoryName(rawName) {
    const trimmed = String(rawName || "").trim();
    const allNames = getAllCategoryNames();

    if (trimmed && allNames.includes(trimmed)) {
      return trimmed;
    }

    const mapped = LEGACY_CATEGORY_MAP[trimmed.toLowerCase()];
    if (mapped) {
      if (allNames.includes(mapped)) {
        return mapped;
      }
      if (allNames.length === 0) {
        return mapped;
      }
    }

    if (allNames.length > 0) {
      return allNames[0];
    }

    if (trimmed) return trimmed;
    return FALLBACK_CATEGORY_SETTINGS[0]?.name || "Annet";
  }

  function populateItemCategorySelect() {
    const select = $("#itemCategorySelect");
    if (!select) return;
    const categories = getCategoriesForRendering();
    const currentValue = select.value;
    select.innerHTML = "";

    if (categories.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Ingen kategorier tilgjengelig";
      select.appendChild(opt);
      select.disabled = true;
      return;
    }

    categories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat.name;
      opt.textContent = cat.name;
      select.appendChild(opt);
    });

    select.disabled = false;
    const target = resolveCategoryName(currentValue || categories[0].name);
    select.value = target;
  }

  // ---------- Weekly menu ----------
  function renderWeeklyMenu() {
    const container = $("#weeklyMenuList");
    if (!container) return;
    container.innerHTML = "";

    if (isMenuLoading) {
      const loading = document.createElement("div");
      loading.className = "loading-text";
      loading.textContent = "Henter ukens middager‚Ä¶";
      container.appendChild(loading);
      return;
    }

    if (menuLoadError && Object.values(weeklyMenu).every((dish) => !dish)) {
      const err = document.createElement("div");
      err.className = "error-text";
      err.textContent = menuLoadError;
      container.appendChild(err);
      return;
    }

    DAYS.forEach(day => {
      const row = document.createElement("div");
      row.className = "weekly-row";
      row.setAttribute("role", "button");
      row.setAttribute("tabindex", "0");

      const label = document.createElement("div");
      label.className = "weekly-day-label";
      label.textContent = day.label;

      const dish = document.createElement("div");
      dish.className = "weekly-dish";
      const text = weeklyMenu[day.key] || "";
      if (!text) {
        dish.textContent = `${day.label} ‚Äì Planlegg middag ‚Ä¶`;
        dish.classList.add("empty");
      } else {
        dish.textContent = text;
      }

      const openModal = () => openMenuModal(day.key, day.label);
      row.addEventListener("click", openModal);
      row.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openModal();
        }
      });

      row.appendChild(label);
      row.appendChild(dish);
      container.appendChild(row);
    });
  }

  function openMenuModal(dayKey, dayLabel) {
    currentMenuDayKey = dayKey;
    const overlay = $("#menuModalOverlay");
    const title   = $("#menuModalTitle");
    const input   = $("#menuTextInput");

    if (title) title.textContent = `Middag p√• ${dayLabel}`;
    if (input) {
      input.value = weeklyMenu[dayKey] || "";
      setTimeout(() => input.focus(), 20);
    }
    if (overlay) overlay.classList.add("open");
  }

  function closeMenuModal() {
    const overlay = $("#menuModalOverlay");
    if (overlay) overlay.classList.remove("open");
    currentMenuDayKey = null;
  }
  // ---------- Frequent items ----------
  function trackFrequentItem(name, category) {
    const cleanName = String(name || "").trim();
    if (!cleanName) return;
    const resolvedCategory = resolveCategoryName(category || getDefaultCategoryName());

    const existing = frequentItems.find(f => f.name.toLowerCase() === cleanName.toLowerCase());
    if (existing) {
      existing.timesUsed = (existing.timesUsed || 0) + 1;
      existing.category = resolvedCategory;
    } else {
      frequentItems.push({
        name: cleanName,
        category: resolvedCategory,
        timesUsed: 1
      });
    }
    saveFrequent();
    renderFrequentItems();
  }

  function renderFrequentItems() {
    const grid = $("#frequentGrid");
    if (!grid) return;

    const sorted = [...frequentItems].sort((a,b) => (b.timesUsed||0) - (a.timesUsed||0));
    const top = sorted.slice(0, 10);
    const activeNames = new Set(
      shoppingItems.map((it) => String(it?.name || "").trim().toLowerCase())
    );

    grid.innerHTML = "";
    if (top.length === 0) {
      grid.textContent = "Her dukker det opp varer dere bruker ofte, etter hvert som dere bygger handlelister.";
      return;
    }

    top.forEach(item => {
      const chip = document.createElement("button");
      chip.className = "frequent-chip";
      chip.type = "button";
      chip.textContent = item.name;
      const isActive = activeNames.has(item.name.toLowerCase());
      if (isActive) chip.classList.add("active");
      chip.setAttribute("aria-pressed", String(isActive));
      chip.addEventListener("click", () => {
        addItemToCategoryByName(item.name, item.category, 1);
      });
      grid.appendChild(chip);
    });
  }

  // ---------- Handleliste / kategorier ----------
  async function addItemToCategoryByName(name, categoryName, quantity = 1) {
    const cleanName = String(name || "").trim();
    if (!cleanName) return;
    const resolvedCategory = resolveCategoryName(categoryName || getDefaultCategoryName());
    const qty = Math.max(1, Number(quantity) || 1);

    try {
      if (shoppingListService?.addItem) {
        const updated = await shoppingListService.addItem(supa, {
          weekISO: ACTIVE_WEEK_ISO,
          name: cleanName,
          category: resolvedCategory,
          quantity: qty
        });
        applyShoppingItems(updated);
      } else {
        shoppingItems.push({
          id: createItemId(),
          name: cleanName,
          category: resolvedCategory,
          quantity: qty,
          checked: false
        });
        applyShoppingItems(shoppingItems);
      }
      trackFrequentItem(cleanName, resolvedCategory);
      renderCategories();
    } catch (err) {
      console.error("Kunne ikke lagre vare til Supabase", err);
      showToast("Kunne ikke lagre vare i skyen ‚Äì lagret lokalt.", "error");
      shoppingItems.push({
        id: createItemId(),
        name: cleanName,
        category: resolvedCategory,
        quantity: qty,
        checked: false
      });
      applyShoppingItems(shoppingItems);
      trackFrequentItem(cleanName, resolvedCategory);
      renderCategories();
    }
  }

  function deriveDisplayName(item) {
    if (!item || !item.name) return "";
    const trimmed = String(item.name).trim();
    const qtyNumber = Math.max(1, Number(item.quantity) || 1);
    const match = /^(\d+)\s+(.*)$/.exec(trimmed);
    if (match) {
      const leadingQty = Number(match[1]);
      const rest = match[2].trim();
      const firstWord = rest.split(/\s+/)[0]?.toLowerCase();
      const unitWords = new Set([
        "stk","st","pk","pakke","pakker","pose","poser","kg","g","l","dl","ml","cl","x","flaske","flasker","boks","bokser","eske","kartong"
      ]);
      if (leadingQty === qtyNumber && rest && !unitWords.has(firstWord)) {
        return rest.charAt(0).toUpperCase() + rest.slice(1);
      }
    }
    return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
  }

  function createItemCard(item, options = {}) {
    const { showCategorySuffix = false } = options;
    const card = document.createElement("div");
    card.className = "item-card" + (item.checked ? " checked" : "");
    const itemId = item.id;

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "item-checkbox";
    checkbox.checked = !!item.checked;
    checkbox.addEventListener("change", (e) => {
      e.stopPropagation();
      toggleItemChecked(itemId);
    });
    checkbox.addEventListener("click", (e) => e.stopPropagation());

    const details = document.createElement("div");
    details.className = "item-details";

    const left = document.createElement("div");
    left.className = "item-left";

    const nameEl = document.createElement("div");
    nameEl.className = "item-name";
    const baseName = deriveDisplayName(item);
    if (showCategorySuffix && item.category) {
      nameEl.textContent = `${baseName} (${item.category})`;
    } else {
      nameEl.textContent = baseName;
    }

    left.appendChild(checkbox);
    left.appendChild(nameEl);

    const qtyLabel = document.createElement("div");
    qtyLabel.className = "item-quantity";
    qtyLabel.textContent = `${item.quantity} stk`;

    const stepper = document.createElement("div");
    stepper.className = "stepper";
    const decBtn = document.createElement("button");
    decBtn.type = "button";
    decBtn.className = "stepper-btn";
    decBtn.textContent = "‚àí";
    decBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      updateQuantity(itemId, -1);
    });
    const valEl = document.createElement("span");
    valEl.className = "stepper-value";
    valEl.textContent = item.quantity;
    const incBtn = document.createElement("button");
    incBtn.type = "button";
    incBtn.className = "stepper-btn";
    incBtn.textContent = "+";
    incBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      updateQuantity(itemId, 1);
    });
    stepper.appendChild(decBtn);
    stepper.appendChild(valEl);
    stepper.appendChild(incBtn);

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "item-delete-btn";
    delBtn.innerHTML = "üóë";
    delBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      deleteItem(itemId);
    });

    const controls = document.createElement("div");
    controls.className = "item-controls";
    controls.appendChild(stepper);
    controls.appendChild(delBtn);

    const right = document.createElement("div");
    right.className = "item-right";
    right.appendChild(qtyLabel);
    right.appendChild(controls);

    details.appendChild(left);
    details.appendChild(right);

    card.appendChild(details);

    card.addEventListener("click", (event) => {
      if (event.target.closest(".stepper-btn") || event.target.closest(".item-delete-btn")) {
        return;
      }
      toggleItemChecked(itemId);
    });

    return card;
  }

function renderCategories() {
  refreshCategorySettings();
  populateItemCategorySelect();

  const container = $("#categoriesContainer");
  const purchasedContainer = $("#purchasedContainer");
  const emptyText = $("#shoppingEmptyText");
  if (!container) return;

  container.innerHTML = "";
  if (purchasedContainer) purchasedContainer.innerHTML = "";

  if (isShoppingLoading) {
    const loading = document.createElement("div");
    loading.className = "loading-text";
    loading.textContent = "Henter handleliste‚Ä¶";
    container.appendChild(loading);
    if (emptyText) emptyText.style.display = "none";
    return;
  }

  if (shoppingLoadError && shoppingItems.length === 0) {
    const err = document.createElement("div");
    err.className = "error-text";
    err.textContent = shoppingLoadError;
    container.appendChild(err);
    if (emptyText) emptyText.style.display = "block";
    return;
  }

  const categoriesToShow = getCategoriesForRendering();
  const knownCategoryNames = new Set(categoriesToShow.map(cat => cat.name));
  const grouped = new Map();
  categoriesToShow.forEach(cat => grouped.set(cat.name, []));
  const orphanItems = [];
  const purchasedItems = [];

  let totalItems = 0;
  shoppingItems.forEach(item => {
    const qty = Math.max(1, Number(item.quantity) || 1);
    totalItems += qty;

    if (isStoreMode && item.checked) {
      purchasedItems.push(item);
      return;
    }

    if (knownCategoryNames.has(item.category)) {
      grouped.get(item.category).push(item);
    } else {
      orphanItems.push(item);
    }
  });

  categoriesToShow.forEach(cat => {
    const items = grouped.get(cat.name) || [];
    const card = document.createElement("div");
    card.className = "category-card open";
    card.dataset.categoryName = cat.name;
    card.addEventListener("click", (e) => {
      if (e.target.closest(".item-card")) return;
      openItemModal(cat.name);
    });

    const header = document.createElement("div");
    header.className = "category-header";
    header.setAttribute("role", "button");
    header.setAttribute("tabindex", "0");
    header.setAttribute("aria-expanded", "true");
    header.innerHTML = `
      <div class="category-title">
        ${cat.name}
        <span class="category-count">(${items.length})</span>
      </div>
    `;
    header.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openItemModal(cat.name);
      }
    });

    const content = document.createElement("div");
    content.className = "category-content";
    content.style.maxHeight = "2000px";
    content.style.opacity = "1";

    const inner = document.createElement("div");
    inner.className = "category-inner";
    items.forEach(item => inner.appendChild(createItemCard(item)));

    content.appendChild(inner);
    card.appendChild(header);
    card.appendChild(content);
    container.appendChild(card);
  });

  if (orphanItems.length > 0) {
    const card = document.createElement("div");
    card.className = "category-card open";
    const header = document.createElement("div");
    header.className = "category-header";
    header.innerHTML = `
      <div class="category-title">
        Andre varer
        <span class="category-count">(${orphanItems.length})</span>
      </div>
    `;
    const content = document.createElement("div");
    content.className = "category-content";
    content.style.maxHeight = "2000px";
    content.style.opacity = "1";
    const inner = document.createElement("div");
    inner.className = "category-inner";
    orphanItems.forEach(item => inner.appendChild(createItemCard(item, { showCategorySuffix: true })));
    content.appendChild(inner);
    card.appendChild(header);
    card.appendChild(content);
    container.appendChild(card);
  }

  if (isStoreMode && purchasedItems.length > 0 && purchasedContainer) {
    const title = document.createElement("div");
    title.className = "purchased-section-title";
    title.textContent = `Kj√∏pt denne turen (${purchasedItems.length} varer)`;
    purchasedContainer.appendChild(title);

    const purchasedList = document.createElement("div");
    purchasedList.className = "category-inner";

    purchasedItems.forEach(item => {
      const showSuffix = !knownCategoryNames.has(item.category);
      purchasedList.appendChild(createItemCard(item, { showCategorySuffix: showSuffix }));
    });

    purchasedContainer.appendChild(purchasedList);
  }

  if (emptyText) {
    emptyText.style.display = totalItems === 0 ? "block" : "none";
  }

  renderFrequentItems();
  updateFooter(totalItems);
}

  // ---------- Mutators ----------

  function renderWithCheckDelay(isChecked) {
    if (isChecked) {
      setTimeout(() => renderCategories(), 400);
    } else {
      renderCategories();
    }
  }

  async function toggleItemChecked(itemId) {
    const idx = shoppingItems.findIndex(item => item.id === itemId);
    if (idx === -1) return;
    const nextValue = !shoppingItems[idx].checked;

    if (shoppingListService?.toggleItemChecked) {
      try {
        const updated = await shoppingListService.toggleItemChecked(
          supa,
          itemId,
          nextValue,
          ACTIVE_WEEK_ISO
        );
        applyShoppingItems(updated);
        renderWithCheckDelay(nextValue);
        return;
      } catch (err) {
        console.error("Kunne ikke oppdatere vare-status", err);
        showToast("Kunne ikke lagre endring, pr√∏ver lokalt.", "error");
      }
    }

    shoppingItems[idx].checked = nextValue;
    saveShoppingItems();
    renderWithCheckDelay(nextValue);
  }

  async function updateQuantity(itemId, delta) {
    const idx = shoppingItems.findIndex(item => item.id === itemId);
    if (idx === -1) return;
    const current = Math.max(1, Number(shoppingItems[idx].quantity) || 1);
    const nextValue = Math.max(1, current + delta);

    if (shoppingListService?.updateItemQuantity) {
      try {
        const updated = await shoppingListService.updateItemQuantity(
          supa,
          itemId,
          nextValue,
          ACTIVE_WEEK_ISO
        );
        applyShoppingItems(updated);
        renderCategories();
        return;
      } catch (err) {
        console.error("Kunne ikke oppdatere antall", err);
        showToast("Kunne ikke lagre antall, pr√∏ver lokalt.", "error");
      }
    }

    shoppingItems[idx].quantity = nextValue;
    saveShoppingItems();
    renderCategories();
  }

  async function deleteItem(itemId) {
    if (shoppingListService?.deleteItem) {
      try {
        const updated = await shoppingListService.deleteItem(supa, itemId, ACTIVE_WEEK_ISO);
        applyShoppingItems(updated);
        renderCategories();
        return;
      } catch (err) {
        console.error("Kunne ikke slette vare", err);
        showToast("Kunne ikke slette i skyen, fjernet lokalt.", "error");
      }
    }

    const next = shoppingItems.filter(item => item.id !== itemId);
    if (next.length === shoppingItems.length) return;
    shoppingItems = next;
    saveShoppingItems();
    renderCategories();
  }

  async function markAllChecked() {
    if (shoppingListService?.markAllChecked) {
      try {
        const updated = await shoppingListService.markAllChecked(supa, ACTIVE_WEEK_ISO);
        applyShoppingItems(updated);
        renderCategories();
        return;
      } catch (err) {
        console.error("Kunne ikke merke alle som kj√∏pt", err);
        showToast("Kunne ikke oppdatere alle varer.", "error");
      }
    }

    shoppingItems.forEach(item => {
      item.checked = true;
    });
    saveShoppingItems();
    renderCategories();
  }

  async function clearChecked() {
    if (shoppingListService?.clearChecked) {
      try {
        const updated = await shoppingListService.clearChecked(supa, ACTIVE_WEEK_ISO);
        applyShoppingItems(updated);
        renderCategories();
        return;
      } catch (err) {
        console.error("Kunne ikke t√∏mme kj√∏pte", err);
        showToast("Kunne ikke t√∏mme kj√∏pte varer.", "error");
      }
    }

    shoppingItems = shoppingItems.filter(item => !item.checked);
    saveShoppingItems();
    renderCategories();
  }

  // ---------- Footer ----------
  function updateFooter(totalItems) {
    const footerTotal = $("#footerTotal");
    if (!footerTotal) return;
    const label = currentConfig.total_label || defaultConfig.total_label;
    footerTotal.textContent = `${label}: ${fmtInt(totalItems)}`;
  }

  // ---------- FAB / vare-modal ----------
  function openItemModal(categoryName) {
    const overlay = $("#itemModalOverlay");
    const nameInput = $("#itemNameInput");

    populateItemCategorySelect();
    modalQty = 1;
    $("#modalQty").textContent = "1";

    // forh√•ndsvelg kategori hvis vi fikk en, ellers Matvarer
    const catSelect = $("#itemCategorySelect");
    if (catSelect) {
      const resolved = resolveCategoryName(categoryName || getDefaultCategoryName());
      catSelect.value = resolved;
    }

    if (nameInput) {
      nameInput.value = "";
      setTimeout(() => nameInput.focus(), 20);
    }
    if (overlay) overlay.classList.add("open");
  }

  function closeItemModal() {
    const overlay = $("#itemModalOverlay");
    if (overlay) overlay.classList.remove("open");
  }

  // ---------- Inbox fra middagsplan ----------
  function getInboxItems() {
    try {
      const arr = JSON.parse(localStorage.getItem(INBOX_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  async function mergeInboxItems() {
    const inbox = getInboxItems();
    if (!Array.isArray(inbox) || inbox.length === 0) return 0;

    const targetCategory = getDefaultCategoryName();
    const existing = new Set(
      shoppingItems
        .filter(item => item.category === targetCategory)
        .map(i => String(i.name || "").trim().toLowerCase())
    );

    let added = 0;
    for (const name of inbox) {
      const clean = String(name || "").trim();
      if (!clean) continue;
      const key = clean.toLowerCase();
      if (existing.has(key)) continue;
      await addItemToCategoryByName(clean, targetCategory, 1);
      existing.add(key);
      added++;
    }

    setLS(INBOX_KEY, []);
    return added;
  }

  function initInboxButton() {
    const inboxBtn = $("#inboxBtn");
    const inboxCountSpan = $("#inboxCount");
    if (!inboxBtn || !inboxCountSpan) return;

    const items = getInboxItems();
    if (!items || items.length === 0) {
      inboxBtn.style.display = "none";
      return;
    }

    inboxBtn.style.display = "inline-flex";
    inboxCountSpan.textContent = items.length;

    inboxBtn.addEventListener("click", async () => {
      const ok = confirm(`Legg til ${items.length} varer fra middagsplanen i handlelista?`);
      if (!ok) return;
      const added = await mergeInboxItems();
      renderCategories();
      inboxBtn.style.display = "none";
      if (added > 0) {
        showToast(`La til ${added} varer fra middagsplanen ‚úÖ`, "success");
      }
    });
  }

  // ---------- Butikk-modus ----------
const modeToggleBtn = $("#modeToggleBtn");
const exitStoreBtn = $("#exitStoreBtn");

function setStoreMode(nextValue) {
  isStoreMode = !!nextValue;
  document.body.classList.toggle("store-mode", isStoreMode);

  if (modeToggleBtn) {
    modeToggleBtn.textContent = isStoreMode ? "Avslutt butikk-modus" : "Start butikk-modus üõí";
    modeToggleBtn.classList.toggle("active", isStoreMode);
  }
  if (exitStoreBtn) {
    exitStoreBtn.textContent = isStoreMode ? "Ferdig i butikken" : "Start butikk-modus";
  }

  if (isStoreMode) {
    const shoppingSection = $("#shoppingSection");
    if (shoppingSection) {
      shoppingSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  } else {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  renderCategories();
}

if (modeToggleBtn) {
  modeToggleBtn.addEventListener("click", () => setStoreMode(!isStoreMode));
}
if (exitStoreBtn) {
  exitStoreBtn.addEventListener("click", () => setStoreMode(false));
}

  // ---------- Tilbake-knapp ----------
  const backBtn = $("#backBtn");
  if (backBtn) {
    backBtn.addEventListener("click", () => {
      const ref = document.referrer || "";
      const cameFromApp = /(^|\/)app\.html(\?|#|$)/.test(ref);
      if (cameFromApp) {
        history.back();
      } else {
        window.location.href = "app.html";
      }
    });
  }

  // ---------- Element SDK (tema / tekst) ----------
  function onConfigChange(cfg) {
    currentConfig = { ...currentConfig, ...cfg };

    const font = currentConfig.font_family || defaultConfig.font_family;
    const baseSize = currentConfig.font_size || defaultConfig.font_size;
    const bg = currentConfig.background_color || defaultConfig.background_color;
    const txt = currentConfig.text_color || defaultConfig.text_color;
    const secTxt = currentConfig.secondary_text_color || defaultConfig.secondary_text_color;
    const primary = currentConfig.primary_color || defaultConfig.primary_color;
    const surface = currentConfig.surface_color || defaultConfig.surface_color;

    document.body.style.fontFamily = `${font}, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
    document.body.style.background = `linear-gradient(135deg, ${bg} 0%, #f0f9f4 100%)`;

    const title = $("#pageTitle");
    const subtitle = $("#pageSubtitle");
    if (title) {
      title.textContent = currentConfig.page_title || defaultConfig.page_title;
      title.style.fontSize = `${baseSize * 2}px`;
      title.style.color = txt;
    }
    if (subtitle) {
      subtitle.textContent = currentConfig.page_subtitle || defaultConfig.page_subtitle;
      subtitle.style.fontSize = `${baseSize}px`;
      subtitle.style.color = secTxt;
    }

    // Overflater / prim√¶rfarge
    $$(".category-inner, .modal").forEach(el => {
      el.style.background = surface;
    });
    $$(".fab, .footer-btn.mark-all, .btn-primary").forEach(el => {
      el.style.background = primary;
      el.style.color = "#ffffff";
    });

    const footerTotal = $("#footerTotal");
    if (footerTotal) {
      const totalLabel = currentConfig.total_label || defaultConfig.total_label;
      const currentNum = footerTotal.textContent.replace(/\D+/g, "");
      const n = parseInt(currentNum || "0", 10);
      footerTotal.textContent = `${totalLabel}: ${fmtInt(n)}`;
    }
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: v => window.elementSdk.setConfig({ background_color: v }) },
          { get: () => config.surface_color    || defaultConfig.surface_color,    set: v => window.elementSdk.setConfig({ surface_color: v }) },
          { get: () => config.text_color       || defaultConfig.text_color,       set: v => window.elementSdk.setConfig({ text_color: v }) },
          { get: () => config.primary_color    || defaultConfig.primary_color,    set: v => window.elementSdk.setConfig({ primary_color: v }) },
          { get: () => config.secondary_text_color || defaultConfig.secondary_text_color, set: v => window.elementSdk.setConfig({ secondary_text_color: v }) },
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: v  => window.elementSdk.setConfig({ font_family: v })
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: v  => window.elementSdk.setConfig({ font_size: v })
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
        ["total_label", config.total_label || defaultConfig.total_label]
      ])
    });
  }

  // ---------- Event-listeners for modaler og footer ----------
  // FAB
  $("#fabBtn")?.addEventListener("click", () => openItemModal());

  // Vare-modal
  $("#itemCancelBtn")?.addEventListener("click", closeItemModal);
  $("#itemModalOverlay")?.addEventListener("click", (e) => {
    if (e.target === $("#itemModalOverlay")) closeItemModal();
  });
  $("#modalDecBtn")?.addEventListener("click", () => {
    modalQty = Math.max(1, modalQty - 1);
    $("#modalQty").textContent = String(modalQty);
  });
  $("#modalIncBtn")?.addEventListener("click", () => {
    modalQty += 1;
    $("#modalQty").textContent = String(modalQty);
  });
  $("#addItemForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = $("#itemNameInput").value.trim();
    const cat  = $("#itemCategorySelect").value;
    if (!name) return;
    await addItemToCategoryByName(name, cat, modalQty);
    closeItemModal();
  });

  // Middags-modal
  $("#menuCancelBtn")?.addEventListener("click", closeMenuModal);
  $("#menuModalOverlay")?.addEventListener("click", (e) => {
    if (e.target === $("#menuModalOverlay")) closeMenuModal();
  });
  $("#weeklyMenuForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentMenuDayKey) {
      closeMenuModal();
      return;
    }
    const txt = $("#menuTextInput").value.trim();
    await saveMenuEntry(currentMenuDayKey, txt);
    renderWeeklyMenu();
    closeMenuModal();
  });

  // Footer-knapper
  $("#markAllBtn")?.addEventListener("click", markAllChecked);
  $("#clearBtn")?.addEventListener("click", clearChecked);

  // ---------- Init ----------
  async function init() {
    if (!supa) {
      console.error('Supabase-klient mangler');
      return;
    }
    if (window.authHelpers?.protectPage) {
      await window.authHelpers.protectPage(supa);
      if (window.location.pathname !== '/handleliste.html') {
        return;
      }
    }

    if (window.authHelpers?.initializeAuthListener) {
      window.authHelpers.initializeAuthListener(supa);
    }

    if (categoryService?.loadCategorySettings) {
      try {
    await categoryService.loadCategorySettings(supa);
      } catch (err) {
        console.warn("Kunne ikke laste kategorier fra Supabase", err);
      }
    }

    await ensureHouseholdId();
    await Promise.all([loadWeeklyMenuData(), loadShoppingItemsData()]);
    renderFrequentItems();
    initInboxButton();
    await setupRealtimeChannels();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await init();

    window.tourManager?.startTourIfNeeded({
      tourId: 'shopping-list',
      version: 1,
      steps: [
        {
          element: '#weeklySection',
          popover: {
            title: 'Ukens middager',
            description: 'Planlegg middager og send ingrediensene rett til handlelista.',
            side: 'bottom'
          }
        },
        {
          element: '#frequentSection',
          popover: {
            title: 'Faste varer',
            description: 'Legg til ting dere ofte kj√∏per, s√• slipper dere √• skrive de inn hver gang.',
            side: 'bottom'
          }
        },
        {
          element: '#shoppingSection',
          popover: {
            title: 'Handleliste',
            description: 'Her ser dere alt dere skal kj√∏pe denne gangen.',
            side: 'top'
          }
        },
        {
          element: '#modeToggleBtn',
          popover: {
            title: 'Butikk-modus',
            description: 'Trykk her n√•r du g√•r inn i butikken, s√• blir det enklere √• krysse av varene etter hvert som du handler.',
            side: 'top'
          }
        }
      ]
    });
  });
  window.addEventListener('beforeunload', cleanupRealtimeChannels);
</script>
</body>
</html>
