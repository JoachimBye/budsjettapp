<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <!-- Element SDK (for tekst/tema-redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supa-client.js"></script>

  <!-- Sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>

  <style>
    :root {
      --bg-app: #F9FAF9;
      --bg-card: #FFFFFF;
      --brand-green: #4A7A65;
      --brand-green-dark: #2D5C45;
      --accent-soft-green: #E8F5E9;
      --text-main: #1C1C1E;
      --text-secondary: #636366;
      --text-muted: #8E8E93;
      --border-radius-card: 24px;
      --border-radius-input: 12px;
      --shadow-card: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 16px 40px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(140% 120% at 50% 0%, #ffffff 0%, var(--bg-app) 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    .auth-card {
      background: var(--bg-card);
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow-card);
      padding: 28px 28px 32px;
      max-width: 420px;
      width: 100%;
      margin: 24px auto;
      position: relative;
    }

    .login-card {
      animation: cardEnter 0.6s 0.05s ease-out backwards;
    }

    .auth-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 8px;
      text-align: center;
      letter-spacing: -0.01em;
    }

    .auth-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin: 0 0 24px;
      text-align: center;
      line-height: 1.6;
    }

    .auth-field-group {
      margin-bottom: 16px;
    }

    .auth-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .auth-input {
      width: 100%;
      height: 50px;
      border-radius: var(--border-radius-input);
      border: none;
      background: #F2F2F7;
      padding: 0 14px;
      font-size: 16px;
      color: var(--text-main);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.03);
      transition: box-shadow 0.2s ease, background-color 0.2s ease, transform 0.08s ease;
    }

    .auth-input::placeholder {
      color: var(--text-muted);
    }

    .auth-input:focus {
      background: #FFFFFF;
      box-shadow:
        0 0 0 1px rgba(74, 122, 101, 0.25),
        0 0 0 4px rgba(74, 122, 101, 0.08);
    }

    .auth-input.pulse-once {
      animation: softPulse 1.4s ease-out 0.8s 2;
    }

    .hint {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }

    .submit-btn,
    .auth-button-primary {
      width: 100%;
      height: 52px;
      border-radius: 16px;
      border: none;
      background: var(--brand-green);
      color: white;
      font-size: 16px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(74, 122, 101, 0.4);
      transition:
        transform 0.08s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.12s ease,
        opacity 0.2s ease;
      margin-top: 6px;
    }

    .auth-button-primary:hover:not(:disabled) {
      box-shadow: 0 10px 24px rgba(74, 122, 101, 0.45);
    }

    .auth-button-primary:active:not(:disabled) {
      transform: scale(0.96);
      box-shadow: 0 4px 10px rgba(74, 122, 101, 0.35);
    }

    .auth-button-primary:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .auth-button-primary .spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: rgba(255, 255, 255, 1);
      animation: spin 0.7s linear infinite;
      display: none;
    }

    .auth-button-primary.loading .spinner {
      display: inline-block;
    }

    .auth-button-primary.loading {
      cursor: progress;
    }

    .success-message {
      background: var(--accent-soft-green);
      border: 1px solid rgba(74, 122, 101, 0.18);
      border-radius: 14px;
      padding: 12px 14px;
      margin-top: 16px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .success-message.show { display: flex; }

    .success-text {
      color: var(--text-main);
      font-weight: 500;
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }

    .login-link {
      text-align: center;
      margin-top: 18px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .auth-link {
      color: var(--brand-green-dark);
      font-weight: 500;
      text-decoration: none;
      transition: color 0.15s ease, text-decoration 0.15s ease;
    }

    .auth-link:hover {
      text-decoration: underline;
      color: var(--brand-green);
    }

    .footer,
    .auth-footer-note {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 8px;
    }

    .error-hint {
      margin-top: 10px;
      font-size: 13px;
      color: #d32f2f;
      line-height: 1.5;
      text-align: center;
    }

    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(74, 122, 101, 0.28); }
      100% { box-shadow: 0 0 0 14px rgba(74, 122, 101, 0); }
    }

    @keyframes cardEnter {
      0%   { opacity: 0; transform: translateY(24px) scale(0.97); }
      60%  { opacity: 1; transform: translateY(0) scale(1.01); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      body { padding: 24px 16px 32px; }
      .auth-card { padding: 24px; margin: 12px auto; }
      .auth-title { font-size: 22px; }
      .auth-subtitle { font-size: 14px; }
    }

    @view-transition { navigation: auto; }

    @media (prefers-reduced-motion: reduce) {
      .login-card,
      .auth-input.pulse-once {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="card auth-card login-card">
    <h1 class="title auth-title" id="main-title">Bli med i familie betaen</h1>
    <p class="subtitle auth-subtitle" id="subtitle">
      Vi sender deg en magisk lenke pÃ¥ e-post slik at du kan komme i gang.
    </p>

    <form id="loginForm">
      <!-- Steg 1: e-post -->
      <div class="form-group auth-field-group" id="emailGroup">
        <label for="email" class="auth-label" id="email-label">E-postadresse</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder="din@epost.no"
          autocomplete="email"
          class="auth-input"
        />
        <p class="hint" id="email-hint" style="display:none;"></p>
      </div>

      <!-- Steg 1 (kun registrering): invitasjonskode -->
      <div class="form-group auth-field-group" id="inviteGroup">
        <label for="invite" class="auth-label" id="code-label">Invitasjonskode</label>
        <input
          type="text"
          id="invite"
          name="invite"
          required
          placeholder=""
          class="auth-input"
        />
        <p class="hint" id="code-hint">
          Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.
        </p>
      </div>

      <!-- Steg 2: OTP-kode (skjules i steg 1) -->
      <div class="form-group auth-field-group" id="otpGroup" style="display:none;">
        <label for="otpInput" class="auth-label" id="otp-label">Engangskode</label>
        <input
          type="text"
          id="otpInput"
          name="otp"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="6"
          placeholder="Skriv 6-sifret kode"
          class="auth-input"
        />
        <p class="hint" id="otp-hint">
          Sjekk e-posten din. Tips: se i sÃ¸ppelpost/spam hvis du ikke finner den.
        </p>
      </div>

      <div class="terms-row" style="margin-top: 8px; margin-bottom: 12px;">
        <label class="terms-checkbox" style="display: flex; align-items: flex-start; gap: 8px; font-size: 14px;">
          <input type="checkbox" id="accept-terms" style="margin-top: 3px;">
          <span>
            Jeg har lest og aksepterer
            <a href="vilkar.html" target="_blank" rel="noopener noreferrer">
              vilkÃ¥r og personvern
            </a>.
          </span>
        </label>
      </div>

      <button type="submit" class="submit-btn auth-button-primary" id="magic-link-button">
        <span class="spinner" aria-hidden="true"></span>
        <span id="button-text">Bli med i betaen</span>
      </button>

      <!-- Inline feilmelding -->
      <p class="error-hint" id="errorHint" style="display:none;"></p>

      <div class="success-message" id="successBox">
        <span class="success-text" id="successText">
          Kode sendt! Sjekk e-posten din og skriv inn 6-sifret kode.
        </span>
      </div>
    </form>

    <div class="login-link" id="login-link-row">
      <span id="loginLinkPrefix">Har du ikke konto?</span>
      <a href="/index.html" class="auth-link" id="loginAnchor" data-action="landing">Bli med i betaen</a>
    </div>
  </div>

  <div class="footer auth-footer-note" id="footer-text">
    Laget i Uranusvegen 30 ðŸŒ™ Â· Familieversjon 1.0
  </div>

  <script>
    // ===== Supabase init =====================================================
    const supa = window.supaClient?.getClient();
    if (!supa) {
      console.error('Supabase-klient mangler');
    }

    // ===== Element SDK â€“ enkel tekst/tema-konfig ============================
    const defaultConfig = {
      main_title: "Bli med i familie-betaen ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
      subtitle: "Vi sender deg en magisk lenke slik at du kan komme i gang.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      footer_text: "Laget i TromsÃ¸ ðŸŒ™ Â· Familieversjon v0.9 beta",
      background_color: "#F9FAF9",
      card_color: "#FFFFFF",
      primary_color: "#4A7A65",
      primary_color_dark: "#2D5C45",
      text_color: "#1C1C1E",
      accent_color: "#E8F5E9"
    };

    function onConfigChange(config) {
      document.getElementById('main-title').textContent =
        config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent =
        config.subtitle || defaultConfig.subtitle;
      document.getElementById('email-label').textContent =
        config.email_label || defaultConfig.email_label;
      document.getElementById('code-label').textContent =
        config.code_label || defaultConfig.code_label;
      document.getElementById('code-hint').textContent =
        config.code_hint || defaultConfig.code_hint;
      document.getElementById('button-text').textContent =
        config.button_text || defaultConfig.button_text;
      document.getElementById('footer-text').textContent =
        config.footer_text || defaultConfig.footer_text;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const primaryDark = config.primary_color_dark || defaultConfig.primary_color_dark;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      const setVar = (name, value) => {
        if (!value) return;
        document.documentElement.style.setProperty(name, value);
      };

      setVar('--bg-app', backgroundColor);
      setVar('--bg-card', cardColor);
      setVar('--brand-green', primaryColor);
      setVar('--brand-green-dark', primaryDark);
      setVar('--accent-soft-green', accentColor);
      setVar('--text-main', textColor);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) =>
          new Map([
            ["main_title", config.main_title || defaultConfig.main_title],
            ["subtitle", config.subtitle || defaultConfig.subtitle],
            ["email_label", config.email_label || defaultConfig.email_label],
            ["code_label", config.code_label || defaultConfig.code_label],
            ["code_hint", config.code_hint || defaultConfig.code_hint],
            ["button_text", config.button_text || defaultConfig.button_text],
            ["footer_text", config.footer_text || defaultConfig.footer_text]
          ])
      });
    }

    // ===== State + UI =======================================================
    const qs = (sel) => document.querySelector(sel);

    const state = {
      mode: 'register',   // 'register' | 'login'
      step: 'email',      // 'email' | 'otp' | 'magic-link'
      isLoading: false,
      lastEmail: null,
      error: null
    };
    let inviteCodeFromUrl = null;
    const termsCheckbox = document.getElementById('accept-terms');
    const magicLinkButton = document.getElementById('magic-link-button');
    const shouldDisableMagicButton = (isLoading) =>
      Boolean(isLoading || (termsCheckbox && !termsCheckbox.checked));

    if (magicLinkButton) {
      magicLinkButton.disabled = shouldDisableMagicButton(state.isLoading);
    }

    if (termsCheckbox && magicLinkButton) {
      termsCheckbox.addEventListener('change', () => {
        magicLinkButton.disabled = shouldDisableMagicButton(state.isLoading);
      });
    }

    const hasPendingInvite = () => Boolean(localStorage.getItem('pending_invite'));
    const isInviteFlow = () => state.mode === 'register' || hasPendingInvite() || Boolean(inviteCodeFromUrl);

    const ui = {
      elements: {
        form: qs('#loginForm'),
        title: qs('#main-title'),
        subtitle: qs('#subtitle'),
        emailGroup: qs('#emailGroup'),
        emailLabel: qs('#email-label'),
        emailInput: qs('#email'),
        emailHint: qs('#email-hint'),
        inviteGroup: qs('#inviteGroup'),
        inviteInput: qs('#invite'),
        otpGroup: qs('#otpGroup'),
        otpLabel: qs('#otp-label'),
        otpInput: qs('#otpInput'),
        otpHint: qs('#otp-hint'),
        submitBtn: qs('#magic-link-button'),
        buttonText: qs('#button-text'),
        successBox: qs('#successBox'),
        successText: qs('#successText'),
        errorHint: qs('#errorHint'),
        loginLinkRow: qs('#login-link-row'),
        loginAnchor: qs('#loginAnchor'),
        loginLinkPrefix: qs('#loginLinkPrefix')
      },

      render() {
        const {
          mode,
          step,
          isLoading,
          lastEmail,
          error
        } = state;

        const el = this.elements;
        const inviteFlow = isInviteFlow();

        // Feilmelding
        if (el.errorHint) {
          el.errorHint.textContent = error || '';
          el.errorHint.style.display = error ? 'block' : 'none';
        }

        // Loading-state
        if (el.submitBtn && el.buttonText) {
          const disableButton = shouldDisableMagicButton(isLoading);
          el.submitBtn.disabled = disableButton;
          el.submitBtn.classList.toggle('loading', isLoading);
          el.submitBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');

          if (isLoading) {
            el.buttonText.textContent =
              step === 'email'
                ? (inviteFlow ? 'Sender magisk lenke...' : 'Sender kode...')
                : (inviteFlow ? 'Sender magisk lenke...' : 'Logger inn...');
          } else {
            el.buttonText.textContent =
              step === 'email'
                ? (inviteFlow ? 'Send magisk lenke' : (mode === 'register' ? 'Bli med i betaen' : 'Send kode'))
                : (inviteFlow ? 'Send magisk lenke pÃ¥ nytt' : (mode === 'register' ? 'FullfÃ¸r' : 'Logg inn'));
          }
        }

        // Hva skal vises hvor?
        if (el.emailGroup) {
          el.emailGroup.style.display = (step === 'email') ? 'block' : 'none';
        }
        if (el.inviteGroup) {
          const showInvite = (step === 'email' && mode === 'register');
          el.inviteGroup.style.display = showInvite ? 'block' : 'none';

          if (el.inviteInput) {
            if (showInvite) {
              el.inviteInput.setAttribute('required', 'required');
            } else {
              el.inviteInput.removeAttribute('required');
            }
          }
        }
        if (el.otpGroup) {
          const showOtp = (step === 'otp' && !inviteFlow);
          el.otpGroup.style.display = showOtp ? 'block' : 'none';
        }
        if (el.loginLinkRow && el.loginAnchor && el.loginLinkPrefix) {
          if (step !== 'email') {
            el.loginLinkRow.style.display = 'none';
          } else if (mode === 'login') {
            el.loginLinkRow.style.display = 'block';
            el.loginLinkPrefix.textContent = 'Har du ikke konto?';
            el.loginAnchor.textContent = 'Bli med i betaen';
            el.loginAnchor.href = '/index.html';
            el.loginAnchor.dataset.action = 'landing';
          } else {
            el.loginLinkRow.style.display = 'block';
            el.loginLinkPrefix.textContent = 'Har du allerede konto?';
            el.loginAnchor.textContent = 'Logg inn med kode';
            el.loginAnchor.href = '#login';
            el.loginAnchor.dataset.action = 'login';
          }
        }

        // Tittel + undertekst
        if (step === 'email') {
          if (el.title) {
            el.title.textContent =
              inviteFlow
                ? 'Bli med i familie betaen'
                : 'Logg inn';
          }
          if (el.subtitle) {
            el.subtitle.textContent =
              inviteFlow
                ? 'Vi sender deg en magisk lenke pÃ¥ e-post. Klikk pÃ¥ den for Ã¥ komme i gang.'
                : 'Skriv e-posten din, sÃ¥ sender vi en 6-sifret kode.';
          }
          if (el.emailInput) {
            el.emailInput.value = el.emailInput.value || '';
            el.emailInput.type = 'email';
            el.emailInput.placeholder = 'din@epost.no';
            el.emailInput.inputMode = 'email';
          }
          if (el.emailHint) {
            el.emailHint.style.display = 'none';
            el.emailHint.textContent = '';
          }
          if (el.successBox) {
            el.successBox.classList.remove('show');
          }
        } else if (step === 'otp') {
          // OTP-steg
          if (el.title) el.title.textContent = 'Sjekk e-posten din';
          if (el.subtitle) {
            el.subtitle.textContent =
              lastEmail
                ? `Skriv inn koden fra e-posten til ${lastEmail}.`
                : 'Skriv inn koden fra e-posten nedenfor.';
          }
          if (el.otpInput) {
            if (!isLoading) el.otpInput.focus();
          }
          if (el.successBox) el.successBox.classList.add('show');
          if (el.successText) {
            el.successText.textContent =
              lastEmail
                ? `Vi har sendt en kode til ${lastEmail}. Skriv den inn for Ã¥ fullfÃ¸re.`
                : 'Vi har sendt deg en kode. Skriv den inn for Ã¥ fullfÃ¸re.';
          }
        } else {
          if (el.title) el.title.textContent = 'Sjekk e-posten din';
          if (el.subtitle) {
            el.subtitle.textContent =
              lastEmail
                ? `Vi har sendt en magisk lenke til ${lastEmail}. Klikk pÃ¥ lenken for Ã¥ fortsette.`
                : 'Vi har sendt deg en magisk lenke. Ã…pne den for Ã¥ fortsette.';
          }
          if (el.successBox) el.successBox.classList.add('show');
          if (el.successText) {
            el.successText.textContent =
              lastEmail
                ? `Vi har sendt en magisk lenke til ${lastEmail}. Klikk pÃ¥ lenken for Ã¥ fortsette.`
                : 'Vi har sendt deg en magisk lenke. Ã…pne den for Ã¥ fortsette.';
          }
        }

        // Liten visuell markering pÃ¥ invitasjonsfelt i registreringsmodus
        if (el.inviteInput) {
          if (mode === 'register' && step === 'email') {
            el.inviteInput.classList.add('pulse-once');
          } else {
            el.inviteInput.classList.remove('pulse-once');
          }
        }
      }
    };

    function setState(partial) {
      Object.assign(state, partial);
      ui.render();
    }

    // ===== Handlers ==========================================================
    async function handleEmailSubmit() {
      const el = ui.elements;
      const email = el.emailInput.value.trim();
      const inviteCode = el.inviteInput ? el.inviteInput.value.trim() : '';

      if (!email) {
        return setState({ error: 'Skriv inn e-postadresse.' });
      }

      setState({ isLoading: true, error: null });

      try {
        // Registrering: valider invitasjonskode fÃ¸rst
        if (state.mode === 'register') {
          if (!inviteCode) {
            throw new Error('Skriv inn invitasjonskode.');
          }

          const { data: household, error: hErr } = await supa
            .rpc('validate_invite_code', { p_code: inviteCode })
            .single();

          if (hErr || !household || !household.active) {
            throw new Error('Ugyldig eller deaktivert husstandskode.');
          }

          // Lagre intensjon â€“ brukes etter innlogging
          localStorage.setItem('pending_invite', inviteCode);
        }

        const inviteFlow = isInviteFlow();
        let otpError = null;

        if (inviteFlow) {
          const { error } = await supa.auth.signInWithOtp({
            email,
            options: {
              emailRedirectTo: `${location.origin}/index.html`
            }
          });
          otpError = error;
        } else {
          const { error } = await supa.auth.signInWithOtp({ email });
          otpError = error;
        }

        if (otpError) {
          console.error('signInWithOtp feilet:', otpError);
          throw otpError;
        }

        setState({
          step: inviteFlow ? 'magic-link' : 'otp',
          lastEmail: email,
          isLoading: false,
          error: null
        });
      } catch (err) {
        console.error('Feil under signInWithOtp-hÃ¥ndtering:', err);
        setState({
          isLoading: false,
          error: err.message || (isInviteFlow() ? 'Kunne ikke sende magisk lenke. PrÃ¸v igjen.' : 'Kunne ikke sende engangskode. PrÃ¸v igjen.')
        });
      }
    }

    async function handleOtpSubmit() {
      const el = ui.elements;
      const token = el.otpInput.value.trim();

      if (!token) {
        return setState({ error: 'Skriv inn 6-sifret kode.' });
      }
      if (!state.lastEmail) {
        return setState({ error: 'Noe gikk galt â€“ prÃ¸v Ã¥ starte pÃ¥ nytt.' });
      }

      setState({ isLoading: true, error: null });

      try {
        const { error } = await supa.auth.verifyOtp({
          email: state.lastEmail,
          token,
          type: 'email'
        });
        if (error) throw error;

        // La auth-helpers bestemme hvor vi skal videre
        if (window.authHelpers?.protectPage) {
          await window.authHelpers.protectPage(supa);
        } else {
          window.location.href = '/index.html';
        }
      } catch (err) {
        console.error(err);
        setState({
          isLoading: false,
          error: 'Feil kode. PrÃ¸v igjen.'
        });
      }
    }

    function onFormSubmit(e) {
      e.preventDefault();
      if (state.step === 'otp') {
        handleOtpSubmit();
      } else {
        handleEmailSubmit();
      }
    }

    // ðŸ”§ OPPDATERT FUNKSJON HER
    function switchToLoginMode(e) {
      if (e) e.preventDefault();
      setState({
        mode: 'login',
        step: 'email',
        isLoading: false,
        error: null,
        lastEmail: null
      });

      // Bare auto-fokuser e-postfeltet nÃ¥r vi *ikke* kommer fra et klikk-event
      // (f.eks. nÃ¥r siden Ã¥pnes med #login i URL).
      if (!e && ui.elements.emailInput) {
        ui.elements.emailInput.focus();
      }
    }

    function handleLoginLinkClick(e) {
      const action = e.currentTarget?.dataset?.action;
      if (action === 'login') {
        switchToLoginMode(e);
      }
    }

    // ===== Init / bootstrap ==================================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Auth-guard â€“ kan sende oss til /app.html hvis vi allerede er logget inn
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        if (window.location.pathname !== '/innlogging.html') return;
      }

      // URL ?code=... -> forhÃ¥ndsfyll invitasjonskode
      const url = new URL(location.href);
      const codeFromUrl = url.searchParams.get('code');
      inviteCodeFromUrl = codeFromUrl;
      if (codeFromUrl && ui.elements.inviteInput) {
        ui.elements.inviteInput.value = codeFromUrl;
      }

      // Start i login-modus hvis #login
      if (location.hash === '#login') {
        switchToLoginMode();
      } else {
        // initial render i register-modus
        ui.render();
      }

      // Lytt pÃ¥ submit
      if (ui.elements.form) {
        ui.elements.form.addEventListener('submit', onFormSubmit);
      }

      // Nederste lenke (enten tilbake til landing eller til login-modus)
      if (ui.elements.loginAnchor) {
        ui.elements.loginAnchor.addEventListener('click', handleLoginLinkClick);
      }
    });
  </script>
</body>
</html>
