<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <!-- Element SDK (for tekst/tema-redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt ‚Äì du bruker mest custom CSS under) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2rem 1rem;
      overflow: hidden;
      position: relative;
    }
    * { box-sizing: border-box; }
    .card {
      background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,.1);
      padding:2.5rem; max-width:480px; width:100%; margin-bottom:1.5rem;
      position: relative;
      z-index: 10;
    }
    .title {
      font-size:1.75rem; font-weight:700; color:#1b5e20;
      margin-bottom:.5rem; text-align:center;
    }
    .subtitle {
      font-size:1rem; color:#558b2f; margin-bottom:2rem;
      text-align:center; line-height:1.5;
    }
    .form-group { margin-bottom:1.5rem; }
    label {
      display:block; font-size:.9rem; font-weight:600;
      color:#2e7d32; margin-bottom:.5rem;
    }
    input {
      width:100%; padding:.875rem 1rem;
      border:2px solid #c8e6c9; border-radius:.5rem;
      font-size:1rem; transition:all .3s ease; background:#fff;
      position: relative;
    }
    input:focus {
      outline:none; border-color:#4caf50;
      box-shadow:0 0 0 3px rgba(76,175,80,.1);
    }
    .hint { font-size:.85rem; color:#689f38; margin-top:.5rem; line-height:1.4; }
    .submit-btn {
      width:100%; padding:1rem; background:#4caf50; color:#fff;
      border:none; border-radius:.5rem; font-size:1.1rem;
      font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:1rem;
    }
    .submit-btn:hover {
      background:#45a049; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(76,175,80,.3);
    }
    .submit-btn:disabled {
      background:#a5d6a7; cursor:not-allowed; transform:none;
    }
    .success-message {
      background:#e8f5e9; border:2px solid #4caf50;
      border-radius:.5rem; padding:1rem; margin-top:1rem;
      display:none; align-items:center; gap:.75rem;
    }
    .success-message.show { display:flex; }
    .success-text { color:#2e7d32; font-weight:600; flex:1; }
    .login-link {
      text-align:center; margin-top:1.5rem;
      font-size:.9rem; color:#558b2f;
    }
    .login-link a {
      color:#2e7d32; text-decoration:none; font-weight:600;
    }
    .login-link a:hover { text-decoration:underline; }
    .footer { text-align:center; color:#558b2f; font-size:.85rem; }
    @media (max-width:640px){
      .card{padding:1.5rem}
      .title{font-size:1.5rem}
    }
    @view-transition { navigation: auto; }

    /* --- Flytende "boble"-bakgrunn --- */
    .floating-bubbles {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
    }
    .bubble {
        position: absolute;
        border-radius: 9999px;
        background: radial-gradient(circle, rgba(200, 230, 201, 0.5), rgba(240, 244, 195, 0.3));
        animation: floatUpDown 25s ease-in-out infinite;
    }
    .bubble-1 {
        width: 200px;
        height: 200px;
        top: 10%;
        left: 5%;
        animation-duration: 30s;
    }
    .bubble-2 {
        width: 300px;
        height: 300px;
        top: 60%;
        right: -10%;
        animation-duration: 25s;
        animation-delay: 2s;
    }
    .bubble-3 {
        width: 150px;
        height: 150px;
        bottom: 5%;
        left: 30%;
        animation-duration: 20s;
    }
    .bubble-4 {
        width: 250px;
        height: 250px;
        top: -5%;
        left: 60%;
        animation-duration: 35s;
        animation-delay: 1s;
    }

    @keyframes floatUpDown {
        0%   { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
        50%  { transform: translateY(-28px) translateX(10px) scale(1.05); opacity: 0.9; }
        100% { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
    }

    /* Pop-in animasjon p√• kortet */
    .login-card {
        animation: cardEnter 0.6s 0.1s ease-out backwards;
    }

    @keyframes cardEnter {
        0%   { opacity: 0; transform: translateY(24px) scale(0.96); }
        60%  { opacity: 1; transform: translateY(0) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Invitasjonskode "pulse" */
    input#invite.pulse-once {
        animation: softPulse 1.4s ease-out 0.8s 2;
    }

    @keyframes softPulse {
        0%   { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.40); }
        100% { box-shadow: 0 0 0 14px rgba(76, 175, 80, 0.00); }
    }

    /* Redusert bevegelse */
    @media (prefers-reduced-motion: reduce) {
        .floating-bubbles .bubble,
        .login-card,
        input#invite.pulse-once {
            animation: none !important;
            transition: none !important;
        }
    }
  </style>
</head>
<body>

  <!-- Bakgrunnsbobler -->
  <div class="floating-bubbles" aria-hidden="true">
      <span class="bubble bubble-1"></span>
      <span class="bubble bubble-2"></span>
      <span class="bubble bubble-3"></span>
      <span class="bubble bubble-4"></span>
  </div>

  <div class="card login-card">
    <h1 class="title" id="main-title">Bli med i familie betaen</h1>
    <p class="subtitle" id="subtitle">Du er invitert til √• teste v√•r nye budsjett app f√∏r alle andre.</p>

    <form id="loginForm">
      <div class="form-group">
        <label for="email" id="email-label">E-postadresse</label>
        <input type="email" id="email" name="email" required placeholder="din@epost.no" autocomplete="email"/>
        <p class="hint" id="email-hint" style="display:none;"></p>
      </div>

      <div class="form-group" id="inviteGroup">
        <label for="invite" id="code-label">Invitasjonskode</label>
        <input type="text" id="invite" name="invite" required placeholder="" />
        <p class="hint" id="code-hint">Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.</p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span id="button-text">Bli med i betaen</span>
      </button>

      <div class="success-message" id="successBox">
        <span class="success-text" id="successText">
          Kode sendt! Sjekk e-posten din og skriv inn 6-sifret kode under.
        </span>
      </div>
    </form>

    <div class="login-link" id="login-link-row">
      Har du allerede konto? <a href="#login" id="loginAnchor">Logg inn</a>
    </div>
  </div>

  <div class="footer" id="footer-text">Laget i Uranusvegen 30 üåô ¬∑ Familieversjon 1.0</div>

  <script>
    // Supabase ‚Äì dine verdier (anon key er OK i frontend)
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Element SDK ‚Äì tema/tekster
    const defaultConfig = {
      main_title: "Bli med i familie-betaen üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      subtitle: "Du er invitert til √• teste v√•r nye budsjett-app f√∏r alle andre.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      footer_text: "Laget i Troms√∏ üåô ¬∑ Familieversjon v0.9 beta",
      background_color: "#e8f5e9",
      card_color: "#ffffff",
      primary_color: "#4caf50",
      text_color: "#1b5e20",
      accent_color: "#558b2f"
    };

    async function onConfigChange(config) {
      document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('email-label').textContent = config.email_label || defaultConfig.email_label;
      document.getElementById('code-label').textContent = config.code_label || defaultConfig.code_label;
      document.getElementById('code-hint').textContent = config.code_hint || defaultConfig.code_hint;
      document.getElementById('button-text').textContent = config.button_text || defaultConfig.button_text;
      document.getElementById('footer-text').textContent = config.footer_text || defaultConfig.footer_text;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #fff8e1 100%)`;
      document.querySelector('.card').style.background = cardColor;
      document.querySelector('.submit-btn').style.background = primaryColor;
      document.querySelector('.title').style.color = textColor;
      document.querySelectorAll('.badge')?.forEach(b => b.style.color = accentColor);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
        mapToEditPanelValues: (config) => new Map([
          ["main_title", config.main_title || defaultConfig.main_title],
          ["subtitle", config.subtitle || defaultConfig.subtitle],
          ["email_label", config.email_label || defaultConfig.email_label],
          ["code_label", config.code_label || defaultConfig.code_label],
          ["code_hint", config.code_hint || defaultConfig.code_hint],
          ["button_text", config.button_text || defaultConfig.button_text],
          ["footer_text", config.footer_text || defaultConfig.footer_text]
        ])
      });
    }

    // ===== State for login/registrering ======================================
    const qs = (sel) => document.querySelector(sel);

    let isLoginMode = false;   // false = "Bli med i betaen", true = "Logg inn"
    let flowStep = 'email';    // 'email' eller 'otp'
    let lastEmail = null;

    // Bytt til "Logg inn"-modus
    function switchToLoginMode() {
      isLoginMode = true;
      flowStep = 'email';

      document.getElementById('main-title').textContent = 'Logg inn';
      document.getElementById('subtitle').textContent =
        'Skriv e-posten din, s√• sender vi en 6-sifret kode.';
      document.getElementById('button-text').textContent = 'Send kode';
      document.getElementById('successText').textContent =
        'Kode sendt! Skriv den inn for √• logge inn.';

      const group = document.getElementById('inviteGroup');
      if (group) group.style.display = 'none';
      const invite = document.getElementById('invite');
      if (invite) invite.required = false;

      const loginRow = document.getElementById('login-link-row');
      if (loginRow) loginRow.style.display = 'none';

      const emailInput = qs('#email');
      const emailLabel = qs('#email-label');
      const emailHint = qs('#email-hint');

      if (emailInput && emailLabel) {
        emailLabel.textContent = 'E-postadresse';
        emailInput.type = 'email';
        emailInput.value = '';
        emailInput.placeholder = 'din@epost.no';
        emailInput.inputMode = 'email';
        emailInput.removeAttribute('pattern');
        emailInput.removeAttribute('maxLength');
      }
      if (emailHint) {
        emailHint.style.display = 'none';
        emailHint.textContent = '';
      }

      const successBox = qs('#successBox');
      if (successBox) successBox.classList.remove('show');
    }

    // OTP-steget for LOGIN
    function enterLoginOtpStep(email) {
      flowStep = 'otp';
      lastEmail = email;

      const emailInput = qs('#email');
      const emailLabel = qs('#email-label');
      const emailHint = qs('#email-hint');
      const btnText = qs('#button-text');
      const successBox = qs('#successBox');
      const successText = qs('#successText');

      if (emailLabel) emailLabel.textContent = 'Engangskode';
      if (emailInput) {
        emailInput.type = 'text';
        emailInput.value = '';
        emailInput.placeholder = 'Skriv 6-sifret kode';
        emailInput.inputMode = 'numeric';
        emailInput.pattern = '[0-9]*';
        emailInput.maxLength = 6;
        emailInput.focus();
      }
      if (btnText) btnText.textContent = 'Logg inn';
      if (successBox) successBox.classList.add('show');
      if (successText) {
        successText.textContent = `Vi har sendt en kode til ${email}. Skriv den inn for √• logge inn.`;
      }
      if (emailHint) {
        emailHint.style.display = 'block';
        emailHint.textContent = 'Tips: sjekk s√∏ppelpost hvis du ikke finner e-posten.';
      }
    }

    // OTP-steget for REGISTRERING
    function enterRegisterOtpStep(email) {
      flowStep = 'otp';
      lastEmail = email;

      const emailInput = qs('#email');
      const emailLabel = qs('#email-label');
      const emailHint = qs('#email-hint');
      const btnText = qs('#button-text');
      const successBox = qs('#successBox');
      const successText = qs('#successText');

      if (emailLabel) emailLabel.textContent = 'Engangskode';
      if (emailInput) {
        emailInput.type = 'text';
        emailInput.value = '';
        emailInput.placeholder = 'Skriv 6-sifret kode';
        emailInput.inputMode = 'numeric';
        emailInput.pattern = '[0-9]*';
        emailInput.maxLength = 6;
        emailInput.focus();
      }
      if (btnText) btnText.textContent = 'Fullf√∏r';
      if (successBox) successBox.classList.add('show');
      if (successText) {
        successText.textContent =
          `Vi har sendt en kode til ${email}. Skriv den inn for √• fullf√∏re registreringen.`;
      }
      if (emailHint) {
        emailHint.style.display = 'block';
        emailHint.textContent = 'Tips: sjekk s√∏ppelpost hvis du ikke finner e-posten.';
      }

      const group = document.getElementById('inviteGroup');
      if (group) group.style.display = 'none';
    }

    // ===== Submit-knappen: h√•ndter begge steg + begge modi ===================
    async function handleSubmit(e) {
      e.preventDefault();

      const emailInput = qs('#email');
      if (!emailInput) return;

      const value = emailInput.value.trim();
      const inviteInput = qs('#invite');
      const inviteCode = inviteInput ? inviteInput.value.trim() : '';
      const btn = qs('#submitBtn');

      // LOGIN: steg 2 ‚Äì verifiser kode
      if (isLoginMode && flowStep === 'otp') {
        const token = value;
        if (!lastEmail || token.length < 4) {
          alert('Skriv inn koden fra e-posten');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Logger inn...';

        try {
          const { error } = await supa.auth.verifyOtp({
            email: lastEmail,
            token,
            type: 'email'
          });
          if (error) throw error;

          if (window.authHelpers?.protectPage) {
            await window.authHelpers.protectPage(supa);
          } else {
            window.location.href = '/index.html';
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'Feil kode. Pr√∏v igjen.');
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
        return;
      }

      // REGISTRERING: steg 2 ‚Äì verifiser kode
      if (!isLoginMode && flowStep === 'otp') {
        const token = value;
        if (!lastEmail || token.length < 4) {
          alert('Skriv inn koden fra e-posten');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Fullf√∏rer...';

        try {
          const { error } = await supa.auth.verifyOtp({
            email: lastEmail,
            token,
            type: 'email'
          });
          if (error) throw error;

          if (window.authHelpers?.protectPage) {
            await window.authHelpers.protectPage(supa);
          } else {
            window.location.href = '/index.html';
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'Feil kode. Pr√∏v igjen.');
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
        return;
      }

      // Felles: steg 1 ‚Äì send kode (login ELLER registrering)
      const email = value;
      if (!email) {
        alert('Skriv inn e-post');
        return;
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Sender kode...';

      try {
        // Registrering: valider invitasjonskode via RPC + lagre pending_invite
        if (!isLoginMode) {
          if (!inviteCode) {
            throw new Error('Skriv inn invitasjonskode');
          }

          const { data: household, error: hErr } = await supa
            .rpc('validate_invite_code', { p_code: inviteCode })
            .single();

          if (hErr || !household || !household.active) {
            throw new Error('Ugyldig eller deaktivert husstandskode');
          }

          localStorage.setItem('pending_invite', inviteCode);
        }

        const { error } = await supa.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: location.origin + '/index.html' }
        });
        if (error) throw error;

        if (isLoginMode) {
          enterLoginOtpStep(email);
        } else {
          enterRegisterOtpStep(email);
        }

      } catch (err) {
        console.error(err);
        alert(err.message || 'Kunne ikke sende engangskode');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // ===== Initial load / auth-guard ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        if (window.location.pathname !== '/innlogging.html') return;
      }

      const p = new URL(location.href).searchParams.get('code');
      if (p && qs('#invite')) {
        qs('#invite').value = p;
      }

      if (location.hash === '#login') {
        switchToLoginMode();
      }

      if (!isLoginMode) {
        const inviteInput = document.querySelector('#invite');
        if (inviteInput) {
          inviteInput.classList.add('pulse-once');
        }
      }

      qs('#loginForm')?.addEventListener('submit', handleSubmit);
    });

    // "Har du allerede konto? Logg inn"
    qs('#loginAnchor').addEventListener('click', (e) => {
      e.preventDefault();
      switchToLoginMode();
      qs('#email')?.focus();
    });
  </script>
</body>
</html>
