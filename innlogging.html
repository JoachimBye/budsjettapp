<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <!-- Element SDK (for tekst/tema-redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt ‚Äì du bruker mest custom CSS under) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2rem 1rem;
    }
    * { box-sizing: border-box; }
    .logo { font-size: 3rem; margin-bottom: .5rem; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .app-name { font-size: 1.25rem; color:#2e7d32; font-weight:600; margin-bottom:2rem; display:flex; align-items:center; gap:.5rem; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,.1); padding:2.5rem; max-width:480px; width:100%; margin-bottom:1.5rem; }
    .title { font-size:1.75rem; font-weight:700; color:#1b5e20; margin-bottom:.5rem; text-align:center; }
    .subtitle { font-size:1rem; color:#558b2f; margin-bottom:2rem; text-align:center; line-height:1.5; }
    .form-group { margin-bottom:1.5rem; }
    label { display:block; font-size:.9rem; font-weight:600; color:#2e7d32; margin-bottom:.5rem; }
    input { width:100%; padding:.875rem 1rem; border:2px solid #c8e6c9; border-radius:.5rem; font-size:1rem; transition:all .3s ease; background:#fff; }
    input:focus { outline:none; border-color:#4caf50; box-shadow:0 0 0 3px rgba(76,175,80,.1); }
    .hint { font-size:.85rem; color:#689f38; margin-top:.5rem; line-height:1.4; }
    .submit-btn { width:100%; padding:1rem; background:#4caf50; color:#fff; border:none; border-radius:.5rem; font-size:1.1rem; font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:1rem; }
    .submit-btn:hover { background:#45a049; transform:translateY(-2px); box-shadow:0 4px 12px rgba(76,175,80,.3); }
    .submit-btn:active { transform:translateY(0); }
    .submit-btn:disabled { background:#a5d6a7; cursor:not-allowed; transform:none; }
    .success-message { background:#e8f5e9; border:2px solid #4caf50; border-radius:.5rem; padding:1rem; margin-top:1rem; display:none; align-items:center; gap:.75rem; animation:slideIn .3s ease; }
    .success-message.show { display:flex; }
    @keyframes slideIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
    .success-icon { font-size:1.5rem; }
    .success-text { color:#2e7d32; font-weight:600; flex:1; }
    .info-box { background:#fff3e0; border-left:4px solid #ff9800; border-radius:.5rem; padding:1rem; margin-top:1.5rem; font-size:.9rem; color:#e65100; line-height:1.5; }
    .progress-bar { background:#e0e0e0; border-radius:1rem; height:.5rem; margin-top:1.5rem; overflow:hidden; }
    .progress-fill { background:linear-gradient(90deg,#4caf50,#8bc34a); height:100%; width:90%; border-radius:1rem; transition:width .5s ease; }
    .progress-text { font-size:.85rem; color:#558b2f; text-align:center; margin-top:.5rem; font-weight:600; }
    .security-badges { display:flex; justify-content:center; gap:1.5rem; margin-top:2rem; padding-top:1.5rem; border-top:1px solid #e0e0e0; flex-wrap:wrap; }
    .badge { display:flex; align-items:center; gap:.5rem; font-size:.85rem; color:#558b2f; }
    .footer { text-align:center; color:#689f38; font-size:.9rem; margin-top:1rem; }
    .login-link { text-align:center; margin-top:1.5rem; font-size:.9rem; color:#558b2f; }
    .login-link a { color:#2e7d32; text-decoration:none; font-weight:600; }
    .login-link a:hover { text-decoration:underline; }
    @media (max-width:640px){ .card{padding:1.5rem} .title{font-size:1.5rem} .security-badges{gap:1rem} }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <div class="logo">üçΩÔ∏è</div>
  <div class="app-name">Familie-budsjett</div>

  <div class="card">
    <h1 class="title" id="main-title">Bli med i familie-betaen üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h1>
    <p class="subtitle" id="subtitle">Du er invitert til √• teste v√•r nye budsjett-app f√∏r alle andre.</p>

    <form id="loginForm">
      <div class="form-group">
        <label for="email" id="email-label">E-postadresse</label>
        <input type="email" id="email" name="email" required placeholder="din@epost.no" autocomplete="email"/>
      </div>

      <div class="form-group">
        <label for="invite" id="code-label">Husstandskode (invitasjonskode)</label>
        <input type="text" id="invite" name="invite" required placeholder="NORDMO2025" />
        <p class="hint" id="code-hint">Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.</p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn"><span id="button-text">Bli med i betaen</span></button>

      <div class="success-message" id="successBox">
        <span class="success-icon">‚úîÔ∏è</span>
        <span class="success-text">Lenke sendt! Sjekk e-posten din.</span>
      </div>
    </form>

    <div class="info-box" id="exclusivity-text">
      üéâ Du er blant de f√∏rste som tester denne appen. Dine tilbakemeldinger gj√∏r at vi kan gj√∏re den enda bedre f√∏r lansering.
    </div>

    <div class="progress-bar"><div class="progress-fill"></div></div>
    <p class="progress-text">27 / 30 plasser opptatt</p>

    <div class="security-badges">
      <div class="badge">üîí Trygt for familien</div>
      <div class="badge">üö´ Ingen deling av data</div>
      <div class="badge">‚ú® Meld deg ut n√•r som helst</div>
    </div>

    <div class="login-link">Har du allerede konto? <a href="#login" id="loginAnchor">Logg inn</a></div>
  </div>

  <div class="footer" id="footer-text">Laget i Troms√∏ üåô ¬∑ Familieversjon v0.9 beta</div>

  <script>
    // TODO: Sett disse fra Supabase ‚Üí Project Settings ‚Üí API
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // (Valgfritt) Standard-konfig for Element SDK
    const defaultConfig = {
      main_title: "Bli med i familie-betaen üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      subtitle: "Du er invitert til √• teste v√•r nye budsjett-app f√∏r alle andre.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      exclusivity_text: "üéâ Du er blant de f√∏rste som tester denne appen. Dine tilbakemeldinger gj√∏r at vi kan gj√∏re den enda bedre f√∏r lansering.",
      footer_text: "Laget i Troms√∏ üåô ¬∑ Familieversjon v0.9 beta",
      background_color: "#e8f5e9",
      card_color: "#ffffff",
      primary_color: "#4caf50",
      text_color: "#1b5e20",
      accent_color: "#558b2f"
    };

    async function onConfigChange(config) {
      document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('email-label').textContent = config.email_label || defaultConfig.email_label;
      document.getElementById('code-label').textContent = config.code_label || defaultConfig.code_label;
      document.getElementById('code-hint').textContent = config.code_hint || defaultConfig.code_hint;
      document.getElementById('button-text').textContent = config.button_text || defaultConfig.button_text;
      document.getElementById('exclusivity-text').textContent = config.exclusivity_text || defaultConfig.exclusivity_text;
      document.getElementById('footer-text').textContent = config.footer_text || defaultConfig.footer_text;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #fff8e1 100%)`;
      document.querySelector('.card').style.background = cardColor;
      document.querySelector('.submit-btn').style.background = primaryColor;
      document.querySelector('.title').style.color = textColor;
      document.querySelectorAll('.badge').forEach(b => b.style.color = accentColor);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
        mapToEditPanelValues: (config) => new Map([
          ["main_title", config.main_title || defaultConfig.main_title],
          ["subtitle", config.subtitle || defaultConfig.subtitle],
          ["email_label", config.email_label || defaultConfig.email_label],
          ["code_label", config.code_label || defaultConfig.code_label],
          ["code_hint", config.code_hint || defaultConfig.code_hint],
          ["button_text", config.button_text || defaultConfig.button_text],
          ["exclusivity_text", config.exclusivity_text || defaultConfig.exclusivity_text],
          ["footer_text", config.footer_text || defaultConfig.footer_text]
        ])
      });
    }

    // Hjelpefunksjoner
    const qs = (sel) => document.querySelector(sel);

    // Redirect hvis allerede innlogget
    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supa.auth.getSession();
      if (session) window.location.href = '/app.html';
    });

    // Klikk p√• "Logg inn" -> fokus p√• e-postfelt
    qs('#loginAnchor').addEventListener('click', (e) => {
      e.preventDefault();
      qs('#email')?.focus();
    });

    // Submit: sjekk husstandskode -> send magisk lenke
    async function handleSubmit(e) {
      e.preventDefault();
      const email = qs('#email').value.trim();
      const inviteCode = qs('#invite').value.trim();
      const btn = qs('#submitBtn');

      if (!email || !inviteCode) return alert('Skriv inn e-post og husstandskode');

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Sender...';

      try {
        // 1) Valider invitasjonskode i Supabase (households-tabellen m√• finnes der)
        const { data: household, error: hErr } = await supa
          .from('households')
          .select('id, max_members, active')
          .eq('invite_code', inviteCode)
          .single();

        if (hErr || !household || !household.active) {
          throw new Error('Ugyldig eller deaktivert husstandskode');
        }

        // 2) Send magisk lenke
        const { error } = await supa.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.origin + '/app.html',
            data: { invite_code: inviteCode, beta: true } // metadata f√∏lger brukeren
          }
        });
        if (error) throw error;

        // 3) Vis suksess
        qs('#successBox').classList.add('show');
      } catch (err) {
        alert(err.message || 'Kunne ikke sende magisk lenke');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      qs('#loginForm').addEventListener('submit', handleSubmit);
    });
  </script>
</body>
</html>
