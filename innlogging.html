<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <!-- Element SDK (for tekst/tema-redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2rem 1rem;
      overflow: hidden;
      position: relative;
    }
    * { box-sizing: border-box; }

    .card {
      background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,.1);
      padding:2.5rem; max-width:480px; width:100%; margin-bottom:1.5rem;
      position: relative;
      z-index: 10;
    }
    .title {
      font-size:1.75rem; font-weight:700; color:#1b5e20;
      margin-bottom:.5rem; text-align:center;
    }
    .subtitle {
      font-size:1rem; color:#558b2f; margin-bottom:2rem;
      text-align:center; line-height:1.5;
    }
    .form-group { margin-bottom:1.5rem; }
    label {
      display:block; font-size:.9rem; font-weight:600;
      color:#2e7d32; margin-bottom:.5rem;
    }
    input {
      width:100%; padding:.875rem 1rem;
      border:2px solid #c8e6c9; border-radius:.5rem;
      font-size:1rem; transition:all .3s ease; background:#fff;
      position: relative;
    }
    input:focus {
      outline:none; border-color:#4caf50;
      box-shadow:0 0 0 3px rgba(76,175,80,.1);
    }
    .hint { font-size:.85rem; color:#689f38; margin-top:.5rem; line-height:1.4; }

    .submit-btn {
      width:100%; padding:1rem; background:#4caf50; color:#fff;
      border:none; border-radius:.5rem; font-size:1.1rem;
      font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:1rem;
    }
    .submit-btn:hover {
      background:#45a049; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(76,175,80,.3);
    }
    .submit-btn:disabled {
      background:#a5d6a7; cursor:not-allowed; transform:none;
      box-shadow:none;
    }

    .success-message {
      background:#e8f5e9; border:2px solid #4caf50;
      border-radius:.5rem; padding:1rem; margin-top:1rem;
      display:none; align-items:center; gap:.75rem;
    }
    .success-message.show { display:flex; }
    .success-text { color:#2e7d32; font-weight:600; flex:1; }

    .login-link {
      text-align:center; margin-top:1.5rem;
      font-size:.9rem; color:#558b2f;
    }
    .login-link a {
      color:#2e7d32; text-decoration:none; font-weight:600;
    }
    .login-link a:hover { text-decoration:underline; }

    .footer {
      text-align:center; color:#558b2f; font-size:.85rem;
    }

    /* Inline feilmelding */
    .error-hint {
      margin-top: .75rem;
      font-size: .85rem;
      color: #d32f2f;
      line-height: 1.4;
    }

    @media (max-width:640px){
      .card{padding:1.5rem}
      .title{font-size:1.5rem}
    }

    @view-transition { navigation: auto; }

    /* --- Flytende "boble"-bakgrunn --- */
    .floating-bubbles {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .bubble {
      position: absolute;
      border-radius: 9999px;
      background: radial-gradient(circle, rgba(200, 230, 201, 0.5), rgba(240, 244, 195, 0.3));
      animation: floatUpDown 25s ease-in-out infinite;
    }
    .bubble-1 {
      width: 200px;
      height: 200px;
      top: 10%;
      left: 5%;
      animation-duration: 30s;
    }
    .bubble-2 {
      width: 300px;
      height: 300px;
      top: 60%;
      right: -10%;
      animation-duration: 25s;
      animation-delay: 2s;
    }
    .bubble-3 {
      width: 150px;
      height: 150px;
      bottom: 5%;
      left: 30%;
      animation-duration: 20s;
    }
    .bubble-4 {
      width: 250px;
      height: 250px;
      top: -5%;
      left: 60%;
      animation-duration: 35s;
      animation-delay: 1s;
    }

    @keyframes floatUpDown {
      0%   { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
      50%  { transform: translateY(-28px) translateX(10px) scale(1.05); opacity: 0.9; }
      100% { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
    }

    /* Pop-in animasjon p√• kortet */
    .login-card {
      animation: cardEnter 0.6s 0.1s ease-out backwards;
    }

    @keyframes cardEnter {
      0%   { opacity: 0; transform: translateY(24px) scale(0.96); }
      60%  { opacity: 1; transform: translateY(0) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Invitasjonskode "pulse" */
    input#invite.pulse-once {
      animation: softPulse 1.4s ease-out 0.8s 2;
    }

    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.40); }
      100% { box-shadow: 0 0 0 14px rgba(76, 175, 80, 0.00); }
    }

    /* Redusert bevegelse */
    @media (prefers-reduced-motion: reduce) {
      .floating-bubbles .bubble,
      .login-card,
      input#invite.pulse-once {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>

  <!-- Bakgrunnsbobler -->
  <div class="floating-bubbles" aria-hidden="true">
    <span class="bubble bubble-1"></span>
    <span class="bubble bubble-2"></span>
    <span class="bubble bubble-3"></span>
    <span class="bubble bubble-4"></span>
  </div>

  <div class="card login-card">
    <h1 class="title" id="main-title">Bli med i familie betaen</h1>
    <p class="subtitle" id="subtitle">
      Du er invitert til √• teste v√•r nye budsjett app f√∏r alle andre.
    </p>

    <form id="loginForm">
      <!-- Steg 1: e-post -->
      <div class="form-group" id="emailGroup">
        <label for="email" id="email-label">E-postadresse</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder="din@epost.no"
          autocomplete="email"
        />
        <p class="hint" id="email-hint" style="display:none;"></p>
      </div>

      <!-- Steg 1 (kun registrering): invitasjonskode -->
      <div class="form-group" id="inviteGroup">
        <label for="invite" id="code-label">Invitasjonskode</label>
        <input
          type="text"
          id="invite"
          name="invite"
          required
          placeholder=""
        />
        <p class="hint" id="code-hint">
          Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.
        </p>
      </div>

      <!-- Steg 2: OTP-kode (skjules i steg 1) -->
      <div class="form-group" id="otpGroup" style="display:none;">
        <label for="otpInput" id="otp-label">Engangskode</label>
        <input
          type="text"
          id="otpInput"
          name="otp"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="6"
          placeholder="Skriv 6-sifret kode"
        />
        <p class="hint" id="otp-hint">
          Sjekk e-posten din. Tips: se i s√∏ppelpost/spam hvis du ikke finner den.
        </p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span id="button-text">Bli med i betaen</span>
      </button>

      <!-- Inline feilmelding -->
      <p class="error-hint" id="errorHint" style="display:none;"></p>

      <div class="success-message" id="successBox">
        <span class="success-text" id="successText">
          Kode sendt! Sjekk e-posten din og skriv inn 6-sifret kode.
        </span>
      </div>
    </form>

    <div class="login-link" id="login-link-row">
      Har du allerede konto?
      <a href="#login" id="loginAnchor">Logg inn</a>
    </div>
  </div>

  <div class="footer" id="footer-text">
    Laget i Uranusvegen 30 üåô ¬∑ Familieversjon 1.0
  </div>

  <script>
    // ===== Supabase init =====================================================
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== Element SDK ‚Äì enkel tekst/tema-konfig ============================
    const defaultConfig = {
      main_title: "Bli med i familie-betaen üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      subtitle: "Du er invitert til √• teste v√•r nye budsjett-app f√∏r alle andre.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      footer_text: "Laget i Troms√∏ üåô ¬∑ Familieversjon v0.9 beta",
      background_color: "#e8f5e9",
      card_color: "#ffffff",
      primary_color: "#4caf50",
      text_color: "#1b5e20",
      accent_color: "#558b2f"
    };

    function onConfigChange(config) {
      document.getElementById('main-title').textContent =
        config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent =
        config.subtitle || defaultConfig.subtitle;
      document.getElementById('email-label').textContent =
        config.email_label || defaultConfig.email_label;
      document.getElementById('code-label').textContent =
        config.code_label || defaultConfig.code_label;
      document.getElementById('code-hint').textContent =
        config.code_hint || defaultConfig.code_hint;
      document.getElementById('button-text').textContent =
        config.button_text || defaultConfig.button_text;
      document.getElementById('footer-text').textContent =
        config.footer_text || defaultConfig.footer_text;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;

      document.body.style.background =
        `linear-gradient(135deg, ${backgroundColor} 0%, #fff8e1 100%)`;
      document.querySelector('.card').style.background = cardColor;
      document.querySelector('.submit-btn').style.background = primaryColor;
      document.querySelector('.title').style.color = textColor;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) =>
          new Map([
            ["main_title", config.main_title || defaultConfig.main_title],
            ["subtitle", config.subtitle || defaultConfig.subtitle],
            ["email_label", config.email_label || defaultConfig.email_label],
            ["code_label", config.code_label || defaultConfig.code_label],
            ["code_hint", config.code_hint || defaultConfig.code_hint],
            ["button_text", config.button_text || defaultConfig.button_text],
            ["footer_text", config.footer_text || defaultConfig.footer_text]
          ])
      });
    }

    // ===== State + UI =======================================================
    const qs = (sel) => document.querySelector(sel);

    const state = {
      mode: 'register',   // 'register' | 'login'
      step: 'email',      // 'email' | 'otp'
      isLoading: false,
      lastEmail: null,
      error: null
    };

    const ui = {
      elements: {
        form: qs('#loginForm'),
        title: qs('#main-title'),
        subtitle: qs('#subtitle'),
        emailGroup: qs('#emailGroup'),
        emailLabel: qs('#email-label'),
        emailInput: qs('#email'),
        emailHint: qs('#email-hint'),
        inviteGroup: qs('#inviteGroup'),
        inviteInput: qs('#invite'),
        otpGroup: qs('#otpGroup'),
        otpLabel: qs('#otp-label'),
        otpInput: qs('#otpInput'),
        otpHint: qs('#otp-hint'),
        submitBtn: qs('#submitBtn'),
        buttonText: qs('#button-text'),
        successBox: qs('#successBox'),
        successText: qs('#successText'),
        errorHint: qs('#errorHint'),
        loginLinkRow: qs('#login-link-row'),
        loginAnchor: qs('#loginAnchor')
      },

      render() {
        const {
          mode,
          step,
          isLoading,
          lastEmail,
          error
        } = state;

        const el = this.elements;

        // Feilmelding
        if (el.errorHint) {
          el.errorHint.textContent = error || '';
          el.errorHint.style.display = error ? 'block' : 'none';
        }

        // Loading-state
        if (el.submitBtn && el.buttonText) {
          el.submitBtn.disabled = isLoading;
          if (isLoading) {
            el.buttonText.textContent =
              step === 'email'
                ? (mode === 'register' ? 'Sender kode...' : 'Sender kode...')
                : (mode === 'register' ? 'Fullf√∏rer...' : 'Logger inn...');
          } else {
            el.buttonText.textContent =
              step === 'email'
                ? (mode === 'register' ? 'Bli med i betaen' : 'Send kode')
                : (mode === 'register' ? 'Fullf√∏r' : 'Logg inn');
          }
        }

        // Hva skal vises hvor?
        if (el.emailGroup) {
          el.emailGroup.style.display = (step === 'email') ? 'block' : 'none';
        }
 if (el.inviteGroup) {
  const showInvite = (step === 'email' && mode === 'register');
  el.inviteGroup.style.display = showInvite ? 'block' : 'none';

  if (el.inviteInput) {
    if (showInvite) {
      el.inviteInput.setAttribute('required', 'required');
    } else {
      el.inviteInput.removeAttribute('required');
    }
  }
}
        if (el.otpGroup) {
          el.otpGroup.style.display = (step === 'otp') ? 'block' : 'none';
        }
        if (el.loginLinkRow) {
          el.loginLinkRow.style.display = (step === 'email') ? 'block' : 'none';
        }

        // Tittel + undertekst
        if (step === 'email') {
          if (el.title) {
            el.title.textContent =
              mode === 'register'
                ? 'Bli med i familie betaen'
                : 'Logg inn';
          }
          if (el.subtitle) {
            el.subtitle.textContent =
              mode === 'register'
                ? 'Du er invitert til √• teste v√•r nye budsjett app f√∏r alle andre.'
                : 'Skriv e-posten din, s√• sender vi en 6-sifret kode.';
          }
          if (el.emailInput) {
            el.emailInput.value = el.emailInput.value || '';
            el.emailInput.type = 'email';
            el.emailInput.placeholder = 'din@epost.no';
            el.emailInput.inputMode = 'email';
          }
          if (el.emailHint) {
            el.emailHint.style.display = 'none';
            el.emailHint.textContent = '';
          }
          if (el.successBox) {
            el.successBox.classList.remove('show');
          }
        } else {
          // OTP-steg
          if (el.title) el.title.textContent = 'Sjekk e-posten din';
          if (el.subtitle) {
            el.subtitle.textContent =
              lastEmail
                ? `Vi har sendt en 6-sifret kode til ${lastEmail}.`
                : 'Vi har sendt deg en 6-sifret kode.';
          }
          if (el.otpInput) {
            if (!isLoading) el.otpInput.focus();
          }
          if (el.successBox) el.successBox.classList.add('show');
          if (el.successText && lastEmail) {
            el.successText.textContent =
              `Vi har sendt en kode til ${lastEmail}. Skriv den inn for √• fullf√∏re.`;
          }
        }

        // Liten visuell markering p√• invitasjonsfelt i registreringsmodus
        if (el.inviteInput) {
          if (mode === 'register' && step === 'email') {
            el.inviteInput.classList.add('pulse-once');
          } else {
            el.inviteInput.classList.remove('pulse-once');
          }
        }
      }
    };

    function setState(partial) {
      Object.assign(state, partial);
      ui.render();
    }

    // ===== Handlers ==========================================================
    async function handleEmailSubmit() {
      const el = ui.elements;
      const email = el.emailInput.value.trim();
      const inviteCode = el.inviteInput ? el.inviteInput.value.trim() : '';

      if (!email) {
        return setState({ error: 'Skriv inn e-postadresse.' });
      }

      setState({ isLoading: true, error: null });

      try {
        // Registrering: valider invitasjonskode f√∏rst
        if (state.mode === 'register') {
          if (!inviteCode) {
            throw new Error('Skriv inn invitasjonskode.');
          }

          const { data: household, error: hErr } = await supa
            .rpc('validate_invite_code', { p_code: inviteCode })
            .single();

          if (hErr || !household || !household.active) {
            throw new Error('Ugyldig eller deaktivert husstandskode.');
          }

          // Lagre intensjon ‚Äì brukes etter innlogging
          localStorage.setItem('pending_invite', inviteCode);
        }

        const { error } = await supa.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: location.origin + '/index.html'
          }
        });
        if (error) throw error;

        setState({
          step: 'otp',
          lastEmail: email,
          isLoading: false,
          error: null
        });
      } catch (err) {
        console.error(err);
        setState({
          isLoading: false,
          error: err.message || 'Kunne ikke sende engangskode. Pr√∏v igjen.'
        });
      }
    }

    async function handleOtpSubmit() {
      const el = ui.elements;
      const token = el.otpInput.value.trim();

      if (!token) {
        return setState({ error: 'Skriv inn 6-sifret kode.' });
      }
      if (!state.lastEmail) {
        return setState({ error: 'Noe gikk galt ‚Äì pr√∏v √• starte p√• nytt.' });
      }

      setState({ isLoading: true, error: null });

      try {
        const { error } = await supa.auth.verifyOtp({
          email: state.lastEmail,
          token,
          type: 'email'
        });
        if (error) throw error;

        // La auth-helpers bestemme hvor vi skal videre
        if (window.authHelpers?.protectPage) {
          await window.authHelpers.protectPage(supa);
        } else {
          window.location.href = '/index.html';
        }
      } catch (err) {
        console.error(err);
        setState({
          isLoading: false,
          error: 'Feil kode. Pr√∏v igjen.'
        });
      }
    }

    function onFormSubmit(e) {
      e.preventDefault();
      if (state.step === 'email') {
        handleEmailSubmit();
      } else {
        handleOtpSubmit();
      }
    }

    // üîß OPPDATERT FUNKSJON HER
    function switchToLoginMode(e) {
      if (e) e.preventDefault();
      setState({
        mode: 'login',
        step: 'email',
        isLoading: false,
        error: null,
        lastEmail: null
      });

      // Bare auto-fokuser e-postfeltet n√•r vi *ikke* kommer fra et klikk-event
      // (f.eks. n√•r siden √•pnes med #login i URL).
      if (!e && ui.elements.emailInput) {
        ui.elements.emailInput.focus();
      }
    }

    // ===== Init / bootstrap ==================================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Auth-guard ‚Äì kan sende oss til /app.html hvis vi allerede er logget inn
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        if (window.location.pathname !== '/innlogging.html') return;
      }

      // URL ?code=... -> forh√•ndsfyll invitasjonskode
      const url = new URL(location.href);
      const codeFromUrl = url.searchParams.get('code');
      if (codeFromUrl && ui.elements.inviteInput) {
        ui.elements.inviteInput.value = codeFromUrl;
      }

      // Start i login-modus hvis #login
      if (location.hash === '#login') {
        switchToLoginMode();
      } else {
        // initial render i register-modus
        ui.render();
      }

      // Lytt p√• submit
      if (ui.elements.form) {
        ui.elements.form.addEventListener('submit', onFormSubmit);
      }

      // "Har du allerede konto? Logg inn"
      if (ui.elements.loginAnchor) {
        ui.elements.loginAnchor.addEventListener('click', switchToLoginMode);
      }
    });
  </script>
</body>
</html>
