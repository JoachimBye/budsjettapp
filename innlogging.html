<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <!-- Element SDK (for tekst/tema-redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Tailwind (valgfritt â€“ du bruker mest custom CSS under) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2rem 1rem;
    }
    * { box-sizing: border-box; }
    .card {
      background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,.1);
      padding:2.5rem; max-width:480px; width:100%; margin-bottom:1.5rem;
    }
    .title {
      font-size:1.75rem; font-weight:700; color:#1b5e20;
      margin-bottom:.5rem; text-align:center;
    }
    .subtitle {
      font-size:1rem; color:#558b2f; margin-bottom:2rem;
      text-align:center; line-height:1.5;
    }
    .form-group { margin-bottom:1.5rem; }
    label {
      display:block; font-size:.9rem; font-weight:600;
      color:#2e7d32; margin-bottom:.5rem;
    }
    input {
      width:100%; padding:.875rem 1rem;
      border:2px solid #c8e6c9; border-radius:.5rem;
      font-size:1rem; transition:all .3s ease; background:#fff;
    }
    input:focus {
      outline:none; border-color:#4caf50;
      box-shadow:0 0 0 3px rgba(76,175,80,.1);
    }
    .hint { font-size:.85rem; color:#689f38; margin-top:.5rem; line-height:1.4; }
    .submit-btn {
      width:100%; padding:1rem; background:#4caf50; color:#fff;
      border:none; border-radius:.5rem; font-size:1.1rem;
      font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:1rem;
    }
    .submit-btn:hover {
      background:#45a049; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(76,175,80,.3);
    }
    .submit-btn:disabled {
      background:#a5d6a7; cursor:not-allowed; transform:none;
    }
    .success-message {
      background:#e8f5e9; border:2px solid #4caf50;
      border-radius:.5rem; padding:1rem; margin-top:1rem;
      display:none; align-items:center; gap:.75rem;
    }
    .success-message.show { display:flex; }
    .success-text { color:#2e7d32; font-weight:600; flex:1; }
    .login-link {
      text-align:center; margin-top:1.5rem;
      font-size:.9rem; color:#558b2f;
    }
    .login-link a {
      color:#2e7d32; text-decoration:none; font-weight:600;
    }
    .login-link a:hover { text-decoration:underline; }
    .footer { text-align:center; color:#558b2f; font-size:.85rem; }
    @media (max-width:640px){
      .card{padding:1.5rem}
      .title{font-size:1.5rem}
    }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>

  <div class="card">
    <h1 class="title" id="main-title">Bli med i familie betaen</h1>
    <p class="subtitle" id="subtitle">Du er invitert til Ã¥ teste vÃ¥r nye budsjett app fÃ¸r alle andre.</p>

    <form id="loginForm">
      <div class="form-group">
        <label for="email" id="email-label">E-postadresse</label>
        <input type="email" id="email" name="email" required placeholder="din@epost.no" autocomplete="email"/>
        <!-- Denne hint-teksten bruker vi om igjen i login-OTP-steget -->
        <p class="hint" id="email-hint" style="display:none;"></p>
      </div>

      <div class="form-group" id="inviteGroup">
        <label for="invite" id="code-label">Husstandskode (invitasjonskode)</label>
        <input type="text" id="invite" name="invite" required placeholder="NORDMO2025" />
        <p class="hint" id="code-hint">Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.</p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span id="button-text">Bli med i betaen</span>
      </button>

      <!-- Info etter utsending -->
      <div class="success-message" id="successBox">
        <span class="success-text" id="successText">
          Kode sendt! Sjekk e-posten din og skriv inn 6-sifret kode under.
        </span>
      </div>
    </form>

    <!-- OTP-steg for REGISTRERING (brukes ikke i login-modus) -->
    <div id="otpBox" style="display:none; margin-top:1rem;">
      <label for="otp" style="display:block; font-weight:600; color:#2e7d32; margin-bottom:0.5rem;">Engangskode</label>
      <input id="otp" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6"
             placeholder="Skriv 6-sifret kode fra e-post"
             style="width:100%; padding:0.875rem 1rem; border:2px solid #c8e6c9; border-radius:0.5rem;"/>
      <button id="otpBtn" class="submit-btn" style="margin-top:0.75rem;">Bekreft kode</button>
      <p class="hint" style="margin-top:0.5rem;">Tips: sjekk sÃ¸ppelpost hvis du ikke finner e-posten.</p>
    </div>

    <div class="login-link" id="login-link-row">
      Har du allerede konto? <a href="#login" id="loginAnchor">Logg inn</a>
    </div>
  </div>

  <div class="footer" id="footer-text">Laget i Uranusvegen 30 ðŸŒ™ Â· Familieversjon 1.0</div>

  <script>
    // Supabase â€“ dine verdier (anon key er OK i frontend)
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Element SDK â€“ uendret (du kan redigere tekster/tema)
    const defaultConfig = {
      main_title: "Bli med i familie-betaen ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
      subtitle: "Du er invitert til Ã¥ teste vÃ¥r nye budsjett-app fÃ¸r alle andre.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      footer_text: "Laget i TromsÃ¸ ðŸŒ™ Â· Familieversjon v0.9 beta",
      background_color: "#e8f5e9",
      card_color: "#ffffff",
      primary_color: "#4caf50",
      text_color: "#1b5e20",
      accent_color: "#558b2f"
    };

    async function onConfigChange(config) {
      document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('email-label').textContent = config.email_label || defaultConfig.email_label;
      document.getElementById('code-label').textContent = config.code_label || defaultConfig.code_label;
      document.getElementById('code-hint').textContent = config.code_hint || defaultConfig.code_hint;
      document.getElementById('button-text').textContent = config.button_text || defaultConfig.button_text;
      document.getElementById('footer-text').textContent = config.footer_text || defaultConfig.footer_text;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #fff8e1 100%)`;
      document.querySelector('.card').style.background = cardColor;
      document.querySelector('.submit-btn').style.background = primaryColor;
      document.querySelector('.title').style.color = textColor;
      document.querySelectorAll('.badge')?.forEach(b => b.style.color = accentColor);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
        mapToEditPanelValues: (config) => new Map([
          ["main_title", config.main_title || defaultConfig.main_title],
          ["subtitle", config.subtitle || defaultConfig.subtitle],
          ["email_label", config.email_label || defaultConfig.email_label],
          ["code_label", config.code_label || defaultConfig.code_label],
          ["code_hint", config.code_hint || defaultConfig.code_hint],
          ["button_text", config.button_text || defaultConfig.button_text],
          ["footer_text", config.footer_text || defaultConfig.footer_text]
        ])
      });
    }

    // ===== Login / register state ============================================
    const qs = (sel) => document.querySelector(sel);
    let lastEmail = null;
    let lastInvite = null;
    let isLoginMode = false;
    let loginStep = 'email'; // 'email' -> send kode, 'otp' -> verifiser

    function switchToLoginMode() {
      isLoginMode = true;
      loginStep = 'email';

      // Oppdater tekster
      document.getElementById('main-title').textContent = 'Logg inn';
      document.getElementById('subtitle').textContent = 'Skriv e-posten din, sÃ¥ sender vi en 6-sifret kode.';
      document.getElementById('button-text').textContent = 'Send kode';
      document.getElementById('successText').textContent = 'Kode sendt! Skriv den inn for Ã¥ logge inn.';

      // Skjul invitasjonsfelt
      const group = document.getElementById('inviteGroup');
      if (group) group.style.display = 'none';
      const invite = document.getElementById('invite');
      if (invite) invite.required = false;

      // Skjul "Har du allerede konto? Logg inn"
      const loginRow = document.getElementById('login-link-row');
      if (loginRow) loginRow.style.display = 'none';

      // Reset e-postfelt til e-post-modus (fÃ¸rste steg)
      const emailInput = qs('#email');
      const emailLabel = qs('#email-label');
      const emailHint = qs('#email-hint');
      if (emailInput && emailLabel) {
        emailLabel.textContent = 'E-postadresse';
        emailInput.type = 'email';
        emailInput.value = '';
        emailInput.placeholder = 'din@epost.no';
        emailInput.inputMode = 'email';
        emailInput.removeAttribute('pattern');
        emailInput.removeAttribute('maxLength');
      }
      if (emailHint) {
        emailHint.style.display = 'none';
        emailHint.textContent = '';
      }

      // Skjul registrerings-OTP-boks hvis den skulle vÃ¦re synlig
      const otpBox = qs('#otpBox');
      if (otpBox) otpBox.style.display = 'none';
    }

    // ===== Initial load / redirect-hÃ¥ndtering via auth-helpers ===============
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.authHelpers?.protectPage) {
        // La "hjernen" bestemme om vi skal vÃ¦re pÃ¥ /innlogging.html eller ikke
        await window.authHelpers.protectPage(supa);

        // Hvis vi ble sendt videre (f.eks. til /app.html), ikke gjÃ¸r mer her
        if (window.location.pathname !== '/innlogging.html') return;
      }

      // Autofyll ?code=XYZ i URL (for registrering)
      const p = new URL(location.href).searchParams.get('code');
      if (p && qs('#invite')) {
        qs('#invite').value = p;
      }

      // Hvis hash er #login â†’ gÃ¥ rett i login-modus
      if (location.hash === '#login') {
        switchToLoginMode();
      }

      // Lyttere
      qs('#loginForm')?.addEventListener('submit', handleSubmit);
      qs('#otpBtn')?.addEventListener('click', handleOtpVerify);
    });

    // â€œLogg innâ€-lenke (fra registreringsmodus) â†’ bytt til login-modus
    qs('#loginAnchor').addEventListener('click', (e) => {
      e.preventDefault();
      switchToLoginMode();
      qs('#email')?.focus();
    });

    // Hjelpefunksjon: gÃ¥ til OTP-steg i LOGIN-modus
    function enterLoginOtpStep(email) {
      loginStep = 'otp';
      lastEmail = email;

      const emailInput = qs('#email');
      const emailLabel = qs('#email-label');
      const emailHint = qs('#email-hint');
      const btnText = qs('#button-text');
      const successBox = qs('#successBox');
      const successText = qs('#successText');

      if (emailLabel) emailLabel.textContent = 'Engangskode';
      if (emailInput) {
        emailInput.type = 'text';
        emailInput.value = '';
        emailInput.placeholder = 'Skriv 6-sifret kode';
        emailInput.inputMode = 'numeric';
        emailInput.pattern = '[0-9]*';
        emailInput.maxLength = 6;
        emailInput.focus();
      }
      if (btnText) btnText.textContent = 'Logg inn';
      if (successBox) successBox.classList.add('show');
      if (successText) {
        successText.textContent = `Vi har sendt en kode til ${email}. Skriv den inn for Ã¥ logge inn.`;
      }
      if (emailHint) {
        emailHint.style.display = 'block';
        emailHint.textContent = 'Tips: sjekk sÃ¸ppelpost hvis du ikke finner e-posten.';
      }
    }

    // ===== 1) Submit-knapp â€“ send kode ELLER verifiser (login-modus steg 2) ==
    async function handleSubmit(e) {
      e.preventDefault();
      const emailInput = qs('#email');
      if (!emailInput) return;

      const emailOrCode = emailInput.value.trim();
      const inviteCode = qs('#invite') ? qs('#invite').value.trim() : '';
      const btn = qs('#submitBtn');

      // LOGIN: steg 2 â€“ verifiser kode
      if (isLoginMode && loginStep === 'otp') {
        if (!lastEmail || emailOrCode.length < 4) {
          alert('Skriv inn koden fra e-posten');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Logger inn...';

        try {
          const { error } = await supa.auth.verifyOtp({
            email: lastEmail,
            token: emailOrCode,
            type: 'email'
          });
          if (error) throw error;

          // La auth-helpers bestemme neste side
          if (window.authHelpers?.protectPage) {
            await window.authHelpers.protectPage(supa);
          } else {
            window.location.href = '/index.html';
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'Feil kode. PrÃ¸v igjen.');
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
        return;
      }

      // Felles: steg 1 â€“ send kode (login ELLER registrering)
      const email = emailOrCode;
      if (!email) {
        alert('Skriv inn e-post');
        return;
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Sender kode...';

      try {
        // Registrering: valider invitasjonskode + lagre pending_invite
        if (!isLoginMode) {
          const { data: household, error: hErr } = await supa
            .from('households')
            .select('id, max_members, active')
            .eq('invite_code', inviteCode)
            .single();

          if (hErr || !household || !household.active) {
            throw new Error('Ugyldig eller deaktivert husstandskode');
          }
          localStorage.setItem('pending_invite', inviteCode);
        }

        const { error } = await supa.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: location.origin + '/index.html' }
        });
        if (error) throw error;

        if (isLoginMode) {
          // Login: gÃ¥ til OTP-steg med samme input/knapp
          enterLoginOtpStep(email);
        } else {
          // Registrering: vis eksisterende OTP-boks
          qs('#successBox').classList.add('show');
          qs('#otpBox').style.display = 'block';
          lastEmail = email;
          lastInvite = inviteCode;
        }

      } catch (err) {
        console.error(err);
        alert(err.message || 'Kunne ikke sende engangskode');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // ===== 2) Verifiser OTP (registrering) â†’ logg inn â†’ sentral ruting =======
    async function handleOtpVerify() {
      const token = qs('#otp').value.trim();
      if (!lastEmail || token.length < 4) {
        alert('Skriv inn koden fra e-posten');
        return;
      }

      const otpBtn = qs('#otpBtn');
      otpBtn.disabled = true;
      const old = otpBtn.textContent;
      otpBtn.textContent = 'Bekrefter...';

      try {
        // Verifiser OTP (logger inn brukeren)
        const { error } = await supa.auth.verifyOtp({
          email: lastEmail,
          token,
          type: 'email'
        });
        if (error) throw error;

        // Etter vellykket registrering: la auth-helpers bestemme destinasjon
        if (window.authHelpers?.protectPage) {
          await window.authHelpers.protectPage(supa);
        } else {
          window.location.href = '/index.html';
        }
      } catch (err) {
        console.error(err);
        alert(err.message || 'Feil kode. PrÃ¸v igjen.');
      } finally {
        otpBtn.disabled = false;
        otpBtn.textContent = old;
      }
    }
  </script>
</body>
</html>
