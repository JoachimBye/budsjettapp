<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Familie-budsjett Beta</title>

  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="/auth-helpers.js"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #fff8e1 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 2rem 1rem;
      overflow: hidden;
      position: relative;
    }
    * { box-sizing: border-box; }
    .card {
      background:#fff; border-radius:1rem; box-shadow:0 8px 32px rgba(0,0,0,.1);
      padding:2.5rem; max-width:480px; width:100%; margin-bottom:1.5rem;
      position: relative;
      z-index: 10;
    }
    .title {
      font-size:1.75rem; font-weight:700; color:#1b5e20;
      margin-bottom:.5rem; text-align:center;
    }
    .subtitle {
      font-size:1rem; color:#558b2f; margin-bottom:2rem;
      text-align:center; line-height:1.5;
    }
    .form-group { margin-bottom:1.5rem; }
    label {
      display:block; font-size:.9rem; font-weight:600;
      color:#2e7d32; margin-bottom:.5rem;
    }
    input {
      width:100%; padding:.875rem 1rem;
      border:2px solid #c8e6c9; border-radius:.5rem;
      font-size:1rem; transition:all .3s ease; background:#fff;
      position: relative;
    }
    input:focus {
      outline:none; border-color:#4caf50;
      box-shadow:0 0 0 3px rgba(76,175,80,.1);
    }
    .hint { font-size:.85rem; color:#689f38; margin-top:.5rem; line-height:1.4; }
    .submit-btn {
      width:100%; padding:1rem; background:#4caf50; color:#fff;
      border:none; border-radius:.5rem; font-size:1.1rem;
      font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:1rem;
    }
    .submit-btn:hover {
      background:#45a049; transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(76,175,80,.3);
    }
    .submit-btn:disabled {
      background:#a5d6a7; cursor:not-allowed; transform:none;
    }
    .success-message {
      background:#e8f5e9; border:2px solid #4caf50;
      border-radius:.5rem; padding:1rem; margin-top:1rem;
      display:none; align-items:center; gap:.75rem;
    }
    .success-message.show { display:flex; }
    .success-text { color:#2e7d32; font-weight:600; flex:1; text-align: center; }
    .login-link {
      text-align:center; margin-top:1.5rem;
      font-size:.9rem; color:#558b2f;
    }
    .login-link a {
      color:#2e7d32; text-decoration:none; font-weight:600;
    }
    .login-link a:hover { text-decoration:underline; }
    .footer { text-align:center; color:#558b2f; font-size:.85rem; }
    @media (max-width:640px){
      .card{padding:1.5rem}
      .title{font-size:1.5rem}
    }
    @view-transition { navigation: auto; }

    /* --- Flytende "boble"-bakgrunn --- */
    .floating-bubbles {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
    }
    .bubble {
        position: absolute;
        border-radius: 9999px;
        background: radial-gradient(circle, rgba(200, 230, 201, 0.5), rgba(240, 244, 195, 0.3));
        animation: floatUpDown 25s ease-in-out infinite;
    }
    .bubble-1 {
        width: 200px;
        height: 200px;
        top: 10%;
        left: 5%;
        animation-duration: 30s;
    }
    .bubble-2 {
        width: 300px;
        height: 300px;
        top: 60%;
        right: -10%;
        animation-duration: 25s;
        animation-delay: 2s;
    }
    .bubble-3 {
        width: 150px;
        height: 150px;
        bottom: 5%;
        left: 30%;
        animation-duration: 20s;
    }
    .bubble-4 {
        width: 250px;
        height: 250px;
        top: -5%;
        left: 60%;
        animation-duration: 35s;
        animation-delay: 1s;
    }

    @keyframes floatUpDown {
        0%   { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
        50%  { transform: translateY(-28px) translateX(10px) scale(1.05); opacity: 0.9; }
        100% { transform: translateY(0) translateX(0) scale(1);   opacity: 0.65; }
    }

    /* Pop-in animasjon p√• kortet */
    .login-card {
        animation: cardEnter 0.6s 0.1s ease-out backwards;
    }

    @keyframes cardEnter {
        0%   { opacity: 0; transform: translateY(24px) scale(0.96); }
        60%  { opacity: 1; transform: translateY(0) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Invitasjonskode "pulse" */
    input#invite.pulse-once {
        animation: softPulse 1.4s ease-out 0.8s 2;
    }

    @keyframes softPulse {
        0%   { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.40); }
        100% { box-shadow: 0 0 0 14px rgba(76, 175, 80, 0.00); }
    }

    /* Redusert bevegelse */
    @media (prefers-reduced-motion: reduce) {
        .floating-bubbles .bubble,
        .login-card,
        input#invite.pulse-once {
            animation: none !important;
            transition: none !important;
        }
    }
  </style>
</head>
<body>

  <div class="floating-bubbles" aria-hidden="true">
      <span class="bubble bubble-1"></span>
      <span class="bubble bubble-2"></span>
      <span class="bubble bubble-3"></span>
      <span class="bubble bubble-4"></span>
  </div>

  <div class="card login-card">
    <h1 class="title" id="main-title">Bli med i familie betaen</h1>
    <p class="subtitle" id="subtitle">Du er invitert til √• teste v√•r nye budsjett app f√∏r alle andre.</p>

    <form id="loginForm">
      <div class="form-group" id="emailGroup">
        <label for="email" id="email-label">E-postadresse</label>
        <input type="email" id="email" name="email" required placeholder="din@epost.no" autocomplete="email"/>
        <p class="hint" id="email-hint" style="display:none;"></p>
      </div>

      <div class="form-group" id="inviteGroup">
        <label for="invite" id="code-label">Invitasjonskode</label>
        <input type="text" id="invite" name="invite" required placeholder="" />
        <p class="hint" id="code-hint">Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.</p>
      </div>

      <div class="form-group" id="otpGroup" style="display: none;">
        <label for="otpInput" id="otp-label">Engangskode</label>
        <input type="text" id="otpInput" name="otp" placeholder="123456" 
               inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" />
        
        <p class="hint">
          <a href="#" id="resetLink" style="color: #2e7d32; font-weight: 500; text-decoration: none;">
            Endre e-postadresse
          </a>
        </p>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span id="button-text">Bli med i betaen</span>
      </button>

      <p id="errorHint" style="color: #d32f2f; text-align: center; margin-top: 1rem; font-weight: 500; min-height: 1.2em;"></p>

      <div class="success-message" id="successBox">
        <span class="success-text" id="successText">
          Kode sendt! Sjekk e-posten din og skriv inn 6-sifret kode under.
        </span>
      </div>
    </form>

    <div class="login-link" id="login-link-row">
      Har du allerede konto? <a href="#login" id="loginAnchor">Logg inn</a>
    </div>
  </div>

  <div class="footer" id="footer-text">Laget i Uranusvegen 30 üåô ¬∑ Familieversjon 1.0</div>

  <script>
    // Supabase ‚Äì dine verdier
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== Element SDK (Konfigurasjon) =============================================
    const defaultConfig = {
      main_title: "Bli med i familie-betaen üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      subtitle: "Du er invitert til √• teste v√•r nye budsjett-app f√∏r alle andre.",
      email_label: "E-postadresse",
      code_label: "Husstandskode (invitasjonskode)",
      code_hint: "Koden forbinder deg med familien din og gir deg tilgang til beta-versjonen.",
      button_text: "Bli med i betaen",
      footer_text: "Laget i Troms√∏ üåô ¬∑ Familieversjon v0.9 beta",
      background_color: "#e8f5e9",
      card_color: "#ffffff",
      primary_color: "#4caf50",
      text_color: "#1b5e20",
      accent_color: "#558b2f"
    };

    async function onConfigChange(config) {
      // S√∏rg for at elementene finnes f√∏r vi setter textContent
      const safeSetText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      };

      safeSetText('main-title', config.main_title || defaultConfig.main_title);
      safeSetText('subtitle', config.subtitle || defaultConfig.subtitle);
      safeSetText('email-label', config.email_label || defaultConfig.email_label);
      safeSetText('code-label', config.code_label || defaultConfig.code_label);
      safeSetText('code-hint', config.code_hint || defaultConfig.code_hint);
      // button-text settes n√• av render()
      safeSetText('footer-text', config.footer_text || defaultConfig.footer_text);

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #fff8e1 100%)`;
      document.querySelector('.card').style.background = cardColor;
      document.querySelector('.submit-btn').style.background = primaryColor;
      document.querySelector('.title').style.color = textColor;
      document.querySelectorAll('.badge')?.forEach(b => b.style.color = accentColor);
    }

    // ===== NY STRUKTUR: Login/Registrering ==================================

    const qs = (sel) => document.querySelector(sel);

    /* === 1. STATE === */
    // Ett sted som definerer appens tilstand
    const state = {
      mode: 'register', // 'register' | 'login'
      step: 'email',    // 'email' | 'otp'
      isLoading: false,
      lastEmail: null,
      error: null
    };

    // Funksjon for √• oppdatere state og trigge en re-render
    function setState(newState) {
      // T√∏m feil ved de fleste state-endringer, med mindre feil er det som settes
      if (newState.error === undefined) {
        state.error = null;
      }
      Object.assign(state, newState);
      ui.render(); // Kaller render-funksjonen hver gang state endres
    }

    /* === 2. UI (DOM + Rendering) === */
    const ui = {
      // Samle alle elementer √©n gang
      elements: {
        form: qs('#loginForm'),
        title: qs('#main-title'),
        subtitle: qs('#subtitle'),
        
        emailGroup: qs('#emailGroup'),
        emailInput: qs('#email'),
        
        inviteGroup: qs('#inviteGroup'),
        inviteInput: qs('#invite'),

        otpGroup: qs('#otpGroup'),
        otpInput: qs('#otpInput'),
        resetLink: qs('#resetLink'),

        submitBtn: qs('#submitBtn'),
        buttonText: qs('#button-text'),
        
        successBox: qs('#successBox'),
        successText: qs('#successText'),

        errorHint: qs('#errorHint'),
        
        loginLinkRow: qs('#login-link-row'),
        loginAnchor: qs('#loginAnchor'),
      },

      // √ân funksjon som oppdaterer hele UI basert p√• state
      render() {
        const { mode, step, isLoading, lastEmail, error } = state;

        // 1. Loading State (Knapp)
        ui.elements.submitBtn.disabled = isLoading;
        if (isLoading) {
          ui.elements.buttonText.textContent = step === 'email' ? 'Sender...' : 'Sjekker...';
        } else if (step === 'email') {
          // Bruk config for knappetekst
          const buttonKey = (mode === 'register' ? config.button_text : 'Send kode');
          ui.elements.buttonText.textContent = buttonKey || (mode === 'register' ? defaultConfig.button_text : 'Send kode');
        } else {
          ui.elements.buttonText.textContent = mode === 'register' ? 'Fullf√∏r' : 'Logg inn';
        }
        
        // 2. Error State
        ui.elements.errorHint.textContent = error || '';
        ui.elements.errorHint.style.display = error ? 'block' : 'none';

        // 3. Step/Mode visibility
        ui.elements.emailGroup.style.display = step === 'email' ? 'block' : 'none';
        ui.elements.inviteGroup.style.display = (step === 'email' && mode === 'register') ? 'block' : 'none';
        ui.elements.otpGroup.style.display = step === 'otp' ? 'block' : 'none';
        ui.elements.loginLinkRow.style.display = step === 'email' ? 'block' : 'none';

        // 4. Text Content & Suksessmeldinger
        ui.elements.successBox.classList.remove('show');
        
        if (step === 'email') {
          // Hent tekster fra config for √• st√∏tte Element SDK
          const titleKey = mode === 'register' ? 'main_title' : 'Logg inn';
          const subKey = mode === 'register' ? 'subtitle' : 'Skriv e-posten din, s√• sender vi en 6-sifret kode.';
          
          ui.elements.title.textContent = config[titleKey] || defaultConfig[titleKey] || 'Logg inn';
          ui.elements.subtitle.textContent = config[subKey] || defaultConfig[subKey] || subKey;

          ui.elements.inviteInput.required = (mode === 'register');
          
        } else {
          // OTP-steg
          ui.elements.title.textContent = 'Sjekk e-posten din';
          ui.elements.subtitle.textContent = `Vi har sendt en 6-sifret kode til:`;
          // Gjenbruk successBox for √• vise e-posten tydelig
          ui.elements.successText.textContent = lastEmail;
          ui.elements.successBox.classList.add('show');
        }
      },
      
      // Hjelpefunksjon for √• bytte til Login-modus
      switchToLoginMode(e) {
        e?.preventDefault();
        setState({ mode: 'login', step: 'email', error: null, lastEmail: null });
        ui.elements.emailInput.focus();
      },

      // Hjelpefunksjon for "Start p√• nytt"
      resetFlow(e) {
        e?.preventDefault();
        setState({ step: 'email', error: null, lastEmail: null });
        ui.elements.emailInput.focus();
      }
    };
    // Hent config fra SDK for √• fylle render() riktig
    let config = { ...defaultConfig };


    /* === 3. HANDLERS (Logikk) === */

    async function handleEmailSubmit() {
      const email = ui.elements.emailInput.value.trim();
      // Koder er ofte lettere √• h√•ndtere uten store/sm√• bokstaver
      const inviteCode = ui.elements.inviteInput.value.trim().toUpperCase();

      if (!email) {
        setState({ error: 'E-postadresse mangler.' });
        return;
      }

      setState({ isLoading: true, error: null });

      try {
        // 1. Register-flyt: Valider kode
        if (state.mode === 'register') {
          if (!inviteCode) {
            throw new Error('Invitasjonskode mangler.');
          }

          // Kall RPC
          const { data, error: rpcError } = await supa
            .rpc('validate_invite_code', { p_code: inviteCode });

          if (rpcError || !data || !data.active) {
            console.error('RPC Error:', rpcError);
            // Brukervennlig feilmelding
            throw new Error('Ugyldig eller inaktiv invitasjonskode.');
          }

          // Suksess! Lagre intensjon
          localStorage.setItem('pending_invite', inviteCode);
        }

        // 2. Felles: Send OTP
        const { error: otpError } = await supa.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: location.origin + '/index.html' }
        });
        if (otpError) throw otpError;

        // 3. G√• til OTP-steg
        setState({ isLoading: false, step: 'otp', lastEmail: email });
        ui.elements.otpInput.focus();

      } catch (err) {
        setState({ isLoading: false, error: err.message || 'En ukjent feil oppstod.' });
      }
    }

    async function handleOtpSubmit() {
      const token = ui.elements.otpInput.value.trim();
      if (!token || token.length < 6) {
        setState({ error: 'Koden m√• v√¶re p√• 6 siffer.' });
        return;
      }

      setState({ isLoading: true, error: null });

      try {
        const { error } = await supa.auth.verifyOtp({
          email: state.lastEmail,
          token,
          type: 'email'
        });
        if (error) throw error;

        // Suksess! La auth-helpers ta over
        if (window.authHelpers?.protectPage) {
          await window.authHelpers.protectPage(supa);
        } else {
          window.location.href = '/index.html'; // Fallback
        }

      } catch (err) {
        console.error('Verify OTP Error:', err);
        setState({ isLoading: false, error: 'Feil kode. Pr√∏v igjen.' });
      }
    }

    /* === 4. INIT (Event Listeners) === */

    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Sjekk om vi allerede er logget inn
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        // Hvis protectPage omdirigerer oss, stopper vi
        if (window.location.pathname !== '/innlogging.html') return;
      }

      // 2. Fyll ut invitasjonskode fra URL (?code=...)
      const p = new URL(location.href).searchParams.get('code');
      if (p && ui.elements.inviteInput) {
        ui.elements.inviteInput.value = p.toUpperCase();
      }

      // 3. Sjekk for #login
      if (location.hash === '#login') {
        setState({ mode: 'login' }); // Bytt modus
      }

      // 4. Bind event listeners
      ui.elements.form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (state.step === 'email') {
          handleEmailSubmit();
        } else {
          handleOtpSubmit();
        }
      });

      ui.elements.loginAnchor.addEventListener('click', ui.switchToLoginMode);
      ui.elements.resetLink.addEventListener('click', ui.resetFlow);

      // 5. Init Element SDK (flyttet hit)
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: (newConfig) => {
            config = { ...defaultConfig, ...newConfig }; // Oppdater global config
            onConfigChange(config); // Kall den gamle funksjonen
            ui.render(); // Re-render UI med nye tekster
          },
          mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
          mapToEditPanelValues: (cfg) => {
            const conf = cfg || defaultConfig;
            return new Map([
              ["main_title", conf.main_title],
              ["subtitle", conf.subtitle],
              ["email_label", conf.email_label],
              ["code_label", conf.code_label],
              ["code_hint", conf.code_hint],
              ["button_text", conf.button_text],
              ["footer_text", conf.footer_text]
            ]);
          }
        });
      }

      // 6. F√∏rste render (etter SDK er klar)
      await onConfigChange(config); // S√∏rg for at config er satt
      ui.render();

      // 7. Pulse-animasjon
      if (state.mode === 'register') {
        ui.elements.inviteInput?.classList.add('pulse-once');
      }
    });
  </script>

</body>
</html>
