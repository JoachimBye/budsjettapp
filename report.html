<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ukesrapport - Husholdningsbudsjett</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body{box-sizing:border-box;margin:0;padding:0;height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#f8fffe 0%,#f0f9f4 100%);overflow-y:auto}
    html{height:100%}
    .container{max-width:800px;margin:0 auto;padding:30px;min-height:100%;display:flex;flex-direction:column}
    .header{text-align:center;margin-bottom:40px;animation:fadeInDown .6s ease-out}
    .title{font-size:32px;font-weight:700;color:#2d5f4d;margin-bottom:15px;line-height:1.3}
    .description{font-size:18px;color:#5a7a6d;line-height:1.5;max-width:600px;margin:0 auto}
    .content-section{flex:1;display:flex;flex-direction:column;gap:40px;margin-bottom:40px}
    .card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .budget-overview{animation:fadeInUp .8s ease-out .1s both}
    .budget-circle-container{display:flex;align-items:center;justify-content:space-between;gap:40px}
    .budget-circle{position:relative;width:200px;height:200px;flex-shrink:0}
    .circle-bg{width:100%;height:100%;border-radius:50%;background:#e8f5f0;position:relative;overflow:hidden}
    .circle-progress{position:absolute;inset:0;border-radius:50%;background:conic-gradient(#4caf50 0deg,#4caf50 0deg,transparent 0deg);transition:all .8s ease-out}
    .circle-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10}
    .circle-percentage{font-size:28px;font-weight:800;color:#2d5f4d;margin-bottom:5px}
    .circle-label{font-size:14px;color:#5a7a6d;font-weight:500}
    .budget-details{flex:1}
    .budget-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #f0f9f4}
    .budget-item:last-child{border-bottom:none}
    .budget-item.saved{background:rgba(76,175,80,.1);border-radius:12px;padding:20px;margin-top:15px;border-bottom:none}
    .budget-label{font-size:18px;font-weight:600;color:#2d5f4d}
    .budget-amount{font-size:20px;font-weight:700;color:#2d5f4d}
    .budget-amount.saved{color:#4caf50;font-size:24px}
    .celebration-icon{margin-left:10px;font-size:24px}
    .section-title{font-size:24px;font-weight:700;color:#2d5f4d;margin-bottom:25px;text-align:center}
    .categories-section{animation:fadeInUp .8s ease-out .2s both}
    .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
    .category-item{text-align:center;padding:20px;background:#fafffe;border-radius:15px;border:2px solid #e8f5f0}
    .category-icon{font-size:40px;margin-bottom:10px;display:block}
    .category-name{font-size:16px;font-weight:600;color:#2d5f4d;margin-bottom:8px}
    .category-bar{width:100%;height:8px;background:#e8f5f0;border-radius:4px;overflow:hidden;margin-bottom:8px}
    .category-progress{height:100%;background:#4caf50;border-radius:4px;transition:width 1s ease-out .2s}
    .category-percentage{font-size:18px;font-weight:700;color:#4caf50}
    .insights-section{animation:fadeInUp .8s ease-out .3s both}
    .insights-list{display:flex;flex-direction:column;gap:20px}
    .insight-item{display:flex;align-items:flex-start;gap:15px;padding:20px;background:#f8fffe;border-radius:15px;border-left:4px solid #4caf50}
    .insight-icon{font-size:24px;flex-shrink:0;margin-top:2px}
    .insight-text{font-size:16px;color:#2d5f4d;line-height:1.5;margin:0}
    .button-section{text-align:center;animation:fadeInUp .8s ease-out .4s both}
    .start-week-button{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%);color:#fff;border:none;padding:25px 60px;font-size:22px;font-weight:700;border-radius:50px;cursor:pointer;box-shadow:0 8px 20px rgba(76,175,80,.3);transition:all .3s ease;margin-bottom:20px}
    .start-week-button:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(76,175,80,.4);background:linear-gradient(135deg,#45a049 0%,#3d8b40 100%)}
    .start-week-button:active{transform:translateY(-1px)}
    .back-button{background:transparent;color:#8a9a8d;border:2px solid #e0e7e3;padding:18px 45px;font-size:18px;font-weight:500;border-radius:30px;cursor:pointer;transition:all .3s ease}
    .back-button:hover{background:#f5f8f6;border-color:#c8d4cb;color:#5a7a6d}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:768px){
      .container{padding:20px}
      .title{font-size:28px}
      .description{font-size:16px}
      .budget-circle-container{flex-direction:column;gap:30px}
      .budget-circle{width:160px;height:160px}
      .circle-percentage{font-size:24px}
      .categories-grid{grid-template-columns:1fr}
      .start-week-button{font-size:20px;padding:22px 50px}
    }
  </style>
  <style>@view-transition{navigation:auto}</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1 class="title" id="mainTitle">Ukesrapport â€“ <span id="weekTitle">Uke</span></h1>
      <p class="description" id="descriptionText">Her er en oppsummering av ukens forbruk og hvordan dere ligger an til neste uke.</p>
    </div>

    <div class="content-section">
      <div class="card budget-overview">
        <div class="budget-circle-container">
          <div class="budget-circle">
            <div class="circle-bg"><div class="circle-progress" id="circleProgress"></div></div>
            <div class="circle-content">
              <div class="circle-percentage" id="circlePercentage">0%</div>
              <div class="circle-label">brukt</div>
            </div>
          </div>

          <div class="budget-details">
            <div class="budget-item"><span class="budget-label" id="budgetLabel">Budsjett:</span><span class="budget-amount" id="budgetAmount">â€“</span></div>
            <div class="budget-item"><span class="budget-label" id="spentLabel">Brukt:</span><span class="budget-amount" id="spentAmount">â€“</span></div>
            <div class="budget-item saved"><span class="budget-label" id="savedLabel">Sparte:</span><span class="budget-amount saved" id="savedAmount">â€“<span class="celebration-icon">ðŸŽ‰</span></span></div>
          </div>
        </div>
      </div>

      <div class="card categories-section" id="categoriesSection">
        <h2 class="section-title" id="categoriesTitle">Kategorier (toppbutikker)</h2>
        <div class="categories-grid" id="categoriesGrid"></div>
      </div>

      <div class="card insights-section">
        <h2 class="section-title" id="insightsTitle">Innsikter</h2>
        <div class="insights-list" id="insightsList"></div>
      </div>
    </div>

    <div class="button-section">
      <button class="start-week-button" id="startWeekButton"><span id="startNewWeekText">Start ny uke</span></button><br/>
      <button class="back-button" id="backButton"><span id="backButtonText">Tilbake til oversikten</span></button>
    </div>
  </main>

  <script>
    // --- helpers ---
    const defaultConfig = {
      background_color:"#f8fffe", surface_color:"#ffffff", text_color:"#2d5f4d",
      primary_action_color:"#4caf50", secondary_text_color:"#5a7a6d",
      font_family:"Inter", font_size:18,
      main_title:"Ukesrapport", description_text:"Her er en oppsummering av ukens forbruk og hvordan dere ligger an til neste uke.",
      budget_label:"Budsjett:", spent_label:"Brukt:", saved_label:"Sparte:",
      categories_title:"Kategorier (toppbutikker)", insights_title:"Innsikter",
      start_new_week_text:"Start ny uke", back_button_text:"Tilbake til oversikten"
    };

    function adjustColor(color, percent){
      const num=parseInt(color.replace('#',''),16); const amt=Math.round(2.55*percent);
      const R=Math.max(0,Math.min(255,(num>>16)+amt));
      const G=Math.max(0,Math.min(255,((num>>8)&0x00FF)+amt));
      const B=Math.max(0,Math.min(255,(num&0x0000FF)+amt));
      return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
    }
    const NOK = n=> (n||0).toLocaleString('no-NO')+" kr";

    function getQueryWeek(){
      const p=new URLSearchParams(location.search); const w=p.get('week');
      return w && /^\d{4}-\d{2}-\d{2}$/.test(w) ? w : null;
    }
    function getWeekInfo(date=new Date()){
      const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day=d.getUTCDay(); const diffToMon=(day===0?-6:1-day);
      const mon=new Date(d); mon.setUTCDate(d.getUTCDate()+diffToMon);
      const sun=new Date(mon); sun.setUTCDate(mon.getUTCDate()+6);
      const mondayISO=mon.toISOString().slice(0,10);
      const fmt=(x)=>x.toLocaleDateString('no-NO',{day:'numeric',month:'short'});
      const weekNo = (()=>{
        // ISO uke
        const tmp=new Date(Date.UTC(mon.getUTCFullYear(), mon.getUTCMonth(), mon.getUTCDate()));
        tmp.setUTCDate(tmp.getUTCDate()+3-((tmp.getUTCDay()+6)%7));
        const week1=new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
        return 1+Math.round(((tmp-week1)/86400000-3+((week1.getUTCDay()+6)%7))/7);
      })();
      return { mondayISO, label:`Uke ${weekNo} â€“ ${fmt(mon)}â€“${fmt(sun)}` };
    }
    const purchasesKey = mon => `purchases_${mon}`;
    const spentKey = mon => `spent_${mon}`;
    const weeklyBudgetKey = 'weeklyBudget'; // hentet pÃ¥ hovedsiden / fallback

    function loadPurchases(monISO){
      try{ return JSON.parse(localStorage.getItem(purchasesKey(monISO))||'[]'); }catch{ return []; }
    }
    function sum(arr, sel){ return arr.reduce((a,x)=>a+(+sel(x)||0),0); }
    function groupBy(arr, keySel){
      const m=new Map(); for(const it of arr){ const k=keySel(it)||'Annet'; m.set(k,(m.get(k)||[]).concat(it)); }
      return m;
    }

    // --- theming via elementSdk ---
    async function onConfigChange(config){
      const bg=config.background_color||defaultConfig.background_color;
      const surf=config.surface_color||defaultConfig.surface_color;
      const text=config.text_color||defaultConfig.text_color;
      const prim=config.primary_action_color||defaultConfig.primary_action_color;
      const sec=config.secondary_text_color||defaultConfig.secondary_text_color;
      const font=config.font_family||defaultConfig.font_family;
      const base=config.font_size||defaultConfig.font_size;

      document.body.style.background=`linear-gradient(135deg, ${bg} 0%, ${adjustColor(bg,-2)} 100%)`;
      document.querySelectorAll('.card').forEach(c=>c.style.background=surf);
      document.querySelectorAll('.title,.section-title,.budget-label,.budget-amount,.category-name,.insight-text').forEach(el=>{
        el.style.color=el.classList.contains('budget-amount')?text:text;
        el.style.fontFamily=`${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      });
      document.querySelectorAll('.description').forEach(el=>{
        el.style.color=sec; el.style.fontFamily=`${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`; el.style.fontSize=`${base}px`;
      });
      const circleBg=document.querySelector('.circle-bg'); if(circleBg) circleBg.style.background=adjustColor(prim,85);
      document.querySelectorAll('.category-bar').forEach(b=>b.style.background=adjustColor(prim,85));
      document.querySelectorAll('.category-progress').forEach(p=>p.style.background=prim);
      const startBtn=document.getElementById('startWeekButton');
      startBtn.style.background=`linear-gradient(135deg, ${prim} 0%, ${adjustColor(prim,-10)} 100%)`;
      document.querySelector('.budget-item.saved').style.background=`${prim}1a`;
    }
    function mapToCapabilities(config){
      return {
        recolorables:[
          {get:()=>config.background_color||defaultConfig.background_color,set:v=>window.elementSdk?.setConfig({background_color:v})},
          {get:()=>config.surface_color||defaultConfig.surface_color,set:v=>window.elementSdk?.setConfig({surface_color:v})},
          {get:()=>config.text_color||defaultConfig.text_color,set:v=>window.elementSdk?.setConfig({text_color:v})},
          {get:()=>config.primary_action_color||defaultConfig.primary_action_color,set:v=>window.elementSdk?.setConfig({primary_action_color:v})},
          {get:()=>config.secondary_text_color||defaultConfig.secondary_text_color,set:v=>window.elementSdk?.setConfig({secondary_text_color:v})},
        ],
        borderables:[],
        fontEditable:{get:()=>config.font_family||defaultConfig.font_family,set:v=>window.elementSdk?.setConfig({font_family:v})},
        fontSizeable:{get:()=>config.font_size||defaultConfig.font_size,set:v=>window.elementSdk?.setConfig({font_size:v})}
      };
    }
    function mapToEditPanelValues(config){
      return new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["description_text", config.description_text || defaultConfig.description_text],
        ["budget_label", config.budget_label || defaultConfig.budget_label],
        ["spent_label", config.spent_label || defaultConfig.spent_label],
        ["saved_label", config.saved_label || defaultConfig.saved_label],
        ["categories_title", config.categories_title || defaultConfig.categories_title],
        ["insights_title", config.insights_title || defaultConfig.insights_title],
        ["start_new_week_text", config.start_new_week_text || defaultConfig.start_new_week_text],
        ["back_button_text", config.back_button_text || defaultConfig.back_button_text]
      ]);
    }

    // --- render weekly report ---
    function renderCategories(storeMap, total, primColor){
      const grid=document.getElementById('categoriesGrid'); grid.innerHTML='';
      const items=[...storeMap.entries()]
        .map(([store,items])=>({store,spent:sum(items,x=>x.amount)}))
        .sort((a,b)=>b.spent-a.spent)
        .slice(0,3);

      if(!items.length){ document.getElementById('categoriesSection').style.display='none'; return; }

      const iconFor = (name)=> 'ðŸ›’'; // enkelt â€“ kan utvides per kjede
      items.forEach(({store,spent})=>{
        const pct = total>0 ? Math.round((spent/total)*100) : 0;
        const card=document.createElement('div'); card.className='category-item';
        card.innerHTML = `
          <span class="category-icon">${iconFor(store)}</span>
          <div class="category-name">${store}</div>
          <div class="category-bar"><div class="category-progress" style="width:${pct}%; background:${primColor}"></div></div>
          <div class="category-percentage">${pct}%</div>
        `;
        grid.appendChild(card);
      });
    }

    function renderInsights(purchases, total, spent, prevSpent){
      const list=document.getElementById('insightsList'); list.innerHTML='';
      const add = (icon, text)=>{
        const li=document.createElement('div'); li.className='insight-item';
        li.innerHTML=`<span class="insight-icon">${icon}</span><p class="insight-text">${text}</p>`;
        list.appendChild(li);
      };
      // nivÃ¥
      const ratio = total>0 ? spent/total : 0;
      if (ratio <= 0.8) add('ðŸ‘', 'StrÃ¥lende! Dere brukte under 80% av ukebudsjettet.');
      else if (ratio <= 1.0) add('âœ…', 'God kontroll â€“ dere holdt dere innenfor budsjettet denne uka.');
      else add('âš–ï¸', 'Litt over budsjettet denne uka. Vurder Ã©n ekstra hjemmelaget middag neste uke.');

      // endring vs forrige uke
      if (Number.isFinite(prevSpent)){
        const diff = spent - prevSpent;
        if (Math.abs(diff) >= 100){
          add(diff<=0 ? 'ðŸ“‰' : 'ðŸ“ˆ',
              diff<=0 ? `Ned ${NOK(Math.abs(diff))} fra forrige uke â€“ bra jobba!`
                      : `Opp ${NOK(Math.abs(diff))} fra forrige uke. Sjekk handlelisten fÃ¸r neste tur.`);
        }
      }

      // stÃ¸rste enkeltkjÃ¸p
      if (purchases.length){
        const max = purchases.reduce((m,x)=> x.amount>m.amount?x:m, purchases[0]);
        add('ðŸ·ï¸', `StÃ¸rste kjÃ¸p: ${NOK(max.amount)} pÃ¥ ${max.store} (${new Date(max.dateISO).toLocaleDateString('no-NO')}).`);
      }
    }

    function loadWeekly(monISO){
      const purchases = loadPurchases(monISO);
      // belÃ¸p lagres som heltall kr i add-purchase.html
      const spent = sum(purchases, x=>x.amount);
      const budget = Number(localStorage.getItem(weeklyBudgetKey)) || 3000;
      const saved = Math.max(0, budget - spent);
      return { purchases, spent, budget, saved };
    }

    function prevMondayISO(monISO){
      const d=new Date(monISO+'T00:00:00Z');
      d.setUTCDate(d.getUTCDate()-7);
      return d.toISOString().slice(0,10);
    }
    function nextMondayISO(monISO){
      const d=new Date(monISO+'T00:00:00Z');
      d.setUTCDate(d.getUTCDate()+7);
      return d.toISOString().slice(0,10);
    }

    function setCircle(progressDeg, primary){
      const el=document.getElementById('circleProgress');
      el.style.background=`conic-gradient(${primary} 0deg, ${primary} ${progressDeg}deg, transparent ${progressDeg}deg)`;
    }

    function init(){
      // Finn uke (fra query eller i dag)
      const queryWeek = getQueryWeek();
      const weekInfo = queryWeek ? getWeekInfo(new Date(queryWeek)) : getWeekInfo(new Date());
      const { mondayISO, label } = weekInfo;
      document.getElementById('weekTitle').textContent = label;

      // Hent data for uke + forrige uke
      const { purchases, spent, budget, saved } = loadWeekly(mondayISO);
      const prev = loadWeekly(prevMondayISO(mondayISO));

      // Tall
      document.getElementById('budgetAmount').textContent = NOK(budget);
      document.getElementById('spentAmount').textContent = NOK(spent);
      document.getElementById('savedAmount').innerHTML = `${NOK(saved)}<span class="celebration-icon">ðŸŽ‰</span>`;
      const pct = budget>0 ? Math.min(100, Math.round((spent/budget)*100)) : 0;
      document.getElementById('circlePercentage').textContent = `${pct}%`;
      setCircle((budget>0? (spent/budget)*360 : 0), (window.elementSdk?.config?.primary_action_color)||'#4caf50');

      // Kategorier = toppbutikker
      const byStore = groupBy(purchases, x=>x.store);
      renderCategories(byStore, Math.max(spent,1), (window.elementSdk?.config?.primary_action_color)||'#4caf50');

      // Innsikter
      renderInsights(purchases, budget, spent, prev.spent);

      // Start ny uke
      document.getElementById('startWeekButton').addEventListener('click', ()=>{
        const next = nextMondayISO(mondayISO);
        // kopierer samme budsjett (lagres allerede globalt i weeklyBudget)
        location.href = `report.html?week=${next}`;
      });

      // Tilbake
      document.getElementById('backButton').addEventListener('click', ()=>{
        if (document.referrer) history.back();
        else location.href='app.html';
      });
    }

    // elementSdk init
    if (window.elementSdk){
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }
    // start
    init();
  </script>

  <!-- (valgfritt: beholder CF/canvas-snippet om nÃ¸dvendig i miljÃ¸et ditt)
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'',t:''};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);} }if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);document.readyState!=='loading'?c():document.addEventListener('DOMContentLoaded',c);} })();</script>
  -->
</body>
</html>
