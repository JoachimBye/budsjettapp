<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Husholdningsbudsjett</title>

  <!-- Element SDK (valgfri redigering) -->
  <script src="/_sdk/element_sdk.js" defer></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript" defer></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="/js/supa-client.js" defer></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript" defer></script>

  <!-- Ny: sentral auth/ruting-hjerne -->
  <script src="/auth-helpers.js" defer></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5f0 100%);
      display: flex; align-items: center; justify-content: center;
    }
    html { height: 100%; }
    .container { width: 90%; max-width: 600px; text-align: center; padding: 40px; }
    .icon-container { margin-bottom: 40px; animation: fadeInDown 0.8s ease-out; }
    .icon { width: 120px; height: 120px; margin: 0 auto; }
    .content { animation: fadeInUp 0.8s ease-out 0.2s both; }
    .title { font-size: 36px; font-weight: 700; color: #2d5f4d; margin-bottom: 24px; line-height: 1.3; }
    .description {
      font-size: 20px; color: #5a7a6d; line-height: 1.6; margin-bottom: 50px;
      max-width: 550px; margin-left: auto; margin-right: auto;
    }
    .cta-button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white; border: none; padding: 20px 60px; font-size: 24px; font-weight: 600;
      border-radius: 50px; cursor: pointer; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease; animation: fadeInUp 0.8s ease-out 0.4s both;
    }
    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(76, 175, 80, 0.4);
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    }
    .cta-button:active {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3);
    }
    @keyframes fadeInDown { from { opacity:0; transform: translateY(-30px);} to{opacity:1; transform: translateY(0);} }
    @keyframes fadeInUp   { from { opacity:0; transform: translateY(30px);}  to{opacity:1; transform: translateY(0);} }
    @media (max-width: 768px) {
      .title { font-size: 28px; }
      .description { font-size: 18px; }
      .cta-button { font-size: 20px; padding: 18px 50px; }
    }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <main class="container">
    <div class="icon-container">
      <svg class="icon" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="25" y="15" width="70" height="90" rx="8" fill="#4caf50" opacity="0.1" />
        <rect x="30" y="20" width="60" height="80" rx="6" fill="white" stroke="#4caf50" stroke-width="3" />
        <circle cx="60" cy="25" r="2" fill="#4caf50" />
        <rect x="40" y="35" width="40" height="3" rx="1.5" fill="#4caf50" opacity="0.6" />
        <rect x="40" y="45" width="30" height="3" rx="1.5" fill="#4caf50" opacity="0.4" />
        <circle cx="45" cy="60" r="8" fill="#4caf50" opacity="0.2" />
        <path d="M45 57 L44 61 L48 61 Z" fill="#4caf50" />
        <rect x="40" y="75" width="40" height="3" rx="1.5" fill="#4caf50" opacity="0.6" />
        <rect x="40" y="85" width="35" height="3" rx="1.5" fill="#4caf50" opacity="0.4" />
      </svg>
    </div>

    <div class="content">
      <h1 class="title" id="welcomeTitle">Velkommen til husholdningsbudsjettet ditt üíö</h1>
      <p class="description" id="welcomeDescription">
        En enkel l√∏sning for √• holde oversikt over ukens matbudsjett rett p√• kj√∏leskapet.
        F√∏lg med p√• forbruket, registrer kj√∏p, og f√• kontroll p√• pengene ‚Äì sammen som familie.
      </p>
      <button class="cta-button" id="ctaButton">Kom i gang</button>
      <div id="inviteStatus" class="description" style="margin-top:16px; min-height: 28px;"></div>
    </div>
  </main>

  <script>
    // ---------- Element SDK / tema ----------
    const defaultConfig = {
      background_color: "#f0f9f4",
      surface_color: "#ffffff",
      text_color: "#2d5f4d",
      primary_action_color: "#4caf50",
      secondary_text_color: "#5a7a6d",
      font_family: "Inter",
      font_size: 20,
      welcome_title: "Velkommen til husholdningsbudsjettet ditt üíö",
      welcome_description:
        "En enkel l√∏sning for √• holde oversikt over ukens matbudsjett rett p√• kj√∏leskapet.\nF√∏lg med p√• forbruket, registrer kj√∏p, og f√• kontroll p√• pengene ‚Äì sammen som familie.",
      button_text: "Kom i gang"
    };

    function adjustColor(hex, percent) {
      const num = parseInt(hex.replace('#',''), 16);
      const amt = Math.round(2.55 * percent);
      const R = Math.min(255, Math.max(0, (num >> 16) + amt));
      const G = Math.min(255, Math.max(0, ((num >> 8) & 0xFF) + amt));
      const B = Math.min(255, Math.max(0, (num & 0xFF) + amt));
      return '#' + (0x1000000 + (R << 16) + (G << 8) + B).toString(16).slice(1);
    }

    function applyTheme(cfg) {
      const backgroundColor = cfg.background_color || defaultConfig.background_color;
      const surfaceColor = cfg.surface_color || defaultConfig.surface_color;
      const textColor = cfg.text_color || defaultConfig.text_color;
      const primary = cfg.primary_action_color || defaultConfig.primary_action_color;
      const secondary = cfg.secondary_text_color || defaultConfig.secondary_text_color;
      const font = cfg.font_family || defaultConfig.font_family;
      const base = cfg.font_size || defaultConfig.font_size;

      document.body.style.background =
        `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor,-5)} 100%)`;

      const title = document.getElementById('welcomeTitle');
      title.textContent = cfg.welcome_title || defaultConfig.welcome_title;
      title.style.color = textColor;
      title.style.fontFamily =
        `${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      title.style.fontSize = `${base * 1.8}px`;

      const desc = document.getElementById('welcomeDescription');
      desc.textContent = cfg.welcome_description || defaultConfig.welcome_description;
      desc.style.color = secondary;
      desc.style.fontFamily =
        `${font}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      desc.style.fontSize = `${base}px`;

      const btn = document.getElementById('ctaButton');
      btn.textContent = cfg.button_text || defaultConfig.button_text;
      btn.style.background =
        `linear-gradient(135deg, ${primary} 0%, ${adjustColor(primary,-10)} 100%)`;

      const svgRect = document.querySelector('svg rect[fill="white"]');
      if (svgRect) {
        svgRect.setAttribute('fill', surfaceColor);
        svgRect.setAttribute('stroke', primary);
      }
      document
        .querySelectorAll('svg [fill*="#4caf50"]')
        .forEach(el => el.setAttribute('fill', primary));
    }

    function initElementTheme() {
      // Kalles etter at defer-skriptene er lastet (inne i DOMContentLoaded)
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: applyTheme,
          mapToCapabilities: () => ({ recolorables: [], borderables: [] }),
          mapToEditPanelValues: (config) =>
            new Map([
              ["welcome_title", config.welcome_title || defaultConfig.welcome_title],
              ["welcome_description", config.welcome_description || defaultConfig.welcome_description],
              ["button_text", config.button_text || defaultConfig.button_text]
            ])
        });
      } else {
        // Fallback: bare bruk standard-temaet
        applyTheme(defaultConfig);
      }
    }

    // ---------- Ruting + Supabase / join_with_code ----------
    window.addEventListener('DOMContentLoaded', async () => {
      const btn = document.getElementById('ctaButton');
      const statusEl = document.getElementById('inviteStatus');

      const attachDefaultCta = () => {
        if (!btn) return;
        btn.disabled = false;
        btn.textContent = btn.dataset.defaultText || 'Kom i gang';
        btn.onclick = () => {
          btn.style.transform = 'scale(0.95)';
          setTimeout(() => {
            btn.style.transform = '';
            window.location.href = '/onboarding1.html';
          }, 120);
        };
      };

      // 1) Init tema/Element
      initElementTheme();

      // 2) Hvis Supabase-lib ikke er lastet ‚Üí enkel fallback til innlogging
      if (!window.supabase || !window.supabase.createClient) {
        attachDefaultCta();
        btn?.addEventListener('click', () => {
          window.location.href = '/innlogging.html';
        });
        return;
      }

      const supa = window.supaClient?.getClient();
      if (!supa) {
        attachDefaultCta();
        btn?.addEventListener('click', () => {
          window.location.href = '/innlogging.html';
        });
        return;
      }

      // Lytt p√• SIGNED_OUT globalt (uten √• rydde localStorage ‚Äì det gj√∏r handleLogout)
      if (window.authHelpers?.initializeAuthListener) {
        window.authHelpers.initializeAuthListener(supa);
      }

      // La auth-helpers bestemme om vi skal v√¶re p√• /index.html eller redirectes
      if (window.authHelpers?.protectPage) {
        await window.authHelpers.protectPage(supa);
        if (window.location.pathname !== '/index.html') return;
      }

      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        attachDefaultCta();
        return;
      }

      const inviteCode =
        localStorage.getItem('pending_invite') ||
        session.user?.user_metadata?.invite_code ||
        null;

      const attemptJoin = async () => {
        if (!inviteCode) return true;
        if (statusEl) statusEl.textContent = 'Kobler deg til husstanden...';
        try {
          const { error } = await supa.rpc('join_with_code', { p_code: inviteCode });
          if (error) {
            console.error('join_with_code failed', error);
            if (statusEl) {
              statusEl.textContent = 'Kunne ikke koble deg til husstanden. Sjekk invitasjonskoden og pr√∏v igjen.';
            }
            return false;
          }
          localStorage.removeItem('pending_invite');
          if (statusEl) statusEl.textContent = 'Du er n√• koblet til husstanden üéâ';
          return true;
        } catch (e) {
          console.error('Unexpected error in join_with_code', e);
          if (statusEl) statusEl.textContent = 'Noe gikk galt. Pr√∏v igjen senere.';
          return false;
        }
      };

      let joinSuccess = true;
      if (inviteCode) {
        joinSuccess = await attemptJoin();
      } else if (statusEl) {
        statusEl.textContent = '';
      }

      if (!joinSuccess) {
        if (btn) {
          btn.dataset.defaultText = btn.textContent;
          btn.textContent = 'Pr√∏v igjen';
          btn.onclick = async () => {
            btn.disabled = true;
            const ok = await attemptJoin();
            btn.disabled = false;
            if (ok) {
              attachDefaultCta();
            }
          };
        }
        return;
      }

      attachDefaultCta();
    });
  </script>
</body>
</html>
