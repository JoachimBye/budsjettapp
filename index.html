<!doctype html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Husholdningsbudsjett</title>

  <!-- Element SDK (valgfri redigering) -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- (valgfritt) Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <style>
    body {
      box-sizing: border-box; margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f9f4 0%, #e8f5f0 100%);
      display: flex; align-items: center; justify-content: center;
    }
    html { height: 100%; }
    .container { width: 90%; max-width: 600px; text-align: center; padding: 40px; }
    .icon-container { margin-bottom: 40px; animation: fadeInDown 0.8s ease-out; }
    .icon { width: 120px; height: 120px; margin: 0 auto; }
    .content { animation: fadeInUp 0.8s ease-out 0.2s both; }
    .title { font-size: 36px; font-weight: 700; color: #2d5f4d; margin-bottom: 24px; line-height: 1.3; }
    .description { font-size: 20px; color: #5a7a6d; line-height: 1.6; margin-bottom: 50px; max-width: 550px; margin-left: auto; margin-right: auto; }
    .cta-button {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white; border: none; padding: 20px 60px; font-size: 24px; font-weight: 600;
      border-radius: 50px; cursor: pointer; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease; animation: fadeInUp 0.8s ease-out 0.4s both;
    }
    .cta-button:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(76, 175, 80, 0.4); background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%); }
    .cta-button:active { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3); }
    @keyframes fadeInDown { from { opacity:0; transform: translateY(-30px);} to{opacity:1; transform: translateY(0);} }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(30px);} to{opacity:1; transform: translateY(0);} }
    @media (max-width: 768px) {
      .title { font-size: 28px; }
      .description { font-size: 18px; }
      .cta-button { font-size: 20px; padding: 18px 50px; }
    }
    @view-transition { navigation: auto; }
  </style>
</head>
<body>
  <main class="container">
    <div class="icon-container">
      <svg class="icon" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="25" y="15" width="70" height="90" rx="8" fill="#4caf50" opacity="0.1" />
        <rect x="30" y="20" width="60" height="80" rx="6" fill="white" stroke="#4caf50" stroke-width="3" />
        <circle cx="60" cy="25" r="2" fill="#4caf50" />
        <rect x="40" y="35" width="40" height="3" rx="1.5" fill="#4caf50" opacity="0.6" />
        <rect x="40" y="45" width="30" height="3" rx="1.5" fill="#4caf50" opacity="0.4" />
        <circle cx="45" cy="60" r="8" fill="#4caf50" opacity="0.2" />
        <path d="M45 57 L44 61 L48 61 Z" fill="#4caf50" />
        <rect x="40" y="75" width="40" height="3" rx="1.5" fill="#4caf50" opacity="0.6" />
        <rect x="40" y="85" width="35" height="3" rx="1.5" fill="#4caf50" opacity="0.4" />
      </svg>
    </div>

    <div class="content">
      <h1 class="title" id="welcomeTitle">Velkommen til husholdningsbudsjettet ditt üíö</h1>
      <p class="description" id="welcomeDescription">
        En enkel l√∏sning for √• holde oversikt over ukens matbudsjett rett p√• kj√∏leskapet.
        F√∏lg med p√• forbruket, registrer kj√∏p, og f√• kontroll p√• pengene ‚Äì sammen som familie.
      </p>
      <button class="cta-button" id="ctaButton" disabled>Kom i gang</button>
    </div>
  </main>

  <script>
    // === Supabase init (samme verdier som hos deg) ============================
    const SUPABASE_URL = 'https://mmeitnqbnphuabnyamns.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZWl0bnFibnBodWFibnlhbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNDUsImV4cCI6MjA3ODM1NjM0NX0.qewZdwM-yfIBKMr-MUuLKX-fpfCy0Gw8agronvVzONY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === Element SDK konfig (valgfritt ‚Äì samme som f√∏r) ======================
    const defaultConfig = {
      background_color: "#f0f9f4",
      surface_color: "#ffffff",
      text_color: "#2d5f4d",
      primary_action_color: "#4caf50",
      secondary_text_color: "#5a7a6d",
      font_family: "Inter",
      font_size: 20,
      welcome_title: "Velkommen til husholdningsbudsjettet ditt üíö",
      welcome_description: "En enkel l√∏sning for √• holde oversikt over ukens matbudsjett rett p√• kj√∏leskapet.\nF√∏lg med p√• forbruket, registrer kj√∏p, og f√• kontroll p√• pengene ‚Äì sammen som familie.",
      button_text: "Kom i gang"
    };

    function adjustColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 +
        (R<255 ? (R<1?0:R) : 255) * 0x10000 +
        (G<255 ? (G<1?0:G) : 255) * 0x100 +
        (B<255 ? (B<1?0:B) : 255)).toString(16).slice(1);
    }

    async function onConfigChange(config) {
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryTextColor = config.secondary_text_color || defaultConfig.secondary_text_color;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${adjustColor(backgroundColor, -5)} 100%)`;

      const titleElement = document.getElementById('welcomeTitle');
      titleElement.textContent = config.welcome_title || defaultConfig.welcome_title;
      titleElement.style.color = textColor;
      titleElement.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      titleElement.style.fontSize = `${baseSize * 1.8}px`;

      const descElement = document.getElementById('welcomeDescription');
      descElement.textContent = config.welcome_description || defaultConfig.welcome_description;
      descElement.style.color = secondaryTextColor;
      descElement.style.fontFamily = `${customFont}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      descElement.style.fontSize = `${baseSize}px`;

      const buttonElement = document.getElementById('ctaButton');
      buttonElement.textContent = config.button_text || defaultConfig.button_text;
      buttonElement.style.background = `linear-gradient(135deg, ${primaryActionColor} 0%, ${adjustColor(primaryActionColor, -10)} 100%)`;

      const svgRect = document.querySelector('svg rect[fill="white"]');
      if (svgRect) { svgRect.setAttribute('fill', surfaceColor); svgRect.setAttribute('stroke', primaryActionColor); }

      const svgPaths = document.querySelectorAll('svg rect[fill*="#4caf50"], svg circle[fill*="#4caf50"], svg path[fill*="#4caf50"]');
      svgPaths.forEach(path => {
        const currentFill = path.getAttribute('fill');
        if (currentFill && currentFill.includes('#4caf50')) path.setAttribute('fill', primaryActionColor);
      });
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
        mapToEditPanelValues: (config) => new Map([
          ["welcome_title", config.welcome_title || defaultConfig.welcome_title],
          ["welcome_description", config.welcome_description || defaultConfig.welcome_description],
          ["button_text", config.button_text || defaultConfig.button_text]
        ])
      });
    }

    // === Auth-guard, join_with_code og ruting ================================
    (async () => {
      const btn = document.getElementById('ctaButton');

      // 1) Auth-guard
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = '/innlogging.html'; return; }

      // 2) Knytt bruker til husstand f√∏rste gang (RPC)
      try {
        const inviteCode =
          session.user?.user_metadata?.invite_code ||
          localStorage.getItem('pending_invite') || null;

        if (inviteCode) {
          await supa.rpc('join_with_code', {
            p_code: inviteCode,
            p_email: session.user.email
          });
          localStorage.removeItem('pending_invite');
        }
      } catch (e) {
        console.warn('join_with_code feilet:', e?.message || e);
      }

      // 3) Bestem neste side (onboarding eller app)
      const onboardingDone = localStorage.getItem('onboarding_done') === '1';
      btn.disabled = false;
      btn.addEventListener('click', () => {
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          btn.style.transform = '';
          window.location.href = onboardingDone ? '/app.html' : '/onboarding1.html';
        }, 120);
      });

      // 4) Reager p√• utlogging
      supa.auth.onAuthStateChange((event) => {
        if (event === 'SIGNED_OUT') location.href = '/innlogging.html';
      });
    })();
  </script>
</body>
</html>
